{% extends 'base.html' %}
{% load static %}
{% block content_wrapper_class %}flex-1 h-full overflow-hidden p-4 md:p-8 pb-0 md:pb-0{% endblock %}

{% block content %}
<div class="h-full flex overflow-hidden gap-6">
    <!-- Left Panel: Target Selector -->
    <div class="w-1/3 flex flex-col gap-4">
        <!-- Date Picker Module -->
        <div class="bg-surface/30 border border-white/10 rounded-xl overflow-hidden p-4">
            <h3 class="text-xs font-mono text-gray-400 mb-2">DATE</h3>
            <form method="get" id="dateForm" class="mb-0">
                <input type="date" name="date" value="{{ today_date }}" 
                    class="w-full bg-black/50 border border-white/10 rounded px-2 py-2 text-sm text-white focus:border-primary transition"
                    onchange="this.form.submit()">
            </form>
            <!-- Hidden CSRF for JS -->
            <form style="display:none">{% csrf_token %}</form>
        </div>

        <!-- Target List Module -->
        <div class="bg-surface/30 border border-white/10 rounded-xl overflow-hidden flex-1 flex flex-col relative">
            <div class="p-4 border-b border-white/10 bg-black/20">
                <h2 class="text-primary font-mono text-sm flex items-center gap-2">
                    <span class="w-1 h-4 bg-primary block"></span>
                    TARGET SELECT
                </h2>
                <div class="text-[10px] text-gray-500 font-mono mt-1">
                    {{ today_date }} ({{ weekday_jp }})
                </div>
            </div>
    
            <!-- Target List -->
            <div class="flex-1 overflow-y-auto p-2 space-y-2" id="targetList">
                {% for item in todays_targets %}
                <div class="target-item p-3 rounded flex items-center gap-3 cursor-pointer hover:bg-white/5 transition border border-transparent hover:border-primary/30 group relative select-target-btn"
                    data-id="{{ item.obj.id }}" data-name="{{ item.obj.nickname }}"
                    data-avatar="{% if item.obj.avatar %}{{ item.obj.avatar.url }}{% endif %}">
                    
                    <!-- Avatar -->
                    <div class="w-[50px] h-[50px] min-w-[50px] min-h-[50px] rounded-full bg-black border border-white/10 overflow-hidden flex-shrink-0 relative" style="width: 50px; height: 50px;">
                        {% if item.obj.avatar %}
                        <img src="{{ item.obj.avatar.url }}" class="w-full h-full object-cover">
                        {% else %}
                        <div class="w-full h-full flex items-center justify-center text-xs text-gray-500">{{ item.obj.nickname|slice:":1" }}</div>
                        {% endif %}
                    </div>
                    
                    <!-- Info -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-white font-mono truncate group-hover:text-primary">{{ item.obj.nickname }}</span>
                            <!-- Icons -->
                            {% if item.is_anniversary %}
                            <span class="text-red-500 text-xs" title="Anniversary"><i class="fas fa-gift"></i></span>
                            {% endif %}
                            {% if item.has_entry %}
                            <span class="text-primary text-xs" title="Log Exists"><i class="fas fa-check-circle"></i></span>
                            {% endif %}
                            {% if not item.has_entry %}
                            <span class="text-yellow-500 text-xs" title="Unfilled"><i class="fas fa-exclamation-circle"></i></span>
                            {% endif %}
                        </div>
                        <div class="text-[10px] text-gray-500 truncate">
                            {{ item.obj.last_name }} {{ item.obj.first_name }} 
                            {% if item.age %}({{ item.age }}){% endif %}
                        </div>
                    </div>

                    <!-- Minus Button (Hover Only) -->
                    <button class="absolute top-2 right-2 text-gray-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity remove-target-btn z-10 p-1"
                        data-id="{{ item.obj.id }}" title="リストから除外">
                        <i class="fas fa-minus-circle"></i>
                    </button>
                    
                    <div class="status-indicator w-1 h-full absolute left-0 top-0 bottom-0 bg-gray-700 transition-colors"></div>
                </div>
                {% empty %}
                <div class="text-center text-gray-500 text-xs py-10">
                    本日の予定ターゲットはいません
                </div>
                {% endfor %}
            </div>
    
            <!-- Buttons -->
            <div class="p-4 border-t border-white/10 bg-black/20 space-y-2">
                <button id="openTargetSearch"
                    class="w-full py-2 bg-primary/10 hover:bg-primary/20 text-primary border border-primary/30 rounded text-xs font-mono transition flex items-center justify-center gap-2">
                    <span>+</span> ADD TARGET
                </button>
                <button id="removeUnfilledBtn"
                    class="w-full py-2 bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/30 rounded text-xs font-mono transition flex items-center justify-center gap-2">
                    <span>-</span> REMOVE UNFILLED
                </button>
            </div>
        </div>
    </div>

    <!-- Right Panel: Dossier Chat-style Input -->
    <div class="flex-1 bg-surface/30 border border-white/10 rounded-xl overflow-hidden flex flex-col relative h-full">
        <!-- Overlay for No Selection -->
        <div id="noSelectionOverlay"
            class="absolute inset-0 z-50 bg-black/80 backdrop-blur-sm flex flex-col items-center justify-center text-gray-500">
            <div class="text-4xl mb-4 opacity-50">⚡</div>
            <div class="font-mono text-sm">SELECT TARGET FROM LEFT PANEL</div>
        </div>

        <!-- 1. HEADER: Target Info & Timeline Search -->
        <div class="p-4 border-b border-white/10 bg-black/20 flex justify-between items-center shrink-0 z-10 shadow-md">
            <!-- Target Info -->
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded bg-black border border-white/10 overflow-hidden" id="selectedAvatar">
                    <!-- JS populated -->
                </div>
                <div>
                    <h2 class="text-white font-mono text-sm" id="selectedName">--</h2>
                    <div class="text-[10px] text-gray-500">DOSSIER ENTRY</div>
                </div>
            </div>

            <!-- Search & Filters -->
            <div class="flex items-center gap-2">
                <!-- Encanto Filter Toggle -->
                <button id="encantoFilterBtn" class="flex items-center gap-1 px-3 py-1.5 rounded-full border border-white/10 text-gray-500 hover:text-green-400 hover:border-green-400/50 transition font-mono text-xs" title="Show Encanto Only">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>ENCANTO</span>
                </button>

                <select id="timelineTypeFilter" class="bg-black/50 border border-white/10 rounded px-2 py-1 text-xs text-white focus:border-primary">
                    <option value="">ALL</option>
                    <option value="EVENT">EVENT</option>
                    <option value="QUESTION">QUESTION</option>
                </select>

                <div class="relative group">
                    <input type="text" id="timelineSearch" placeholder="Search..." 
                        class="bg-black/50 border border-white/10 rounded-full px-3 py-1 text-xs text-white focus:border-primary w-32 focus:w-48 transition-all">
                    <i class="fas fa-search absolute right-3 top-1.5 text-gray-500 text-xs pointer-events-none"></i>
                </div>
            </div>
        </div>

        <!-- 2. TIMELINE: Infinite Scroll Area -->
        <div id="timelineContainer" class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth bg-black/20">
            <div id="timelineLoading" class="hidden text-center py-2 text-gray-500 text-xs">
                <i class="fas fa-spinner fa-spin"></i> Loading context...
            </div>
            <div id="timelineContent" class="space-y-4 flex flex-col justify-end min-h-0"></div>
        </div>

        <!-- 3. FOOTER: Input Area (Fixed) -->
        <div class="bg-surface border-t border-white/10 shrink-0 z-20 shadow-[0_-5px_20px_rgba(0,0,0,0.5)]">
            <!-- Tabs -->
            <div class="flex border-b border-white/10 bg-black/20">
                <button class="flex-1 py-2 text-xs font-mono text-center border-b-2 border-primary text-white bg-white/5 transition-colors"
                    id="tabEvent">
                    出来事 (EVENT)
                </button>
                <button
                    class="flex-1 py-2 text-xs font-mono text-center border-b-2 border-transparent text-gray-500 hover:text-gray-300 transition-colors"
                    id="tabQuestion">
                    質問 (QUESTION)
                </button>
            </div>

            <!-- Main Form Area -->
            <div class="flex flex-col h-full"> 
                 <!-- Edit Mode Indicator -->
                <div id="editModeBar" class="hidden bg-yellow-500/20 text-yellow-400 text-[10px] px-4 py-1 flex justify-between items-center">
                    <span>EDITING MODE</span>
                    <button id="cancelEditBtn" class="hover:text-white">✕ CANCEL</button>
                </div>
                
                <div class="flex-1 p-4 max-h-[40vh] overflow-y-auto flex flex-col">
                     <!-- Event Form -->
                    <div id="formEvent" class="space-y-3 flex-1 flex flex-col">
                        <textarea id="eventContent"
                            class="w-full h-20 bg-black/20 border border-white/10 rounded p-3 text-sm text-white focus:border-primary focus:outline-none resize-none flex-1 font-sans"
                            placeholder="出来事・会話・観察内容..."></textarea>
                        
                        <!-- Tags -->
                        <div class="flex flex-wrap gap-1" id="tagSelectionArea">
                            {% for tag in tags %}
                            <button type="button" 
                                class="tag-append-btn px-2 py-0.5 rounded-full border border-white/20 text-[10px] text-gray-400 hover:border-primary hover:text-primary transition bg-black/40"
                                data-name="{{ tag.name }}">
                                {{ tag.name }}({{ tag.count }})
                            </button>
                            {% endfor %}
                            <button type="button" id="moreTagsBtn" class="px-2 py-0.5 rounded-full border border-white/10 text-[10px] text-gray-500 hover:text-white transition">...</button>
                        </div>
                    </div>

                    <!-- Question Form -->
                    <div id="formQuestion" class="space-y-3 hidden">
                        <div class="flex gap-2">
                             <select id="qCategory" class="flex-1 bg-black/20 border border-white/10 rounded px-2 py-1 text-xs text-white focus:border-primary">
                                <option value="">カテゴリ</option>
                                {% regroup questions by category as category_list %}
                                {% for cat in category_list %}
                                <option value="{{ cat.grouper }}">{{ cat.grouper }}</option>
                                {% endfor %}
                            </select>
                            <select id="qSelect" class="flex-[2] bg-black/20 border border-white/10 rounded px-2 py-1 text-xs text-white focus:border-primary" disabled>
                                <option value="">質問選択...</option>
                            </select>
                        </div>

                        <div id="qDetails" class="hidden bg-black/20 border border-white/5 rounded p-2 text-[10px] text-gray-400 flex gap-4">
                             <div>Rank: <span id="qRank" class="text-primary"></span></div>
                             <div class="truncate flex-1">Intent: <span id="qDesc"></span></div>
                             <div class="hidden">Ex: <span id="qEx"></span></div>
                        </div>
                        
                        <div id="qChoicesCheck" class="opacity-50 pointer-events-none transition-opacity bg-black/20 border border-white/5 rounded p-2 min-h-[40px] flex flex-col justify-center">
                             <div id="qCheckPlaceholder" class="text-[10px] text-gray-500 text-center">選択肢 (質問を選択)</div>
                             <div id="qChoicesContainer" class="flex flex-wrap gap-1"></div>
                        </div>

                        <textarea id="qAnswer"
                            class="w-full h-16 bg-black/20 border border-white/10 rounded p-3 text-sm text-white focus:border-primary focus:outline-none resize-none font-sans"
                            placeholder="回答・反応..."></textarea>
                    </div>
                </div>

                <!-- Controls Area -->
                <div class="flex items-center justify-between gap-3 p-4 pb-12 border-t border-white/10 bg-black/20">
                    <!-- Date & Contact -->
                    <div class="flex items-center gap-3">
                         <div class="relative">
                            <input type="date" id="occurrenceDate" value="{{ today_date }}" class="bg-black/50 border border-white/10 rounded px-2 py-1 text-[10px] text-gray-400 focus:outline-none focus:border-primary [color-scheme:dark]">
                         </div>

                        <div class="flex items-center gap-2 cursor-pointer group">
                             <input type="checkbox" id="contactFlag" class="rounded border-gray-600 text-primary bg-gray-900 w-4 h-4 cursor-pointer">
                             <label for="contactFlag" class="text-[10px] text-gray-400 group-hover:text-white cursor-pointer leading-tight">接触</label>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <button id="saveLogBtn" class="bg-primary text-black font-bold py-2 px-6 rounded hover:bg-primary/90 transition-all shadow-lg shadow-primary/20 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                        <span id="saveBtnText">SAVE</span>
                    </button>
                    <!-- Hidden ID for Editing -->
                    <input type="hidden" id="editingItemId" value="">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search Modal -->
<div id="searchModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-surface border border-white/20 rounded-xl p-6 w-full max-w-md shadow-2xl h-[500px] flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-mono text-white">ターゲット検索</h3>
            <button id="closeSearch" class="text-gray-400 hover:text-white">✕</button>
        </div>
        <input type="text" id="searchInput" placeholder="Search by name..."
            class="w-full bg-black/20 border border-white/10 rounded px-3 py-2 text-sm text-white mb-4 focus:border-primary">
        <div class="flex-1 overflow-y-auto space-y-2 pr-1" id="searchList">
            {% for t in all_targets %}
            <div class="search-item p-2 rounded border border-white/5 hover:bg-white/5 cursor-pointer flex items-center gap-3"
                data-id="{{ t.id }}" data-name="{{ t.nickname }}"
                data-avatar="{% if t.avatar %}{{ t.avatar.url }}{% endif %}">
                <div class="w-8 h-8 rounded bg-gray-900 border border-white/10 flex items-center justify-center text-[10px] text-gray-500 overflow-hidden">
                    {% if t.avatar %}<img src="{{ t.avatar.url }}" class="w-full h-full object-cover">{% else %}{{ t.nickname|slice:":1" }}{% endif %}
                </div>
                <div class="text-sm text-white font-mono">{{ t.nickname }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Tag Modal -->
<div id="tagModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-surface border border-white/20 rounded-xl p-6 w-full max-w-lg shadow-2xl max-h-[80vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-mono text-white">ALL TAGS</h3>
            <button id="closeTagModal" class="text-gray-400 hover:text-white">✕</button>
        </div>
        <div class="flex-1 overflow-y-auto p-2" id="allTagsContainer">
            <!-- Loaded via JS -->
            <div class="text-center text-gray-500 text-xs">Loading tags...</div>
        </div>
    </div>
</div>

<script id="questionsData" type="application/json">
[
    {% for q in questions %}
    {
        "id": "{{ q.id }}", 
        "category": "{{ q.category|default:'' }}", 
        "text": "{{ q.title }}",
        "description": "{{ q.description|escapejs }}",
        "example": "{{ q.example|escapejs }}",
        "answer_type": "{{ q.answer_type }}",
        "choices": "{{ q.choices|escapejs }}",
        "rank": {% if q.rank %}"{{ q.rank.name }} ({{ q.rank.points }}pt)"{% else %}null{% endif %}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
]
</script>

<script>
    // --- State ---
    let currentTargetId = null;
    let questionsData = JSON.parse(document.getElementById('questionsData').textContent);

    // --- UI Elements ---
    const targetList = document.getElementById('targetList');
    const overlay = document.getElementById('noSelectionOverlay');
    const selectedName = document.getElementById('selectedName');
    const selectedAvatar = document.getElementById('selectedAvatar');
    const tabEvent = document.getElementById('tabEvent');
    const tabQuestion = document.getElementById('tabQuestion');
    const formEvent = document.getElementById('formEvent');
    const formQuestion = document.getElementById('formQuestion');
    const qCategory = document.getElementById('qCategory');
    const qSelect = document.getElementById('qSelect');
    const saveBtn = document.getElementById('saveLogBtn');
    const saveBtnText = document.getElementById('saveBtnText');
    const occurrenceDateInput = document.getElementById('occurrenceDate');
    const contactFlagCheckbox = document.getElementById('contactFlag');
    const editingItemIdInput = document.getElementById('editingItemId');
    const editModeBar = document.getElementById('editModeBar');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    
    // Encanto Filter
    const encantoFilterBtn = document.getElementById('encantoFilterBtn');
    let isEncantoFilterActive = false;

    // --- Timeline State ---
    const timelineContainer = document.getElementById('timelineContainer');
    const timelineContent = document.getElementById('timelineContent');
    const timelineLoading = document.getElementById('timelineLoading');
    const timelineSearch = document.getElementById('timelineSearch');
    const timelineTypeFilter = document.getElementById('timelineTypeFilter');
    
    let isFetching = false;
    let hasMore = true;
    let timelineCursorDate = null;

    // --- Target Selection ---
    targetList.addEventListener('click', function(e) {
        const removeBtn = e.target.closest('.remove-target-btn');
        if (removeBtn) {
            e.stopPropagation();
            const id = removeBtn.dataset.id;
            const date = document.querySelector('input[name="date"]').value;
            if(confirm('このターゲットを本日のリストから除外しますか？')) {
                toggleTargetState(id, date, 'hide', () => location.reload());
            }
            return;
        }

        const item = e.target.closest('.target-item');
        if (item) {
            document.querySelectorAll('.target-item').forEach(el => {
                el.classList.remove('bg-white/10', 'border-primary');
                el.querySelector('.status-indicator').classList.remove('bg-primary', 'shadow-[0_0_8px_rgba(34,197,94,0.8)]');
                el.querySelector('.status-indicator').classList.add('bg-gray-700');
            });
            item.classList.add('bg-white/10', 'border-primary');
            item.querySelector('.status-indicator').classList.remove('bg-gray-700');
            item.querySelector('.status-indicator').classList.add('bg-primary', 'shadow-[0_0_8px_rgba(34,197,94,0.8)]');

            currentTargetId = item.dataset.id;
            selectedName.textContent = item.dataset.name;
            const avatarUrl = item.dataset.avatar;
            selectedAvatar.innerHTML = avatarUrl 
                ? `<img src="${avatarUrl}" class="w-full h-full object-cover">` 
                : `<div class="w-full h-full flex items-center justify-center text-xs text-gray-500">${item.dataset.name.slice(0, 1)}</div>`;

            document.getElementById('noSelectionOverlay').classList.add('hidden');
            resetTimeline();
            fetchTimeline();
            cancelEditMode(); // Reset edit mode on target switch
        }
    });

    // --- Timeline Functions ---
    function resetTimeline() {
        timelineContent.innerHTML = '';
        console.log("Clearing timeline", timelineContent.innerHTML); // Debug
        timelineCursorDate = null;
        hasMore = true;
    }

    function fetchTimeline(append = false) {
        if (!currentTargetId || isFetching || (!hasMore && append)) return;
        
        isFetching = true;
        if (append) timelineLoading.classList.remove('hidden');

        const params = new URLSearchParams({ target_id: currentTargetId, limit: 20 });
        if (append && timelineCursorDate) params.append('before_date', timelineCursorDate);
        if (timelineSearch.value) params.append('search', timelineSearch.value);
        if (timelineTypeFilter.value) params.append('type', timelineTypeFilter.value);
        if (isEncantoFilterActive) params.append('contact_only', 'true');

        fetch(`{% url "timeline_list" %}?${params.toString()}`)
            .then(res => res.json())
            .then(data => {
                isFetching = false;
                timelineLoading.classList.add('hidden');
                
                if (data.success) {
                    if (data.data.length < 20) hasMore = false;
                    if (data.data.length > 0) {
                        timelineCursorDate = data.data[data.data.length - 1].date;
                        renderTimelineItems(data.data, append);
                    }
                }
            })
            .catch(err => {
                isFetching = false;
                console.error(err);
            });
    }

    function renderTimelineItems(items, append) {
        // Items are created_at DESC (Newest First) from API.
        // We want reversed (Old -> New) for chat style at bottom.
        const orderedItems = [...items].reverse();
        const fragment = document.createDocumentFragment();
        orderedItems.forEach(item => fragment.appendChild(createTimelineElement(item)));

        if (append) {
            const firstChild = timelineContent.firstElementChild;
            const oldHeight = timelineContainer.scrollHeight;
            timelineContent.insertBefore(fragment, firstChild);
            timelineContainer.scrollTop = timelineContainer.scrollHeight - oldHeight;
        } else {
            timelineContent.appendChild(fragment);
            timelineContainer.scrollTop = timelineContainer.scrollHeight;
        }
    }

    function createTimelineElement(item) {
        const typeBadge = item.type === 'EVENT' ? 'bg-blue-500/20 text-blue-400' : 'bg-green-500/20 text-green-400';
        
        let content = '';
        if (item.type === 'QUESTION') { 
                content = `
                    <div class="text-xs font-bold text-white mb-1">Q. ${item.question_title || 'Unknown Question'}</div>
                    <div class="text-gray-400">${escapeHtml(item.question_answer || '')}</div>
                `;
            } else {
                content = `<div class="text-gray-300 text-sm whitespace-pre-wrap">${escapeHtml(item.description || '')}</div>`;
            }
        
        let tagsHtml = '';
        if (item.tags && item.tags.length > 0) {
            const tags = item.tags.map(t => `<span class="text-[10px] text-gray-500 mr-1">#${escapeHtml(t.name)}</span>`).join('');
            tagsHtml = `<div class="mt-2 pt-2 border-t border-white/5">${tags}</div>`;
        }

        let encantoBadge = '';
        if (item.contact_made) {
             encantoBadge = `<span class="flex items-center gap-1 text-[10px] px-1.5 rounded bg-green-500/20 text-green-400 border border-white/10 mr-2">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Encanto
             </span>`;
        }

        const div = document.createElement('div');
        div.className = "bg-white/5 border border-white/5 rounded p-3 text-sm hover:bg-white/10 transition-colors group relative";
        div.innerHTML = `
            <div class="flex justify-between items-start mb-1">
                 <div class="flex items-center gap-2">
                    ${encantoBadge}
                    <span class="text-[10px] px-1.5 rounded ${typeBadge} border border-white/10">${item.type}</span>
                 </div>
                 <div class="flex items-center gap-3">
                     <!-- Buttons -->
                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button class="text-gray-500 hover:text-white edit-btn" title="Edit">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        </button>
                        <button class="text-gray-500 hover:text-red-500 delete-btn" title="Delete">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    <div class="text-[10px] text-gray-500 font-mono text-right">
                        <div>${item.created_at || ''}</div>
                        <div class="opacity-75">Occurred: ${item.date}</div>
                    </div>
                 </div>
            </div>
            <div class="text-gray-300 leading-relaxed break-words line-clamp-20">${content}</div>
            ${tagsHtml}
        `;
        
        // Handlers
        div.querySelector('.delete-btn').onclick = () => deleteLog(item.id);
        div.querySelector('.edit-btn').onclick = () => editLog(item);

        return div;
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    timelineContainer.addEventListener('scroll', () => {
        if (timelineContainer.scrollTop === 0 && hasMore && !isFetching) fetchTimeline(true);
    });
    
    let searchDebounce;
    timelineSearch.addEventListener('input', () => {
        clearTimeout(searchDebounce);
        searchDebounce = setTimeout(() => { resetTimeline(); fetchTimeline(); }, 500);
    });
    timelineTypeFilter.addEventListener('change', () => { resetTimeline(); fetchTimeline(); });
    
    // Encanto Filter
    encantoFilterBtn.addEventListener('click', () => {
        isEncantoFilterActive = !isEncantoFilterActive;
        
        if (isEncantoFilterActive) {
            encantoFilterBtn.classList.remove('text-gray-500', 'border-white/10', 'bg-transparent');
            encantoFilterBtn.classList.add('bg-green-500', 'text-black', 'border-green-500', 'font-bold');
        } else {
            encantoFilterBtn.classList.add('text-gray-500', 'border-white/10', 'bg-transparent');
            encantoFilterBtn.classList.remove('bg-green-500', 'text-black', 'border-green-500', 'font-bold');
        }

        resetTimeline();
        fetchTimeline();
    });

    // --- Action Functions ---
    // --- Action Functions ---
    function deleteLog(itemId) {
        if(!confirm("ログを削除しますか？この操作は取り消せません。")) return;
        
        fetch('{% url "intelligence_log" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                action: 'delete',
                item_id: itemId
            })
        }).then(res => res.json()).then(data => {
            if (data.success) {
                // If editing this item, cancel edit
                if (editingItemIdInput.value === itemId) {
                    cancelEditMode();
                }
                resetTimeline();
                fetchTimeline();
            } else {
                alert('削除に失敗しました: ' + (data.error || 'Unknown error'));
            }
        }).catch(err => {
            alert('通信エラーが発生しました');
            console.error(err);
        });
    }

    function editLog(item) {
        // Mode Set
        editingItemIdInput.value = item.id;
        editModeBar.classList.remove('hidden');
        saveBtnText.textContent = "UPDATE";
        saveBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-400');
        saveBtn.classList.remove('bg-primary', 'hover:bg-primary/90');
        
        // Populate Data
        occurrenceDateInput.value = item.date;
        contactFlagCheckbox.checked = item.contact_made;
        
        if (item.type === 'QUESTION') {
            tabQuestion.click();
            // Try to set Question Select
            // We need question_id. Backend didn't send it until I added it in Step 344.
            // item.question_id should exist now.
            if (item.question_id) {
                // Find question in questionsData
                const q = questionsData.find(q => q.id === item.question_id);
                if (q) {
                    qCategory.value = q.category;
                    qCategory.dispatchEvent(new Event('change'));
                    qSelect.value = q.id;
                    qSelect.dispatchEvent(new Event('change'));
                }
            }
            document.getElementById('qAnswer').value = item.description || '';
        } else {
            tabEvent.click();
            document.getElementById('eventContent').value = item.description || '';
        }
    }

    function cancelEditMode() {
        editingItemIdInput.value = "";
        editModeBar.classList.add('hidden');
        saveBtnText.textContent = "SAVE";
        saveBtn.classList.add('bg-primary', 'hover:bg-primary/90');
        saveBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-400');
        
        document.getElementById('eventContent').value = "";
        document.getElementById('qAnswer').value = "";
        contactFlagCheckbox.checked = false;
        // reset date? keep today or last selected
    }
    
    cancelEditBtn.addEventListener('click', cancelEditMode);

    // --- Tag Click Append ---
    // Top 10
    document.querySelector('#formEvent #tagSelectionArea').addEventListener('click', (e) => {
        if(e.target.classList.contains('tag-append-btn')) {
            const tagName = e.target.dataset.name;
            appendTagToActive(tagName);
        }
    });

    function appendTagToActive(tagName) {
        const isEvent = !formEvent.classList.contains('hidden');
        const targetEl = isEvent ? document.getElementById('eventContent') : document.getElementById('qAnswer');
        const val = targetEl.value;
        // Append on new line if content exists? User said "bottom line".
        if (val.length > 0 && !val.endsWith('\n')) {
             targetEl.value = val + "\n#" + tagName + " ";
        } else {
             targetEl.value = val + "#" + tagName + " ";
        }
    }
    
    // Tag Modal Logic
    const tagModal = document.getElementById('tagModal');
    const moreTagsBtn = document.getElementById('moreTagsBtn');
    const closeTagModal = document.getElementById('closeTagModal');
    const allTagsContainer = document.getElementById('allTagsContainer');
    
    moreTagsBtn.addEventListener('click', () => {
        tagModal.classList.remove('hidden');
        // Fetch
        fetch('{% url "tag_list_api" %}')
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    allTagsContainer.innerHTML = '';
                    data.tags.forEach(tag => {
                        const btn = document.createElement('button');
                        btn.className = "px-3 py-1 m-1 rounded-full border border-white/20 text-xs text-gray-300 hover:border-primary hover:text-primary transition bg-black/40";
                        btn.textContent = `${tag.name} (${tag.count})`;
                        btn.onclick = () => {
                            appendTagToActive(tag.name);
                             tagModal.classList.add('hidden');
                        };
                        allTagsContainer.appendChild(btn);
                    });
                }
            });
    });
    closeTagModal.addEventListener('click', () => tagModal.classList.add('hidden'));

    // --- Save ---
    document.getElementById('saveLogBtn').addEventListener('click', () => {
        if (!currentTargetId) { alert('ターゲットを選択してください'); return; }

        const isEventTab = !formEvent.classList.contains('hidden');
        const editingId = editingItemIdInput.value;
        const payload = {
            target_id: currentTargetId,
            date: occurrenceDateInput.value,
            description: "",
            event_type: "NOTE",
            tags: [],
            question_id: null,
            contact_made: contactFlagCheckbox.checked,
            action: editingId ? 'update' : 'create',
            item_id: editingId
            // tags are handled via regex now in backend too, or we can send them?
            // Backend in Step 339 parses content hashtags AND explicitly sent list.
            // We are appending to content. So regex will catch it.
        };

        if (isEventTab) { 
            payload.description = document.getElementById('eventContent').value; 
            payload.contact_made = contactFlagCheckbox.checked;

            if (!payload.description && !payload.contact_made && !editingId) { // Check edit too
                alert("内容を入力するか接触フラグをONにしてください");
                return;
            }
        } else {
            payload.event_type = 'QUESTION';
            const qId = qSelect.value;
            let ans = document.getElementById('qAnswer').value;
            if (!qId && !editingId) { // Allow update without re-selecting Q? Backend doesn't support changing Q yet if not sent.
                 alert('質問を選択してください');
                 return;
            }
            if(qId) payload.question_id = qId;
            
            // Single Select Answer
            if (currentQuestion && currentQuestion.answer_type === 'SELECTION' && selectedChoices.size > 0) {
                 const choice = Array.from(selectedChoices)[0];
                 ans = `[選択: ${choice}]\n${ans}`;
            }
            
            if (!ans.trim() && selectedChoices.size === 0 && !editingId) {
                 alert('回答を入力または選択してください');
                 return;
            }
            payload.description = ans;
        }
        
        // Send
        fetch('{% url "intelligence_log" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(payload)
        }).then(res => res.json()).then(data => {
            if (data.success) {
                // Clear Form or Reset Edit
                if(editingId) cancelEditMode(); 
                else {
                    document.getElementById('eventContent').value = '';
                    document.getElementById('qAnswer').value = '';
                    // Keep checkboxes? Usually clear.
                    contactFlagCheckbox.checked = false;
                }
                resetTimeline();
                fetchTimeline();
            } else {
                alert('保存に失敗しました: ' + (data.error || 'Unknown error'));
            }
        });
    });

    // Helper: Target State Toggle (Copied from previous)
    function toggleTargetState(targetId, date, action, callback) {
        return fetch('{% url "target_state_toggle" %}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value},
            body: JSON.stringify({ target_id: targetId, date: date, action: action })
        }).then(res => res.json()).then(data => {
            if(data.success && callback) callback();
            return data;
        });
    }
    
    // Search Modal (Target)
    const searchModal = document.getElementById('searchModal');
    document.getElementById('openTargetSearch').addEventListener('click', () => searchModal.classList.remove('hidden'));
    document.getElementById('closeSearch').addEventListener('click', () => searchModal.classList.add('hidden'));
    document.getElementById('searchInput').addEventListener('input', function() {
        const term = this.value.toLowerCase();
        document.querySelectorAll('.search-item').forEach(el => {
            el.classList.toggle('hidden', !el.dataset.name.toLowerCase().includes(term));
        });
    });
    document.getElementById('searchList').addEventListener('click', function(e) {
        const item = e.target.closest('.search-item');
        if (item) {
             const id = item.dataset.id;
             let exists = false;
             document.querySelectorAll('.target-item').forEach(el => { if(el.dataset.id === id) exists=true; });
             if(!exists) toggleTargetState(id, document.querySelector('input[name="date"]').value, 'add', () => location.reload());
             else alert('すでにリストに追加されています');
             searchModal.classList.add('hidden');
        }
    });

    // Q Elements Logic
    const qDetails = document.getElementById('qDetails');
    const qChoicesContainer = document.getElementById('qChoicesContainer');
    const qChoicesCheck = document.getElementById('qChoicesCheck');
    const qCheckPlaceholder = document.getElementById('qCheckPlaceholder');
    let selectedChoices = new Set();
    let currentQuestion = null;

    qCategory.addEventListener('change', (e) => {
        const cat = e.target.value;
        qSelect.innerHTML = '<option value="">質問を選択してください</option>';
        qSelect.disabled = !cat;
        qDetails.classList.add('hidden');
        qChoicesContainer.innerHTML = '';
        qChoicesCheck.classList.add('opacity-50', 'pointer-events-none');
        selectedChoices.clear(); currentQuestion = null;
        if(cat) questionsData.filter(q => q.category === cat).forEach(q => qSelect.add(new Option(q.text, q.id)));
    });

    qSelect.addEventListener('change', (e) => {
        const qId = e.target.value;
        const q = questionsData.find(item => item.id === qId);
        currentQuestion = q;
        selectedChoices.clear();
        if(q) {
             document.getElementById('qRank').textContent = q.rank || '-';
             document.getElementById('qDesc').textContent = q.description || '-';
             document.getElementById('qEx').textContent = q.example || '-';
             qDetails.classList.remove('hidden');
             
             qChoicesContainer.innerHTML = '';
             if (q.answer_type === 'SELECTION' && q.choices) {
                 qChoicesCheck.classList.remove('opacity-50', 'pointer-events-none');
                 if(qCheckPlaceholder) qCheckPlaceholder.classList.add('hidden');
                 q.choices.split(',').map(c => c.trim()).filter(c=>c).forEach(c => {
                     const btn = document.createElement('button');
                     btn.className = 'choice-btn px-2 py-1 rounded-full border border-white/20 text-[10px] text-gray-300 hover:border-primary hover:text-primary transition bg-black/40';
                     btn.textContent = c;
                     btn.onclick = () => {
                         selectedChoices.clear();
                         selectedChoices.add(c);
                         document.querySelectorAll('.choice-btn').forEach(b => {
                             b.classList.remove('bg-primary/20', 'border-primary', 'text-primary');
                             b.classList.add('bg-black/40', 'border-white/20', 'text-gray-300');
                         });
                         btn.classList.add('bg-primary/20', 'border-primary', 'text-primary');
                         btn.classList.remove('bg-black/40', 'border-white/20', 'text-gray-300');
                     };
                     qChoicesContainer.appendChild(btn);
                 });
             } else {
                 qChoicesCheck.classList.add('opacity-50', 'pointer-events-none');
                 if(qCheckPlaceholder) qCheckPlaceholder.classList.remove('hidden');
             }
        } else {
             qDetails.classList.add('hidden');
             qChoicesCheck.classList.add('opacity-50', 'pointer-events-none');
        }
    });

    const removeUnfilledBtn = document.getElementById('removeUnfilledBtn');
    removeUnfilledBtn.addEventListener('click', function() {
        if(!confirm('未記入のターゲットを一括で除外しますか？')) return;
        const date = document.querySelector('input[name="date"]').value;
        let promises = [];
        document.querySelectorAll('.target-item').forEach(item => {
            if (item.querySelector('.fa-exclamation-circle')) { 
                promises.push(toggleTargetState(item.dataset.id, date, 'hide'));
            }
        });
        Promise.all(promises).then(() => location.reload());
    });

    // --- Tab Switching Logic ---
    tabEvent.addEventListener('click', () => {
        formEvent.classList.remove('hidden');
        formQuestion.classList.add('hidden');
        tabEvent.classList.add('border-primary', 'text-white', 'bg-white/5');
        tabEvent.classList.remove('border-transparent', 'text-gray-500');
        tabQuestion.classList.add('border-transparent', 'text-gray-500');
        tabQuestion.classList.remove('border-primary', 'text-white', 'bg-white/5');
    });

    tabQuestion.addEventListener('click', () => {
        formQuestion.classList.remove('hidden');
        formEvent.classList.add('hidden');
        tabQuestion.classList.add('border-primary', 'text-white', 'bg-white/5');
        tabQuestion.classList.remove('border-transparent', 'text-gray-500');
        tabEvent.classList.add('border-transparent', 'text-gray-500');
        tabEvent.classList.remove('border-primary', 'text-white', 'bg-white/5');
    });

</script>
{% endblock %}