{% extends 'base.html' %}
{% load static %}
{% block content_wrapper_class %}flex-1 flex flex-col min-h-0 overflow-hidden bg-background{% endblock %}

{% block content %}
<!-- Unified Responsive Layout -->
<div class="flex flex-1 min-h-0 relative" id="splitPaneContainer">
    <!-- Left Panel: Target Selector -->
    <div id="leftPanel" class="flex flex-col w-full md:w-[30%] h-full min-w-[250px] max-w-[50vw] bg-surface relative z-0">
        <!-- Unified Compact Header: Date & Actions -->
        <div class="p-2 border-b border-white/10 flex items-center gap-2 shrink-0 bg-surface z-20">
            <!-- Date (Small) -->
            <!-- Date (Small) -->
            <form method="get" id="dateForm" class="mb-0 flex-1 min-w-0 flex items-center gap-2">
                <label for="occurrenceDateInput" class="text-[10px] text-text-sub font-mono shrink-0">発生日</label>
                <input type="date" id="occurrenceDateInput" name="date" value="{{ today_date }}"
                    class="w-full bg-background border border-white/10 rounded px-2 py-1 text-[10px] md:text-xs text-text-sub focus:border-primary transition h-8"
                    onchange="this.form.submit()">
            </form>
            
            <!-- Actions (Compact) -->
            <button id="openTargetSearch" class="h-8 px-3 bg-primary/10 hover:bg-primary/20 text-primary border border-primary/30 rounded text-[10px] font-mono transition flex items-center justify-center gap-1">
                <i class="fas fa-plus"></i> ADD
            </button>
            <button id="removeUnfilledBtn" class="h-8 px-3 bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/30 rounded text-[10px] font-mono transition flex items-center justify-center gap-1">
                <i class="fas fa-trash-alt"></i>
            </button>
        </div>

        <!-- Target List Header (Simplified) -->
        <div class="px-3 py-1 bg-surface/50 border-b border-white/5 shrink-0 flex justify-between items-center">
            <h2 class="text-text-sub font-mono text-[10px] tracking-wider">TARGET SELECT</h2>
            <span class="text-[10px] text-text-sub opacity-50">{{ todays_targets|length }}</span>
        </div>

        <!-- Target List (No Extra Padding) -->
        <div class="flex-1 overflow-y-auto p-0" id="targetList">
            {% if todays_targets %}
            {% for item in todays_targets %}
            <div class="target-item p-3 border-b border-white/5 flex items-center gap-3 cursor-pointer hover:bg-white/5 transition group relative select-target-btn"
                data-id="{{ item.obj.id }}" data-name="{{ item.obj.nickname }}"
                data-avatar="{% if item.obj.avatar %}{{ item.obj.avatar.url }}{% endif %}">

                <!-- Avatar -->
                <div class="w-10 h-10 min-w-[40px] max-w-[40px] rounded-full bg-gray-800 border border-white/10 overflow-hidden relative pointer-events-none shrink-0" style="width: 40px !important; height: 40px !important; min-width: 40px !important; max-width: 40px !important;">
                    {% if item.obj.avatar %}
                    <img src="{{ item.obj.avatar.url }}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">
                    {% else %}
                    <div class="w-full h-full flex items-center justify-center text-[10px] text-text-sub">{{ item.obj.nickname|slice:":1" }}</div>
                    {% endif %}
                </div>

                <!-- Info -->
                <div class="flex-1 min-w-0 flex flex-col justify-center pointer-events-none gap-0.5">
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-text-main font-bold truncate group-hover:text-primary transition-colors">{{ item.obj.nickname }}</span>
                    </div>
                    <!-- Full Name & Age -->
                    <div class="text-[10px] text-text-sub truncate font-sans">
                        {{ item.obj.last_name }} {{ item.obj.first_name }} <span class="opacity-70">({{ item.age }})</span>
                    </div>

                    <!-- Status Lines -->
                    <div class="flex flex-wrap gap-2 mt-0.5">
                       {% if item.is_anniversary %}
                       <span class="text-[10px] text-red-400 font-bold animate-pulse flex items-center gap-1">
                           <i class="fas fa-gift"></i> {{ item.anniversary_label }}
                       </span>
                       {% endif %}
                       
                       {% if item.is_upcoming_anniversary %}
                       <span class="text-[10px] text-yellow-500/80 flex items-center gap-1">
                           <i class="fas fa-bullhorn transform -rotate-12"></i> {{ item.upcoming_anniversary_label }}
                       </span>
                       {% endif %}
                    </div>
                </div>

                <!-- Right Side Stats -->
                <div class="flex flex-col items-end gap-1 text-[9px] text-text-sub font-mono mr-2">
                    <div title="Last Contact">
                        <i class="fas fa-history opacity-50 mr-1"></i>
                        {% if item.last_contact_date %}{{ item.last_contact_date|date:"m/d" }}{% else %}-{% endif %}
                    </div>
                    <div title="Logs Today" class="{% if item.log_count > 0 %}text-primary{% else %}opacity-30{% endif %}">
                        <i class="fas fa-file-alt opacity-50 mr-1"></i>
                        {{ item.log_count }}
                    </div>
                </div>

                <!-- Minus Button (Right Aligned) -->
                <button
                    class="w-8 h-8 flex items-center justify-center text-text-sub hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity remove-target-btn z-10"
                    data-id="{{ item.obj.id }}">
                    <i class="fas fa-minus-circle"></i>
                </button>
                
                <!-- Active Indicator -->
                <div class="status-indicator w-0.5 h-full absolute left-0 top-0 bottom-0 bg-transparent transition-colors"></div>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center text-text-sub text-xs py-10 opacity-50">
                NO TARGETS
            </div>
            {% endif %}
        </div>
        
        <!-- Hidden forms for JS compatibility -->
        <form style="display:none">{% csrf_token %}</form>
    </div>

    <!-- Resizer Handle (Desktop Only) -->
    <div id="resizer" class="hidden md:flex w-2 hover:w-2 bg-transparent hover:bg-primary/30 cursor-col-resize z-40 items-center justify-center group flex-shrink-0 transition-all active:bg-primary/50">
        <div class="w-0.5 h-8 bg-border group-hover:bg-primary rounded transition-colors pointer-events-none"></div>
    </div>

    <!-- Right Panel: Dossier Chat-style Input -->
    <div id="rightPanel"
        class="hidden md:flex flex-col flex-1 bg-surface border border-border rounded-xl overflow-hidden min-h-0 relative h-full">
        <!-- Overlay for No Selection -->
        <div id="noSelectionOverlay"
            class="absolute inset-0 z-50 bg-background/80 backdrop-blur-sm flex flex-col items-center justify-center text-text-sub">
            <div class="text-4xl mb-4 opacity-50">⚡</div>
            <div class="font-mono text-sm">SELECT TARGET FROM LEFT PANEL</div>
        </div>

        <!-- 1. HEADER: Chat Header -->
        <div class="h-14 px-4 border-b border-white/10 bg-surface flex justify-between items-center shrink-0 z-10 shadow-md">
            <!-- Left: Back & Target Name (No Avatar) -->
            <div class="flex items-center gap-3">
                <!-- Back Button (Mobile) -->
                <button id="mobileBackBtn" class="md:hidden w-8 h-8 flex items-center justify-center rounded-full active:bg-white/10 text-white transition">
                    <i class="fas fa-chevron-left"></i>
                </button>
                
                <h2 class="text-text-main font-bold text-base" id="selectedName">--</h2>
            </div>

            <!-- Right: Tools -->
            <div class="flex items-center gap-3">
                 <!-- Occurrence Date (Calendar Icon) -->
                 <div class="relative">
                     <input type="date" id="occurrenceDate" value="{{ today_date }}"
                         class="absolute inset-0 opacity-0 cursor-pointer z-10 w-full h-full">
                     <button class="w-8 h-8 flex items-center justify-center text-text-sub hover:text-primary transition rounded-full hover:bg-white/5" title="発生日">
                         <i class="far fa-calendar-alt text-lg"></i>
                     </button>
                </div>

                <!-- Search Toggle -->
                <div class="relative group flex items-center">
                     <input type="text" id="timelineSearch" placeholder="検索..."
                         class="w-0 focus:w-32 bg-transparent border-b border-primary text-xs px-2 py-1 transition-all opacity-0 focus:opacity-100 outline-none text-text-main">
                     <button id="toggleSearchBtn" class="w-8 h-8 flex items-center justify-center text-text-sub hover:text-primary transition rounded-full hover:bg-white/5" 
                        onclick="const el=document.getElementById('timelineSearch'); el.classList.toggle('w-0'); el.classList.toggle('w-32'); el.classList.toggle('opacity-0'); el.focus()">
                         <i class="fas fa-search text-lg"></i>
                     </button>
                </div>

                <!-- Answer Button -->
                <button id="openAnswerModalBtn" class="bg-primary hover:bg-primary/90 text-black px-4 py-1.5 rounded-full text-xs font-bold transition flex items-center gap-1 shadow-lg shadow-primary/20">
                    <i class="fas fa-comment-dots"></i> 回答
                </button>
            </div>
        </div>

        <!-- 2. TIMELINE: Infinite Scroll Area -->
        <div id="timelineContainer" class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth bg-surface/50">
            <div id="timelineLoading" class="hidden text-center py-2 text-text-sub text-xs">
                <i class="fas fa-spinner fa-spin"></i> Loading context...
            </div>
            <div id="timelineContent" class="space-y-4 flex flex-col justify-end min-h-0"></div>
        </div>

        <!-- 3. FOOTER: Chat Input Area -->
        <div class="bg-surface border-t border-white/10 shrink-0 z-20 pb-safe">
            <div class="p-2 flex items-end gap-2 bg-surface">
                <!-- Tools Left -->
                 <div class="flex items-center pb-2 gap-1">
                     <!-- Tag -->
                    <button id="toggleTagMenuBtn" class="w-8 h-8 flex items-center justify-center text-text-sub hover:text-primary transition rounded-full hover:bg-white/5" title="タグ">
                        <i class="fas fa-hashtag"></i>
                    </button>
                    <!-- Image -->
                    <button id="uploadImageBtn" class="w-8 h-8 flex items-center justify-center text-text-sub hover:text-primary transition rounded-full hover:bg-white/5" title="画像">
                        <i class="fas fa-image"></i>
                    </button>
                     <!-- Contact -->
                    <button id="contactFlagBtn" class="h-8 px-2 flex items-center justify-center text-text-sub hover:text-primary transition rounded-full hover:bg-white/5 text-xs font-bold border border-transparent" 
                        onclick="this.classList.toggle('text-primary'); this.classList.toggle('border-primary'); this.classList.toggle('bg-primary/10'); document.getElementById('contactFlag').checked = !document.getElementById('contactFlag').checked;">
                        接触
                    </button>
                 </div>

                <!-- Input -->
                <textarea id="chatInput" rows="1" class="flex-1 bg-background border border-white/10 rounded-2xl px-4 py-2.5 text-sm text-text-main focus:border-primary focus:outline-none resize-none font-sans max-h-32" placeholder="メッセージを入力..."></textarea>
                
                <!-- Submit (Plane) -->
                <button id="saveLogBtn" class="w-10 h-10 rounded-full bg-primary text-black flex items-center justify-center shrink-0 hover:scale-105 transition shadow-lg opacity-0 pointer-events-none transform scale-0 duration-200" disabled>
                    <i class="fas fa-paper-plane text-lg translate-x-[-1px] translate-y-[1px]"></i>
                </button>
                
                <!-- Hidden inputs -->
                <input type="checkbox" id="contactFlag" class="hidden">
                <input type="file" id="imageInput" class="hidden" accept="image/*">
            </div>
        </div>
    </div>
</div>

<!-- Question Answer Modal -->
<div id="questionAnswerModal" class="hidden fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-surface border border-border rounded-xl w-full max-w-2xl shadow-2xl flex flex-col max-h-[90vh]">
        <div class="p-4 border-b border-border flex justify-between items-center bg-surface rounded-t-xl">
            <h3 class="text-lg font-bold text-text-main"><i class="fas fa-comment-dots text-primary mr-2"></i>質問に回答</h3>
            <button onclick="document.getElementById('questionAnswerModal').classList.add('hidden')" class="text-text-sub hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-4">
            <!-- Step 1: Category Selection -->
            <div id="qStep1" class="space-y-4">
               <h4 class="text-sm text-text-sub mb-2">カテゴリを選択</h4>
               <div class="grid grid-cols-2 md:grid-cols-3 gap-2" id="qCategoryGrid">
                   <!-- Populated by JS -->
               </div>
            </div>

            <!-- Step 2: Question Selection -->
            <div id="qStep2" class="hidden space-y-4">
                <div class="flex items-center gap-2 mb-2">
                    <button id="qBackToCat" class="text-text-sub hover:text-white text-xs"><i class="fas fa-arrow-left"></i> 戻る</button>
                    <h4 class="text-sm text-text-main font-bold" id="qSelectedCatName">-</h4>
                </div>
                <div class="grid grid-cols-2 gap-2" id="qQuestionGrid">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Step 3: Answer Form -->
            <div id="qStep3" class="hidden space-y-4">
                 <div class="flex items-center gap-2 mb-2">
                    <button id="qBackToQuestions" class="text-text-sub hover:text-white text-xs"><i class="fas fa-arrow-left"></i> 戻る</button>
                    <h4 class="text-sm text-text-main font-bold">回答を入力</h4>
                </div>
                
                <div class="bg-background p-3 rounded border border-border mb-4">
                    <div class="text-primary font-bold text-sm mb-1" id="qTargetQuestion">-</div>
                    <div class="text-xs text-text-sub" id="qTargetIntent">-</div>
                </div>

                <textarea id="qModalAnswer" class="w-full h-32 bg-background border border-border rounded p-3 text-sm text-text-main focus:border-primary focus:outline-none" placeholder="回答を入力..."></textarea>
                
                <div class="flex justify-end gap-2">
                    <button class="px-4 py-2 rounded border border-border text-text-sub hover:text-white" onclick="document.getElementById('questionAnswerModal').classList.add('hidden')">キャンセル</button>
                    <button id="submitAnswerBtn" class="px-6 py-2 rounded bg-primary text-black font-bold hover:bg-primary/90">回答を保存</button>
                </div>
            </div>
        </div>
    </div>
</div>




<!-- Search Modal -->
<div id="searchModal"
    class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-surface border border-border rounded-xl p-6 w-full max-w-md shadow-2xl h-[500px] flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-mono text-text-main">ターゲット検索</h3>
            <button id="closeSearch" class="text-text-sub hover:text-text-main">✕</button>
        </div>
        <input type="text" id="searchInput" placeholder="Search by name..."
            class="w-full bg-background border border-border rounded px-3 py-2 text-sm text-text-main mb-4 focus:border-primary">
        <div class="flex-1 overflow-y-auto space-y-2 pr-1" id="searchList">
            {% for t in all_targets %}
            <div class="search-item p-2 rounded border border-border hover:bg-text-main/5 cursor-pointer flex items-center gap-3"
                data-id="{{ t.id }}" data-name="{{ t.nickname }}"
                data-avatar="{% if t.avatar %}{{ t.avatar.url }}{% endif %}">
                <div
                    class="w-8 h-8 rounded bg-background border border-border flex items-center justify-center text-[10px] text-text-sub overflow-hidden">
                    {% if t.avatar %}<img src="{{ t.avatar.url }}" class="w-full h-full object-cover">{% else %}{{
                    t.nickname|slice:":1" }}{% endif %}
                </div>
                <div class="text-sm text-text-main font-mono">{{ t.nickname }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Tag Modal -->
<div id="tagModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-surface border border-border rounded-xl p-6 w-full max-w-lg shadow-2xl max-h-[80vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-mono text-text-main">ALL TAGS</h3>
            <button id="closeTagModal" class="text-text-sub hover:text-text-main">✕</button>
        </div>
        <div class="flex-1 overflow-y-auto p-2" id="allTagsContainer">
            <!-- Loaded via JS -->
            <div class="text-center text-text-sub text-xs">Loading tags...</div>
        </div>
    </div>
</div>

<script id="questionsData" type="application/json">
[
    {% for q in questions %}
    {
        "id": "{{ q.id }}", 
        "category": "{{ q.category|default:'' }}", 
        "text": "{{ q.title }}",
        "description": "{{ q.description|escapejs }}",
        "example": "{{ q.example|escapejs }}",
        "answer_type": "{{ q.answer_type }}",
        "choices": "{{ q.choices|escapejs }}",
        "rank": {% if q.rank %}"{{ q.rank.name }} ({{ q.rank.points }}pt)"{% else %}null{% endif %}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
]
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {


    // --- State ---
    let currentTargetId = null;
    let questionsData = JSON.parse(document.getElementById('questionsData').textContent);

    // --- UI Elements ---
    const targetList = document.getElementById('targetList');
    const overlay = document.getElementById('noSelectionOverlay');
    const selectedName = document.getElementById('selectedName');
    const selectedAvatar = document.getElementById('selectedAvatar');
    // Tabs removed
    // Forms removed
    const qCategory = document.getElementById('qCategory');
    const qSelect = document.getElementById('qSelect');
    const saveBtn = document.getElementById('saveLogBtn');
    const saveBtnText = document.getElementById('saveBtnText');
    const occurrenceDateInput = document.getElementById('occurrenceDate');
    const contactFlagCheckbox = document.getElementById('contactFlag');
    const editingItemIdInput = document.getElementById('editingItemId');
    const editModeBar = document.getElementById('editModeBar');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const deleteBtn = document.getElementById('deleteLogBtn');

    // Encanto Filter
    const encantoFilterBtn = document.getElementById('encantoFilterBtn');
    let isEncantoFilterActive = false;

    // --- Timeline State ---
    const timelineContainer = document.getElementById('timelineContainer');
    const timelineContent = document.getElementById('timelineContent');
    const timelineLoading = document.getElementById('timelineLoading');
    const timelineSearch = document.getElementById('timelineSearch');
    const timelineTypeFilter = document.getElementById('timelineTypeFilter');

    // Panels
    const leftPanel = document.getElementById('leftPanel');
    const rightPanel = document.getElementById('rightPanel');
    const mobileBackBtn = document.getElementById('mobileBackBtn');

    let isFetching = false;
    let hasMore = true;
    let timelineCursorDate = null;

    // --- Panel Switching Logic ---
    const mobileBottomNav = document.getElementById('mobileBottomNav');

    function showChatView() {
        if (window.innerWidth < 768) {
            leftPanel.classList.add('hidden');
            rightPanel.classList.remove('hidden');
            rightPanel.classList.add('flex');
            
            // Hide Bottom Nav in Detail View
            if (mobileBottomNav) mobileBottomNav.classList.add('hidden');
        }
    }

    function showListView() {
        if (window.innerWidth < 768) {
            rightPanel.classList.add('hidden');
            rightPanel.classList.remove('flex');
            leftPanel.classList.remove('hidden');
            
            // Show Bottom Nav in List View
            if (mobileBottomNav) mobileBottomNav.classList.remove('hidden');
        }
    }

    if (mobileBackBtn) {
        mobileBackBtn.addEventListener('click', showListView);
    }

    // --- Resizer Logic ---
    const resizer = document.getElementById('resizer');
    const splitPaneContainer = document.getElementById('splitPaneContainer');

    if (resizer) {
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
            document.body.classList.add('select-none'); // Prevent selection during drag
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const containerRect = splitPaneContainer.getBoundingClientRect();
            // Calculate width in percent
            let newWidthInfo = ((e.clientX - containerRect.left) / containerRect.width) * 100;
            
            // Constrain
            if (newWidthInfo < 20) newWidthInfo = 20;
            if (newWidthInfo > 60) newWidthInfo = 60; // Max 60%

            leftPanel.style.width = `${newWidthInfo}%`;
        });

        document.addEventListener('mouseup', () => {
             if(isResizing) {
                isResizing = false;
                document.body.style.cursor = '';
                document.body.classList.remove('select-none');
            }
        });
    }

    // --- Target Selection ---
    targetList.addEventListener('click', function (e) {
        const removeBtn = e.target.closest('.remove-target-btn');
        if (removeBtn) {
            e.stopPropagation();
            const id = removeBtn.dataset.id;
            const date = document.querySelector('input[name="date"]').value;
            if (confirm('このターゲットを本日のリストから除外しますか？')) {
                toggleTargetState(id, date, 'hide', () => location.reload());
            }
            return;
        }

        const item = e.target.closest('.target-item');
        if (item) {
            document.querySelectorAll('.target-item').forEach(el => {
                el.classList.remove('bg-text-main/10', 'border-primary');
                el.querySelector('.status-indicator').classList.remove('bg-primary', 'shadow-[0_0_8px_rgba(34,197,94,0.8)]');
                el.querySelector('.status-indicator').classList.add('bg-text-sub/50');
            });
            item.classList.add('bg-text-main/10', 'border-primary');
            item.querySelector('.status-indicator').classList.remove('bg-text-sub/50');
            item.querySelector('.status-indicator').classList.add('bg-primary', 'shadow-[0_0_8px_rgba(34,197,94,0.8)]');

            currentTargetId = item.dataset.id;
            selectedName.textContent = item.dataset.name;
            const avatarUrl = item.dataset.avatar;
            if (selectedAvatar) {
                 if (avatarUrl) {
                     selectedAvatar.innerHTML = `<img src="${avatarUrl}" class="w-full h-full object-cover">`;
                 } else {
                     selectedAvatar.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-700 text-text-sub font-mono text-xs">${item.dataset.name.slice(0,1)}</div>`;
                 }
            }

            // Show Chat View (Mobile)
            showChatView();
            
            // Mobile: Hide Bottom Nav
            if (window.innerWidth < 768 && mobileBottomNav) {
                mobileBottomNav.classList.add('hidden');
            }

            // Reset Timeline
            noSelectionOverlay.classList.add('hidden');
            resetTimeline();
            fetchTimeline();
            
            // Enable Inputs
            document.getElementById('saveLogBtn').disabled = true; // Wait for input
            document.getElementById('chatInput').disabled = false;
        }
    });


    // --- Timeline Functions ---
    function resetTimeline() {
        timelineContent.innerHTML = '';
        console.log("Clearing timeline");
        timelineCursorDate = null;
        hasMore = true;
    }

    function fetchTimeline(append = false) {
        if (!currentTargetId || isFetching || (!hasMore && append)) return;

        isFetching = true;
        if (append) timelineLoading.classList.remove('hidden');

        const params = new URLSearchParams({ target_id: currentTargetId, limit: 20 });
        if (append && timelineCursorDate) params.append('before_date', timelineCursorDate);
        if (timelineSearch.value) params.append('search', timelineSearch.value);
        if (timelineTypeFilter && timelineTypeFilter.value) params.append('type', timelineTypeFilter.value);
        if (isEncantoFilterActive) params.append('contact_only', 'true');

        fetch(`{% url "timeline_list" %}?${params.toString()}`)
            .then(res => res.json())
            .then(data => {
                isFetching = false;
                timelineLoading.classList.add('hidden');

                if (data.success) {
                    if (data.data.length < 20) hasMore = false;
                    if (data.data.length > 0) {
                        timelineCursorDate = data.data[data.data.length - 1].date;
                        renderTimelineItems(data.data, append);
                    }
                }
            })
            .catch(err => {
                isFetching = false;
                console.error(err);
            });
    }

    function renderTimelineItems(items, append) {
        // items are Newest -> Oldest
        // We want to display Oldest -> Newest (Chat order)
        const orderedItems = [...items].reverse();

        const fragment = document.createDocumentFragment();
        
        orderedItems.forEach((item, index) => {
            // Date Separator Logic
            // Check if date changed from previous item (or if it's the first item)
            let showDate = false;
            if (index === 0) {
                // For the very first item (oldest), always show date unless we are appending to existing list
                // If appending (scrolling up), we need to check against the bottom of the *previous* batch (which is visually below).
                // Actually, renderTimelineItems is usually called with a batch.
                // If not appending (fresh load), show date for first.
                if (!append) showDate = true;
                // If appending, we effectively prepend. The "last" date of this batch might match the "first" date of the existing DOM.
                // This logic is tricky with reverse scrolling. 
                // Simplified: Just always show date separator if it differs from the previous item *in this list*.
                showDate = true; 
            } else {
                const prevItem = orderedItems[index - 1];
                if (item.date !== prevItem.date) showDate = true;
            }
            
            // Check global lastDate reference if needed, but for chat view, local comparison is usually enough
            // provided we handle the connection points.
            // Let's stick to local comparison for now.
            
            if (showDate) {
                const sep = document.createElement('div');
                sep.className = "flex items-center justify-center my-6 opacity-70";
                sep.innerHTML = `<div class="bg-surface/50 border border-white/5 rounded-full px-4 py-1 text-[11px] text-text-sub font-mono tracking-widest backdrop-blur-sm shadow-sm">${item.date.replace(/-/g, '/')}</div>`;
                fragment.appendChild(sep);
            }
            fragment.appendChild(createTimelineElement(item));
        });

        if (append) {
            // Prepend functionality (History)
            const firstChild = timelineContent.firstElementChild;
            const oldHeight = timelineContainer.scrollHeight;
            timelineContent.insertBefore(fragment, firstChild);
            timelineContainer.scrollTop = timelineContainer.scrollHeight - oldHeight;
        } else {
            // Standard load (Newest at bottom)
            timelineContent.appendChild(fragment);
            timelineContainer.scrollTop = timelineContainer.scrollHeight;
        }
    }

    function createTimelineElement(item) {
        // Time Formatting (HH:MM)
        let timeStr = '--:--';
        if (item.created_at) {
             const parts = item.created_at.split(' ');
             if (parts.length > 1) {
                 timeStr = parts[1].slice(0, 5); // HH:MM
             } else if (item.created_at.includes('T')) {
                 timeStr = item.created_at.split('T')[1].slice(0, 5);
             } else {
                 timeStr = item.created_at.slice(-5);
             }
        }

        let contentHtml = '';
        
        // Content Processing
        if (item.type === 'QUESTION') {
            const qTitle = item.question_title || '質問';
            let ans = item.description || '';
            let choiceVal = null;
            const choiceMatch = ans.match(/\[選択:\s*(.*?)\]/);
            if (choiceMatch) {
                choiceVal = choiceMatch[1];
                ans = ans.replace(choiceMatch[0], '').trim();
            }
            
            contentHtml = `
                <div class="text-[11px] font-bold text-primary mb-1 opacity-80 pl-1">${escapeHtml(qTitle)}</div>
                <div class="text-text-main text-sm whitespace-pre-wrap leading-relaxed">${escapeHtml(ans)}</div>
            `;
            if (choiceVal) {
                contentHtml += `<div class="mt-2"><span class="inline-block px-3 py-1 rounded-full border border-primary/30 text-primary text-xs bg-primary/5">${escapeHtml(choiceVal)}</span></div>`;
            }
        } else {
            // NOTE / EVENT
            contentHtml = `<div class="text-text-main text-sm whitespace-pre-wrap leading-relaxed">${escapeHtml(item.description)}</div>`;
        }

        // Tags (Inline Pills)
        let tagsHtml = '';
        if (item.tags && item.tags.length > 0) {
            tagsHtml = `<div class="mt-2 flex flex-wrap gap-1.5 pt-1 border-t border-white/5">
                ${item.tags.map(t => `<span class="px-2 py-0.5 rounded-md bg-white/5 border border-white/5 text-[10px] text-text-sub hover:text-primary transition">#${escapeHtml(t.name)}</span>`).join('')}
            </div>`;
        }

        const div = document.createElement('div');
        div.className = "flex gap-2 group relative px-2 transition-all duration-300";
        div.innerHTML = `
            <!-- Left: Time & Indicators -->
            <div class="flex flex-col items-center gap-1 min-w-[44px] pt-1 shrink-0">
                ${item.contact_made ? '<span class="text-[9px] font-bold text-black bg-primary px-1.5 py-0.5 rounded-sm tracking-tighter">接触</span>' : ''}
                <span class="text-[10px] font-mono text-text-sub opacity-50 block">${timeStr}</span>
            </div>
            
            <!-- Right: Content -->
            <div class="flex-1 max-w-full min-w-0">
                <div class="bg-surface border border-white/10 rounded-xl rounded-tl-none p-3 relative hover:bg-white/5 transition hover:border-white/20 shadow-sm">
                     ${contentHtml}
                     ${tagsHtml}
                     
                     <!-- Edit/Action Button (Hidden until hover) -->
                     <button class="edit-link-btn absolute -right-6 top-0 w-6 h-6 flex items-center justify-center text-text-sub opacity-0 group-hover:opacity-100 hover:text-primary transition">
                         <i class="fas fa-ellipsis-v text-xs"></i>
                     </button>
                </div>
            </div>
        `;
        
        div.querySelector('.edit-link-btn').onclick = () => editLog(item);
        return div;
    }

    function escapeHtml(text) {
        if (!text) return '';
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    timelineContainer.addEventListener('scroll', () => {
        if (timelineContainer.scrollTop === 0 && hasMore && !isFetching) fetchTimeline(true);
    });
    // Mobile Scroll




    let searchDebounce;
    if(timelineSearch){
        timelineSearch.addEventListener('input', () => {
            clearTimeout(searchDebounce);
            searchDebounce = setTimeout(() => { resetTimeline(); fetchTimeline(); }, 500);
        });
    }

    // --- Action Functions ---
    // --- Action Functions ---
    function deleteLog(itemId) {
        if (!confirm("ログを削除しますか？この操作は取り消せません。")) return;

        fetch('{% url "intelligence_log" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                action: 'delete',
                item_id: itemId
            })
        }).then(res => res.json()).then(data => {
            if (data.success) {
                // If editing this item, cancel edit
                if (editingItemIdInput.value === itemId) {
                    cancelEditMode();
                }
                resetTimeline();
                fetchTimeline();
                
                // Update NoLog Badge
                if (data.target_id !== undefined && data.has_entry_today !== undefined) {
                     const targetEl = document.querySelector(`.target-item[data-id="${data.target_id}"]`);
                     if (targetEl) {
                         let badge = targetEl.querySelector('.nolog-badge');
                         if (!data.has_entry_today) {
                             if (!badge) {
                                 badge = document.createElement('div');
                                 badge.className = "text-[10px] text-yellow-500/80 flex items-center gap-1 mt-0.5 nolog-badge";
                                 badge.innerHTML = '<i class="fas fa-exclamation-circle text-[9px]"></i> NoLog';
                                 const nameDiv = targetEl.querySelector('.text-\\[10px\\].text-text-sub.truncate');
                                 if (nameDiv) nameDiv.after(badge);
                             } else {
                                 badge.classList.remove('hidden');
                             }
                         } else {
                             if (badge) badge.classList.add('hidden');
                         }
                     }
                }
            } else {
                alert('削除に失敗しました: ' + (data.error || 'Unknown error'));
            }
        }).catch(err => {
            alert('通信エラーが発生しました');
            console.error(err);
        });
    }

    deleteBtn.addEventListener('click', () => {
        if(editingItemIdInput.value) deleteLog(editingItemIdInput.value);
    });

    function editLog(item) {
        // Mode Set
        editingItemIdInput.value = item.id;
        editModeBar.classList.remove('hidden');
        saveBtnText.textContent = "UPDATE";
        saveBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-400');
        saveBtn.classList.remove('bg-primary', 'hover:bg-primary/90');
        deleteBtn.classList.remove('hidden'); // Show Delete Button

        // Populate Data
        occurrenceDateInput.value = item.date;
        contactFlagCheckbox.checked = item.contact_made;

        if (item.type.toUpperCase() === 'QUESTION') {
            tabQuestion.click();
            // Try to set Question Select
            if (item.question_id) {
                // Find question in questionsData
                const q = questionsData.find(q => q.id == item.question_id); // loose equality for string/int
                if (q) {
                    qCategory.value = q.category;
                    qCategory.dispatchEvent(new Event('change'));
                    qSelect.value = q.id;
                    qSelect.dispatchEvent(new Event('change'));
                }
            }
            
            // Handle content and choice
            let rawContent = item.description || '';
            const choiceMatch = rawContent.match(/\[選択:\s*(.*?)\]/);
            
            // Reset choice selection
            selectedChoices.clear();
            document.querySelectorAll('.choice-btn').forEach(b => {
                 b.classList.remove('bg-primary/20', 'border-primary', 'text-primary');
                 b.classList.add('bg-background', 'border-border', 'text-text-sub');
            });

            if (choiceMatch) {
                const prevChoice = choiceMatch[1];
                selectedChoices.add(prevChoice);
                 // Highlight button
                const btn = Array.from(document.querySelectorAll('.choice-btn')).find(b => b.textContent.trim() === prevChoice.trim());
                if(btn) {
                    btn.click(); // simulate click to set styles and state
                }
                // Strip from content
                rawContent = rawContent.replace(choiceMatch[0], '').trim();
            }
            
            document.getElementById('qAnswer').value = rawContent;
        } else {
            tabEvent.click();
            document.getElementById('eventContent').value = item.description || '';
        }
    }

    function cancelEditMode() {
        editingItemIdInput.value = "";
        editModeBar.classList.add('hidden');
        saveBtnText.textContent = "SAVE";
        saveBtn.classList.add('bg-primary', 'hover:bg-primary/90');
        saveBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-400');
        deleteBtn.classList.add('hidden'); // Hide Delete Button

        document.getElementById('eventContent').value = "";
        document.getElementById('qAnswer').value = "";
        contactFlagCheckbox.checked = false;
        // reset date? keep today or last selected
    }

    cancelEditBtn.addEventListener('click', cancelEditMode);

    // --- Tag Click Append ---
    // Top 10
    const tagSelectionArea = document.querySelector('#formEvent #tagSelectionArea'); 
    // Wait, #formEvent is gone. We need to attach this to a new tag area if it exists, or just the Tag Modal.
    // The Input Bar has a "Tag Button" that opens the Tag Modal.
    // We can also have a small "Quick Tags" bar above the input if requested, but user didn't ask.
    // I will remove this block as #formEvent is gone.
    
    function appendTagToActive(tagName) {
        const val = chatInput.value;
        if (val.length > 0 && !val.endsWith(' ')) {
             chatInput.value = val + " #" + tagName + " ";
        } else {
             chatInput.value = val + "#" + tagName + " ";
        }
        chatInput.dispatchEvent(new Event('input')); // updates height/button
    }

    // Tag Modal Logic
    const tagModal = document.getElementById('tagModal');
    const toggleTagMenuBtn = document.getElementById('toggleTagMenuBtn');
    const closeTagModal = document.getElementById('closeTagModal');
    const allTagsContainer = document.getElementById('allTagsContainer');

    if(toggleTagMenuBtn){
        toggleTagMenuBtn.addEventListener('click', () => {
            tagModal.classList.remove('hidden');
            // Fetch
            fetch('{% url "tag_list_api" %}')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        allTagsContainer.innerHTML = '';
                        data.tags.forEach(tag => {
                            const btn = document.createElement('button');
                            btn.className = "px-3 py-1 m-1 rounded-full border border-border text-xs text-text-sub hover:border-primary hover:text-primary transition bg-background";
                            btn.textContent = `${tag.name} (${tag.count})`;
                            btn.onclick = () => {
                                appendTagToActive(tag.name);
                                tagModal.classList.add('hidden');
                            };
                            allTagsContainer.appendChild(btn);
                        });
                    }
                });
        });
    }
    closeTagModal.addEventListener('click', () => tagModal.classList.add('hidden'));

    // Image Upload Logic
    const uploadImageBtn = document.getElementById('uploadImageBtn');
    const imageInput = document.getElementById('imageInput');
    if(uploadImageBtn && imageInput) {
        uploadImageBtn.addEventListener('click', () => imageInput.click());
        imageInput.addEventListener('change', () => {
             if(imageInput.files.length > 0) {
                 // For now, just append text to input as we don't have multipart form handling in this AJAX view yet
                 chatInput.value += ` [画像: ${imageInput.files[0].name}] `;
                 chatInput.dispatchEvent(new Event('input'));
             }
        });
    }

    // --- Save Logic Wrapper ---
    saveLogBtn.addEventListener('click', () => {
        // Determine type
        const isEdit = !!editingItemIdInput.value;
        const type = isEdit ? (editingItemIdInput.dataset.type || 'NOTE') : 'NOTE';
        const qId = isEdit ? editingItemIdInput.dataset.questionId : null;
        
        saveLogItem({
            event_type: type,
            question_id: qId,
            description: chatInput.value,
            contact_made: contactFlagCheckbox.checked
        });
    });

    // --- Unified Save Function ---
    function saveLogItem(payload, onSuccess) {
        if (!currentTargetId) { alert('ターゲットを選択してください'); return; }
        
        const finalPayload = {
            target_id: currentTargetId,
            date: payload.date || document.getElementById('occurrenceDate').value,
            description: payload.description,
            event_type: payload.event_type || 'NOTE',
            question_id: payload.question_id || null,
            contact_made: payload.contact_made || false,
            tags: payload.tags || [],
            action: editingItemIdInput.value ? 'update' : 'create',
            item_id: editingItemIdInput.value
        };
        
        // Simple validation
         if (!finalPayload.description && !finalPayload.question_id && !finalPayload.contact_made) {
             alert('内容を入力してください'); return;
        }

        fetch('{% url "intelligence_log" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(finalPayload)
        }).then(res => res.json()).then(data => {
            if (data.success) {
                cancelEditMode();
                resetTimeline();
                fetchTimeline();
                if(onSuccess) onSuccess();
                
                 // Update NoLog Badge (optional, kept from original)
                 // ... omitted for brevity as it was complex, but let's keep it simple here or assume timeline update is enough.
                 // Actually the original had it. I'll rely on timeline reload.
            } else {
                alert('Error: ' + data.error);
            }
        });
    }

    // --- Chat Input Logic ---
    const chatInput = document.getElementById('chatInput');
    const saveLogBtn = document.getElementById('saveLogBtn');
    
    chatInput.addEventListener('input', function() {
        // Auto resize
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        
        // Toggle Send Button Animation
        if (this.value.trim().length > 0) {
            saveLogBtn.classList.remove('opacity-0', 'pointer-events-none', 'scale-0');
            saveLogBtn.classList.add('opacity-100', 'scale-100');
            saveLogBtn.disabled = false;
        } else {
            saveLogBtn.classList.add('opacity-0', 'pointer-events-none', 'scale-0');
            saveLogBtn.classList.remove('opacity-100', 'scale-100');
            saveLogBtn.disabled = true;
        }
    });

    // --- Answer Modal Logic ---
    const modal = document.getElementById('questionAnswerModal');
    const qStep1 = document.getElementById('qStep1');
    const qStep2 = document.getElementById('qStep2');
    const qStep3 = document.getElementById('qStep3');
    const qCategoryGrid = document.getElementById('qCategoryGrid');
    const qQuestionGrid = document.getElementById('qQuestionGrid');
    
    // Open Modal
    document.getElementById('openAnswerModalBtn').addEventListener('click', () => {
        if (!currentTargetId) { alert('ターゲットを選択してください'); return; }
        modal.classList.remove('hidden');
        showStep1();
    });
    
    function showStep1() {
        qStep1.classList.remove('hidden');
        qStep2.classList.add('hidden');
        qStep3.classList.add('hidden');
        
        // Populate Categories
        const categories = [...new Set(questionsData.map(q => q.category).filter(Boolean))];
        qCategoryGrid.innerHTML = '';
        categories.forEach(cat => {
            const btn = document.createElement('button');
            btn.className = "bg-background border border-border rounded p-3 text-sm text-text-main hover:border-primary hover:text-primary transition font-bold";
            btn.textContent = cat;
            btn.onclick = () => showStep2(cat);
            qCategoryGrid.appendChild(btn);
        });
    }
    
    function showStep2(category) {
        qStep1.classList.add('hidden');
        qStep2.classList.remove('hidden');
        document.getElementById('qSelectedCatName').textContent = category;
        
        // Populate Questions
        qQuestionGrid.innerHTML = '';
        const qs = questionsData.filter(q => q.category === category);
        qs.forEach(q => {
            const btn = document.createElement('button');
            btn.className = "bg-background border border-border rounded p-3 text-xs text-left hover:border-primary group transition flex flex-col gap-1 h-full";
            btn.innerHTML = `<span class="font-bold text-text-main group-hover:text-primary transition-colors">${q.text}</span>`;
            if (q.rank) btn.innerHTML += `<span class="text-[10px] text-text-sub">Rank: ${q.rank}</span>`;
            
            btn.onclick = () => showStep3(q);
            qQuestionGrid.appendChild(btn);
        });
        
        document.getElementById('qBackToCat').onclick = showStep1;
    }
    
    let currentModalQuestion = null;
    function showStep3(question) {
        qStep2.classList.add('hidden');
        qStep3.classList.remove('hidden');
        currentModalQuestion = question;
        
        document.getElementById('qTargetQuestion').textContent = question.text;
        document.getElementById('qTargetIntent').textContent = question.description || 'No intent description';
        document.getElementById('qModalAnswer').value = '';
        document.getElementById('qModalAnswer').focus();
        
        document.getElementById('qBackToQuestions').onclick = () => showStep2(question.category);
    }
    
    // Submit Answer from Modal
    document.getElementById('submitAnswerBtn').addEventListener('click', () => {
        if (!currentModalQuestion) return;
        const ans = document.getElementById('qModalAnswer').value;
        if (!ans.trim()) { alert('回答を入力してください'); return; }
        
        saveLogItem({
            event_type: 'QUESTION',
            question_id: currentModalQuestion.id,
            description: ans,
            date: document.getElementById('occurrenceDate').value
        }, () => {
            modal.classList.add('hidden'); // Close modal on success
        });
    });

    // --- Unified Save Function ---
    function saveLogItem(payload, onSuccess) {
        if (!currentTargetId) { alert('ターゲットを選択してください'); return; }
        
        const finalPayload = {
            target_id: currentTargetId,
            date: payload.date || document.getElementById('occurrenceDate').value,
            description: payload.description,
            event_type: payload.event_type || 'NOTE',
            question_id: payload.question_id || null,
            contact_made: payload.contact_made || false,
            tags: payload.tags || [],
            action: editingItemIdInput.value ? 'update' : 'create',
            item_id: editingItemIdInput.value
        };
        
        // Check content
        if (!finalPayload.description && !finalPayload.question_id && !finalPayload.contact_made) {
             alert('内容を入力してください'); return;
        }

        fetch('{% url "intelligence_log" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(finalPayload)
        }).then(res => res.json()).then(data => {
            if (data.success) {
                if (data.action === 'create') {
                     // Clear inputs
                     chatInput.value = '';
                     chatInput.style.height = 'auto';
                     saveLogBtn.classList.add('opacity-50', 'pointer-events-none');
                     contactFlagCheckbox.checked = false;
                     document.getElementById('contactFlagBtn').classList.remove('text-primary', 'border-primary', 'bg-primary/10');
                } else {
                    cancelEditMode();
                }
                
                resetTimeline();
                fetchTimeline();
                if(onSuccess) onSuccess();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }

    // Edit Log Wrapper
    window.editLog = function(item) {
        editingItemIdInput.value = item.id;
        editingItemIdInput.dataset.type = item.type || 'NOTE';
        editingItemIdInput.dataset.questionId = item.question_id || '';
        
        chatInput.value = item.description || '';
        
        if (item.type === 'QUESTION') {
            chatInput.placeholder = "回答を編集 (" + (item.question_title || "Question") + ")...";
        } else {
            chatInput.placeholder = "内容を編集...";
            contactFlagCheckbox.checked = item.contact_made;
             // Update contact button style
            const btn = document.getElementById('contactFlagBtn');
            if(item.contact_made) {
                 btn.classList.add('text-primary', 'border-primary', 'bg-primary/10');
            } else {
                 btn.classList.remove('text-primary', 'border-primary', 'bg-primary/10');
            }
        }

        chatInput.focus();
        // Show Send Button
        saveLogBtn.classList.remove('opacity-0', 'pointer-events-none', 'scale-0');
        saveLogBtn.classList.add('opacity-100', 'scale-100', 'bg-yellow-500'); 
        saveLogBtn.classList.remove('bg-primary');
        saveLogBtn.disabled = false;
        
        chatInput.style.height = 'auto';
        chatInput.style.height = (chatInput.scrollHeight) + 'px';
    };

    window.cancelEditMode = function() {
        editingItemIdInput.value = '';
        delete editingItemIdInput.dataset.type;
        delete editingItemIdInput.dataset.questionId;
        
        chatInput.value = '';
        chatInput.placeholder = "メッセージを入力...";
        
        saveLogBtn.classList.add('opacity-0', 'pointer-events-none', 'scale-0');
        saveLogBtn.classList.remove('opacity-100', 'scale-100', 'bg-yellow-500');
        saveLogBtn.classList.add('bg-primary');
        
        contactFlagCheckbox.checked = false;
        const btn = document.getElementById('contactFlagBtn');
        btn.classList.remove('text-primary', 'border-primary', 'bg-primary/10');
        chatInput.style.height = 'auto';
    };
    
    // Auto-Select Logic (Simplified)
    const urlParams = new URLSearchParams(window.location.search);
    const preTargetId = urlParams.get('target_id');
    if (preTargetId) {
        const targetBtn = document.querySelector(`.target-item[data-id="${preTargetId}"]`);
        if (targetBtn) {
            targetBtn.click();
            targetBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
    
    cancelEditBtn.addEventListener('click', cancelEditMode);

}); // End DOMContentLoaded
</script>
{% endblock %}