{% extends 'base.html' %}
{% load static %}
{% block content_wrapper_class %}flex-1 flex flex-col min-h-0 overflow-hidden bg-background{% endblock %}

{% block content %}
<!-- Unified Responsive Layout -->
<div class="flex flex-1 min-h-0 relative" id="splitPaneContainer">
    <!-- Left Panel: Target Selector -->
    <div id="leftPanel" class="flex flex-col w-full md:w-[30%] h-full min-w-[250px] max-w-[50vw] bg-surface relative z-0">
        <!-- Unified Compact Header: Date & Actions -->
        <div class="p-2 border-b border-white/10 flex items-center gap-2 shrink-0 bg-surface z-20">
            <!-- Date (Small) -->
            <!-- Date (Small) -->
            <form method="get" id="dateForm" class="mb-0 flex-1 min-w-0 flex items-center gap-2">
                <label for="occurrenceDateInput" class="text-[10px] text-text-sub font-mono shrink-0">発生日</label>
                <input type="date" id="occurrenceDateInput" name="date" value="{{ today_date }}"
                    class="w-full bg-background border border-white/10 rounded px-2 py-1 text-[10px] md:text-xs text-text-sub focus:border-primary transition h-8"
                    onchange="this.form.submit()">
            </form>
            
            <!-- Actions (Compact) -->
            <button id="openTargetSearch" class="h-8 px-3 bg-primary/10 hover:bg-primary/20 text-primary border border-primary/30 rounded text-[10px] font-mono transition flex items-center justify-center gap-1">
                <i class="fas fa-plus"></i> ADD
            </button>
            <button id="removeUnfilledBtn" class="h-8 px-3 bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/30 rounded text-[10px] font-mono transition flex items-center justify-center gap-1">
                <i class="fas fa-trash-alt"></i>
            </button>
        </div>

        <!-- Target List Header (Simplified) -->
        <div class="px-3 py-1 bg-surface/50 border-b border-white/5 shrink-0 flex justify-between items-center">
            <h2 class="text-text-sub font-mono text-[10px] tracking-wider">TARGET SELECT</h2>
            <span class="text-[10px] text-text-sub opacity-50">{{ todays_targets|length }}</span>
        </div>

        <!-- Target List (No Extra Padding) -->
        <div class="flex-1 overflow-y-auto p-0" id="targetList">
            {% if todays_targets %}
            <!-- Manual Add Section -->
            {% if any_manual %}
            <div class="px-3 py-1 bg-primary/5 border-y border-white/5 shrink-0">
                <span class="text-[9px] text-primary font-bold tracking-tighter">MANUAL ADD</span>
            </div>
            {% endif %}
            
            {% for item in todays_targets %}
            {% if item.is_manual %}
            <div class="target-item p-3 border-b border-white/5 flex items-center gap-3 cursor-pointer hover:bg-white/5 transition group relative select-target-btn"
                data-id="{{ item.obj.id }}" data-name="{{ item.obj.nickname }}"
                data-avatar="{% if item.obj.avatar %}{{ item.obj.avatar.url }}{% endif %}">
                {% include 'intelligence_target_item_partial.html' %}
            </div>
            {% endif %}
            {% endfor %}

            <!-- System Section (Groups & Anniv) -->
            {% if any_system %}
            <div class="px-3 py-1 bg-white/5 border-y border-white/5 shrink-0 mt-2">
                <span class="text-[9px] text-text-sub font-bold tracking-tighter">SCHEDULED</span>
            </div>
            {% endif %}

            {% for item in todays_targets %}
            {% if not item.is_manual %}
            <div class="target-item p-3 border-b border-white/5 flex items-center gap-3 cursor-pointer hover:bg-white/5 transition group relative select-target-btn"
                data-id="{{ item.obj.id }}" data-name="{{ item.obj.nickname }}"
                data-avatar="{% if item.obj.avatar %}{{ item.obj.avatar.url }}{% endif %}">
                {% include 'intelligence_target_item_partial.html' %}
            </div>
            {% endif %}
            {% endfor %}

            {% else %}
            <div class="text-center text-text-sub text-xs py-10 opacity-50">
                NO TARGETS
            </div>
            {% endif %}
        </div>
        
        <!-- Hidden forms for JS compatibility -->
        <form style="display:none">{% csrf_token %}</form>
    </div>

    <!-- Resizer Handle (Desktop Only) -->
    <div id="resizer" class="hidden md:flex w-2 hover:w-2 bg-transparent hover:bg-primary/30 cursor-col-resize z-40 items-center justify-center group flex-shrink-0 transition-all active:bg-primary/50">
        <div class="w-0.5 h-8 bg-border group-hover:bg-primary rounded transition-colors pointer-events-none"></div>
    </div>

    <!-- Right Panel: Dossier Chat-style Input -->
    <div id="rightPanel"
        class="hidden md:flex flex-col flex-1 bg-surface overflow-hidden min-h-0 relative h-full">
        <!-- Overlay for No Selection -->
        <div id="noSelectionOverlay"
            class="absolute inset-0 z-50 bg-background/80 backdrop-blur-sm flex flex-col items-center justify-center text-text-sub">
            <div class="text-4xl mb-4 opacity-50">⚡</div>
            <div class="font-mono text-sm">SELECT TARGET FROM LEFT PANEL</div>
        </div>

        <!-- 1. HEADER: Chat Header -->
        <div class="h-14 px-4 border-b border-white/10 bg-surface flex justify-between items-center shrink-0 z-10 shadow-md">
            <!-- Left: Back & Target Name (No Avatar) -->
            <div class="flex items-center gap-3 min-w-0">
                <!-- Back Button (Mobile) -->
                <button id="mobileBackBtn" class="md:hidden w-8 h-8 flex items-center justify-center rounded-full active:bg-white/10 text-white transition shrink-0">
                    <i class="fas fa-chevron-left"></i>
                </button>
                
                <h2 class="text-text-main font-bold text-sm truncate max-w-[120px]" id="selectedName">--</h2>
            </div>

            <!-- Right: Tools -->
            <div class="flex items-center gap-1">
                 <!-- 1. Occurrence Date (Calendar Icon) -->
                 <div class="relative">
                     <input type="date" id="occurrenceDate" value="{{ today_date }}"
                         class="absolute inset-0 opacity-0 cursor-pointer z-20 w-8 h-8">
                     <button class="w-8 h-8 flex items-center justify-center text-text-sub hover:text-primary transition rounded-full hover:bg-white/5" title="発生日">
                         <i class="far fa-calendar-alt text-lg"></i>
                     </button>
                </div>

                <!-- 2. Search Popover -->
                <div class="relative group flex items-center">
                     <button id="toggleSearchBtn" class="w-8 h-8 flex items-center justify-center text-text-sub hover:text-primary transition rounded-full hover:bg-white/5 z-20">
                         <i class="fas fa-search text-lg"></i>
                     </button>
                     
                     <!-- Popover Input (Hidden by default) -->
                     <div id="searchPopover" class="hidden absolute top-10 right-0 w-48 bg-surface border border-white/10 rounded-lg p-2 shadow-xl z-30">
                        <input type="text" id="timelineSearch" placeholder="検索..."
                             class="w-full bg-background border border-primary/30 text-xs px-2 py-1.5 rounded focus:border-primary focus:outline-none text-text-main">
                     </div>
                </div>

                <!-- 3. Answer Button (Question Mark) -->
                <button id="openAnswerModalBtn" class="w-8 h-8 flex items-center justify-center text-text-sub hover:text-primary transition rounded-full hover:bg-white/5" title="質問に回答">
                    <i class="fas fa-question text-lg"></i>
                </button>
            </div>
        </div>

        <!-- Style to Hide Mobile Bottom Nav when this view is active (Chat View) -->
        <!-- Style to Hide Mobile Bottom Nav when this view is active (Chat View) -->
        <!-- Logic moved to JS for dynamic visibility -->

        <!-- 2. TIMELINE: Infinite Scroll Area -->
        <div id="timelineContainer" class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth bg-surface/50">
            <div id="timelineLoading" class="hidden text-center py-2 text-text-sub text-xs">
                <i class="fas fa-spinner fa-spin"></i> Loading context...
            </div>
            <div id="timelineContent" class="space-y-4 flex flex-col justify-end min-h-0"></div>
        </div>

        <!-- 3. INPUT AREA: Fixed Bottom (Chat Style) -->
        <div class="shrink-0 bg-surface border-t border-white/10 p-2 pb-safe z-20" id="chatInputBar">
             <div class="flex items-center gap-2 max-w-3xl mx-auto">
                <!-- Left Icons Group -->
                <div class="flex items-center gap-1 shrink-0">
                    <!-- 1. Image Upload -->
                    <button class="w-9 h-9 flex items-center justify-center text-text-sub hover:text-primary transition rounded-full hover:bg-white/5" id="uploadImageBtn" title="画像">
                        <i class="far fa-image text-lg"></i>
                    </button>
                    
                    <!-- 2. Contact Flag -->
                    <button class="w-9 h-9 flex items-center justify-center text-text-sub hover:text-primary transition rounded-full hover:bg-white/5" id="contactFlagBtn" title="接触">
                        <i class="fas fa-handshake text-lg"></i>
                    </button>
                    
                    <!-- 3. Tag Selection -->
                    <button class="w-9 h-9 flex items-center justify-center text-text-sub hover:text-primary transition rounded-full hover:bg-white/5" id="toggleTagMenuBtn" title="タグ">
                         <i class="fas fa-hashtag text-lg"></i>
                    </button>
                </div>

                <!-- Center: Text Input -->
                <textarea id="chatInput" rows="1" placeholder="メッセージを入力..." 
                    class="flex-1 bg-background border border-white/10 text-text-main text-sm rounded-full px-4 py-2 focus:ring-1 focus:ring-primary focus:border-primary resize-none overflow-hidden hover:border-white/20 transition leading-5 max-h-32"></textarea>
                
                <!-- Right: Action Button (Toggle) -->
                <div class="shrink-0 w-10 h-10 flex items-center justify-center relative">
                    <!-- A. Detail Link (Default) -->
                     <button id="targetDetailBtn" class="absolute inset-0 flex items-center justify-center text-text-sub hover:text-white transition rounded-full hover:bg-white/5">
                        <i class="fas fa-ellipsis-h text-lg"></i>
                    </button>
                    
                    <!-- B. Send Button (When Typing) -->
                    <button id="saveLogBtn" class="absolute inset-0 flex items-center justify-center bg-primary text-black rounded-full shadow-lg hover:bg-primary/90 transition transform scale-0 opacity-0 pointer-events-none duration-200" disabled>
                        <i class="fas fa-paper-plane text-sm"></i>
                    </button>
                </div>

                <!-- Hidden inputs -->
                <input type="checkbox" id="contactFlag" class="hidden">
                <input type="file" id="imageInput" class="hidden" accept="image/*">
            </div>
        </div>
    </div>
</div>

{% include "intelligence_log_answer_modal.html" %}




<!-- Search Modal -->
<div id="searchModal"
    class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-surface border border-border rounded-xl p-6 w-full max-w-md shadow-2xl h-[500px] flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-mono text-text-main">ターゲット検索</h3>
            <button id="closeSearch" class="text-text-sub hover:text-text-main">✕</button>
        </div>
        <input type="text" id="searchInput" placeholder="Search by name..."
            class="w-full bg-background border border-border rounded px-3 py-2 text-sm text-text-main mb-4 focus:border-primary">
        <div class="flex-1 overflow-y-auto space-y-2 pr-1" id="searchList">
            {% for t in all_targets %}
            <div class="search-item p-2 rounded border border-border hover:bg-text-main/5 cursor-pointer flex items-center gap-3"
                data-id="{{ t.id }}" data-name="{{ t.nickname }}"
                data-avatar="{% if t.avatar %}{{ t.avatar.url }}{% endif %}">
                <div
                    class="w-8 h-8 rounded bg-background border border-border flex items-center justify-center text-[10px] text-text-sub overflow-hidden">
                    {% if t.avatar %}<img src="{{ t.avatar.url }}" class="w-full h-full object-cover">{% else %}{{
                    t.nickname|slice:":1" }}{% endif %}
                </div>
                <div class="text-sm text-text-main font-mono">{{ t.nickname }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Tag Modal -->
{% include "intelligence_log_tag_modal.html" %}

<script id="questionsData" type="application/json">
[
    {% for q in questions %}
    {
        "id": "{{ q.id }}", 
        "category": "{{ q.category|default:'' }}", 
        "text": "{{ q.title }}",
        "description": "{{ q.description|escapejs }}",
        "example": "{{ q.example|escapejs }}",
        "answer_type": "{{ q.answer_type }}",
        "choices": "{{ q.choices|escapejs }}",
        "rank": {% if q.rank %}"{{ q.rank.name }} ({{ q.rank.points }}pt)"{% else %}null{% endif %}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
]
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {


    // --- State ---
    let currentTargetId = null;
    let questionsData = JSON.parse(document.getElementById('questionsData').textContent);

    // --- UI Elements ---
    const targetList = document.getElementById('targetList');
    const overlay = document.getElementById('noSelectionOverlay');
    const selectedName = document.getElementById('selectedName');
    const selectedAvatar = document.getElementById('selectedAvatar');
    // Tabs removed
    // Forms removed
    const qCategory = document.getElementById('qCategory');
    const qSelect = document.getElementById('qSelect');
    const saveBtn = document.getElementById('saveLogBtn');
    const saveBtnText = document.getElementById('saveBtnText');
    const occurrenceDateInput = document.getElementById('occurrenceDate');
    const contactFlagCheckbox = document.getElementById('contactFlag');
    const editingItemIdInput = document.getElementById('editingItemId');
    const editModeBar = document.getElementById('editModeBar');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const deleteBtn = document.getElementById('deleteLogBtn');

    // Encanto Filter
    const encantoFilterBtn = document.getElementById('encantoFilterBtn');
    let isEncantoFilterActive = false;

    // --- Timeline State ---
    const timelineContainer = document.getElementById('timelineContainer');
    const timelineContent = document.getElementById('timelineContent');
    const timelineLoading = document.getElementById('timelineLoading');
    const timelineSearch = document.getElementById('timelineSearch');
    const timelineTypeFilter = document.getElementById('timelineTypeFilter');

    // Panels
    const leftPanel = document.getElementById('leftPanel');
    const rightPanel = document.getElementById('rightPanel');
    const mobileBackBtn = document.getElementById('mobileBackBtn');

    let isFetching = false;
    let hasMore = true;
    let timelineCursorDate = null;

    // (Legacy Panel Logic removed)

    // --- Resizer Logic ---
    const resizer = document.getElementById('resizer');
    const splitPaneContainer = document.getElementById('splitPaneContainer');

    if (resizer) {
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
            document.body.classList.add('select-none'); // Prevent selection during drag
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const containerRect = splitPaneContainer.getBoundingClientRect();
            // Calculate width in percent
            let newWidthInfo = ((e.clientX - containerRect.left) / containerRect.width) * 100;
            
            // Constrain
            if (newWidthInfo < 20) newWidthInfo = 20;
            if (newWidthInfo > 60) newWidthInfo = 60; // Max 60%

            leftPanel.style.width = `${newWidthInfo}%`;
        });

        document.addEventListener('mouseup', () => {
             if(isResizing) {
                isResizing = false;
                document.body.style.cursor = '';
                document.body.classList.remove('select-none');
            }
        });
    }

    // --- Target Selection ---
    targetList.addEventListener('click', function (e) {
        const removeBtn = e.target.closest('.remove-target-btn');
        if (removeBtn) {
            e.stopPropagation();
            const id = removeBtn.dataset.id;
            const date = document.querySelector('input[name="date"]').value;
            if (confirm('このターゲットを本日のリストから除外しますか？')) {
                toggleTargetState(id, date, 'hide', () => location.reload());
            }
            return;
        }

        const item = e.target.closest('.target-item');
        if (item) {
            document.querySelectorAll('.target-item').forEach(el => {
                el.classList.remove('bg-text-main/10', 'border-primary');
                el.querySelector('.status-indicator').classList.remove('bg-primary', 'shadow-[0_0_8px_rgba(34,197,94,0.8)]');
                el.querySelector('.status-indicator').classList.add('bg-text-sub/50');
            });
            item.classList.add('bg-text-main/10', 'border-primary');
            item.querySelector('.status-indicator').classList.remove('bg-text-sub/50');
            item.querySelector('.status-indicator').classList.add('bg-primary', 'shadow-[0_0_8px_rgba(34,197,94,0.8)]');

            currentTargetId = item.dataset.id;
            selectedName.textContent = item.dataset.name;
            const avatarUrl = item.dataset.avatar;
            if (selectedAvatar) {
                 if (avatarUrl) {
                     selectedAvatar.innerHTML = `<img src="${avatarUrl}" class="w-full h-full object-cover">`;
                 } else {
                     selectedAvatar.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-700 text-text-sub font-mono text-xs">${item.dataset.name.slice(0,1)}</div>`;
                 }
            }

            // Show Chat View (Mobile)
            showChatView();
            
            // Mobile: Hide Bottom Nav
            if (window.innerWidth < 768 && mobileBottomNav) {
                mobileBottomNav.classList.add('hidden');
            }

            // Reset Timeline
            noSelectionOverlay.classList.add('hidden');
            resetTimeline();
            fetchTimeline();
            
            // Enable Inputs
            document.getElementById('saveLogBtn').disabled = true; // Wait for input
            document.getElementById('chatInput').disabled = false;
        }
    });


    // --- Timeline Functions ---
    function resetTimeline() {
        timelineContent.innerHTML = '';
        console.log("Clearing timeline");
        timelineCursorDate = null;
        hasMore = true;
    }

    function fetchTimeline(append = false) {
        if (!currentTargetId || isFetching || (!hasMore && append)) return;

        isFetching = true;
        if (append) timelineLoading.classList.remove('hidden');

        const params = new URLSearchParams({ target_id: currentTargetId, limit: 20 });
        if (append && timelineCursorDate) params.append('before_date', timelineCursorDate);
        if (timelineSearch.value) params.append('search', timelineSearch.value);
        if (timelineTypeFilter && timelineTypeFilter.value) params.append('type', timelineTypeFilter.value);
        if (isEncantoFilterActive) params.append('contact_only', 'true');

        fetch(`{% url "timeline_list" %}?${params.toString()}`)
            .then(res => res.json())
            .then(data => {
                isFetching = false;
                timelineLoading.classList.add('hidden');

                if (data.success) {
                    if (data.data.length < 20) hasMore = false;
                    if (data.data.length > 0) {
                        timelineCursorDate = data.data[data.data.length - 1].date;
                        renderTimelineItems(data.data, append);
                    }
                }
            })
            .catch(err => {
                isFetching = false;
                console.error(err);
            });
    }

    function renderTimelineItems(items, append) {
        // items are Newest -> Oldest
        // We want to display Oldest -> Newest (Chat order)
        const orderedItems = [...items].reverse();

        const fragment = document.createDocumentFragment();
        
        orderedItems.forEach((item, index) => {
            // Date Separator Logic
            // Check if date changed from previous item (or if it's the first item)
            let showDate = false;
            if (index === 0) {
                // For the very first item (oldest), always show date unless we are appending to existing list
                // If appending (scrolling up), we need to check against the bottom of the *previous* batch (which is visually below).
                // Actually, renderTimelineItems is usually called with a batch.
                // If not appending (fresh load), show date for first.
                if (!append) showDate = true;
                // If appending, we effectively prepend. The "last" date of this batch might match the "first" date of the existing DOM.
                // This logic is tricky with reverse scrolling. 
                // Simplified: Just always show date separator if it differs from the previous item *in this list*.
                showDate = true; 
            } else {
                const prevItem = orderedItems[index - 1];
                if (item.date !== prevItem.date) showDate = true;
            }
            
            // Check global lastDate reference if needed, but for chat view, local comparison is usually enough
            // provided we handle the connection points.
            // Let's stick to local comparison for now.
            
            if (showDate) {
                const sep = document.createElement('div');
                sep.className = "flex items-center justify-center my-6 opacity-70";
                sep.innerHTML = `<div class="bg-surface/50 border border-white/5 rounded-full px-4 py-1 text-[11px] text-text-sub font-mono tracking-widest backdrop-blur-sm shadow-sm">${item.date.replace(/-/g, '/')}</div>`;
                fragment.appendChild(sep);
            }
            fragment.appendChild(createTimelineElement(item));
        });

        if (append) {
            // Prepend functionality (History)
            const firstChild = timelineContent.firstElementChild;
            const oldHeight = timelineContainer.scrollHeight;
            timelineContent.insertBefore(fragment, firstChild);
            timelineContainer.scrollTop = timelineContainer.scrollHeight - oldHeight;
        } else {
            // Standard load (Newest at bottom)
            timelineContent.appendChild(fragment);
            timelineContainer.scrollTop = timelineContainer.scrollHeight;
        }
    }

    function createTimelineElement(item) {
        // Time Formatting (HH:MM)
        let timeStr = '--:--';
        if (item.created_at) {
             const parts = item.created_at.split(' ');
             if (parts.length > 1) {
                 timeStr = parts[1].slice(0, 5); // HH:MM
             } else if (item.created_at.includes('T')) {
                 timeStr = item.created_at.split('T')[1].slice(0, 5);
             } else {
                 timeStr = item.created_at.slice(-5);
             }
        }

        let contentHtml = '';
        
        // Content Processing
        if (item.type === 'QUESTION') {
            const qTitle = item.question_title || '質問';
            let ans = item.description || '';
            let choiceVal = null;
            const choiceMatch = ans.match(/\[選択:\s*(.*?)\]/);
            if (choiceMatch) {
                choiceVal = choiceMatch[1];
                ans = ans.replace(choiceMatch[0], '').trim();
            }
            
            contentHtml = `
                <div class="text-[11px] font-bold text-primary mb-1 opacity-80 pl-1">${escapeHtml(qTitle)}</div>
                <div class="text-text-main text-sm whitespace-pre-wrap leading-relaxed">${escapeHtml(ans)}</div>
            `;
            if (choiceVal) {
                contentHtml += `<div class="mt-2"><span class="inline-block px-3 py-1 rounded-full border border-primary/30 text-primary text-xs bg-primary/5">${escapeHtml(choiceVal)}</span></div>`;
            }
        } else {
            // NOTE / EVENT
            contentHtml = `<div class="text-text-main text-sm whitespace-pre-wrap leading-relaxed">${escapeHtml(item.description)}</div>`;
        }

        // Tags (Inline Pills)
        let tagsHtml = '';
        if (item.tags && item.tags.length > 0) {
            tagsHtml = `<div class="mt-2 flex flex-wrap gap-1.5 pt-1 border-t border-white/5">
                ${item.tags.map(t => `<span class="px-2 py-0.5 rounded-md bg-white/5 border border-white/5 text-[10px] text-text-sub hover:text-primary transition">#${escapeHtml(t.name)}</span>`).join('')}
            </div>`;
        }

        const div = document.createElement('div');
        div.className = "flex gap-2 group relative px-2 transition-all duration-300";
        div.innerHTML = `
            <!-- Left: Time & Indicators -->
            <div class="flex flex-col items-center gap-1 min-w-[44px] pt-1 shrink-0">
                ${item.contact_made ? '<span class="text-[9px] font-bold text-black bg-primary px-1.5 py-0.5 rounded-sm tracking-tighter">接触</span>' : ''}
                <span class="text-[10px] font-mono text-text-sub opacity-50 block">${timeStr}</span>
            </div>
            
            <!-- Right: Content -->
            <div class="flex-1 max-w-full min-w-0">
                <div class="bg-surface border border-white/10 rounded-xl rounded-tl-none p-3 relative hover:bg-white/5 transition hover:border-white/20 shadow-sm">
                     ${contentHtml}
                     ${tagsHtml}
                     
                     <!-- Edit/Action Button (Hidden until hover) -->
                     <button class="edit-link-btn absolute -right-6 top-0 w-6 h-6 flex items-center justify-center text-text-sub opacity-0 group-hover:opacity-100 hover:text-primary transition">
                         <i class="fas fa-ellipsis-v text-xs"></i>
                     </button>
                </div>
            </div>
        `;
        
        div.querySelector('.edit-link-btn').onclick = () => editLog(item);
        return div;
    }

    function escapeHtml(text) {
        if (!text) return '';
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    timelineContainer.addEventListener('scroll', () => {
        if (timelineContainer.scrollTop === 0 && hasMore && !isFetching) fetchTimeline(true);
    });
    // Mobile Scroll




    let searchDebounce;
    if(timelineSearch){
        timelineSearch.addEventListener('input', () => {
            clearTimeout(searchDebounce);
            searchDebounce = setTimeout(() => { resetTimeline(); fetchTimeline(); }, 500);
        });
    }

    // Toggle Search Popover
    const toggleSearchBtn = document.getElementById('toggleSearchBtn');
    const searchPopover = document.getElementById('searchPopover');
    if(toggleSearchBtn && searchPopover) {
        toggleSearchBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            searchPopover.classList.toggle('hidden');
            if(!searchPopover.classList.contains('hidden')) {
                timelineSearch.focus();
            }
        });
        
        // Close on click outside
        document.addEventListener('click', (e) => {
             if(!searchPopover.classList.contains('hidden') && !searchPopover.contains(e.target) && !toggleSearchBtn.contains(e.target)) {
                 searchPopover.classList.add('hidden');
             }
        });
    }

    // --- Action Functions ---
    // --- Action Functions ---
    function deleteLog(itemId) {
        if (!confirm("ログを削除しますか？この操作は取り消せません。")) return;

        fetch('{% url "intelligence_log" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                action: 'delete',
                item_id: itemId
            })
        }).then(res => res.json()).then(data => {
            if (data.success) {
                // If editing this item, cancel edit
                if (editingItemIdInput.value === itemId) {
                    cancelEditMode();
                }
                resetTimeline();
                fetchTimeline();
                
                // Update NoLog Badge
                if (data.target_id !== undefined && data.has_entry_today !== undefined) {
                     const targetEl = document.querySelector(`.target-item[data-id="${data.target_id}"]`);
                     if (targetEl) {
                         let badge = targetEl.querySelector('.nolog-badge');
                         if (!data.has_entry_today) {
                             if (!badge) {
                                 badge = document.createElement('div');
                                 badge.className = "text-[10px] text-yellow-500/80 flex items-center gap-1 mt-0.5 nolog-badge";
                                 badge.innerHTML = '<i class="fas fa-exclamation-circle text-[9px]"></i> NoLog';
                                 const nameDiv = targetEl.querySelector('.text-\\[10px\\].text-text-sub.truncate');
                                 if (nameDiv) nameDiv.after(badge);
                             } else {
                                 badge.classList.remove('hidden');
                             }
                         } else {
                             if (badge) badge.classList.add('hidden');
                         }
                     }
                }
            } else {
                alert('削除に失敗しました: ' + (data.error || 'Unknown error'));
            }
        }).catch(err => {
            alert('通信エラーが発生しました');
            console.error(err);
        });
    }

    deleteBtn.addEventListener('click', () => {
        if(editingItemIdInput.value) deleteLog(editingItemIdInput.value);
    });

    // --- Dynamic Mobile Nav Logic ---
    const mobileBottomNav = document.querySelector('nav.fixed.bottom-0'); 
    
    function toggleMobileNav(show) {
        if (!mobileBottomNav) return;
        if (show) {
             mobileBottomNav.classList.remove('hidden');
        } else {
             mobileBottomNav.classList.add('hidden');
        }
    }

    // --- Window Functions (Edit/Cancel) ---
    window.editLog = function(item) {
        editingItemIdInput.value = item.id;
        editingItemIdInput.dataset.type = item.type || 'NOTE';
        editingItemIdInput.dataset.questionId = item.question_id || '';
        
        chatInput.value = item.description || '';
        
        if (item.type === 'QUESTION') {
            chatInput.placeholder = "回答を編集 (" + (item.question_title || "Question") + ")...";
        } else {
            chatInput.placeholder = "内容を編集...";
            contactFlagCheckbox.checked = item.contact_made;
             // Update contact button style
            const btn = document.getElementById('contactFlagBtn');
            if(item.contact_made) {
                 btn.classList.add('text-primary', 'border-primary', 'bg-primary/10');
            } else {
                 btn.classList.remove('text-primary', 'border-transparent', 'bg-primary/10');
                 btn.classList.add('border-transparent');
            }
        }

        chatInput.focus();
        // Force update input state
        chatInput.dispatchEvent(new Event('input'));
        
        // Update Save Button Appearance for Edit
        saveLogBtn.classList.remove('bg-primary');
        saveLogBtn.classList.add('bg-yellow-500');
    };

    window.cancelEditMode = function() {
        editingItemIdInput.value = '';
        delete editingItemIdInput.dataset.type;
        delete editingItemIdInput.dataset.questionId;
        
        chatInput.value = '';
        chatInput.placeholder = "メッセージを入力...";
        
        saveLogBtn.classList.remove('bg-yellow-500');
        saveLogBtn.classList.add('bg-primary');
        
        contactFlagCheckbox.checked = false;
        const btn = document.getElementById('contactFlagBtn');
        btn.classList.remove('text-primary', 'border-primary', 'bg-primary/10');
        btn.classList.add('border-transparent');
        
        chatInput.style.height = 'auto';
        chatInput.dispatchEvent(new Event('input')); // Reset button state
    };
    
    cancelEditBtn.addEventListener('click', cancelEditMode);

    // --- Navigation Logic ---
    if(mobileBackBtn) {
        mobileBackBtn.addEventListener('click', () => {
             document.getElementById('leftPanel').classList.remove('hidden');
             document.getElementById('rightPanel').classList.add('hidden');
             document.getElementById('rightPanel').classList.remove('flex');
             toggleMobileNav(true);
             currentTargetId = null;
             history.pushState(null, '', location.pathname);
        });
    }

    document.querySelectorAll('.target-item').forEach(btn => {
        btn.addEventListener('click', function() {
             toggleMobileNav(false);
        });
    });
    
    // Initial Nav State
    const urlParams = new URLSearchParams(window.location.search);
    const preTargetId = urlParams.get('target_id');
    if (preTargetId) {
        const targetBtn = document.querySelector(`.target-item[data-id="${preTargetId}"]`);
        if (targetBtn) {
            targetBtn.click();
            targetBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        if(window.innerWidth < 768) toggleMobileNav(false);
    } else {
         toggleMobileNav(true);
    }

    // --- Input & Action Logic ---
    const chatInput = document.getElementById('chatInput');
    const saveLogBtn = document.getElementById('saveLogBtn');
    const targetDetailBtn = document.getElementById('targetDetailBtn');

    // Detail Button
    if(targetDetailBtn) {
        targetDetailBtn.addEventListener('click', () => {
             if(currentTargetId) {
                 window.location.href = `/targets/${currentTargetId}/`;
             }
        });
    }

    // Chat Input Listener
    if(chatInput && saveLogBtn) {
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            
            const hasText = this.value.trim().length > 0;
            
            if (hasText) {
                // Show Send (Plane), Hide Detail (...)
                saveLogBtn.classList.remove('opacity-0', 'pointer-events-none', 'scale-0');
                saveLogBtn.classList.add('opacity-100', 'scale-100');
                saveLogBtn.disabled = false;
                
                if(targetDetailBtn) targetDetailBtn.classList.add('opacity-0', 'scale-0');
            } else {
                // Hide Send, Show Detail
                saveLogBtn.classList.add('opacity-0', 'pointer-events-none', 'scale-0');
                saveLogBtn.classList.remove('opacity-100', 'scale-100');
                saveLogBtn.disabled = true;
                
                if(targetDetailBtn) targetDetailBtn.classList.remove('opacity-0', 'scale-0');
            }
        });
    }

    // Image Upload Logic
    const uploadImageBtn = document.getElementById('uploadImageBtn');
    const imageInput = document.getElementById('imageInput');
    if(uploadImageBtn && imageInput) {
        uploadImageBtn.addEventListener('click', () => imageInput.click());
        imageInput.addEventListener('change', () => {
             if(imageInput.files.length > 0) {
                 chatInput.value += ` [画像: ${imageInput.files[0].name}] `;
                 chatInput.dispatchEvent(new Event('input'));
             }
        });
    }

    // Tag Modal Logic
    const tagModal = document.getElementById('tagModal');
    const toggleTagMenuBtn = document.getElementById('toggleTagMenuBtn');
    const closeTagModal = document.getElementById('closeTagModal');
    const allTagsContainer = document.getElementById('allTagsContainer');

    function appendTagToActive(tagName) {
        const val = chatInput.value;
        if (val.length > 0 && !val.endsWith(' ')) {
             chatInput.value = val + " #" + tagName + " ";
        } else {
             chatInput.value = val + "#" + tagName + " ";
        }
        chatInput.dispatchEvent(new Event('input'));
    }

    if(toggleTagMenuBtn){
        toggleTagMenuBtn.addEventListener('click', () => {
            tagModal.classList.remove('hidden');
            fetch('{% url "tag_list_api" %}')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        allTagsContainer.innerHTML = '';
                        data.tags.forEach(tag => {
                            const btn = document.createElement('button');
                            btn.className = "px-3 py-1 m-1 rounded-full border border-border text-xs text-text-sub hover:border-primary hover:text-primary transition bg-background";
                            btn.textContent = `${tag.name} (${tag.count})`;
                            btn.onclick = () => {
                                appendTagToActive(tag.name);
                                tagModal.classList.add('hidden');
                            };
                            allTagsContainer.appendChild(btn);
                        });
                    }
                });
        });
    }
    closeTagModal.addEventListener('click', () => tagModal.classList.add('hidden'));


    // --- Event Listeners ---
    saveLogBtn.addEventListener('click', () => {
        saveLogItem({
            description: chatInput.value,
            contact_made: contactFlagCheckbox.checked
        });
    });

    // --- Unified Save Function ---
    function saveLogItem(payload, onSuccess) {
        if (!currentTargetId) { alert('ターゲットを選択してください'); return; }
        
        const finalPayload = {
            target_id: currentTargetId,
            date: payload.date || document.getElementById('occurrenceDate').value,
            description: payload.description,
            event_type: payload.event_type || (editingItemIdInput.value ? editingItemIdInput.dataset.type : 'NOTE'),
            question_id: payload.question_id || (editingItemIdInput.value ? editingItemIdInput.dataset.questionId : null),
            contact_made: payload.contact_made || false,
            tags: payload.tags || [],
            action: editingItemIdInput.value ? 'update' : 'create',
            item_id: editingItemIdInput.value
        };
        
        if (!finalPayload.description && !finalPayload.question_id && !finalPayload.contact_made) {
             alert('内容を入力してください'); return;
        }

        fetch('{% url "intelligence_log" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(finalPayload)
        }).then(res => res.json()).then(data => {
            if (data.success) {
                if (data.action === 'create' || !editingItemIdInput.value) {
                    // Reset inputs for new log
                    chatInput.value = '';
                    chatInput.style.height = 'auto';
                    contactFlagCheckbox.checked = false;
                    document.getElementById('contactFlagBtn').classList.remove('text-primary', 'border-primary', 'bg-primary/10');
                    cancelEditMode();
                } else {
                    cancelEditMode();
                }
                resetTimeline();
                fetchTimeline();
                if(onSuccess) onSuccess();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }

    // --- Answer Modal Logic ---
    const modal = document.getElementById('questionAnswerModal');
    const qStep1 = document.getElementById('qStep1');
    const qStep2 = document.getElementById('qStep2');
    const qStep3 = document.getElementById('qStep3');
    const qCategoryGrid = document.getElementById('qCategoryGrid');
    const qQuestionGrid = document.getElementById('qQuestionGrid');
    
    document.getElementById('openAnswerModalBtn').addEventListener('click', () => {
        if (!currentTargetId) { alert('ターゲットを選択してください'); return; }
        modal.classList.remove('hidden');
        showStep1();
    });
    
    function showStep1() {
        qStep1.classList.remove('hidden');
        qStep2.classList.add('hidden');
        qStep3.classList.add('hidden');
        const categories = [...new Set(questionsData.map(q => q.category).filter(Boolean))];
        qCategoryGrid.innerHTML = '';
        categories.forEach(cat => {
            const btn = document.createElement('button');
            btn.className = "bg-background border border-border rounded p-3 text-sm text-text-main hover:border-primary hover:text-primary transition font-bold";
            btn.textContent = cat;
            btn.onclick = () => showStep2(cat);
            qCategoryGrid.appendChild(btn);
        });
    }
    
    function showStep2(category) {
        qStep1.classList.add('hidden');
        qStep2.classList.remove('hidden');
        document.getElementById('qSelectedCatName').textContent = category;
        qQuestionGrid.innerHTML = '';
        const qs = questionsData.filter(q => q.category === category);
        qs.forEach(q => {
            const btn = document.createElement('button');
            btn.className = "bg-background border border-border rounded p-3 text-xs text-left hover:border-primary group transition flex flex-col gap-1 h-full";
            btn.innerHTML = `<span class="font-bold text-text-main group-hover:text-primary transition-colors">${q.text}</span>`;
            if (q.rank) btn.innerHTML += `<span class="text-[10px] text-text-sub">Rank: ${q.rank}</span>`;
            btn.onclick = () => showStep3(q);
            qQuestionGrid.appendChild(btn);
        });
        document.getElementById('qBackToCat').onclick = showStep1;
    }
    
    let currentModalQuestion = null;
    function showStep3(question) {
        qStep2.classList.add('hidden');
        qStep3.classList.remove('hidden');
        currentModalQuestion = question;
        document.getElementById('qTargetQuestion').textContent = question.text;
        document.getElementById('qTargetIntent').textContent = question.description || 'No intent description';
        document.getElementById('qModalAnswer').value = '';
        document.getElementById('qModalAnswer').focus();
        document.getElementById('qBackToQuestions').onclick = () => showStep2(question.category);
    }
    
    document.getElementById('submitAnswerBtn').addEventListener('click', () => {
        if (!currentModalQuestion) return;
        const ans = document.getElementById('qModalAnswer').value;
        if (!ans.trim()) { alert('回答を入力してください'); return; }
        saveLogItem({
            event_type: 'QUESTION',
            question_id: currentModalQuestion.id,
            description: ans,
            date: document.getElementById('occurrenceDate').value
        }, () => {
            modal.classList.add('hidden');
        });
    });

}); // End DOMContentLoaded
</script>
{% endblock %}
