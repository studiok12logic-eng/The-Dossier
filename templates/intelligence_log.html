{% extends 'base.html' %}
{% load static %}
{% block content_wrapper_class %}flex-1 flex flex-col min-h-0 overflow-hidden p-4 pb-32 md:p-8 md:pb-12{% endblock %}

{% block content %}
<!-- DESKTOP VERSION (hidden on mobile) -->
<div class="hidden md:flex flex-1 min-h-0 overflow-hidden gap-6">
    <!-- Left Panel: Target Selector -->
    <div class="w-1/3 flex flex-col gap-4">
        <!-- Date Picker Module -->
        <div class="bg-surface border border-border rounded-xl overflow-hidden p-4">
            <h3 class="text-xs font-mono text-text-sub mb-2">DATE</h3>
            <form method="get" id="dateForm" class="mb-0">
                <input type="date" name="date" value="{{ today_date }}"
                    class="w-full bg-background border border-border rounded px-2 py-2 text-sm text-text-main focus:border-primary transition"
                    onchange="this.form.submit()">
            </form>
            <!-- Hidden CSRF for JS -->
            <form style="display:none">{% csrf_token %}</form>
        </div>

        <!-- Target List Module -->
        <div class="bg-surface border border-border rounded-xl overflow-hidden flex-1 flex flex-col relative">
            <div class="p-4 border-b border-border bg-surface">
                <h2 class="text-primary font-mono text-sm flex items-center gap-2">
                    <span class="w-1 h-4 bg-primary block"></span>
                    TARGET SELECT
                </h2>
                <!-- Date Removed -->
            </div>

            <!-- Target List -->
            <div class="flex-1 overflow-y-auto p-2 space-y-2" id="targetList">
                {% if todays_targets %}
                {% for item in todays_targets %}
                <div class="target-item p-3 rounded flex items-center gap-3 cursor-pointer hover:bg-text-main/5 transition border border-transparent hover:border-primary/30 group relative select-target-btn"
                    data-id="{{ item.obj.id }}" data-name="{{ item.obj.nickname }}"
                    data-avatar="{% if item.obj.avatar %}{{ item.obj.avatar.url }}{% endif %}">

                    <!-- Avatar -->
                    <div class="w-[50px] h-[50px] min-w-[50px] min-h-[50px] rounded-full bg-background border border-border overflow-hidden flex-shrink-0 relative"
                        style="width: 50px; height: 50px;">
                        {% if item.obj.avatar %}
                        <img src="{{ item.obj.avatar.url }}" class="w-full h-full object-cover">
                        {% else %}
                        <div class="w-full h-full flex items-center justify-center text-xs text-text-sub">{{ item.obj.nickname|slice:":1" }}</div>
                        {% endif %}
                    </div>

                    <!-- Info -->
                    <div class="flex-1 min-w-0 flex flex-col justify-center">
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-text-main font-mono truncate group-hover:text-primary">{{ item.obj.nickname }}</span>
                        </div>
                        <div class="text-[10px] text-text-sub truncate font-sans">
                            {{ item.obj.last_name }} {{ item.obj.first_name }}{% if item.age %}({{ item.age }}){% endif %}
                        </div>

                        <!-- Status Lines -->
                        {% if not item.has_entry %}
                        <div class="text-[10px] text-yellow-500/80 flex items-center gap-1 mt-0.5 nolog-badge">
                            <i class="fas fa-exclamation-circle text-[9px]"></i> NoLog
                        </div>
                        {% endif %}

                        {% if item.is_anniversary %}
                        <div class="text-[10px] text-red-400 flex items-center gap-1 mt-0.5 font-bold animate-pulse">
                            <i class="fas fa-gift text-[9px]"></i> {{ item.anniversary_label }}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Minus Button (Hover Only) -->
                    <button
                        class="absolute top-2 right-2 text-text-sub hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity remove-target-btn z-10 p-1"
                        data-id="{{ item.obj.id }}" title="リストから除外">
                        <i class="fas fa-minus-circle"></i>
                    </button>

                    <div
                        class="status-indicator w-1 h-full absolute left-0 top-0 bottom-0 bg-text-sub/50 transition-colors">
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center text-text-sub text-xs py-10">
                    本日の予定ターゲットはいません
                </div>
                {% endif %}
            </div>

            <!-- Buttons -->
            <div class="p-4 border-t border-border bg-surface space-y-2">
                <button id="openTargetSearch"
                    class="w-full py-2 bg-primary/10 hover:bg-primary/20 text-primary border border-primary/30 rounded text-xs font-mono transition flex items-center justify-center gap-2">
                    <span>+</span> ADD TARGET
                </button>
                <button id="removeUnfilledBtn"
                    class="w-full py-2 bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/30 rounded text-xs font-mono transition flex items-center justify-center gap-2">
                    <span>-</span> REMOVE UNFILLED
                </button>
            </div>
        </div>
    </div>

    <!-- Right Panel: Dossier Chat-style Input -->
    <div
        class="flex-1 bg-surface border border-border rounded-xl overflow-hidden flex flex-col min-h-0 relative h-full">
        <!-- Overlay for No Selection -->
        <div id="noSelectionOverlay"
            class="absolute inset-0 z-50 bg-background/80 backdrop-blur-sm flex flex-col items-center justify-center text-text-sub">
            <div class="text-4xl mb-4 opacity-50">⚡</div>
            <div class="font-mono text-sm">SELECT TARGET FROM LEFT PANEL</div>
        </div>

        <!-- 1. HEADER: Target Info & Timeline Search -->
        <div class="p-4 border-b border-border bg-surface flex justify-between items-center shrink-0 z-10 shadow-md">
            <!-- Target Info -->
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded bg-background border border-border overflow-hidden" id="selectedAvatar">
                    <!-- JS populated -->
                </div>
                <div>
                    <h2 class="text-text-main font-mono text-sm" id="selectedName">--</h2>
                    <div class="text-[10px] text-text-sub">DOSSIER ENTRY</div>
                </div>
            </div>

            <!-- Search & Filters -->
            <div class="flex items-center gap-2">
                <!-- Encanto Filter Toggle -->
                <button id="encantoFilterBtn"
                    class="flex items-center gap-1 px-3 py-1.5 rounded-full border border-border text-text-sub hover:text-green-400 hover:border-green-400/50 transition font-mono text-xs"
                    title="Show Encanto Only">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-width="2"
                            d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg>
                    <span>ENCANTO</span>
                </button>

                <select id="timelineTypeFilter"
                    class="bg-background border border-border rounded px-2 py-1 text-xs text-text-main focus:border-primary">
                    <option value="">ALL</option>
                    <option value="EVENT">EVENT</option>
                    <option value="QUESTION">QUESTION</option>
                </select>

                <div class="relative group">
                    <input type="text" id="timelineSearch" placeholder="Search..."
                        class="bg-background border border-border rounded-full px-3 py-1 text-xs text-text-main focus:border-primary w-32 focus:w-48 transition-all">
                    <i class="fas fa-search absolute right-3 top-1.5 text-text-sub text-xs pointer-events-none"></i>
                </div>
            </div>
        </div>

        <!-- 2. TIMELINE: Infinite Scroll Area -->
        <div id="timelineContainer" class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth bg-surface/50">
            <div id="timelineLoading" class="hidden text-center py-2 text-text-sub text-xs">
                <i class="fas fa-spinner fa-spin"></i> Loading context...
            </div>
            <div id="timelineContent" class="space-y-4 flex flex-col justify-end min-h-0"></div>
        </div>

        <!-- 3. FOOTER: Input Area (Fixed) -->
        <div class="bg-surface border-t border-border shrink-0 z-20 shadow-[0_-5px_20px_rgba(0,0,0,0.5)]">
            <!-- Tabs -->
            <div class="flex border-b border-border bg-surface">
                <button
                    class="flex-1 py-2 text-xs font-mono text-center border-b-2 border-primary text-text-main bg-text-main/5 transition-colors"
                    id="tabEvent">
                    出来事 (EVENT)
                </button>
                <button
                    class="flex-1 py-2 text-xs font-mono text-center border-b-2 border-transparent text-text-sub hover:text-text-main transition-colors"
                    id="tabQuestion">
                    質問 (QUESTION)
                </button>
            </div>

            <!-- Main Form Area -->
            <div class="flex flex-col h-full" style="display: block;">
                <!-- Edit Mode Indicator -->
                <div id="editModeBar"
                    class="hidden bg-yellow-500/20 text-yellow-400 text-[10px] px-4 py-1 flex justify-between items-center">
                    <span>EDITING MODE</span>
                    <button id="cancelEditBtn" class="hover:text-white">✕ CANCEL</button>
                </div>

                <div class="flex-1 p-4 max-h-[40vh] overflow-y-auto flex flex-col">
                    <!-- Event Form -->
                    <div id="formEvent" class="space-y-3 flex-1 flex flex-col">
                        <textarea id="eventContent"
                            class="w-full h-20 bg-background border border-border rounded p-3 text-sm text-text-main focus:border-primary focus:outline-none resize-none flex-1 font-sans"
                            placeholder="出来事・会話・観察内容..."></textarea>

                        <!-- Tags -->
                        <div class="flex flex-wrap gap-1" id="tagSelectionArea">
                            {% for tag in tags %}
                            <button type="button"
                                class="tag-append-btn px-2 py-0.5 rounded-full border border-border text-[10px] text-text-sub hover:border-primary hover:text-primary transition bg-background"
                                data-name="{{ tag.name }}">
                                {{ tag.name }}({{ tag.count }})
                            </button>
                            {% endfor %}
                            <button type="button" id="moreTagsBtn"
                                class="px-2 py-0.5 rounded-full border border-border text-[10px] text-text-sub hover:text-text-main transition">...</button>
                        </div>
                    </div>

                    <!-- Question Form -->
                    <div id="formQuestion" class="space-y-3 hidden">
                        <div class="flex gap-2">
                            <select id="qCategory"
                                class="flex-1 bg-background border border-border rounded px-2 py-1 text-xs text-text-main focus:border-primary">
                                <option value="">カテゴリ</option>
                                {% regroup questions by category as category_list %}
                                {% for cat in category_list %}
                                <option value="{{ cat.grouper }}">{{ cat.grouper }}</option>
                                {% endfor %}
                            </select>
                            <select id="qSelect"
                                class="flex-[2] bg-background border border-border rounded px-2 py-1 text-xs text-text-main focus:border-primary"
                                disabled>
                                <option value="">質問選択...</option>
                            </select>
                        </div>

                        <!-- PC: Details and Choices in one row. Mobile: Stacked -->
                        <div class="flex flex-col md:flex-row gap-2">
                            <!-- Details (Always Visible) -->
                            <div id="qDetails"
                                class="bg-background border border-border rounded p-2 text-[10px] text-text-sub flex flex-col justify-center min-w-[120px]">
                                <div>Rank: <span id="qRank" class="text-primary">-</span></div>
                                <div class="truncate flex-1">Intent: <span id="qDesc">-</span></div>
                                <div class="hidden">Ex: <span id="qEx">-</span></div>
                            </div>

                            <!-- Choices -->
                            <div id="qChoicesCheck"
                                class="flex-1 opacity-50 pointer-events-none transition-opacity bg-background border border-border rounded p-2 min-h-[40px] flex flex-col justify-center">
                                <div id="qCheckPlaceholder" class="text-[10px] text-text-sub text-center">選択肢 (質問を選択)</div>
                                <div id="qChoicesContainer" class="flex flex-wrap gap-1"></div>
                            </div>
                        </div>

                        <textarea id="qAnswer"
                            class="w-full h-16 bg-background border border-border rounded p-3 text-sm text-text-main focus:border-primary focus:outline-none resize-none font-sans"
                            placeholder="回答・反応..."></textarea>
                    </div>
                </div>

                <!-- Controls Area -->
                <div class="flex items-center justify-between gap-3 p-4 border-t border-border bg-surface">
                    <!-- Date & Contact -->
                    <div class="flex items-center gap-3">
                        <div class="relative">
                            <input type="date" id="occurrenceDate" value="{{ today_date }}"
                                class="bg-background border border-border rounded px-2 py-1 text-[10px] text-text-sub focus:outline-none focus:border-primary [color-scheme:dark]">
                        </div>

                        <div class="flex items-center gap-2 cursor-pointer group">
                            <input type="checkbox" id="contactFlag"
                                class="rounded border-border text-primary bg-background w-4 h-4 cursor-pointer">
                            <label for="contactFlag"
                                class="text-[10px] text-text-sub group-hover:text-text-main cursor-pointer leading-tight">接触</label>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div class="flex items-center gap-2">
                     <button id="deleteLogBtn"
                         class="hidden bg-red-500/10 hover:bg-red-500/20 text-red-500 font-bold py-2 px-3 rounded transition-all border border-red-500/30">
                         <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                     </button>
                    <button id="saveLogBtn"
                        class="bg-primary text-black font-bold py-0 px-[1em] rounded hover:bg-primary/90 transition-all shadow-lg shadow-primary/20 flex items-center gap-2"
                        style="padding-left: 0.5em; padding-right: 0.5em;">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-width="2"
                                d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4">
                            </path>
                        </svg>
                        <span id="saveBtnText">SAVE</span>
                    </button>
                    <!-- Hidden ID for Editing -->
                    <input type="hidden" id="editingItemId" value="">
                </div>
            </div>
        </div>
    </div>
</div>
<!-- End DESKTOP VERSION -->

<!-- MOBILE VERSION (visible only on mobile) -->
<div class="md:hidden flex-1 min-h-0 flex flex-col overflow-hidden">
    <!-- Mobile Header with Date -->
    <div class="bg-surface border border-border rounded-xl p-4 mb-4">
        <form method="get" class="flex items-center gap-3">
            <div class="flex-1">
                <label class="text-xs text-gray-400 mb-1 block">日付</label>
                <input type="date" name="date" value="{{ today_date }}"
                    class="w-full bg-background border border-white/20 rounded px-3 py-2 text-sm text-white"
                    onchange="this.form.submit()">
            </div>
        </form>
    </div>

    <!-- Mobile Tabs -->
    <div class="flex gap-2 mb-4">
        <button id="mobileTabTargets" class="flex-1 py-2 px-4 rounded-lg bg-primary text-black font-medium text-sm">
            ターゲット
        </button>
        <button id="mobileTabLog" class="flex-1 py-2 px-4 rounded-lg bg-white/5 text-gray-400 font-medium text-sm">
            ログ
        </button>
    </div>

    <!-- Mobile Target List View -->
    <div id="mobileTargetsView" class="flex-1 overflow-y-auto space-y-2">
        {% for item in todays_targets %}
        <div class="bg-surface border border-white/10 rounded-xl p-4 flex items-center gap-3 active:bg-white/5"
            onclick="selectMobileTarget('{{ item.obj.id }}', '{{ item.obj.nickname }}', '{% if item.obj.avatar %}{{ item.obj.avatar.url }}{% endif %}')">
            <div class="w-12 h-12 rounded-full bg-background border border-white/10 overflow-hidden flex-shrink-0">
                {% if item.obj.avatar %}
                <img src="{{ item.obj.avatar.url }}" class="w-full h-full object-cover">
                {% else %}
                <div class="w-full h-full flex items-center justify-center text-xs text-gray-500">{{
                    item.obj.nickname|slice:":1" }}</div>
                {% endif %}
            </div>
            <div class="flex-1">
                <div class="text-sm text-white font-medium">{{ item.obj.nickname }}</div>
                <div class="text-xs text-gray-500">{{ item.obj.last_name }} {{ item.obj.first_name }}</div>
            </div>
            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </div>
        {% endfor %}
    </div>

    <!-- Mobile Log View (hidden by default) -->
    <div id="mobileLogView" class="hidden flex-1 flex flex-col overflow-hidden">
        <!-- Selected Target Header -->
        <div id="mobileSelectedTarget"
            class="bg-surface border border-white/10 rounded-xl p-4 mb-4 flex items-center gap-3">
            <button onclick="showMobileTargets()" class="text-gray-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div class="w-10 h-10 rounded-full bg-background border border-white/10 overflow-hidden"
                id="mobileTargetAvatar">
                <div class="w-full h-full flex items-center justify-center text-xs text-gray-500">?</div>
            </div>
            <div class="flex-1">
                <div class="text-sm text-white font-medium" id="mobileTargetName">ターゲットを選択</div>
            </div>
        </div>

        <!-- Mobile Timeline -->
        <div class="flex-1 overflow-y-auto space-y-3 mb-4" id="mobileTimelineContent">
            <!-- Timeline items will be loaded here -->
        </div>

        <!-- Mobile Input (Fixed at bottom) -->
        <div class="bg-surface border border-white/10 rounded-xl p-4">
            <textarea id="mobileLogInput" rows="3"
                class="w-full bg-background border border-white/20 rounded px-3 py-2 text-sm text-white resize-none mb-3"
                placeholder="ログを入力..."></textarea>
            <div class="flex items-center justify-between">
                <label class="flex items-center gap-2 text-xs text-gray-400">
                    <input type="checkbox" id="mobileContactFlag" class="rounded">
                    接触
                </label>
                <button id="mobileSaveBtn" class="bg-primary text-black px-6 py-2 rounded-lg font-medium text-sm">
                    保存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Search Modal -->
<div id="searchModal"
    class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-surface border border-border rounded-xl p-6 w-full max-w-md shadow-2xl h-[500px] flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-mono text-text-main">ターゲット検索</h3>
            <button id="closeSearch" class="text-text-sub hover:text-text-main">✕</button>
        </div>
        <input type="text" id="searchInput" placeholder="Search by name..."
            class="w-full bg-background border border-border rounded px-3 py-2 text-sm text-text-main mb-4 focus:border-primary">
        <div class="flex-1 overflow-y-auto space-y-2 pr-1" id="searchList">
            {% for t in all_targets %}
            <div class="search-item p-2 rounded border border-border hover:bg-text-main/5 cursor-pointer flex items-center gap-3"
                data-id="{{ t.id }}" data-name="{{ t.nickname }}"
                data-avatar="{% if t.avatar %}{{ t.avatar.url }}{% endif %}">
                <div
                    class="w-8 h-8 rounded bg-background border border-border flex items-center justify-center text-[10px] text-text-sub overflow-hidden">
                    {% if t.avatar %}<img src="{{ t.avatar.url }}" class="w-full h-full object-cover">{% else %}{{
                    t.nickname|slice:":1" }}{% endif %}
                </div>
                <div class="text-sm text-text-main font-mono">{{ t.nickname }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Tag Modal -->
<div id="tagModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-surface border border-border rounded-xl p-6 w-full max-w-lg shadow-2xl max-h-[80vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-mono text-text-main">ALL TAGS</h3>
            <button id="closeTagModal" class="text-text-sub hover:text-text-main">✕</button>
        </div>
        <div class="flex-1 overflow-y-auto p-2" id="allTagsContainer">
            <!-- Loaded via JS -->
            <div class="text-center text-text-sub text-xs">Loading tags...</div>
        </div>
    </div>
</div>

<script id="questionsData" type="application/json">
[
    {% for q in questions %}
    {
        "id": "{{ q.id }}", 
        "category": "{{ q.category|default:'' }}", 
        "text": "{{ q.title }}",
        "description": "{{ q.description|escapejs }}",
        "example": "{{ q.example|escapejs }}",
        "answer_type": "{{ q.answer_type }}",
        "choices": "{{ q.choices|escapejs }}",
        "rank": {% if q.rank %}"{{ q.rank.name }} ({{ q.rank.points }}pt)"{% else %}null{% endif %}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
]
</script>

<script>
    // ===== MOBILE-SPECIFIC JAVASCRIPT =====
    let mobileSelectedTargetId = null;

    function selectMobileTarget(id, name, avatar) {
        mobileSelectedTargetId = id;
        document.getElementById('mobileTargetName').textContent = name;

        const avatarEl = document.getElementById('mobileTargetAvatar');
        if (avatar) {
            avatarEl.innerHTML = `<img src="${avatar}" class="w-full h-full object-cover">`;
        } else {
            avatarEl.innerHTML = `<div class="w-full h-full flex items-center justify-center text-xs text-text-sub">${name.charAt(0)}</div>`; // Fixed color class
        }

        // Switch to log view
        document.getElementById('mobileTargetsView').classList.add('hidden');
        document.getElementById('mobileLogView').classList.remove('hidden');
        document.getElementById('mobileTabTargets').classList.remove('bg-primary', 'text-black');
        document.getElementById('mobileTabTargets').classList.add('bg-white/5', 'text-gray-400');
        document.getElementById('mobileTabLog').classList.remove('bg-white/5', 'text-gray-400');
        document.getElementById('mobileTabLog').classList.add('bg-primary', 'text-black');

        // Logic needed for Shared State
        currentTargetId = id;
        resetTimeline();
        fetchTimeline();
    }

    function showMobileTargets() {
        document.getElementById('mobileLogView').classList.add('hidden');
        document.getElementById('mobileTargetsView').classList.remove('hidden');
        document.getElementById('mobileTabLog').classList.remove('bg-primary', 'text-black');
        document.getElementById('mobileTabLog').classList.add('bg-white/5', 'text-gray-400');
        document.getElementById('mobileTabTargets').classList.remove('bg-white/5', 'text-gray-400');
        document.getElementById('mobileTabTargets').classList.add('bg-primary', 'text-black');
    }

    // Mobile tab switching - set up after DOM loads
    document.addEventListener('DOMContentLoaded', function () {
        if (document.getElementById('mobileTabTargets')) {
            document.getElementById('mobileTabTargets').addEventListener('click', showMobileTargets);
            document.getElementById('mobileTabLog').addEventListener('click', () => {
                if (mobileSelectedTargetId) {
                    document.getElementById('mobileTargetsView').classList.add('hidden');
                    document.getElementById('mobileLogView').classList.remove('hidden');
                    document.getElementById('mobileTabTargets').classList.remove('bg-primary', 'text-black');
                    document.getElementById('mobileTabTargets').classList.add('bg-white/5', 'text-gray-400');
                    document.getElementById('mobileTabLog').classList.remove('bg-white/5', 'text-gray-400');
                    document.getElementById('mobileTabLog').classList.add('bg-primary', 'text-black');
                }
            });
        }
    });
    // ===== END MOBILE JAVASCRIPT =====

    // --- State ---
    let currentTargetId = null;
    let questionsData = JSON.parse(document.getElementById('questionsData').textContent);

    // --- UI Elements ---
    const targetList = document.getElementById('targetList');
    const overlay = document.getElementById('noSelectionOverlay');
    const selectedName = document.getElementById('selectedName');
    const selectedAvatar = document.getElementById('selectedAvatar');
    const tabEvent = document.getElementById('tabEvent');
    const tabQuestion = document.getElementById('tabQuestion');
    const formEvent = document.getElementById('formEvent');
    const formQuestion = document.getElementById('formQuestion');
    const qCategory = document.getElementById('qCategory');
    const qSelect = document.getElementById('qSelect');
    const saveBtn = document.getElementById('saveLogBtn');
    const saveBtnText = document.getElementById('saveBtnText');
    const occurrenceDateInput = document.getElementById('occurrenceDate');
    const contactFlagCheckbox = document.getElementById('contactFlag');
    const editingItemIdInput = document.getElementById('editingItemId');
    const editModeBar = document.getElementById('editModeBar');
    const cancelEditBtn = document.getElementById('cancelEditBtn');

    // Encanto Filter
    const encantoFilterBtn = document.getElementById('encantoFilterBtn');
    let isEncantoFilterActive = false;

    // --- Timeline State ---
    const timelineContainer = document.getElementById('timelineContainer');
    const mobileTimelineContent = document.getElementById('mobileTimelineContent'); // Added for mobile
    const timelineContent = document.getElementById('timelineContent');
    const timelineLoading = document.getElementById('timelineLoading');
    const timelineSearch = document.getElementById('timelineSearch');
    const timelineTypeFilter = document.getElementById('timelineTypeFilter');

    let isFetching = false;
    let hasMore = true;
    let timelineCursorDate = null;

    // --- Target Selection ---
    targetList.addEventListener('click', function (e) {
        const removeBtn = e.target.closest('.remove-target-btn');
        if (removeBtn) {
            e.stopPropagation();
            const id = removeBtn.dataset.id;
            const date = document.querySelector('input[name="date"]').value;
            if (confirm('このターゲットを本日のリストから除外しますか？')) {
                toggleTargetState(id, date, 'hide', () => location.reload());
            }
            return;
        }

        const item = e.target.closest('.target-item');
        if (item) {
            document.querySelectorAll('.target-item').forEach(el => {
                el.classList.remove('bg-text-main/10', 'border-primary');
                el.querySelector('.status-indicator').classList.remove('bg-primary', 'shadow-[0_0_8px_rgba(34,197,94,0.8)]');
                el.querySelector('.status-indicator').classList.add('bg-text-sub/50');
            });
            item.classList.add('bg-text-main/10', 'border-primary');
            item.querySelector('.status-indicator').classList.remove('bg-text-sub/50');
            item.querySelector('.status-indicator').classList.add('bg-primary', 'shadow-[0_0_8px_rgba(34,197,94,0.8)]');

            currentTargetId = item.dataset.id;
            selectedName.textContent = item.dataset.name;
            const avatarUrl = item.dataset.avatar;
            selectedAvatar.innerHTML = avatarUrl
                ? `<img src="${avatarUrl}" class="w-full h-full object-cover">`
                : `<div class="w-full h-full flex items-center justify-center text-xs text-text-sub">${item.dataset.name.slice(0, 1)}</div>`;

            document.getElementById('noSelectionOverlay').classList.add('hidden');
            resetTimeline();
            fetchTimeline();
            cancelEditMode(); // Reset edit mode on target switch
        }
    });

    // --- Timeline Functions ---
    function resetTimeline() {
        timelineContent.innerHTML = '';
        if (mobileTimelineContent) mobileTimelineContent.innerHTML = '';
        console.log("Clearing timeline");
        timelineCursorDate = null;
        hasMore = true;
    }

    function fetchTimeline(append = false) {
        if (!currentTargetId || isFetching || (!hasMore && append)) return;

        isFetching = true;
        if (append) timelineLoading.classList.remove('hidden');

        const params = new URLSearchParams({ target_id: currentTargetId, limit: 20 });
        if (append && timelineCursorDate) params.append('before_date', timelineCursorDate);
        if (timelineSearch.value) params.append('search', timelineSearch.value);
        if (timelineTypeFilter.value) params.append('type', timelineTypeFilter.value);
        if (isEncantoFilterActive) params.append('contact_only', 'true');

        fetch(`{% url "timeline_list" %}?${params.toString()}`)
            .then(res => res.json())
            .then(data => {
                isFetching = false;
                timelineLoading.classList.add('hidden');

                if (data.success) {
                    if (data.data.length < 20) hasMore = false;
                    if (data.data.length > 0) {
                        timelineCursorDate = data.data[data.data.length - 1].date;
                        renderTimelineItems(data.data, append);
                    }
                }
            })
            .catch(err => {
                isFetching = false;
                console.error(err);
            });
    }

    function renderTimelineItems(items, append) {
        // Items are created_at DESC (Newest First) from API.
        // We want reversed (Old -> New) for chat style at bottom.
        const orderedItems = [...items].reverse();

        // Render for Desktop
        const fragment = document.createDocumentFragment();
        orderedItems.forEach(item => fragment.appendChild(createTimelineElement(item)));

        if (append) {
            const firstChild = timelineContent.firstElementChild;
            const oldHeight = timelineContainer.scrollHeight;
            timelineContent.insertBefore(fragment, firstChild);
            timelineContainer.scrollTop = timelineContainer.scrollHeight - oldHeight;
        } else {
            timelineContent.appendChild(fragment);
            timelineContainer.scrollTop = timelineContainer.scrollHeight;
        }

        // Render for Mobile
        if (mobileTimelineContent) {
            const fragmentMobile = document.createDocumentFragment();
            orderedItems.forEach(item => fragmentMobile.appendChild(createTimelineElement(item))); // Create fresh elements with listeners

            if (append) {
                const firstChild = mobileTimelineContent.firstElementChild;
                const oldHeight = mobileTimelineContent.scrollHeight;
                mobileTimelineContent.insertBefore(fragmentMobile, firstChild);
                mobileTimelineContent.scrollTop = mobileTimelineContent.scrollHeight - oldHeight;
            } else {
                mobileTimelineContent.appendChild(fragmentMobile);
                mobileTimelineContent.scrollTop = mobileTimelineContent.scrollHeight;
            }
        }
    }

    function createTimelineElement(item) {
        const typeBadge = item.type === 'EVENT' ? 'bg-blue-500/20 text-blue-400' : 'bg-green-500/20 text-green-400';

        // JS generated HTML also needs semantic classes
        // bg-white/5 -> bg-text-main/5
        // text-white -> text-text-main
        // text-gray-400 -> text-text-sub
        // border-white/5 -> border-border

        let content = '';
        let footerInfoHtml = ''; 
        
        // Tags or Choice Area
        let tagsOrChoiceHtml = '';

        if (item.type.toUpperCase() === 'QUESTION') {
            const qTitle = item.question_title || 'Unknown Question';
            // Use description for answer text
            let answerText = item.description || '';
            let choiceVal = null;

            // Extract Choice specific format "[選択: XYZ]"
            const choiceMatch = answerText.match(/\[選択:\s*(.*?)\]/);
            if (choiceMatch) {
                choiceVal = choiceMatch[1];
                // Strip from content text
                answerText = answerText.replace(choiceMatch[0], '').trim();
            }

            // Body: Title + Answer
            content = `
                <div class="text-[10px] text-text-sub font-bold mb-1 ml-1">${escapeHtml(qTitle)}</div>
                <div class="text-text-sub text-sm whitespace-pre-wrap">${escapeHtml(answerText)}</div>
            `;

            // Footer: Choice (if exists)
            if (choiceVal) {
                tagsOrChoiceHtml = `<div class="mt-2 pt-2 border-t border-border">
                    <span class="inline-block px-2 py-0.5 rounded-full border border-border text-[10px] text-text-sub bg-background">
                        ${escapeHtml(choiceVal)}
                    </span>
                </div>`;
            } else {
                 // Fallback or empty if no choice? User said "Question case selected choice". 
                 // If no choice selected, show nothing or tags? 
                 // Let's show tags if no choice (fallback) or just nothing?
                 // Safer to show tags if they exist and no choice? 
                 // User said "distinguish". Let's assume if no choice, maybe show tags if any.
                 if (item.tags && item.tags.length > 0) {
                     const tags = item.tags.map(t => `<span class="text-[10px] text-text-sub mr-1">#${escapeHtml(t.name)}</span>`).join('');
                     tagsOrChoiceHtml = `<div class="mt-2 pt-2 border-t border-border">${tags}</div>`;
                 }
            }

        } else {
            // EVENT
            content = `<div class="text-text-sub text-sm whitespace-pre-wrap">${escapeHtml(item.description || '')}</div>`;
            
            // Footer: Tags
            if (item.tags && item.tags.length > 0) {
                const tags = item.tags.map(t => `<span class="text-[10px] text-text-sub mr-1">#${escapeHtml(t.name)}</span>`).join('');
                tagsOrChoiceHtml = `<div class="mt-2 pt-2 border-t border-border">${tags}</div>`;
            }
        }

        let encantoBadge = '';
        if (item.contact_made) {
            encantoBadge = `<span class="flex items-center gap-1 text-[10px] items-center px-1.5 rounded bg-green-500/20 text-green-400 border border-border mr-2 h-[20px]">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Encanto
             </span>`;
        }

        const div = document.createElement('div');
        div.className = "bg-text-main/5 border border-border rounded p-3 text-sm hover:bg-text-main/10 transition-colors group relative";
        div.innerHTML = `
            <div class="flex justify-between items-center mb-2">
                 <div class="flex items-center gap-2">
                    ${encantoBadge}
                    <span class="text-[10px] px-1.5 rounded ${typeBadge} border border-border flex-shrink-0">${item.type}</span>
                 </div>
                 <div class="text-[10px] text-text-sub font-mono">
                    Occurred: <span class="text-text-main">${item.date}</span>
                 </div>
            </div>
            
            <div class="text-text-sub leading-relaxed break-words line-clamp-20 mb-2">${content}</div>
            ${tagsOrChoiceHtml}

            <!-- Footer: Created At & Edit Link -->
             <div class="flex justify-end items-center gap-3 mt-2 pt-2 border-t border-white/5">
                <div class="text-[10px] text-text-sub font-mono">${item.created_at || ''}</div>
                <button class="text-[10px] text-primary hover:text-primary/80 underline edit-link-btn">編集</button>
             </div>
        `;

        // Handlers
        div.querySelector('.edit-link-btn').onclick = () => editLog(item);

        return div;
    }

    function escapeHtml(text) {
        if (!text) return '';
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    timelineContainer.addEventListener('scroll', () => {
        if (timelineContainer.scrollTop === 0 && hasMore && !isFetching) fetchTimeline(true);
    });
    // Mobile Scroll
    if (mobileTimelineContent) {
        mobileTimelineContent.addEventListener('scroll', () => {
            if (mobileTimelineContent.scrollTop === 0 && hasMore && !isFetching) fetchTimeline(true);
        });
    }

    let searchDebounce;
    timelineSearch.addEventListener('input', () => {
        clearTimeout(searchDebounce);
        searchDebounce = setTimeout(() => { resetTimeline(); fetchTimeline(); }, 500);
    });
    timelineTypeFilter.addEventListener('change', () => { resetTimeline(); fetchTimeline(); });

    // Encanto Filter
    encantoFilterBtn.addEventListener('click', () => {
        isEncantoFilterActive = !isEncantoFilterActive;

        if (isEncantoFilterActive) {
            encantoFilterBtn.classList.remove('text-text-sub', 'border-border', 'bg-transparent');
            encantoFilterBtn.classList.add('bg-green-500', 'text-black', 'border-green-500', 'font-bold');
        } else {
            encantoFilterBtn.classList.add('text-text-sub', 'border-border', 'bg-transparent');
            encantoFilterBtn.classList.remove('bg-green-500', 'text-black', 'border-green-500', 'font-bold');
        }

        resetTimeline();
        fetchTimeline();
    });

    // --- Action Functions ---
    // --- Action Functions ---
    function deleteLog(itemId) {
        if (!confirm("ログを削除しますか？この操作は取り消せません。")) return;

        fetch('{% url "intelligence_log" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                action: 'delete',
                item_id: itemId
            })
        }).then(res => res.json()).then(data => {
            if (data.success) {
                // If editing this item, cancel edit
                if (editingItemIdInput.value === itemId) {
                    cancelEditMode();
                }
                resetTimeline();
                fetchTimeline();
                
                // Update NoLog Badge
                if (data.target_id !== undefined && data.has_entry_today !== undefined) {
                     const targetEl = document.querySelector(`.target-item[data-id="${data.target_id}"]`);
                     if (targetEl) {
                         let badge = targetEl.querySelector('.nolog-badge');
                         if (!data.has_entry_today) {
                             if (!badge) {
                                 badge = document.createElement('div');
                                 badge.className = "text-[10px] text-yellow-500/80 flex items-center gap-1 mt-0.5 nolog-badge";
                                 badge.innerHTML = '<i class="fas fa-exclamation-circle text-[9px]"></i> NoLog';
                                 const nameDiv = targetEl.querySelector('.text-\\[10px\\].text-text-sub.truncate');
                                 if (nameDiv) nameDiv.after(badge);
                             } else {
                                 badge.classList.remove('hidden');
                             }
                         } else {
                             if (badge) badge.classList.add('hidden');
                         }
                     }
                     }
                }
            } else {
                alert('削除に失敗しました: ' + (data.error || 'Unknown error'));
            }
        }).catch(err => {
            alert('通信エラーが発生しました');
            console.error(err);
        });
    }

    const deleteBtn = document.getElementById('deleteLogBtn');
    deleteBtn.addEventListener('click', () => {
        if(editingItemIdInput.value) deleteLog(editingItemIdInput.value);
    });

    function editLog(item) {
        // Mode Set
        editingItemIdInput.value = item.id;
        editModeBar.classList.remove('hidden');
        saveBtnText.textContent = "UPDATE";
        saveBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-400');
        saveBtn.classList.remove('bg-primary', 'hover:bg-primary/90');
        deleteBtn.classList.remove('hidden'); // Show Delete Button

        // Populate Data
        occurrenceDateInput.value = item.date;
        contactFlagCheckbox.checked = item.contact_made;

        if (item.type.toUpperCase() === 'QUESTION') {
            tabQuestion.click();
            // Try to set Question Select
            if (item.question_id) {
                // Find question in questionsData
                const q = questionsData.find(q => q.id == item.question_id); // loose equality for string/int
                if (q) {
                    qCategory.value = q.category;
                    qCategory.dispatchEvent(new Event('change'));
                    qSelect.value = q.id;
                    qSelect.dispatchEvent(new Event('change'));
                }
            }
            
            // Handle content and choice
            let rawContent = item.description || '';
            const choiceMatch = rawContent.match(/\[選択:\s*(.*?)\]/);
            
            // Reset choice selection
            selectedChoices.clear();
            document.querySelectorAll('.choice-btn').forEach(b => {
                 b.classList.remove('bg-primary/20', 'border-primary', 'text-primary');
                 b.classList.add('bg-background', 'border-border', 'text-text-sub');
            });

            if (choiceMatch) {
                const prevChoice = choiceMatch[1];
                selectedChoices.add(prevChoice);
                 // Highlight button
                const btn = Array.from(document.querySelectorAll('.choice-btn')).find(b => b.textContent.trim() === prevChoice.trim());
                if(btn) {
                    btn.click(); // simulate click to set styles and state
                }
                // Strip from content
                rawContent = rawContent.replace(choiceMatch[0], '').trim();
            }
            
            document.getElementById('qAnswer').value = rawContent;
        } else {
            tabEvent.click();
            document.getElementById('eventContent').value = item.description || '';
        }
    }

    function cancelEditMode() {
        editingItemIdInput.value = "";
        editModeBar.classList.add('hidden');
        saveBtnText.textContent = "SAVE";
        saveBtn.classList.add('bg-primary', 'hover:bg-primary/90');
        saveBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-400');
        deleteBtn.classList.add('hidden'); // Hide Delete Button

        document.getElementById('eventContent').value = "";
        document.getElementById('qAnswer').value = "";
        contactFlagCheckbox.checked = false;
        // reset date? keep today or last selected
    }

    cancelEditBtn.addEventListener('click', cancelEditMode);

    // --- Tag Click Append ---
    // Top 10
    document.querySelector('#formEvent #tagSelectionArea').addEventListener('click', (e) => {
        if (e.target.classList.contains('tag-append-btn')) {
            const tagName = e.target.dataset.name;
            appendTagToActive(tagName);
        }
    });

    function appendTagToActive(tagName) {
        const isEvent = !formEvent.classList.contains('hidden');
        const targetEl = isEvent ? document.getElementById('eventContent') : document.getElementById('qAnswer');
        const val = targetEl.value;
        // Append on new line if content exists? User said "bottom line".
        if (val.length > 0 && !val.endsWith('\n')) {
            targetEl.value = val + "\n#" + tagName + " ";
        } else {
            targetEl.value = val + "#" + tagName + " ";
        }
    }

    // Tag Modal Logic
    const tagModal = document.getElementById('tagModal');
    const moreTagsBtn = document.getElementById('moreTagsBtn');
    const closeTagModal = document.getElementById('closeTagModal');
    const allTagsContainer = document.getElementById('allTagsContainer');

    moreTagsBtn.addEventListener('click', () => {
        tagModal.classList.remove('hidden');
        // Fetch
        fetch('{% url "tag_list_api" %}')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    allTagsContainer.innerHTML = '';
                    data.tags.forEach(tag => {
                        const btn = document.createElement('button');
                        btn.className = "px-3 py-1 m-1 rounded-full border border-border text-xs text-text-sub hover:border-primary hover:text-primary transition bg-background";
                        btn.textContent = `${tag.name} (${tag.count})`;
                        btn.onclick = () => {
                            appendTagToActive(tag.name);
                            tagModal.classList.add('hidden');
                        };
                        allTagsContainer.appendChild(btn);
                    });
                }
            });
    });
    closeTagModal.addEventListener('click', () => tagModal.classList.add('hidden'));

    // --- Save ---
    document.getElementById('saveLogBtn').addEventListener('click', () => {
        if (!currentTargetId) { alert('ターゲットを選択してください'); return; }

        const isEventTab = !formEvent.classList.contains('hidden');
        const editingId = editingItemIdInput.value;
        const payload = {
            target_id: currentTargetId,
            date: occurrenceDateInput.value,
            description: "",
            event_type: "NOTE",
            tags: [],
            question_id: null,
            contact_made: contactFlagCheckbox.checked,
            action: editingId ? 'update' : 'create',
            item_id: editingId
            // tags are handled via regex now in backend too, or we can send them?
            // Backend in Step 339 parses content hashtags AND explicitly sent list.
            // We are appending to content. So regex will catch it.
        };

        if (isEventTab) {
            payload.description = document.getElementById('eventContent').value;
            payload.contact_made = contactFlagCheckbox.checked;

            if (!payload.description && !payload.contact_made && !editingId) { // Check edit too
                alert("内容を入力するか接触フラグをONにしてください");
                return;
            }
        } else {
            payload.event_type = 'QUESTION';
            const qId = qSelect.value;
            let ans = document.getElementById('qAnswer').value;
            if (!qId && !editingId) { // Allow update without re-selecting Q? Backend doesn't support changing Q yet if not sent.
                alert('質問を選択してください');
                return;
            }
            if (qId) payload.question_id = qId;

            // Single Select Answer
            if (currentQuestion && currentQuestion.answer_type === 'SELECTION' && selectedChoices.size > 0) {
                const choice = Array.from(selectedChoices)[0];
                ans = `[選択: ${choice}]\n${ans}`;
            }

            if (!ans.trim() && selectedChoices.size === 0 && !editingId) {
                alert('回答を入力または選択してください');
                return;
            }
            payload.description = ans;
        }

        // Send
        fetch('{% url "intelligence_log" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(payload)
        }).then(res => res.json()).then(data => {
            if (data.success) {
                // Clear Form or Reset Edit
                if (editingId) cancelEditMode();
                else {
                    document.getElementById('eventContent').value = '';
                    document.getElementById('qAnswer').value = '';
                    // Keep checkboxes? Usually clear.
                    contactFlagCheckbox.checked = false;
                }
                resetTimeline();
                fetchTimeline();

                // Update NoLog Badge
                if (data.target_id !== undefined && data.has_entry_today !== undefined) {
                     const targetEl = document.querySelector(`.target-item[data-id="${data.target_id}"]`);
                     if (targetEl) {
                         let badge = targetEl.querySelector('.nolog-badge');
                         if (!data.has_entry_today) {
                             if (!badge) {
                                 badge = document.createElement('div');
                                 badge.className = "text-[10px] text-yellow-500/80 flex items-center gap-1 mt-0.5 nolog-badge";
                                 badge.innerHTML = '<i class="fas fa-exclamation-circle text-[9px]"></i> NoLog';
                                 const nameDiv = targetEl.querySelector('.text-\\[10px\\].text-text-sub.truncate');
                                 if (nameDiv) nameDiv.after(badge);
                             } else {
                                 badge.classList.remove('hidden');
                             }
                         } else {
                             if (badge) badge.classList.add('hidden');
                         }
                     }
                }
                     }
                }
            } else {
                alert('保存に失敗しました: ' + (data.error || 'Unknown error'));
            }
        });
    });

    // Helper: Target State Toggle (Copied from previous)
    function toggleTargetState(targetId, date, action, callback) {
        return fetch('{% url "target_state_toggle" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
            body: JSON.stringify({ target_id: targetId, date: date, action: action })
        }).then(res => res.json()).then(data => {
            if (data.success && callback) callback();
            return data;
        });
    }

    // Search Modal (Target)
    const searchModal = document.getElementById('searchModal');
    document.getElementById('openTargetSearch').addEventListener('click', () => searchModal.classList.remove('hidden'));
    document.getElementById('closeSearch').addEventListener('click', () => searchModal.classList.add('hidden'));
    document.getElementById('searchInput').addEventListener('input', function () {
        const term = this.value.toLowerCase();
        document.querySelectorAll('.search-item').forEach(el => {
            el.classList.toggle('hidden', !el.dataset.name.toLowerCase().includes(term));
        });
    });
    document.getElementById('searchList').addEventListener('click', function (e) {
        const item = e.target.closest('.search-item');
        if (item) {
            const id = item.dataset.id;
            let exists = false;
            document.querySelectorAll('.target-item').forEach(el => { if (el.dataset.id === id) exists = true; });
            if (!exists) toggleTargetState(id, document.querySelector('input[name="date"]').value, 'add', () => location.reload());
            else alert('すでにリストに追加されています');
            searchModal.classList.add('hidden');
        }
    });

    // Q Elements Logic
    const qDetails = document.getElementById('qDetails');
    const qChoicesContainer = document.getElementById('qChoicesContainer');
    const qChoicesCheck = document.getElementById('qChoicesCheck');
    const qCheckPlaceholder = document.getElementById('qCheckPlaceholder');
    let selectedChoices = new Set();
    let currentQuestion = null;

    qCategory.addEventListener('change', (e) => {
        const cat = e.target.value;
        qSelect.innerHTML = '<option value="">質問を選択してください</option>';
        qSelect.disabled = !cat;
        // qDetails.classList.add('hidden'); // Removed to keep visible
        // Reset details
        document.getElementById('qRank').textContent = '-';
        document.getElementById('qDesc').textContent = '-';
        document.getElementById('qEx').textContent = '-';
        
        qChoicesContainer.innerHTML = '';
        qChoicesCheck.classList.add('opacity-50', 'pointer-events-none');
        // Reset placeholder
        if(qCheckPlaceholder) qCheckPlaceholder.classList.remove('hidden');
        selectedChoices.clear(); currentQuestion = null;
        if (cat) questionsData.filter(q => q.category === cat).forEach(q => qSelect.add(new Option(q.text, q.id)));
    });

    qSelect.addEventListener('change', (e) => {
        const qId = e.target.value;
        const q = questionsData.find(item => item.id === qId);
        currentQuestion = q;
        selectedChoices.clear();
        if (q) {
            document.getElementById('qRank').textContent = q.rank || '-';
            document.getElementById('qDesc').textContent = q.description || '-';
            document.getElementById('qEx').textContent = q.example || '-';
            // qDetails.classList.remove('hidden'); // Always visible now

            qChoicesContainer.innerHTML = '';
            if (q.answer_type === 'SELECTION' && q.choices) {
                qChoicesCheck.classList.remove('opacity-50', 'pointer-events-none');
                if (qCheckPlaceholder) qCheckPlaceholder.classList.add('hidden');
                q.choices.split(',').map(c => c.trim()).filter(c => c).forEach(c => {
                    const btn = document.createElement('button');
                    btn.className = 'choice-btn px-2 py-1 rounded-full border border-border text-[10px] text-text-sub hover:border-primary hover:text-primary transition bg-background';
                    btn.textContent = c;
                    btn.onclick = () => {
                        selectedChoices.clear();
                        selectedChoices.add(c);
                        document.querySelectorAll('.choice-btn').forEach(b => {
                            b.classList.remove('bg-primary/20', 'border-primary', 'text-primary');
                            b.classList.add('bg-background', 'border-border', 'text-text-sub');
                        });
                        btn.classList.add('bg-primary/20', 'border-primary', 'text-primary');
                        btn.classList.remove('bg-background', 'border-border', 'text-text-sub');
                    };
                    qChoicesContainer.appendChild(btn);
                });
            } else {
                qChoicesCheck.classList.add('opacity-50', 'pointer-events-none');
                if (qCheckPlaceholder) qCheckPlaceholder.classList.remove('hidden');
            }
        } else {
            // qDetails.classList.add('hidden'); // Removed
             document.getElementById('qRank').textContent = '-';
             document.getElementById('qDesc').textContent = '-';
             document.getElementById('qEx').textContent = '-';
             if(qCheckPlaceholder) qCheckPlaceholder.classList.remove('hidden');
            qChoicesCheck.classList.add('opacity-50', 'pointer-events-none');
        }
    });

    const removeUnfilledBtn = document.getElementById('removeUnfilledBtn');
    removeUnfilledBtn.addEventListener('click', function () {
        if (!confirm('未記入のターゲットを一括で除外しますか？')) return;
        const date = document.querySelector('input[name="date"]').value;
        let promises = [];
        document.querySelectorAll('.target-item').forEach(item => {
            if (item.querySelector('.fa-exclamation-circle')) {
                promises.push(toggleTargetState(item.dataset.id, date, 'hide'));
            }
        });
        Promise.all(promises).then(() => location.reload());
    });

    // --- Tab Switching Logic ---
    tabEvent.addEventListener('click', () => {
        formEvent.classList.remove('hidden');
        formQuestion.classList.add('hidden');
        tabEvent.classList.add('border-primary', 'text-text-main', 'bg-text-main/5');
        tabEvent.classList.remove('border-transparent', 'text-text-sub');
        tabQuestion.classList.add('border-transparent', 'text-text-sub');
        tabQuestion.classList.remove('border-primary', 'text-text-main', 'bg-text-main/5');
    });

    tabQuestion.addEventListener('click', () => {
        formQuestion.classList.remove('hidden');
        formEvent.classList.add('hidden');
        tabQuestion.classList.add('border-primary', 'text-text-main', 'bg-text-main/5');
        tabQuestion.classList.remove('border-transparent', 'text-text-sub');
        tabEvent.classList.add('border-transparent', 'text-text-sub');
        tabEvent.classList.remove('border-primary', 'text-text-main', 'bg-text-main/5');
    });

    // --- Initialization: Handle URL Params for Pre-selection ---
    const urlParams = new URLSearchParams(window.location.search);
    const preQId = urlParams.get('question_id');
    const preTargetId = urlParams.get('target_id');

    // Auto-Select Target
    if (preTargetId) {
        const targetBtn = document.querySelector(`.target-item[data-id="${preTargetId}"]`);
        if (targetBtn) {
            targetBtn.click();

            // Scroll to it
            targetBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    // Auto-Select Question
    if (preQId) {
        // Switch to Question Tab
        tabQuestion.click();

        // Find question data
        const preQ = questionsData.find(q => q.id === preQId);
        if (preQ) {
            // Set Category
            qCategory.value = preQ.category;
            qCategory.dispatchEvent(new Event('change'));

            // Set Question
            qSelect.value = preQ.id;
            qSelect.dispatchEvent(new Event('change'));
        }
    }

</script>
{% endblock %}