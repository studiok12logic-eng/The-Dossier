{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="h-full flex overflow-hidden gap-6">
    <!-- Left Panel: Target Selector -->
    <div class="w-1/3 flex flex-col gap-4">
        <!-- Date Picker Module -->
        <div class="bg-surface/30 border border-white/10 rounded-xl overflow-hidden p-4">
            <h3 class="text-xs font-mono text-gray-400 mb-2">DATE</h3>
            <form method="get" id="dateForm" class="mb-0">
                <input type="date" name="date" value="{{ today_date }}" 
                    class="w-full bg-black/50 border border-white/10 rounded px-2 py-2 text-sm text-white focus:border-primary transition"
                    onchange="this.form.submit()">
            </form>
            <!-- Hidden CSRF for JS -->
            <form style="display:none">{% csrf_token %}</form>
        </div>

        <!-- Target List Module -->
        <div class="bg-surface/30 border border-white/10 rounded-xl overflow-hidden flex-1 flex flex-col relative">
            <div class="p-4 border-b border-white/10 bg-black/20">
                <h2 class="text-primary font-mono text-sm flex items-center gap-2">
                    <span class="w-1 h-4 bg-primary block"></span>
                    TARGET SELECT
                </h2>
                <div class="text-[10px] text-gray-500 font-mono mt-1">
                    {{ today_date }} ({{ weekday_jp }})
                </div>
            </div>
    
            <!-- Target List -->
            <div class="flex-1 overflow-y-auto p-2 space-y-2" id="targetList">
                {% for item in todays_targets %}
                <div class="target-item p-3 rounded flex items-center gap-3 cursor-pointer hover:bg-white/5 transition border border-transparent hover:border-primary/30 group relative select-target-btn"
                    data-id="{{ item.obj.id }}" data-name="{{ item.obj.nickname }}"
                    data-avatar="{% if item.obj.avatar %}{{ item.obj.avatar.url }}{% endif %}">
                    
                    <!-- Avatar -->
                    <div class="w-[50px] h-[50px] min-w-[50px] min-h-[50px] max-w-[50px] max-h-[50px] rounded-full bg-black border border-white/10 overflow-hidden flex-shrink-0 relative" style="width: 50px; height: 50px; min-width: 50px; min-height: 50px;">
                        {% if item.obj.avatar %}
                        <img src="{{ item.obj.avatar.url }}" class="w-full h-full object-cover">
                        {% else %}
                        <div class="w-full h-full flex items-center justify-center text-xs text-gray-500">{{ item.obj.nickname|slice:":1" }}</div>
                        {% endif %}
                    </div>
                    
                    <!-- Info -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-white font-mono truncate group-hover:text-primary">{{ item.obj.nickname }}</span>
                            <!-- Icons -->
                            {% if item.is_anniversary %}
                            <span class="text-red-500 text-xs" title="Anniversary"><i class="fas fa-gift"></i></span>
                            {% endif %}
                            {% if item.has_entry %}
                            <span class="text-primary text-xs" title="Log Exists"><i class="fas fa-check-circle"></i></span>
                            {% endif %}
                            {% if not item.has_entry %}
                            <span class="text-yellow-500 text-xs" title="Unfilled"><i class="fas fa-exclamation-circle"></i></span>
                            {% endif %}
                        </div>
                        <div class="text-[10px] text-gray-500 truncate">
                            {{ item.obj.last_name }} {{ item.obj.first_name }} 
                            {% if item.age %}({{ item.age }}){% endif %}
                        </div>
                    </div>

                    <!-- Minus Button (Hover Only) -->
                    <button class="absolute top-2 right-2 text-gray-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity remove-target-btn z-10 p-1"
                        data-id="{{ item.obj.id }}" title="リストから除外">
                        <i class="fas fa-minus-circle"></i>
                    </button>
                    
                    <div class="status-indicator w-1 h-full absolute left-0 top-0 bottom-0 bg-gray-700 transition-colors"></div>
                </div>
                {% empty %}
                <div class="text-center text-gray-500 text-xs py-10">
                    本日の予定ターゲットはいません
                </div>
                {% endfor %}
            </div>
    
            <!-- Buttons -->
            <div class="p-4 border-t border-white/10 bg-black/20 space-y-2">
                <button id="openTargetSearch"
                    class="w-full py-2 bg-primary/10 hover:bg-primary/20 text-primary border border-primary/30 rounded text-xs font-mono transition flex items-center justify-center gap-2">
                    <span>+</span> ADD TARGET
                </button>
                <button id="removeUnfilledBtn"
                    class="w-full py-2 bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/30 rounded text-xs font-mono transition flex items-center justify-center gap-2">
                    <span>-</span> REMOVE UNFILLED
                </button>
            </div>
        </div>
    </div>

    <!-- Right Panel: Dossier Chat-style Input -->
    <div class="flex-1 bg-surface/30 border border-white/10 rounded-xl overflow-hidden flex flex-col relative h-full">
        <!-- Overlay for No Selection -->
        <div id="noSelectionOverlay"
            class="absolute inset-0 z-50 bg-black/80 backdrop-blur-sm flex flex-col items-center justify-center text-gray-500">
            <div class="text-4xl mb-4 opacity-50">⚡</div>
            <div class="font-mono text-sm">SELECT TARGET FROM LEFT PANEL</div>
        </div>

        <!-- 1. HEADER: Target Info & Timeline Search -->
        <div class="p-4 border-b border-white/10 bg-black/20 flex justify-between items-center shrink-0 z-10 shadow-md">
            <!-- Target Info -->
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded bg-black border border-white/10 overflow-hidden" id="selectedAvatar">
                    <!-- JS populated -->
                </div>
                <div>
                    <h2 class="text-white font-mono text-sm" id="selectedName">--</h2>
                    <div class="text-[10px] text-gray-500">DOSSIER ENTRY</div>
                </div>
            </div>

            <!-- Search & Filters -->
            <div class="flex items-center gap-2">
                <div class="relative group">
                    <input type="text" id="timelineSearch" placeholder="Search logs..." 
                        class="bg-black/50 border border-white/10 rounded-full px-3 py-1 text-xs text-white focus:border-primary w-32 focus:w-48 transition-all">
                    <i class="fas fa-search absolute right-3 top-1.5 text-gray-500 text-xs pointer-events-none"></i>
                </div>
                
                <select id="timelineTypeFilter" class="bg-black/50 border border-white/10 rounded px-2 py-1 text-xs text-white focus:border-primary">
                    <option value="">ALL</option>
                    <option value="EVENT">EVENT</option>
                    <option value="QUESTION">QUESTION</option>
                </select>

                <input type="date" id="logDate" value="{{ today_date }}"
                    class="bg-black/50 border border-white/10 rounded px-2 py-1 text-xs text-white">
            </div>
        </div>

        <!-- 2. TIMELINE: Infinite Scroll Area -->
        <div id="timelineContainer" class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth bg-black/20">
            <!-- Loading Indicator -->
            <div id="timelineLoading" class="hidden text-center py-2 text-gray-500 text-xs">
                <i class="fas fa-spinner fa-spin"></i> Loading history...
            </div>
            
            <!-- Timeline items will be injected here -->
            <div id="timelineContent" class="space-y-4 flex flex-col justify-end min-h-0"></div>
        </div>

        <!-- 3. FOOTER: Input Area (Fixed) -->
        <div class="bg-surface border-t border-white/10 shrink-0 z-20 shadow-[0_-5px_20px_rgba(0,0,0,0.5)]">
            <!-- Tabs -->
            <div class="flex border-b border-white/10 bg-black/20">
                <button class="flex-1 py-2 text-xs font-mono text-center border-b-2 border-primary text-white bg-white/5 transition-colors"
                    id="tabEvent">
                    出来事 (EVENT)
                </button>
                <button
                    class="flex-1 py-2 text-xs font-mono text-center border-b-2 border-transparent text-gray-500 hover:text-gray-300 transition-colors"
                    id="tabQuestion">
                    質問 (QUESTION)
                </button>
            </div>

            <div class="flex">
                <!-- Main Form Area -->
                <div class="flex-1 p-4 max-h-[30vh] overflow-y-auto">
                     <!-- Event Form -->
                    <div id="formEvent" class="space-y-3">
                        <textarea id="eventContent"
                            class="w-full h-20 bg-black/20 border border-white/10 rounded p-3 text-sm text-white focus:border-primary focus:outline-none resize-none"
                            placeholder="出来事・会話・観察内容..."></textarea>
                        
                        <!-- Mini Tags -->
                        <div class="flex flex-wrap gap-1" id="tagSelectionArea">
                            {% for tag in tags %}
                            <button type="button" 
                                class="tag-btn px-2 py-0.5 rounded-full border border-white/20 text-[10px] text-gray-400 hover:border-primary hover:text-primary transition bg-black/40"
                                data-id="{{ tag.id }}" data-name="{{ tag.name }}">
                                {{ tag.name }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Question Form -->
                    <div id="formQuestion" class="space-y-3 hidden">
                        <div class="flex gap-2">
                             <select id="qCategory" class="flex-1 bg-black/20 border border-white/10 rounded px-2 py-1 text-xs text-white focus:border-primary">
                                <option value="">カテゴリ</option>
                                {% regroup questions by category as category_list %}
                                {% for cat in category_list %}
                                <option value="{{ cat.grouper }}">{{ cat.grouper }}</option>
                                {% endfor %}
                            </select>
                            <select id="qSelect" class="flex-[2] bg-black/20 border border-white/10 rounded px-2 py-1 text-xs text-white focus:border-primary" disabled>
                                <option value="">質問選択...</option>
                            </select>
                        </div>

                         <!-- Details & Choices (Collapsed by default logic handled by JS) -->
                        <div id="qDetails" class="hidden bg-black/20 border border-white/5 rounded p-2 text-[10px] text-gray-400 flex gap-4">
                             <div>Rank: <span id="qRank" class="text-primary"></span></div>
                             <div class="truncate flex-1">Intent: <span id="qDesc"></span></div>
                        </div>
                        
                        <div id="qChoicesCheck" class="hidden">
                             <div id="qChoicesContainer" class="flex flex-wrap gap-1"></div>
                        </div>

                        <textarea id="qAnswer"
                            class="w-full h-16 bg-black/20 border border-white/10 rounded p-3 text-sm text-white focus:border-primary focus:outline-none resize-none"
                            placeholder="回答・反応..."></textarea>
                    </div>
                </div>

                <!-- Right Action Bar -->
                <div class="w-32 border-l border-white/10 bg-black/20 p-3 flex flex-col justify-between items-center gap-2">
                     <div class="flex flex-col items-center gap-1 cursor-pointer group" onclick="document.getElementById('contactFlag').click()">
                        <input type="checkbox" id="contactFlag" class="rounded border-gray-600 text-primary bg-gray-900 w-4 h-4 cursor-pointer">
                        <label class="text-[10px] text-gray-400 group-hover:text-white cursor-pointer text-center leading-tight">接触<br>発生</label>
                    </div>

                    <button id="saveLogBtn"
                        class="w-full py-2 bg-primary text-black font-bold font-mono text-xs rounded hover:bg-primary/90 transition shadow-[0_0_10px_rgba(34,197,94,0.3)] flex flex-col items-center justify-center">
                        <i class="fas fa-paper-plane mb-1"></i>
                        SAVE
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search Modal -->
<div id="searchModal"
    class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-surface border border-white/20 rounded-xl p-6 w-full max-w-md shadow-2xl h-[500px] flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-mono text-white">ターゲット検索</h3>
            <button id="closeSearch" class="text-gray-400 hover:text-white">✕</button>
        </div>
        <input type="text" id="searchInput" placeholder="Search by name..."
            class="w-full bg-black/20 border border-white/10 rounded px-3 py-2 text-sm text-white mb-4 focus:border-primary">

        <div class="flex-1 overflow-y-auto space-y-2 pr-1" id="searchList">
            {% for t in all_targets %}
            <div class="search-item p-2 rounded border border-white/5 hover:bg-white/5 cursor-pointer flex items-center gap-3"
                data-id="{{ t.id }}" data-name="{{ t.nickname }}"
                data-avatar="{% if t.avatar %}{{ t.avatar.url }}{% endif %}">
                <!-- Avatar mini -->
                <div
                    class="w-8 h-8 rounded bg-gray-900 border border-white/10 flex items-center justify-center text-[10px] text-gray-500 overflow-hidden">
                    {% if t.avatar %}<img src="{{ t.avatar.url }}" class="w-full h-full object-cover">{% else %}{{
                    t.nickname|slice:":1" }}{% endif %}
                </div>
                <div class="text-sm text-white font-mono">{{ t.nickname }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Data for JS -->
<script id="questionsData" type="application/json">
[
    {% for q in questions %}
    {
        "id": "{{ q.id }}", 
        "category": "{{ q.category|default:'' }}", 
        "text": "{{ q.title }}",
        "description": "{{ q.description|escapejs }}",
        "example": "{{ q.example|escapejs }}",
        "answer_type": "{{ q.answer_type }}",
        "choices": "{{ q.choices|escapejs }}",
        "rank": {% if q.rank %}"{{ q.rank.name }} ({{ q.rank.points }}pt)"{% else %}null{% endif %}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
]
</script>

<script>
    // --- State ---
    let currentTargetId = null;
    let questionsData = JSON.parse(document.getElementById('questionsData').textContent);

    // --- UI Elements ---
    const targetList = document.getElementById('targetList');
    const overlay = document.getElementById('noSelectionOverlay');
    const selectedName = document.getElementById('selectedName');
    const selectedAvatar = document.getElementById('selectedAvatar');
    const tabEvent = document.getElementById('tabEvent');
    const tabQuestion = document.getElementById('tabQuestion');
    const formEvent = document.getElementById('formEvent');
    const formQuestion = document.getElementById('formQuestion');
    const qCategory = document.getElementById('qCategory');
    const qSelect = document.getElementById('qSelect');
    const saveBtn = document.getElementById('saveLogBtn');

    // --- Target Selection ---
    
    // --- Timeline State ---
    const timelineContainer = document.getElementById('timelineContainer');
    const timelineContent = document.getElementById('timelineContent');
    const timelineLoading = document.getElementById('timelineLoading');
    const timelineSearch = document.getElementById('timelineSearch');
    const timelineTypeFilter = document.getElementById('timelineTypeFilter');
    
    let isFetching = false;
    let hasMore = true;
    let timelineCursorDate = null; // Track oldest date for pagination

    // --- Target Selection ---
    
    // Delegate listener on targetList
    targetList.addEventListener('click', function(e) {
        // Handle Minus Button
        const removeBtn = e.target.closest('.remove-target-btn');
        if (removeBtn) {
            e.stopPropagation();
            const id = removeBtn.dataset.id;
            const date = document.querySelector('input[name="date"]').value;
            
            if(confirm('このターゲットを本日のリストから除外しますか？')) {
                toggleTargetState(id, date, 'hide', () => {
                    location.reload(); 
                });
            }
            return;
        }

        // Handle Select
        const item = e.target.closest('.target-item');
        if (item) {
            // Deselect others
            document.querySelectorAll('.target-item').forEach(el => {
                el.classList.remove('bg-white/10', 'border-primary');
                el.querySelector('.status-indicator').classList.remove('bg-primary', 'shadow-[0_0_8px_rgba(34,197,94,0.8)]');
                el.querySelector('.status-indicator').classList.add('bg-gray-700');
            });
            item.classList.add('bg-white/10', 'border-primary');
            item.querySelector('.status-indicator').classList.remove('bg-gray-700');
            item.querySelector('.status-indicator').classList.add('bg-primary', 'shadow-[0_0_8px_rgba(34,197,94,0.8)]');

            currentTargetId = item.dataset.id;
            selectedName.textContent = item.dataset.name;
            const avatarUrl = item.dataset.avatar;
            if (avatarUrl) {
                selectedAvatar.innerHTML = `<img src="${avatarUrl}" class="w-full h-full object-cover">`;
            } else {
                selectedAvatar.innerHTML = `<div class="w-full h-full flex items-center justify-center text-xs text-gray-500">${item.dataset.name.slice(0, 1)}</div>`;
            }

            // Restore overlay hidden state
            document.getElementById('noSelectionOverlay').classList.add('hidden');
            
            // Initial Timeline Fetch
            resetTimeline();
            fetchTimeline();
        }
    });

    // --- Timeline Functions ---
    
    function resetTimeline() {
        timelineContent.innerHTML = '';
        timelineCursorDate = null;
        hasMore = true;
    }

    function fetchTimeline(append = false) {
        if (!currentTargetId || isFetching || (!hasMore && append)) return;
        
        isFetching = true;
        if (append) timelineLoading.classList.remove('hidden');

        const params = new URLSearchParams({
            target_id: currentTargetId,
            limit: 20
        });
        
        if (append && timelineCursorDate) {
            params.append('before_date', timelineCursorDate);
        }
        
        if (timelineSearch.value) params.append('search', timelineSearch.value);
        if (timelineTypeFilter.value) params.append('type', timelineTypeFilter.value);

        fetch(`{% url "timeline_list" %}?${params.toString()}`)
            .then(res => res.json())
            .then(data => {
                isFetching = false;
                timelineLoading.classList.add('hidden');
                
                if (data.success) {
                    if (data.data.length < 20) hasMore = false;
                    
                    if (data.data.length > 0) {
                        // Update cursor
                        timelineCursorDate = data.data[data.data.length - 1].date; // Use oldest date
                        
                        renderTimelineItems(data.data, append);
                    }
                }
            })
            .catch(err => {
                isFetching = false;
                console.error(err);
            });
    }

    function renderTimelineItems(items, append) {
        // Items come in newest first.
        // If append (scrolling up), we want to prepend them to the container reversely (keep oldest at very top).
        // Actually API returns Newest First. 
        // Logic:
        // Initial Load (append=false): We want newest at bottom. So we reverse the API list (Old -> New) and append to container.
        // Scroll Up (append=true): We want older items at the top. API gives Newest->Oldest of that page. 
        // We should reverse them (Oldest -> Newest of that page) and PREPEND to container.
        
        const fragment = document.createDocumentFragment();
        // Reverse to get Old -> New order for display
        const orderedItems = [...items].reverse(); 
        
        orderedItems.forEach(item => {
            const el = createTimelineElement(item);
            fragment.appendChild(el);
        });

        if (append) {
            // Prepend
            const firstChild = timelineContent.firstElementChild;
             // Maintain scroll position logic
            const oldHeight = timelineContainer.scrollHeight;
            timelineContent.insertBefore(fragment, firstChild);
            
            // Adjust scroll
            const newHeight = timelineContainer.scrollHeight;
            timelineContainer.scrollTop = newHeight - oldHeight;
        } else {
            timelineContent.appendChild(fragment);
            // Scroll to bottom
            timelineContainer.scrollTop = timelineContainer.scrollHeight;
        }
    }

    function createTimelineElement(item) {
        const div = document.createElement('div');
        div.className = 'bg-white/5 border border-white/5 rounded p-3 text-sm';
        
        let header = `<div class="flex justify-between items-start mb-1">
            <span class="font-mono text-[10px] text-gray-500">${item.date}</span>
            <span class="text-[10px] px-1.5 rounded ${item.type === 'EVENT' ? 'bg-blue-500/20 text-blue-400' : 'bg-green-500/20 text-green-400'} border border-white/10">${item.type}</span>
        </div>`;
        
        let content = '';
        if (item.type === 'QUESTION') {
            content = `
                <div class="mb-1 text-primary font-bold text-xs">Q. ${item.question_title || 'Unknown Question'}</div>
                <div class="text-gray-300 whitespace-pre-wrap">${escapeHtml(item.description)}</div>
            `;
        } else {
             content = `<div class="text-gray-300 whitespace-pre-wrap">${escapeHtml(item.description)}</div>`;
        }
        
        let footer = '';
        if (item.tags && item.tags.length > 0) {
            const tagsHtml = item.tags.map(t => `<span class="text-[10px] text-gray-500 mr-1">#${escapeHtml(t.name)}</span>`).join('');
            footer = `<div class="mt-2 pt-2 border-t border-white/5">${tagsHtml}</div>`;
        }
        
        div.innerHTML = header + content + footer;
        return div;
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Infinite Scroll
    timelineContainer.addEventListener('scroll', () => {
        if (timelineContainer.scrollTop === 0 && hasMore && !isFetching) {
            fetchTimeline(true);
        }
    });
    
    // Search & Filter
    let searchDebounce;
    timelineSearch.addEventListener('input', () => {
        clearTimeout(searchDebounce);
        searchDebounce = setTimeout(() => {
            resetTimeline();
            fetchTimeline();
        }, 500);
    });
    
    timelineTypeFilter.addEventListener('change', () => {
        resetTimeline();
        fetchTimeline();
    });

    // Remove Unfilled
    const removeUnfilledBtn = document.getElementById('removeUnfilledBtn');
    removeUnfilledBtn.addEventListener('click', function() {
        if(!confirm('未記入のターゲットを一括で除外しますか？')) return;
        
        const date = document.querySelector('input[name="date"]').value;
        let promises = [];
        // Check for unfilled icon presence
        document.querySelectorAll('.target-item').forEach(item => {
            if (item.querySelector('.fa-exclamation-circle')) { 
                const id = item.dataset.id;
                promises.push(toggleTargetState(id, date, 'hide'));
            }
        });
        
        Promise.all(promises).then(() => location.reload());
    });

    function toggleTargetState(targetId, date, action, callback) {
        return fetch('{% url "target_state_toggle" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ target_id: targetId, date: date, action: action })
        }).then(res => res.json()).then(data => {
            if(data.success && callback) callback();
            return data;
        });
    }

    // --- Tabs ---
    tabEvent.addEventListener('click', () => {
        tabEvent.classList.add('border-primary', 'bg-white/5', 'text-white');
        tabEvent.classList.remove('border-transparent', 'text-gray-500');

        tabQuestion.classList.remove('border-primary', 'bg-white/5', 'text-white');
        tabQuestion.classList.add('border-transparent', 'text-gray-500');

        formEvent.classList.remove('hidden');
        formQuestion.classList.add('hidden');
    });

    tabQuestion.addEventListener('click', () => {
        tabQuestion.classList.add('border-primary', 'bg-white/5', 'text-white');
        tabQuestion.classList.remove('border-transparent', 'text-gray-500');

        tabEvent.classList.remove('border-primary', 'bg-white/5', 'text-white');
        tabEvent.classList.add('border-transparent', 'text-gray-500');

        formQuestion.classList.remove('hidden');
        formEvent.classList.add('hidden');
    });

    // --- Add Target Modal ---
    const searchModal = document.getElementById('searchModal');
    const openSearchBtn = document.getElementById('openTargetSearch');
    const closeSearchBtn = document.getElementById('closeSearch');
    const searchInput = document.getElementById('searchInput');
    const searchListElements = document.querySelectorAll('.search-item');

    openSearchBtn.addEventListener('click', () => searchModal.classList.remove('hidden'));
    closeSearchBtn.addEventListener('click', () => searchModal.classList.add('hidden'));

    searchInput.addEventListener('input', function () {
        const term = this.value.toLowerCase();
        searchListElements.forEach(el => {
            const name = el.dataset.name.toLowerCase();
            if (name.includes(term)) el.classList.remove('hidden');
            else el.classList.add('hidden');
        });
    });

    document.getElementById('searchList').addEventListener('click', function (e) {
        const item = e.target.closest('.search-item');
        if (item) {
            const id = item.dataset.id;
            const name = item.dataset.name;
            const avatar = item.dataset.avatar;

            // Check if already in list
            let exists = false;
            document.querySelectorAll('.target-item').forEach(el => {
                if (el.dataset.id === id) exists = true;
            });

            if (!exists) {
                // Add State via AJAX
                const date = document.querySelector('input[name="date"]').value;
                toggleTargetState(id, date, 'add', () => {
                    location.reload(); // Reload to refresh list from server
                });
            } else {
                alert('すでにリストに追加されています');
            }
            searchModal.classList.add('hidden');
        }
    });

    // Question Selection Logic
    // Variables qCategory, qSelect etc are already defined at top of script
    const qDetails = document.getElementById('qDetails');
    const qRank = document.getElementById('qRank');
    const qDesc = document.getElementById('qDesc');
    const qEx = document.getElementById('qEx');
    const qChoicesCheck = document.getElementById('qChoicesCheck');
    const qChoicesContainer = document.getElementById('qChoicesContainer');
    
    // Track selected choices
    let selectedChoices = new Set();
    let currentQuestion = null;

    qCategory.addEventListener('change', (e) => {
        const cat = e.target.value;
        qSelect.innerHTML = '<option value="">質問を選択してください</option>';
        qSelect.disabled = !cat;
        
        // Reset details
        qDetails.classList.add('hidden');
        qChoicesCheck.classList.add('hidden');
        selectedChoices.clear();
        currentQuestion = null;

        if (cat) {
            // Re-filtering question list
             questionsData.filter(q => q.category === cat).forEach(q => {
                const opt = new Option(q.text, q.id);
                qSelect.add(opt);
            });
        }
    });

    qSelect.addEventListener('change', (e) => {
        const qId = e.target.value;
        const q = questionsData.find(item => item.id === qId);
        currentQuestion = q;
        selectedChoices.clear();
        
        if (q) {
            // Show Details
            qRank.textContent = q.rank || '-';
            qDesc.textContent = q.description || '-';
            qEx.textContent = q.example || '-';
            qDetails.classList.remove('hidden');

            // Handle Choices
            qChoicesContainer.innerHTML = '';
            if (q.answer_type === 'SELECTION' && q.choices) {
                qChoicesCheck.classList.remove('hidden');
                const choices = q.choices.split(',').map(c => c.trim()).filter(c => c);
                choices.forEach(c => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'choice-btn px-2 py-1 rounded-full border border-white/20 text-[10px] text-gray-300 hover:border-primary hover:text-primary transition bg-black/40';
                    btn.textContent = c;
                    btn.onclick = () => toggleChoice(btn, c);
                    qChoicesContainer.appendChild(btn);
                });
            } else {
                qChoicesCheck.classList.add('hidden');
            }
        } else {
            qDetails.classList.add('hidden');
            qChoicesCheck.classList.add('hidden');
        }
    });

    function toggleChoice(btn, value) {
        // Single Select Logic
        // Clear previous selection
        selectedChoices.clear();
        document.querySelectorAll('.choice-btn').forEach(b => {
            b.classList.remove('bg-primary/20', 'border-primary', 'text-primary');
            b.classList.add('bg-black/40', 'border-white/20', 'text-gray-300');
        });

        // Set new selection
        selectedChoices.add(value);
        btn.classList.add('bg-primary/20', 'border-primary', 'text-primary');
        btn.classList.remove('bg-black/40', 'border-white/20', 'text-gray-300');
    }

    // --- Tag Interaction ---
    const tagBtns = document.querySelectorAll('.tag-btn');
    tagBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            this.classList.toggle('border-primary');
            this.classList.toggle('text-primary');
            this.classList.toggle('bg-primary/10');
            this.classList.toggle('border-white/20');
        });
    });

    // Save Logic Update
    document.getElementById('saveLogBtn').addEventListener('click', () => {
        if (!currentTargetId) {
            alert('ターゲットを選択してください');
            return;
        }

        const activeTab = document.querySelector('button[id^="tab-"].text-primary').id;
        const payload = {
            target_id: currentTargetId,
            date: document.getElementById('logDate').value, 
            description: "",
            event_type: "NOTE",
            tags: [],
            question_id: null
        };

        if (activeTab === 'tabEvent') { 
            payload.description = document.getElementById('eventContent').value; 
            // Collect selected tags
            document.querySelectorAll('#tagSelectionArea .tag-btn.border-primary').forEach(btn => { 
               payload.tags.push(btn.dataset.id); 
            });
            // Also include contact_made if it's an event
            payload.contact_made = document.getElementById('contactFlag').checked;

            if (!payload.description && !payload.contact_made && payload.tags.length === 0) {
                alert("内容を入力するか接触フラグをONにするかタグを選択してください");
                return;
            }

        } else { // This is the question tab
            const qId = qSelect.value;
            let ans = document.getElementById('qAnswer').value;
            
            if (!qId) {
                alert('質問を選択してください');
                return;
            }
            
            // Prepend choices if any (Single select now)
            if (currentQuestion && currentQuestion.answer_type === 'SELECTION' && selectedChoices.size > 0) {
                const choice = Array.from(selectedChoices)[0]; // Single item
                ans = `[選択: ${choice}]\n${ans}`;
            }

            // Validation: Must have answer OR choice selected
            if (!ans.trim() && selectedChoices.size === 0) {
                 alert('回答を入力または選択してください');
                 return;
            }

            payload.description = ans;
            payload.event_type = 'QUESTION'; 
            payload.question_id = qId;
        }

        fetch('{% url "intelligence_log" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value, 
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // Clear inputs
                document.getElementById('eventContent').value = '';
                document.getElementById('qAnswer').value = '';
                if(activeTab === 'tabEvent') {
                    // Reset tags
                    document.querySelectorAll('.tag-btn').forEach(b => {
                         b.classList.remove('border-primary', 'text-primary', 'bg-primary/10');
                         b.classList.add('border-white/20');
                    });
                }
                
                // Refresh Timeline to show new item
                resetTimeline();
                fetchTimeline();
                
            } else {
                alert("Error: " + data.error);
            }
        });
    });

</script>
{% endblock %}