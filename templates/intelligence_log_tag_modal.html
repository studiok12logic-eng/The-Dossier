<!-- Tag Modal -->
<!-- Tag Modal -->
<div id="tagModal" class="hidden fixed inset-0 z-[60] bg-black/80 flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm transition-opacity duration-300 opacity-0 pointer-events-none">
    <div class="bg-surface border-t sm:border border-white/10 rounded-t-2xl sm:rounded-xl w-full max-w-md h-[80vh] sm:h-[600px] flex flex-col shadow-2xl transform transition-transform duration-300 translate-y-full sm:translate-y-0 scale-95 sm:scale-100">
        
        <!-- Header -->
        <div class="flex justify-between items-center p-4 border-b border-white/10">
            <h3 class="text-sm font-bold tracking-wider text-text-main">TAGS</h3>
            <button onclick="closeTagModal()" class="w-8 h-8 flex items-center justify-center text-text-sub hover:text-white rounded-full bg-white/5">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-4 space-y-6">
            
            <!-- 1. Frequently Used for Target -->
            <div id="targetTagsSection" class="hidden">
                <div id="targetTagsList" class="flex flex-wrap gap-2">
                    <!-- Loaded via JS -->
                </div>
            </div>

            <!-- 2. Create Tag -->
            <div>
                 <div class="flex gap-2">
                     <input type="text" id="newTagInput" placeholder="New tag name..." class="flex-1 bg-surface-2 border border-white/10 rounded-lg px-3 py-2 text-sm text-text-main focus:border-primary/50 focus:ring-0 outline-none">
                     <button onclick="createNewTag()" class="px-4 py-2 bg-primary/10 text-primary hover:bg-primary/20 rounded-lg text-lg font-bold transition-colors w-12 flex items-center justify-center">
                         +
                     </button>
                 </div>
            </div>

            <!-- 3. All Tags (By Frequency) -->
            <div>
                <div id="allTagsList" class="flex flex-wrap gap-2">
                    <!-- Loaded via JS -->
                    <div class="text-xs text-text-sub italic">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Footer: Select Button -->
        <div class="p-4 border-t border-white/10 bg-surface/95 backdrop-blur absolute bottom-0 w-full rounded-b-xl">
            <button onclick="confirmTagSelection()" class="w-full py-3 bg-primary text-black font-bold rounded-xl shadow-lg hover:bg-primary-light transition-transform active:scale-95">
                Select <span id="selectedCountBadge" class="ml-1 hidden bg-black/20 px-2 py-0.5 rounded-full text-xs">0</span>
            </button>
        </div>
        
        <!-- Padding for footer -->
        <div class="h-20 sm:hidden"></div> 
    </div>
</div>

<script>
    let currentSelectedTags = new Set(); // Stores Tag IDs
    let allTagsCache = [];

    const tagModal = document.getElementById('tagModal');
    
    function openTagModal() {
        tagModal.classList.remove('hidden', 'pointer-events-none');
        // Trigger reflow
        void tagModal.offsetWidth;
        tagModal.classList.remove('opacity-0');
        tagModal.firstElementChild.classList.remove('translate-y-full', 'scale-95');
        
        fetchTags();
    }

    function closeTagModal() {
        tagModal.classList.add('opacity-0', 'pointer-events-none');
        tagModal.firstElementChild.classList.add('translate-y-full', 'scale-95');
        setTimeout(() => {
            tagModal.classList.add('hidden');
        }, 300);
    }

    function fetchTags() {
        fetch(`/api/tags/?target_id=${targetId || ''}`) // targetId from global scope
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                renderTags(data.all_tags, data.target_tags);
            }
        });
    }

    function renderTags(allTags, targetTags) {
        allTagsCache = allTags;
        const targetContainer = document.getElementById('targetTagsList');
        const allContainer = document.getElementById('allTagsList');
        
        // Render Target Tags
        if(targetTags && targetTags.length > 0) {
            document.getElementById('targetTagsSection').classList.remove('hidden');
            targetContainer.innerHTML = targetTags.map(t => createTagChip(t)).join('');
        } else {
            document.getElementById('targetTagsSection').classList.add('hidden');
        }

        // Render All Tags
        allContainer.innerHTML = allTags.map(t => createTagChip(t)).join('');
        
        updateSelectedVisuals();
    }

    function createTagChip(tag) {
        const isSelected = currentSelectedTags.has(String(tag.id));
        return `
            <button onclick="toggleTagSelection('${tag.id}', this)" 
                class="tag-chip px-3 py-1.5 rounded-full border text-sm transition-all duration-200 select-none ${isSelected ? 'bg-primary text-black border-primary font-bold' : 'bg-surface-2 text-text-sub border-transparent hover:border-white/20'}"
                data-tag-id="${tag.id}">
                #${tag.name}
                <span class="text-[10px] opacity-60 ml-1">(${tag.count})</span>
            </button>
        `;
    }

    function toggleTagSelection(tagId, btn) {
        tagId = String(tagId);
        if(currentSelectedTags.has(tagId)) {
            currentSelectedTags.delete(tagId);
            btn.classList.remove('bg-primary', 'text-black', 'border-primary', 'font-bold');
            btn.classList.add('bg-surface-2', 'text-text-sub', 'border-transparent');
        } else {
            currentSelectedTags.add(tagId);
            btn.classList.remove('bg-surface-2', 'text-text-sub', 'border-transparent');
            btn.classList.add('bg-primary', 'text-black', 'border-primary', 'font-bold');
        }
        updateBadge();
        
        // Sync multiple instances of same tag (if in both lists)
        const otherBtns = document.querySelectorAll(`.tag-chip[data-tag-id="${tagId}"]`);
        otherBtns.forEach(b => {
             if(b !== btn) {
                 if(currentSelectedTags.has(tagId)) {
                     b.classList.remove('bg-surface-2', 'text-text-sub', 'border-transparent');
                     b.classList.add('bg-primary', 'text-black', 'border-primary', 'font-bold');
                 } else {
                     b.classList.remove('bg-primary', 'text-black', 'border-primary', 'font-bold');
                     b.classList.add('bg-surface-2', 'text-text-sub', 'border-transparent');
                 }
             }
        });
    }
    
    function updateSelectedVisuals() {
        document.querySelectorAll('.tag-chip').forEach(btn => {
            const tagId = String(btn.dataset.tagId);
            if(currentSelectedTags.has(tagId)) {
                 btn.classList.remove('bg-surface-2', 'text-text-sub', 'border-transparent');
                 btn.classList.add('bg-primary', 'text-black', 'border-primary', 'font-bold');
            } else {
                 btn.classList.remove('bg-primary', 'text-black', 'border-primary', 'font-bold');
                 btn.classList.add('bg-surface-2', 'text-text-sub', 'border-transparent');
            }
        });
        updateBadge();
    }

    function updateBadge() {
        const badge = document.getElementById('selectedCountBadge');
        if(currentSelectedTags.size > 0) {
            badge.innerText = currentSelectedTags.size;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }

    function createNewTag() {
        const input = document.getElementById('newTagInput');
        const name = input.value.trim();
        if(!name) return;

        // Check cache first
        const exists = allTagsCache.find(t => t.name.toLowerCase() === name.toLowerCase());
        if(exists) {
            // Select existing
            const btn = document.querySelector(`.tag-chip[data-tag-id="${exists.id}"]`);
            if(btn && !currentSelectedTags.has(String(exists.id))) {
                 toggleTagSelection(exists.id, btn);
            }
            input.value = '';
            return;
        }

        // Create via API
        fetch('/api/tags/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}' // Ensure this template has access or use cookie
            },
            body: JSON.stringify({ name: name })
        }).then(res => res.json()).then(data => {
            if(data.success) {
                const newTag = data.tag;
                // Add to cache
                allTagsCache.unshift(newTag); // Add to top? Or re-sort? Just add to top for now
                
                // Re-render All Tags logic partially or append?
                // Easiest is to append to container or clear and re-render.
                // Re-rendering all is safe.
                // But we need to make sure we select it.
                currentSelectedTags.add(String(newTag.id));
                
                // Hack: Pass updated list to render.
                // We don't have targetTags here locally unless we cached them too.
                // Using global var for targetTags?
                // Let's just append the new chip to "All Tags" and select it.
                
                const allContainer = document.getElementById('allTagsList');
                // Create chip
                const chipHTML = createTagChip(newTag);
                // Prepend or Append? User surely wants to see it. Prepend.
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = chipHTML;
                const newBtn = tempDiv.firstElementChild;
                
                // Visual select
                newBtn.classList.remove('bg-surface-2', 'text-text-sub', 'border-transparent');
                newBtn.classList.add('bg-primary', 'text-black', 'border-primary', 'font-bold');
                
                allContainer.insertBefore(newBtn, allContainer.firstChild);
                
                updateBadge();
                input.value = '';
            } else {
                alert('Error processing tag: ' + (data.error || 'Unknown error'));
            }
        }).catch(err => {
            console.error(err);
        });
    }

    function confirmTagSelection() {
        // Did not ask to append to text.
        // User requested: "Do not put tags in text".
        // We just close. The global currentSelectedTags Set is used by saveLog.
        
        // Optional: Update a visual badge on the main UI? 
        // For now, just close.
        
        updateInputState(); // Resize
        closeTagModal();
        
        // Update main button state to show active tags?
        const mainBtn = document.getElementById('toggleTagMenuBtn');
        if(mainBtn) {
            if(currentSelectedTags.size > 0) {
                mainBtn.classList.add('text-primary');
                mainBtn.classList.remove('text-text-sub');
            } else {
                mainBtn.classList.remove('text-primary');
                mainBtn.classList.add('text-text-sub');
            }
        }
    }
    
    // Override Create New Tag to just append to "Selected" list as a temp item?
    // Or actually call API to create it?
    // Actually simpler: Just append `#NewTag` to input text on Confirm?
    // Yes.
    
    document.getElementById('newTagInput').addEventListener('keypress', (e) => {
        if(e.key === 'Enter') {
             // Treat as "Select this new tag"
             // Since we don't have ID, we can't fully mimic "toggle".
             // We can just immediately add it to input? 
             // Or create a "Temp Tag" object.
        }
    });

</script>
