{% extends 'base.html' %}
{% block content %}
<div class="h-full flex flex-col p-6 space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-start">
        <div>
            <h1 class="text-2xl text-white font-mono tracking-wider">QUESTION DETAIL</h1>
            <p class="text-xs text-gray-400 font-mono mt-1">è³ªå•è©³ç´°åˆ†æ</p>
        </div>
        <a href="{% url 'question_list' %}" class="px-4 py-2 bg-white/5 hover:bg-white/10 text-gray-300 font-mono text-sm rounded border border-white/10 transition">
            â† BACK
        </a>
    </div>

    <!-- Question Selection -->
    <div class="bg-surface border border-white/10 rounded-xl p-6">
        <h3 class="text-sm font-bold text-primary font-mono mb-4">è³ªå•ã‚’é¸æŠ</h3>
        <form method="get" action="" class="flex gap-3">
            <div class="flex-1">
                <label class="block text-xs text-gray-400 mb-2">ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                <select name="category" id="categorySelect" onchange="updateQuestionList()" 
                    class="w-full bg-background border border-white/20 rounded px-3 py-2 text-sm text-white focus:border-primary focus:outline-none">
                    <option value="">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠ...</option>
                    {% for c in categories %}
                    <option value="{{ c.id }}" {% if request.GET.category == c.id|stringformat:"s" %}selected{% endif %}>{{ c.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex-1">
                <label class="block text-xs text-gray-400 mb-2">è³ªå•</label>
                <select name="question_id" id="questionSelect" onchange="this.form.submit()" disabled
                    class="w-full bg-background border border-white/20 rounded px-3 py-2 text-sm text-white focus:border-primary focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed">
                    <option value="">ã¾ãšã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
            </div>
        </form>
    </div>

    {% if question %}
    <!-- Question Info Card -->
    <div class="bg-surface border border-white/10 rounded-xl p-6">
        <div class="flex justify-between items-start mb-4">
            <div class="flex flex-wrap gap-2 items-center">
                <span class="text-xs font-mono text-primary bg-primary/10 px-2 py-1 rounded border border-primary/20">
                    {{ question.category.name|default:"Uncategorized" }}
                </span>
                {% if question.rank %}
                <span class="text-xs font-mono text-gray-300 bg-white/5 px-2 py-1 rounded border border-white/10">
                    {{ question.rank.name }} ({{ question.rank.points }}pt)
                </span>
                {% endif %}
                <span class="text-xs font-mono text-gray-400">
                    {{ question.get_answer_type_display }}
                </span>
            </div>
            <div class="text-xs text-gray-500 font-mono">
                {{ total_targets }} Targets â€¢ {{ total_answers }} Answers
            </div>
        </div>
        
        <h2 class="text-xl text-white font-bold mb-2">{{ question.title }}</h2>
        
        {% if question.description %}
        <p class="text-sm text-gray-400 mb-3">{{ question.description }}</p>
        {% endif %}
        
        {% if question.example %}
        <div class="bg-black/20 p-3 rounded border border-white/5">
            <p class="text-xs text-gray-500 font-mono">EX: {{ question.example }}</p>
        </div>
        {% endif %}
    </div>

    <!-- Filters & Sort -->
    <div class="flex gap-3">
        <form method="get" class="flex-1 bg-surface border border-white/10 rounded-lg p-4">
            <input type="hidden" name="question_id" value="{{ question.id }}">
            <input type="hidden" name="category" value="{{ request.GET.category }}">
            
            <h4 class="text-xs font-mono text-gray-400 mb-3">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h4>
            <div class="space-y-3">
                <div>
                    <label class="block text-xs text-gray-500 mb-1">ã‚°ãƒ«ãƒ¼ãƒ—</label>
                    <select name="group" class="w-full bg-background border border-white/20 rounded px-3 py-2 text-sm text-white focus:border-primary">
                        <option value="">ã™ã¹ã¦ã®ã‚°ãƒ«ãƒ¼ãƒ—</option>
                        {% for g in groups %}
                        <option value="{{ g.id }}" {% if request.GET.group == g.id|stringformat:"s" %}selected{% endif %}>{{ g.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 px-3 py-2 bg-primary/20 hover:bg-primary/30 text-primary text-xs font-mono rounded border border-primary/30 transition">
                        é©ç”¨
                    </button>
                    <a href="?question_id={{ question.id }}&category={{ request.GET.category }}" 
                       class="px-3 py-2 bg-white/5 hover:bg-white/10 text-gray-400 text-xs font-mono rounded border border-white/10 transition">
                        ãƒªã‚»ãƒƒãƒˆ
                    </a>
                </div>
            </div>
        </form>

        <form method="get" class="flex-1 bg-surface border border-white/10 rounded-lg p-4">
            <input type="hidden" name="question_id" value="{{ question.id }}">
            <input type="hidden" name="category" value="{{ request.GET.category }}">
            <input type="hidden" name="group" value="{{ request.GET.group }}">
            
            <h4 class="text-xs font-mono text-gray-400 mb-3">ä¸¦ã³æ›¿ãˆ</h4>
            <div class="space-y-3">
                <select name="sort" onchange="this.form.submit()" class="w-full bg-background border border-white/20 rounded px-3 py-2 text-sm text-white focus:border-primary">
                    <option value="date" {% if request.GET.sort == 'date' or not request.GET.sort %}selected{% endif %}>æœ€æ–°ãƒ­ã‚°é †</option>
                    <option value="choice" {% if request.GET.sort == 'choice' %}selected{% endif %}>é¸æŠè‚¢é †</option>
                    <option value="count" {% if request.GET.sort == 'count' %}selected{% endif %}>å›ç­”æ•°é †</option>
                </select>
            </div>
        </form>
    </div>

    <!-- Answer List -->
    <div class="flex-1 overflow-y-auto space-y-3 pb-20">
        {% for item in answer_data %}
        <div class="bg-surface border border-white/10 rounded-xl overflow-hidden">
            <!-- Target Header -->
            <div class="p-4 flex justify-between items-center border-b border-white/5 bg-white/5">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-background border border-white/10 overflow-hidden">
                        {% if item.target.avatar %}
                        <img src="{{ item.target.avatar.url }}" class="w-full h-full object-cover">
                        {% else %}
                        <div class="w-full h-full flex items-center justify-center text-xs text-gray-500">{{ item.target.nickname|slice:":1" }}</div>
                        {% endif %}
                    </div>
                    <div>
                        <div class="text-sm text-white font-mono">{{ item.target.nickname }}</div>
                        <div class="text-xs text-gray-500">{{ item.target.last_name }} {{ item.target.first_name }}</div>
                    </div>
                </div>
                <div class="text-xs text-gray-500 font-mono">
                    {{ item.answer_count }} å›ç­”
                </div>
            </div>

            <!-- Latest Answer -->
            <div class="p-4">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs text-gray-500 font-mono">{{ item.latest_answer.date }}</span>
                    {% if item.latest_answer.contact_made %}
                    <span class="text-xs px-2 py-0.5 rounded bg-green-500/20 text-green-400 border border-green-500/30">Encanto</span>
                    {% endif %}
                </div>
                <p class="text-sm text-gray-300 whitespace-pre-wrap">{{ item.latest_answer.question_answer }}</p>
                
                {% if item.latest_answer.tags.all %}
                <div class="mt-2 flex flex-wrap gap-1">
                    {% for tag in item.latest_answer.tags.all %}
                    <span class="text-xs text-gray-500">#{{ tag.name }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- History Accordion -->
            {% if item.answer_count > 1 %}
            <div class="border-t border-white/5">
                <button onclick="toggleHistory(this)" class="w-full p-3 text-xs text-gray-400 hover:text-white transition flex items-center justify-center gap-2 bg-white/5 hover:bg-white/10">
                    <span>{{ item.answer_count|add:"-1" }} ä»¶ã®éå»å›ç­”ã‚’è¡¨ç¤º</span>
                    <svg class="w-3 h-3 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <div class="hidden history-content border-t border-white/5">
                    {% for answer in item.all_answers %}
                    {% if not forloop.first %}
                    <div class="p-4 border-t border-white/5 bg-black/10">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-xs text-gray-500 font-mono">{{ answer.date }}</span>
                            {% if answer.contact_made %}
                            <span class="text-xs px-2 py-0.5 rounded bg-green-500/20 text-green-400 border border-green-500/30">Encanto</span>
                            {% endif %}
                        </div>
                        <p class="text-sm text-gray-400 whitespace-pre-wrap">{{ answer.question_answer }}</p>
                        
                        {% if answer.tags.all %}
                        <div class="mt-2 flex flex-wrap gap-1">
                            {% for tag in answer.tags.all %}
                            <span class="text-xs text-gray-500">#{{ tag.name }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% empty %}
        <div class="text-center py-20">
            <p class="text-gray-500 font-mono">ã“ã®è³ªå•ã¸ã®å›ç­”ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- No Question Selected -->
    <div class="flex-1 flex items-center justify-center">
        <div class="text-center">
            <div class="text-6xl mb-4 opacity-20">ğŸ“Š</div>
            <p class="text-gray-500 font-mono">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¨è³ªå•ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        </div>
    </div>
    {% endif %}
</div>

<script>
    const questionsData = {{ questions|safe }};
    
    function updateQuestionList() {
        const categoryId = document.getElementById('categorySelect').value;
        const questionSelect = document.getElementById('questionSelect');
        
        questionSelect.innerHTML = '<option value="">è³ªå•ã‚’é¸æŠ...</option>';
        
        if (!categoryId) {
            questionSelect.disabled = true;
            questionSelect.innerHTML = '<option value="">ã¾ãšã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            return;
        }
        
        questionSelect.disabled = false;
        
        // Filter questions by category
        const filteredQuestions = questionsData.filter(q => q.category_id == categoryId);
        
        filteredQuestions.forEach(q => {
            const option = document.createElement('option');
            option.value = q.id;
            option.textContent = q.title;
            questionSelect.appendChild(option);
        });
    }
    
    function toggleHistory(btn) {
        const content = btn.nextElementSibling;
        const icon = btn.querySelector('svg');
        
        content.classList.toggle('hidden');
        icon.classList.toggle('rotate-180');
    }
    
    // Initialize on page load
    if (document.getElementById('categorySelect').value) {
        updateQuestionList();
        const qId = new URLSearchParams(window.location.search).get('question_id');
        if (qId) {
            document.getElementById('questionSelect').value = qId;
        }
    }
</script>
{% endblock %}
