{% extends "mobile/base_mobile.html" %}

{% block title %}Targets{% endblock %}

{% block content %}
<div class="flex flex-col h-full bg-background pb-20"> 
    
    <!-- Header -->
    <!-- Header -->
    <header class="h-14 px-4 flex items-center justify-between border-b border-white/10 bg-surface/95 backdrop-blur sticky top-0 z-30">
        <span class="text-xs font-bold text-text-sub uppercase tracking-wider">TARGETS</span>
        <div class="flex items-center gap-2">
            <button onclick="toggleSearch()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/5 text-text-sub transition-colors">
                <i class="fas fa-search"></i>
            </button>
            <button onclick="openAddModal()" class="w-8 h-8 flex items-center justify-center rounded-full bg-primary/10 text-primary border border-primary/20 hover:bg-primary/20 transition-colors">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </header>

    <!-- Search Bar (Hidden by default) -->
    <div id="searchBar" class="hidden px-4 py-2 bg-surface border-b border-white/10 sticky top-14 z-40 animate-slide-down">
        <form method="get" action="." class="flex gap-2">
            <div class="relative flex-1">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-text-sub text-xs"></i>
                <input type="text" name="q" value="{{ request.GET.q }}" placeholder="Search (Name, Kana)..." 
                       class="w-full bg-background border border-white/10 rounded-full pl-9 pr-4 py-2 text-xs text-text-main placeholder-text-sub/50 focus:border-primary outline-none">
            </div>
        </form>
    </div>

    <!-- Filter (Group) -->
    <div class="px-4 py-3">
        <select onchange="window.location.href='?group='+this.value" class="w-full bg-surface border border-white/10 rounded-lg text-xs text-text-sub px-3 py-2 outline-none focus:border-primary">
            <option value="">グループ検索</option> <!-- "Group Search" label -->
            {% for g in groups %}
            <option value="{{ g.id }}" {% if request.GET.group|add:"0" == g.id %}selected{% endif %}>{{ g.name }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- List -->
    <div class="flex-1 overflow-y-auto px-4 space-y-4">
        {% for target in targets %}
        <!-- Card -->
        <div class="bg-surface border border-white/5 rounded-xl p-4 hover:border-primary/50 transition-all group relative overflow-hidden flex flex-col mb-2 active:scale-[0.99]"
             onclick="window.location.href='{% url 'target_detail' %}?target_id={{ target.pk }}';"
             oncontextmenu="showContextMenu(event, '{{ target.pk }}')">
            
            <!-- 1. Header Row: Rank, Points, Count, Last Contact -->
            <div class="flex items-center gap-3 mb-3 text-[10px] font-mono border-b border-white/5 pb-2 -mx-4 px-4 bg-white/[0.02]">
                {% with pts=target.total_points|default:0 %}
                <span class="font-bold flex items-center gap-1">
                    {% if pts >= 100 %}
                    <i class="fas fa-crown text-purple-400"></i> <span class="text-purple-400">PLATINUM</span>
                    {% elif pts >= 61 %}
                    <i class="fas fa-crown text-yellow-500"></i> <span class="text-yellow-500">GOLD</span>
                    {% elif pts >= 31 %}
                    <i class="fas fa-medal text-gray-300"></i> <span class="text-gray-300">SILVER</span>
                    {% elif pts >= 1 %}
                    <i class="fas fa-medal text-amber-700"></i> <span class="text-amber-700">BRONZE</span>
                    {% else %}
                    <span class="text-text-sub opacity-50">NO RANK</span>
                    {% endif %}
                </span>
                
                <span class="text-text-sub flex items-center gap-1">
                    <i class="fas fa-star text-yellow-500/50"></i> {{ pts }}pt
                </span>
                <span class="text-text-sub flex items-center gap-1">
                    <i class="fas fa-comment text-blue-400/50"></i> {{ target.log_count }}
                </span>

                <!-- Last Contact (Right Aligned) -->
                <span class="text-text-sub flex items-center gap-1 ml-auto">
                    <i class="fas fa-history text-emerald-500/50"></i> 
                    {% if target.last_contact %}{{ target.last_contact|date:"Y/m/d" }}{% else %}-{% endif %}
                </span>
                {% endwith %}
            </div>

            <!-- 2. Main content: Icon + Info -->
            <div class="flex items-start gap-4">
                <!-- Icon (10vw) -->
                <div class="rounded-full bg-background border border-white/10 overflow-hidden shrink-0 shadow-lg relative"
                     style="width: 10vw; height: 10vw; min-width: 40px; min-height: 40px;">
                    {% if target.avatar %}
                    <img src="{{ target.avatar.url }}" class="w-full h-full object-cover">
                    {% else %}
                    <div class="w-full h-full flex items-center justify-center text-xs font-bold text-text-sub bg-surface-2">
                        {{ target.nickname|slice:":1" }}
                    </div>
                    {% endif %}
                </div>

                <!-- Info -->
                <div class="flex-1 min-w-0">
                    <div class="flex flex-col">
                        <!-- Name & Nickname -->
                        <div class="text-[10px] text-text-sub leading-none mb-0.5 opacity-70">
                            {{ target.last_name }} {{ target.first_name }}
                        </div>
                        <div class="text-base font-bold text-text-main truncate leading-tight">
                            {{ target.nickname }}
                        </div>
                        <!-- Group -->
                        <div class="mt-1 flex flex-wrap gap-1">
                            {% for group in target.groups.all %}
                            <span class="text-[9px] text-primary bg-primary/10 px-1.5 py-0.5 rounded border border-primary/20">
                                {{ group.name }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Latest Log Message -->
            {% if target.latest_msg_content %}
            <div class="mt-3 pt-2 border-t border-white/5">
                <p class="text-[10px] text-text-sub/80 line-clamp-2 italic">
                    <i class="fas fa-quote-left mr-1 opacity-50"></i>
                    {{ target.latest_msg_content }}
                </p>
            </div>
            {% endif %}

        </div>
        {% empty %}
        <div class="text-center py-10 opacity-50 text-sm">
            <p>No targets found.</p>
        </div>
        {% endfor %}
    </div>

</div>

<!-- Context Menu Modal -->
<div id="contextMenu" class="fixed inset-0 z-[60] hidden bg-black/60 backdrop-blur-sm transition-opacity" onclick="hideContextMenu()">
    <div class="absolute bottom-0 left-0 right-0 bg-surface rounded-t-xl overflow-hidden animate-slide-up pb-safe border-t border-white/10">
        <div class="p-4 border-b border-white/10 text-center">
            <span class="text-sm font-bold text-text-sub">Options</span>
        </div>
        <div class="flex flex-col">
            <button onclick="goToLog()" class="p-4 text-left hover:bg-white/5 active:bg-white/10 flex items-center gap-4 border-b border-white/5">
                <div class="w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-400 border border-blue-500/20"><i class="fas fa-file-alt"></i></div>
                <div class="flex flex-col">
                    <span class="font-bold text-text-main">Create Log</span>
                    <span class="text-[10px] text-text-sub">Add a new intelligence log</span>
                </div>
            </button>
            <button onclick="goToEdit()" class="p-4 text-left hover:bg-white/5 active:bg-white/10 flex items-center gap-4 border-b border-white/5">
                <div class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-text-sub border border-white/10"><i class="fas fa-cog"></i></div>
                <div class="flex flex-col">
                    <span class="font-bold text-text-main">Edit Target</span>
                    <span class="text-[10px] text-text-sub">Update profile information</span>
                </div>
            </button>
        </div>
        <div class="p-2">
            <button class="w-full py-3 text-center text-xs font-bold text-text-sub bg-white/5 rounded-lg active:bg-white/10" onclick="hideContextMenu()">Cancel</button>
        </div>
    </div>
</div>

<script>
    function toggleSearch() {
        const bar = document.getElementById('searchBar');
        bar.classList.toggle('hidden');
    }

    // Context Menu Logic
    let currentTargetId = null;
    const contextMenu = document.getElementById('contextMenu');

    function showContextMenu(e, id) {
        e.preventDefault();
        e.stopPropagation(); // prevent click
        currentTargetId = id;
        contextMenu.classList.remove('hidden');
        if(navigator.vibrate) navigator.vibrate(50);
    }

    function hideContextMenu() {
        contextMenu.classList.add('hidden');
        currentTargetId = null;
    }
    
    function goToLog() {
        if(currentTargetId) window.location.href = "{% url 'intelligence_log' %}?target_id=" + currentTargetId;
    }
    
    function goToEdit() {
        // Need to check urls.py for edit path. Assuming /targets/<pk>/edit/ or similar.
        // Actually, let's use the standard URL pattern if possible.
        // But in JS I can't easily reverse. I'll guess standard or use data attribute.
        // Better: store URLs in data attributes on the card? 
        // For now hardcode typical pattern
        if(currentTargetId) window.location.href = "/targets/" + currentTargetId + "/edit/"; 
    }

    function openAddModal() {
        window.location.href = "{% url 'target_add' %}";
    }

    // Slide up animation style
    const style = document.createElement('style');
    style.innerHTML = `
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slide-up 0.2s ease-out; }
        @keyframes slide-down { from { transform: translateY(-10px); opacity:0; } to { transform: translateY(0); opacity:1; } }
        .animate-slide-down { animation: slide-down 0.2s ease-out; }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}
