{% extends "mobile/base_mobile.html" %}

{% block title %}Targets{% endblock %}

{% block content %}
<div class="flex flex-col h-full bg-background pb-20"> <!-- Padding for bottom nav -->
    
    <!-- Header -->
    <header class="h-14 px-4 flex items-center justify-between border-b border-white/10 bg-surface/90 backdrop-blur-xl sticky top-0 z-50">
        <h1 class="text-lg font-bold text-text-main tracking-wide">TARGETS</h1>
        <a href="{% url 'target_add' %}" class="w-12 h-12 flex items-center justify-center rounded-full bg-white text-black shadow-lg hover:scale-105 transition">
            <i class="fas fa-plus text-lg"></i>
        </a>
    </header>

    <!-- List -->
    <div class="flex-1 overflow-y-auto p-4 space-y-3">
        {% for target in targets %}
        <div class="bg-surface border border-white/5 rounded-xl p-4 hover:border-primary/50 transition-all group relative overflow-hidden flex flex-col h-full mb-4">
            <!-- Header Bar (Rank & Last Contact) -->
            <div class="flex justify-between items-center bg-white/5 -mx-4 -mt-4 mb-4 px-4 py-2 border-b border-white/5">
                <!-- Left: Rank & Stats -->
                <div class="flex items-center gap-3 text-[10px] font-mono">
                    <span class="text-yellow-500 font-bold flex items-center gap-1">
                        <i class="fas fa-crown"></i> ゴールド
                    </span>
                    <span class="text-text-sub flex items-center gap-1">
                        <i class="fas fa-star text-gray-600"></i> 30pt
                    </span>
                    <span class="text-text-sub flex items-center gap-1">
                        <i class="fas fa-comment text-gray-600"></i> 3
                    </span>
                </div>
                <!-- Right: Last Contact -->
                <div class="flex items-center gap-2 text-[10px] font-mono text-text-sub">
                    <i class="fas fa-history text-emerald-500"></i>
                    <span>{% if target.last_contact %}{{ target.last_contact|date:"Y-m-d" }}{% else %}-{% endif %}</span>
                </div>
            </div>

            <!-- Inner Card Content (Flex Grow) -->
            <div class="flex items-start gap-4 flex-1">
                <!-- Left Column: Avatar Only -->
                <div class="flex flex-col gap-2 items-center shrink-0">
                    <!-- Avatar (Fixed 100px for mobile optimization) -->
                    <div class="rounded-full bg-background border border-white/10 overflow-hidden relative shadow-lg shrink-0" 
                         style="width: 100px; height: 100px; min-width: 100px; min-height: 100px;">
                        {% if target.avatar %}
                        <img src="{{ target.avatar.url }}" class="w-full h-full object-cover avatar-icon-img">
                        {% else %}
                        <div class="w-full h-full flex items-center justify-center text-4xl text-text-sub">{{ target.nickname|slice:":1" }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Right Column: Detailed Info -->
                <div class="flex-1 min-w-0 flex flex-col gap-2">
                    <div>
                        <!-- Line 1: Name (Small, No Age) -->
                        <div class="text-[9px] text-text-sub leading-none mb-1">
                            {{ target.last_name }} {{ target.first_name }}
                        </div>

                        <!-- Line 2: Nickname (Big, No Label) -->
                        <div class="text-xl font-bold text-text-main font-mono truncate mb-2 leading-none tracking-tight">
                            {{ target.nickname }}
                        </div>

                        <!-- Line 3: Group Badge (Friendly) -->
                        <div class="flex flex-wrap gap-1 mb-3">
                            {% for group in target.groups.all %}
                            <span class="px-2 py-0.5 rounded-full border border-blue-500/30 bg-blue-500/10 text-blue-400 text-[10px] font-mono shadow-[0_0_5px_rgba(59,130,246,0.3)]">
                                {{ group.name }}
                            </span>
                            {% empty %}
                            <!-- No Group -->
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Line 4: Info Grid (2x2) -->
                    <div class="grid grid-cols-2 gap-px bg-white/10 border border-white/10 rounded overflow-hidden mt-auto">
                        <!-- Box 1: BIRTH -->
                        <div class="bg-background/80 p-1.5 flex flex-col justify-center">
                            <div class="text-[9px] text-primary font-bold flex items-center gap-1 mb-0.5">
                                <i class="fas fa-calendar-alt"></i> BIRTH:
                            </div>
                            <div class="text-[10px] text-text-main font-mono leading-none">
                                {% if target.birth_month %}{{ target.birth_year }}/{{ target.birth_month }}/{{ target.birth_day }}{% else %}-{% endif %}
                                {% if target.age %}({{ target.age }}){% endif %}
                            </div>
                        </div>

                        <!-- Box 2: SIGN -->
                        <div class="bg-background/80 p-1.5 flex flex-col justify-center">
                            <div class="text-[9px] text-primary font-bold flex items-center gap-1 mb-0.5">
                                <i class="fas fa-star"></i> SIGN:
                            </div>
                            <div class="text-[10px] text-text-main font-mono leading-none">
                                {{ target.zodiac_hiragana|default:"-" }} / {{ target.eto|default:"-" }}
                            </div>
                        </div>

                        <!-- Box 3: BIO -->
                        <div class="bg-background/80 p-1.5 flex flex-col justify-center">
                            <div class="text-[9px] text-primary font-bold flex items-center gap-1 mb-0.5">
                                <i class="fas fa-dna"></i> TYPE:
                            </div>
                            <div class="text-[10px] text-text-main font-mono leading-none">
                                {{ target.gender_symbol }} / {% if target.blood_type %}{{ target.blood_type }}型{% else %}?{% endif %}
                            </div>
                        </div>

                        <!-- Box 4: ORIGIN -->
                        <div class="bg-background/80 p-1.5 flex flex-col justify-center">
                            <div class="text-[9px] text-primary font-bold flex items-center gap-1 mb-0.5">
                                <i class="fas fa-map-marker-alt"></i> ORIGIN:
                            </div>
                            <div class="text-[10px] text-text-main font-mono leading-none truncate">
                                {{ target.birthplace|default:"Unknown" }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card Footer: Actions (Bottom) -->
            <div class="mt-4 pt-3 border-t border-white/5 flex justify-between items-center bg-black/20 -mx-4 -mb-4 px-4 py-2">
                 <!-- Left: EDIT -->
                 <a href="{% url 'target_edit' target.pk %}" 
                    class="px-3 py-1 bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white border border-white/10 rounded text-[10px] font-bold transition flex items-center gap-1 shadow-sm">
                    <i class="fas fa-pencil-alt text-[9px]"></i> EDIT
                 </a>
                 
                 <!-- Right: LOG, DETAIL -->
                 <div class="flex gap-2">
                    <a href="{% url 'target_detail' %}?target_id={{ target.pk }}" 
                       class="px-3 py-1 bg-purple-500/10 hover:bg-purple-500/20 text-purple-400 hover:text-purple-300 border border-purple-500/30 rounded text-[10px] font-bold transition flex items-center gap-1 shadow-sm">
                       <i class="fas fa-chart-bar text-[9px]"></i> DETAIL
                    </a>
                    <a href="{% url 'intelligence_log' %}?target_id={{ target.pk }}" 
                       class="px-3 py-1 bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 hover:text-blue-300 border border-blue-500/30 rounded text-[10px] font-bold transition flex items-center gap-1 shadow-sm">
                       <i class="fas fa-file-alt text-[9px]"></i> LOG
                    </a>
                 </div>
            </div>
        </div>
        {% empty %}
        <div class="text-center py-10 opacity-50">
            <p>No targets yet.</p>
        </div>
        {% endfor %}
    </div>

</div>

<!-- Context Menu Modal (Hidden by default) -->
<div id="contextMenu" class="fixed inset-0 z-50 hidden bg-black/60 backdrop-blur-sm" onclick="hideContextMenu()">
    <div class="absolute bottom-0 left-0 right-0 bg-surface rounded-t-xl overflow-hidden animate-slide-up pb-safe">
        <div class="p-4 border-b border-white/10 text-center">
            <span class="text-sm font-bold opacity-70">Options</span>
        </div>
        <div class="flex flex-col">
            <button onclick="goToLog()" class="p-4 text-left hover:bg-white/5 flex items-center gap-3 border-b border-white/5">
                <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary"><i class="fas fa-pen"></i></div>
                <span>Create Log</span>
            </button>
            <button onclick="goToEdit()" class="p-4 text-left hover:bg-white/5 flex items-center gap-3 border-b border-white/5">
                <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center"><i class="fas fa-cog"></i></div>
                <span>Edit Target</span>
            </button>
        </div>
        <button class="w-full p-4 text-center text-text-sub bg-surface active:bg-white/5" onclick="hideContextMenu()">Cancel</button>
    </div>
</div>

<script>
    let currentTargetId = null;
    const contextMenu = document.getElementById('contextMenu');

    function showContextMenu(e, id) {
        e.preventDefault();
        currentTargetId = id;
        contextMenu.classList.remove('hidden');
        // Vibrate if supported
        if(navigator.vibrate) navigator.vibrate(50);
    }

    function hideContextMenu() {
        contextMenu.classList.add('hidden');
        currentTargetId = null;
    }
    
    function goToLog() {
        if(currentTargetId) window.location.href = "{% url 'intelligence_log' %}?target_id=" + currentTargetId;
    }
    
    function goToEdit() {
        // Need to fix this URL pattern to match updated urls.py later
        if(currentTargetId) window.location.href = "/targets/" + currentTargetId + "/edit/"; 
    }
    
    // Add slide-up animation
    const style = document.createElement('style');
    style.innerHTML = `
        @keyframes slide-up {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .animate-slide-up { animation: slide-up 0.2s ease-out; }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}
