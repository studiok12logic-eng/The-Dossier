{% extends "mobile/base_mobile.html" %}

{% block title %}{{ target.nickname }} - Log{% endblock %}



{% block bottom_nav %}{% endblock %}

{% block content %}
<div class="fixed inset-0 flex flex-col bg-background overflow-hidden">

    <!-- 1. Header (Minimalist) -->
    <header class="h-14 px-4 flex items-center justify-between border-b border-white/10 bg-surface z-30 shrink-0 sticky top-0">
        <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href='{% url 'target_detail' %}?target_id={{ target.id }}'">
            <button class="w-10 h-10 flex items-center justify-center text-text-sub hover:text-white rounded-full hover:bg-white/5 active:bg-white/10" onclick="event.stopPropagation(); window.location.href='{% url 'intelligence_log' %}'">
                <i class="fas fa-chevron-left text-lg"></i>
            </button>
            
            <div class="flex items-center gap-2">
                 <div class="w-8 h-8 rounded-full bg-surface-2 border border-white/10 overflow-hidden">
                     {% if target.avatar %}
                        <img src="{{ target.avatar.url }}" class="w-full h-full object-cover avatar-icon-img">
                     {% else %}
                        <div class="w-full h-full flex items-center justify-center text-xs font-bold">{{ target.nickname|slice:":1" }}</div>
                     {% endif %}
                 </div>
                 <div>
                     <h1 class="font-bold text-sm text-text-main leading-tight">{{ target.nickname }}</h1>
                     <span class="text-[10px] text-text-sub block leading-none opacity-70">
                        Last: {% if target.last_contact %}{{ target.last_contact|date:"m/d" }}{% else %}-{% endif %}
                    </span>
                 </div>
            </div>
        </div>
        
        <div class="flex items-center gap-1">
             <!-- Date Picker (Visible Input style) -->
            <div class="bg-white/5 rounded-lg h-9 border border-white/10 hover:bg-white/10 transition-colors flex items-center mr-1">
                <input type="date" id="datePicker"
                       value="{{ today_date|date:'Y-m-d' }}" 
                       class="bg-transparent border-none text-text-main font-mono text-xs h-full px-2 focus:ring-0 cursor-pointer"
                       style="color-scheme: dark; width: auto; min-width: 125px;">
            </div>
            
            <!-- Search Toggle -->
            <button id="searchToggleBtn" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-white/5 text-text-sub">
                <i class="fas fa-search text-lg"></i>
            </button>
        </div>
    </header>
    
    <!-- Search Bar (Hidden by default, slide interaction) -->
    <div id="searchPopover" class="hidden px-4 py-2 bg-surface border-b border-white/10 sticky top-14 z-20 animate-slide-down">
         <div class="relative">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-text-sub text-xs"></i>
            <input type="text" id="timelineSearchInput" placeholder="Search logs..." class="w-full bg-background border border-white/10 rounded-full pl-9 pr-4 py-2 text-xs text-text-main placeholder-text-sub/50 focus:border-primary outline-none" autocomplete="off">
        </div>
    </div>

    <!-- 2. Timeline Area -->
    <div id="timelineContainer" class="flex-1 overflow-y-auto bg-black scroll-smooth pb-32">
        {% for group in timeline_items %}
            {% with date_str=group.date_str %}
            <!-- Active Section -->
            <div class="transition-colors duration-500" {% if date_str == today_date|date:'Y-m-d' %}id="activeDateSection" style="background-color: #10b98130;"{% endif %}>
                
                <!-- Separator -->
                <div class="flex items-center justify-center py-4 opacity-50">
                    <div class="h-px bg-white/10 w-12"></div>
                    <div class="flex items-center mx-2 font-mono text-[10px] text-text-sub">
                        <!-- Check specific day for contact -->
                        {% if group.has_contact %}
                            <i class="fas fa-handshake text-primary text-xs mx-1"></i>
                        {% endif %}
                        <span>{{ group.date|date:"Y/m/d" }}</span>
                    </div>
                    <div class="h-px bg-white/10 w-12"></div>
                </div>

                <!-- Items -->
                <div class="px-2 space-y-1">
                {% for item in group.items %} 
                    <!-- Date Header if different from Occurrence Date (and Changed) -->
                    {% if item.created_at|date:"Y-m-d" != date_str %}
                        {% ifchanged item.created_at|date:"Y-m-d" %}
                        <div class="flex justify-start pl-1 mb-1">
                            <span class="text-[9px] font-mono text-text-sub opacity-70">{{ item.created_at|date:"Y/m/d" }}</span>
                        </div>
                        {% endifchanged %}
                    {% endif %}

                    <div class="timeline-item flex gap-1 text-text-main group relative justify-start items-end mb-4" id="log-{{ item.id }}" data-log-id="{{ item.id }}" data-log-content="{{ item.content }}">
                        
                        <!-- Content Bubble (Left, Max 90%) -->
                        <div class="timeline-content-bubble bg-surface-2 rounded-2xl rounded-tl-none px-3 relative active:scale-[0.98] transition-transform select-none" style="max-width: 90%;">
                           {% if item.type == 'Question' %}
                           <div class="font-bold text-xs text-primary mb-1 border-b border-primary/20 pb-1">{{ item.question_text|default:'Question' }}</div>
                           {% endif %}
                           
                           <div class="text-sm whitespace-pre-wrap leading-relaxed break-words">{{ item.content }}</div>

                           <!-- Explicit Tags (Below Message, Tight Spacing) -->
                           {% if item.tags.all %}
                           <div class="mt-1 flex flex-wrap gap-1">
                               {% for tag in item.tags.all %}
                               <button onclick="searchForTag('{{ tag.name }}'); event.stopPropagation();" class="inline-block bg-surface px-2 py-0.5 rounded-full text-[10px] font-mono text-text-sub border border-white/10 hover:border-primary/50 transition-colors text-left">#{{ tag.name }}</button>
                               {% endfor %}
                           </div>
                           {% endif %}
                           
                           <!-- Image Grid -->
                           {% with image_list=item.images.all %}
                           {% if image_list %}
                           <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; width: 100%; margin-top: 4px;">
                               {% for img in image_list %}
                               <div class="relative w-full cursor-pointer overflow-hidden rounded-md active:opacity-80 transition-opacity lightbox-trigger" 
                                    data-src="{{ img.image.url }}"
                                    data-gallery='[{% for i in image_list %}"{{ i.image.url }}"{% if not forloop.last %},{% endif %}{% endfor %}]'
                                    data-index="{{ forloop.counter0 }}"
                                    onclick="handleLightboxClick(this)"
                                    style="aspect-ratio: 1.618/1;">
                                   <img src="{{ img.image.url }}" class="w-full h-full object-cover pointer-events-none">
                               </div>
                               {% endfor %}
                           </div>
                           {% endif %}
                           {% endwith %}
                        </div>

                        <!-- Time / Icon Column (Right, Bottom Aligned with Bubble) -->
                        <div class="flex flex-col justify-end items-start gap-0.5" style="min-width: 40px;">
                            <!-- Contact Icon -->
                            {% if item.contact_made %}
                            <i class="fas fa-handshake text-primary text-[10px] opacity-80"></i>
                            {% endif %}
                            
                            <!-- Time -->
                            <span class="text-[9px] font-mono text-text-sub opacity-50 whitespace-nowrap">{{ item.created_at|date:"H:i" }}</span>
                        </div>

                    </div>
                {% endfor %}
                </div>
            </div>
            {% endwith %}
        {% empty %}
             <div id="emptyState" class="text-center py-10 opacity-50">
                 <p>No logs found.</p>
             </div>
        {% endfor %}
    </div>

    <!-- 3. Chat Input Bar -->
    <div id="chatInputBar" class="fixed bottom-0 left-0 right-0 bg-surface border-t border-white/10 z-40 pb-safe transition-all duration-100 ease-out">
        <div class="p-2 flex items-center gap-2 bg-surface">
            <!-- Tools Left -->
             <div id="toolsLeft" class="flex items-center gap-1 transition-all duration-300 overflow-hidden">
                 <!-- Tag -->
                <button id="toggleTagMenuBtn" class="w-10 h-10 flex items-center justify-center text-text-sub hover:text-primary transition rounded-full active:bg-white/5 shrink-0">
                    <i class="fas fa-hashtag text-lg"></i>
                </button>
                <!-- Image -->
                <button id="uploadImageBtn" class="w-10 h-10 flex items-center justify-center text-text-sub hover:text-primary transition rounded-full active:bg-white/5 shrink-0">
                    <i class="far fa-image text-lg"></i>
                </button>
                 <!-- Contact -->
                <button id="contactFlagBtn" class="w-10 h-10 flex items-center justify-center text-primary bg-primary/10 border border-primary/30 transition rounded-full active:bg-white/5 shrink-0">
                    <i class="fas fa-handshake text-lg"></i>
                </button>
             </div>
             
             <!-- Expand Trigger (Hidden by default) -->
             <button id="toolsCollapseBtn" class="w-8 h-10 hidden items-center justify-center text-text-sub hover:text-primary transition active:scale-90">
                 <i class="fas fa-chevron-right"></i>
             </button>
    
            <!-- Input -->
            <div class="flex-1 relative">
                <textarea id="chatInput" rows="1" class="w-full bg-surface-2 text-text-main placeholder-text-sub/50 border border-white/10 focus:border-primary/50 focus:ring-0 rounded-xl py-2 px-3 resize-none transition-all duration-200 leading-normal" style="min-height: 40px; max-height: 120px; vertical-align: middle;" placeholder="Message..." autocomplete="off"></textarea>
            </div>
            
            <!-- Submit (Only visible when typing usually, or always detail?) -->
            <!-- MOVED Question Modal Trigger here (replacing actionIconDetail) -->
            <div>
                 <button id="saveLogBtn" class="w-10 h-10 flex items-center justify-center rounded-full bg-surface-2 text-primary transition-all shadow-lg active:scale-95">
                    <!-- Default: Question Icon (instead of Ellipsis) -->
                    <i id="actionIconDetail" class="far fa-question-circle text-lg"></i>
                    <!-- Active: Send Icon (Paper Plane) -->
                    <i id="actionIconSend" class="fas fa-paper-plane text-lg hidden translate-x-[-1px] translate-y-[1px]" style="display: none;"></i>
                </button>
            </div>
            
            <!-- Hidden inputs -->
            <input type="checkbox" id="contactFlag" class="hidden" checked>
            <input type="file" id="imageInput" class="hidden" accept="image/*" multiple>
        </div>
    </div>

</div>

<!-- Answer Modal -->
{% include "intelligence_log_answer_modal.html" %} 
<!-- Tag Modal -->
{% include "intelligence_log_tag_modal.html" %}

<!-- Lightbox Modal -->
<div id="lightboxModal" class="fixed inset-0 z-50 hidden bg-black flex items-center justify-center touch-none">
    <button onclick="closeLightbox()" class="absolute top-4 right-4 text-white/50 hover:text-white p-2 z-50">
        <i class="fas fa-times text-2xl"></i>
    </button>
    <div class="relative w-full h-full flex items-center justify-center">
        <img id="lightboxImg" src="" class="max-w-full max-h-full object-contain transition-transform duration-300">
        <!-- Nav -->
        <button id="lbPrev" class="absolute left-2 top-1/2 -translate-y-1/2 text-white/50 hover:text-white p-4 hidden"><i class="fas fa-chevron-left text-2xl"></i></button>
        <button id="lbNext" class="absolute right-2 top-1/2 -translate-y-1/2 text-white/50 hover:text-white p-4 hidden"><i class="fas fa-chevron-right text-2xl"></i></button>
    </div>
</div>

<!-- Log Action Modal (Edit/Delete) -->
<div id="logActionModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm animate-fade-in">
    <div class="bg-surface border border-white/10 rounded-2xl w-64 overflow-hidden shadow-2xl">
        <div class="p-3 text-center border-b border-white/10 text-white/50 text-xs">Manage Log</div>
        <button id="actionEditBtn" class="w-full p-4 text-left text-text-main hover:bg-white/5 flex items-center gap-3">
            <i class="fas fa-pen text-text-sub"></i> Edit
        </button>
        <button id="actionDeleteBtn" class="w-full p-4 text-left text-red-500 hover:bg-white/5 flex items-center gap-3">
            <i class="fas fa-trash"></i> Delete
        </button>
        <button onclick="closeLogActionModal()" class="w-full p-3 text-center text-text-sub hover:bg-white/5 border-t border-white/10">
            Cancel
        </button>
    </div>
</div>

<script>
    const targetId = "{{ target.id }}";
    const timelineContainer = document.getElementById('timelineContainer');
    const chatInput = document.getElementById('chatInput');
    const saveLogBtn = document.getElementById('saveLogBtn');
    const contactFlagBtn = document.getElementById('contactFlagBtn');
    const contactFlag = document.getElementById('contactFlag');
    const searchToggleBtn = document.getElementById('searchToggleBtn');
    const searchPopover = document.getElementById('searchPopover');
    const searchInput = document.getElementById('timelineSearchInput');
    const datePicker = document.getElementById('datePicker');
    const chatInputBar = document.getElementById('chatInputBar');
    const toolsLeft = document.getElementById('toolsLeft');
    const toolsCollapseBtn = document.getElementById('toolsCollapseBtn');
    const uploadImageBtn = document.getElementById('uploadImageBtn');
    const imageInput = document.getElementById('imageInput');
    
    // Global Access (if needed) but local file scripts usually run in scope.
    
    // Lightbox Logic
    const lbModal = document.getElementById('lightboxModal');
    const lbImg = document.getElementById('lightboxImg');
    let currentLbImages = [];
    let currentLbIndex = 0;

    // Action Modal Logic
    const logActionModal = document.getElementById('logActionModal');
    let currentLogId = null;
    let currentLogContent = '';
    
    // State
    // today_date passed from view (filtered date)
    let currentDateFilter = "{{ today_date|date:'Y-m-d' }}"; 
    
    // --- LOAD DATA ---
    document.addEventListener('DOMContentLoaded', () => {
        // Adjust input height initially
        chatInput.style.height = '40px'; 
        
        // Set datepicker default
        if(currentDateFilter) datePicker.value = currentDateFilter;
        
        // Scroll to active section or bottom
        scrollToActive();
        
        // Attach Long Press Listeners
        attachLongPressHandlers();
        
        // Check URL for Deep Linking Actions
        const params = new URLSearchParams(window.location.search);
        const action = params.get('action');
        if(action === 'question') {
             const qId = params.get('question_id');
             // Open Modal (and potentially pre-select)
             // Need to ensure openQuestionModal is defined (it is in included file)
             if(typeof openQuestionModal === 'function') {
                 openQuestionModal(qId);
             }
        }
    });
    
    // --- IMAGE UPLOAD LOGIC ---
    uploadImageBtn.addEventListener('click', () => {
        imageInput.click();
    });

    imageInput.addEventListener('change', (e) => {
        const files = e.target.files;
        if (files.length > 0) {
            if (files.length > 4) {
                 alert("You can select up to 4 images at once.");
                 imageInput.value = ''; // Reset
                 return;
            }
            if (confirm(`Upload ${files.length} images?`)) {
                uploadImages(files);
            }
        }
    });

    function uploadImages(files) {
         const selectedDate = datePicker.value;
         const fd = new FormData();
         fd.append('target_id', targetId);
         fd.append('date', selectedDate || currentDateFilter || new Date().toISOString().split('T')[0]);
         // No content for image upload (User: "Image independent")
         
         for (let i = 0; i < files.length; i++) {
             fd.append('images', files[i]);
         }
         
         fetch('', {
             method: 'POST',
             headers: {
                 'X-CSRFToken': '{{ csrf_token }}'
             },
             body: fd
         }).then(res => {
             if (!res.ok) {
                 if (res.status === 413) throw new Error("File too large (Max 10MB)");
                 throw new Error("Server Error " + res.status);
             }
             return res.text().then(text => {
                 try {
                     return JSON.parse(text);
                 } catch (e) {
                     console.error("Invalid JSON:", text);
                     throw new Error("Invalid Server Response");
                 }
             });
         }).then(data => {
             if(data.success) {
                 window.location.reload();
             } else {
                 alert("Upload failed: " + (data.error || 'Unknown error'));
             }
         }).catch(err => {
             alert("Error: " + err.message);
         });
    }
    
    // --- LIGHTBOX LOGIC ---
    function openLightbox(url, gallery, index) {
        currentLbImages = gallery;
        currentLbIndex = index;
        updateLightboxImage();
        lightboxModal.classList.remove('hidden');
    }
    
    function closeLightbox() {
        lightboxModal.classList.add('hidden');
    }
    
    function updateLightboxImage() {
        lightboxImg.src = currentLbImages[currentLbIndex];
        // Nav visibility
        document.getElementById('lbPrev').classList.toggle('hidden', currentLbImages.length <= 1);
        document.getElementById('lbNext').classList.toggle('hidden', currentLbImages.length <= 1);
    }
    
    document.getElementById('lbPrev').addEventListener('click', (e) => {
        e.stopPropagation();
        currentLbIndex = (currentLbIndex - 1 + currentLbImages.length) % currentLbImages.length;
        updateLightboxImage();
    });
    
    document.getElementById('lbNext').addEventListener('click', (e) => {
        e.stopPropagation();
        currentLbIndex = (currentLbIndex + 1) % currentLbImages.length;
        updateLightboxImage();
    });
    
    // Swipe
    let touchStartX = 0;
    let touchEndX = 0;
    lightboxModal.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
    });
    lightboxModal.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    });
    
    function handleSwipe() {
        if (touchEndX < touchStartX - 50) {
            // Swipe Left -> Next
            currentLbIndex = (currentLbIndex + 1) % currentLbImages.length;
            updateLightboxImage();
        }
        if (touchEndX > touchStartX + 50) {
            // Swipe Right -> Prev
            currentLbIndex = (currentLbIndex - 1 + currentLbImages.length) % currentLbImages.length;
            updateLightboxImage();
        }
    }
    
    function scrollToActive() {
        const activeSection = document.getElementById('activeDateSection');
        if(activeSection) {
            setTimeout(() => {
                // Calculate Exact Scroll Position
                // Goal: Bottom of Active Section = Top of Chat Bar
                const chatBarHeight = chatInputBar.offsetHeight;
                const windowHeight = window.innerHeight;
                
                // We want the element's bottom edge to be at (windowHeight - chatBarHeight)
                // scrollTop = (elementBottomPositionRelativeTopContainer) - (targetVisibleBottom)
                // elementBottomPositionRelativeTopContainer = activeSection.offsetTop + activeSection.offsetHeight
                
                const elementBottom = activeSection.offsetTop + activeSection.offsetHeight;
                const targetVisibleBottom = windowHeight - chatBarHeight;
                
                // If elementBottom is 2000, and targetVisibleBottom is 600 (height 800 - bar 200)
                // We want 2000 to be at 600. So top must be at 1400.
                // scrollTop = 2000 - 600 = 1400.
                
                timelineContainer.scrollTop = elementBottom - targetVisibleBottom;
                
            }, 100);
        } else {
             // Default scroll bottom
             timelineContainer.scrollTop = timelineContainer.scrollHeight;
        }
    }
    
    // --- LONG PRESS LOGIC ---
    function attachLongPressHandlers() {
        const items = document.querySelectorAll('.timeline-content-bubble');
        items.forEach(bubble => {
            let pressTimer;
            const parent = bubble.closest('.timeline-item');
            
            const start = (e) => {
                // e.preventDefault(); // blocks click?
                pressTimer = setTimeout(() => {
                    // Open Modal
                    currentLogId = parent.dataset.logId;
                    currentLogContent = parent.dataset.logContent;
                    logActionModal.classList.remove('hidden');
                    // Vibrate?
                    if(navigator.vibrate) navigator.vibrate(20);
                }, 600); // 600ms long press
            };
            
            const cancel = () => {
                clearTimeout(pressTimer);
            };
            
            // Touch
            bubble.addEventListener('touchstart', start);
            bubble.addEventListener('touchend', cancel);
            bubble.addEventListener('touchmove', cancel);
            
            // Mouse (for testing)
            bubble.addEventListener('mousedown', start);
            bubble.addEventListener('mouseup', cancel);
            bubble.addEventListener('mouseleave', cancel);
        });
    }
    
    function closeLogActionModal() {
        logActionModal.classList.add('hidden');
        currentLogId = null;
    }
    
    document.getElementById('actionEditBtn').addEventListener('click', () => {
        if(currentLogId) editLog(currentLogId, currentLogContent);
        closeLogActionModal();
    });
    
    document.getElementById('actionDeleteBtn').addEventListener('click', () => {
        if(currentLogId) {
             if(confirm('Delete this log?')) {
                  // Call Delete API/View
                  // For now mostly focusing on Edit.
                  // Implementation: POST to delete endpoint or same endpoint with 'delete' action.
                  // Assume generic delete for now or todo.
             }
        }
        closeLogActionModal();
    });
    
    function editLog(id, content) {
        // Populate Input
        chatInput.value = content;
        updateInputState();
        chatInput.focus();
        // Set mode to edit? (Not implemented fully in backend yet? Assuming append for now)
        // User asked for "Edit". Usually implies updating existing.
        // I will just populate for now. Updating ID requires backend support not fully detailed here.
        // Assuming 'Save' creates new. 
        // Warn user?
        alert("Edit mode: Text copied to input. (Update not fully implemented, clicking send creates new log)");
    }
    
    // --- INPUT EXPANSION LOGIC ---
    chatInput.addEventListener('focus', () => {
        // Hide Left Tools, Show Expand Button used to collapse? 
        // User said: "> icon -> Input shrinks, Tools Left selectable"
        // So clicking ">" collapses input.
        toolsLeft.classList.add('hidden');
        toolsCollapseBtn.classList.remove('hidden');
        toolsCollapseBtn.classList.add('flex');
    });
    
    toolsCollapseBtn.addEventListener('click', () => {
        toolsLeft.classList.remove('hidden');
        toolsCollapseBtn.classList.add('hidden');
        toolsCollapseBtn.classList.remove('flex');
        // Unfocus input to keep it collapsed? Or just restore tools?
        // Usually restoring tools implies giving space back.
        // chatInput.blur(); // Optional?
    });

    // --- UI INTERACTIONS ---
    
    // Date Picker Change -> Reload Page with Param
    datePicker.addEventListener('change', (e) => {
        window.location.search = '?target_id=' + targetId + '&date=' + e.target.value;
    });

    // Contact Toggle
    contactFlagBtn.addEventListener('click', () => {
        contactFlag.checked = !contactFlag.checked;
        updateContactBtnState();
    });
    
    function updateContactBtnState() {
        if(contactFlag.checked) {
            contactFlagBtn.classList.add('text-primary', 'bg-primary/10', 'border-primary/30');
            contactFlagBtn.classList.remove('text-text-sub', 'border-transparent');
        } else {
            contactFlagBtn.classList.remove('text-primary', 'bg-primary/10', 'border-primary/30');
            contactFlagBtn.classList.add('text-text-sub', 'border-transparent');
        }
    }
    
    // Initial State Check
    updateContactBtnState(); // Ensure button matches default checked state
    
    // Search Toggle
    searchToggleBtn.addEventListener('click', () => {
        searchPopover.classList.toggle('hidden');
        if(!searchPopover.classList.contains('hidden')) {
            searchInput.focus();
        }
    });

    // Close Search Button
    // Note: Use event delegation or ensure button inside popover calls this if it exists? 
    // The new html has <input ... ><button ... closeSearch ...> NO, I removed button from new html to match target list style?
    // Wait, target list didn't have close button in form.
    // My replacement html:
    // <div class="relative"><i search></i><input ...></div>
    // No close button. 
    // So closeSearch() might be unused or I should add a way to close?
    // Tap outside to close? Or toggle btn again.
    
    searchInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const items = timelineContainer.querySelectorAll('.timeline-content-bubble'); // Search text content
        items.forEach(bubble => {
            const text = bubble.innerText.toLowerCase();
            const parentItem = bubble.closest('.timeline-item');
            if(parentItem) parentItem.style.display = text.includes(term) ? 'flex' : 'none';
        });
    });
    
    function closeSearch() {
        searchPopover.classList.add('hidden');
        searchInput.value = '';
        // Reset Filter (Show all)
        const items = timelineContainer.querySelectorAll('.timeline-item');
        items.forEach(item => item.style.display = 'flex');
    }

    // Action Button Click
    saveLogBtn.addEventListener('click', () => {
        const text = chatInput.value.trim();
        const hasTags = typeof currentSelectedTags !== 'undefined' && currentSelectedTags.size > 0;
        
        if (text || hasTags) {
            saveLog(text);
        } else {
            // Open Question Modal
            if(typeof openQuestionModal === 'function') openQuestionModal();
        }
    });

    function updateInputState() {
        chatInput.style.height = 'auto';
        const newHeight = Math.min(chatInput.scrollHeight, 120);
        chatInput.style.height = (newHeight > 40 ? newHeight : 40) + 'px';
        
        const hasText = chatInput.value.trim().length > 0;
        const hasTags = typeof currentSelectedTags !== 'undefined' && currentSelectedTags.size > 0;
        
        const iconDetail = document.getElementById('actionIconDetail');
        const iconSend = document.getElementById('actionIconSend');
        
        if (hasText || hasTags) {
            // Show Send
            saveLogBtn.classList.remove('bg-surface-2', 'text-primary'); 
            saveLogBtn.classList.add('bg-primary', 'text-black'); 
            
            iconDetail.style.display = 'none';
            iconSend.classList.remove('hidden');
            iconSend.style.display = 'inline-block';
        } else {
            // Show Question (Detail)
            saveLogBtn.classList.remove('bg-primary', 'text-black');
            saveLogBtn.classList.add('bg-surface-2', 'text-primary'); 
            
            iconDetail.style.display = 'inline-block';
            iconSend.classList.add('hidden');
            iconSend.style.display = 'none';
        }
    }
    
    // Re-attach Event Listener (accidentally removed)
    chatInput.addEventListener('input', updateInputState);
    updateInputState();

    function handleLightboxClick(el) {
        const src = el.getAttribute('data-src');
        const gallery = JSON.parse(el.getAttribute('data-gallery'));
        const index = parseInt(el.getAttribute('data-index'));
        openLightbox(src, gallery, index);
    }

    function searchForTag(tagName) {
        // Show Popover
        searchPopover.classList.remove('hidden');
        // Set Value
        searchInput.value = '#' + tagName;
        searchInput.focus();
        // Trigger Filter
        searchInput.dispatchEvent(new Event('input'));
    }

    function saveLog(content) {
        // Use DatePicker Value (should be same as currentDateFilter for SSR, but clearer)
        const selectedDate = datePicker.value;
        const payload = {
            target_id: targetId,
            content: content,
            description: content,
            contact_made: contactFlag.checked,
            date: selectedDate || currentDateFilter || new Date().toISOString().split('T')[0],
            tags: typeof currentSelectedTags !== 'undefined' ? Array.from(currentSelectedTags) : []
        };
        
        fetch('', { 
             method: 'POST',
             headers: {
                 'Content-Type': 'application/json',
                 'X-CSRFToken': '{{ csrf_token }}'
             },
             body: JSON.stringify(payload)
        }).then(res => res.json()).then(data => {
            if(data.success) {
                // Reload to refresh SSR list
                window.location.reload(); 
            }
        });
    }
    // Tag Menu Toggle
    const toggleTagMenuBtn = document.getElementById('toggleTagMenuBtn');
    if(toggleTagMenuBtn) {
        toggleTagMenuBtn.addEventListener('click', () => {
             // Assuming openTagModal is defined in the included modal file
             if(typeof openTagModal === 'function') openTagModal();
        });
    }


</script>

<style>
    @keyframes fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .animate-fade-in { animation: fade-in 0.1s ease-out; }
    /* Hide scrollbar for cleaner look */
    #timelineContainer::-webkit-scrollbar { width: 4px; }
    #timelineContainer::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.1); border-radius: 4px; }
</style>
<!-- Lightbox Modal -->
<div id="lightboxModal" class="fixed inset-0 z-[100] hidden bg-black flex items-center justify-center touch-none">
    <!-- Close Button (Top Right, Fixed) -->
    <button onclick="closeLightbox()" class="fixed top-6 right-6 text-white/80 hover:text-white p-4 z-[110]">
        <i class="fas fa-times text-2xl"></i>
    </button>
    
    <div class="relative w-full h-full flex items-center justify-center">
        <img id="lightboxImg" src="" class="max-w-full max-h-full object-contain transition-transform duration-300 pointer-events-none select-none">
        
        <!-- Nav (Full Height Touch Zones at Edges) -->
        <button id="lbPrev" class="fixed left-0 top-0 bottom-0 w-20 flex items-center justify-center text-white/30 hover:text-white hover:bg-white/5 transition-colors z-[105] hidden">
            <i class="fas fa-chevron-left text-3xl"></i>
        </button>
        <button id="lbNext" class="fixed right-0 top-0 bottom-0 w-20 flex items-center justify-center text-white/30 hover:text-white hover:bg-white/5 transition-colors z-[105] hidden">
            <i class="fas fa-chevron-right text-3xl"></i>
        </button>
    </div>
</div>

{% include "intelligence_log_question_modal.html" %}
{% endblock %}
