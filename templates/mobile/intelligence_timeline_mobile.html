{% extends "mobile/base_mobile.html" %}

{% block title %}{{ target.nickname }} - Log{% endblock %}



{% block bottom_nav %}{% endblock %}

{% block content %}
<div class="flex flex-col h-full bg-background relative overflow-hidden">

    <!-- 1. Header (Minimalist) -->
    <header class="h-14 px-4 flex items-center justify-between border-b border-white/10 bg-surface z-30 shrink-0">
        <div class="flex items-center gap-3">
            <button onclick="window.location.href='{% url 'intelligence_log' %}'" class="w-10 h-10 flex items-center justify-center text-text-sub hover:text-white rounded-full hover:bg-white/5 active:bg-white/10">
                <i class="fas fa-chevron-left text-lg"></i>
            </button>
            
            <div class="flex items-center gap-2">
                 <div class="w-8 h-8 rounded-full bg-surface-2 border border-white/10 overflow-hidden">
                     {% if target.avatar %}
                        <img src="{{ target.avatar.url }}" class="w-full h-full object-cover avatar-icon-img">
                     {% else %}
                        <div class="w-full h-full flex items-center justify-center text-xs font-bold">{{ target.nickname|slice:":1" }}</div>
                     {% endif %}
                 </div>
                 <div>
                     <h1 class="font-bold text-sm text-text-main leading-tight">{{ target.nickname }}</h1>
                     <span class="text-[10px] text-text-sub block leading-none opacity-70">
                        {% if target.last_contact %}Last: {{ target.last_contact|date:"m/d" }}{% else %}New Target{% endif %}
                    </span>
                 </div>
            </div>
        </div>
        
        <div class="flex items-center gap-1">
             <!-- Date Picker (Native) -->
            <div class="relative w-9 h-9 flex items-center justify-center rounded-full hover:bg-white/5 text-text-sub transition-colors" id="datePickerContainer">
                <i class="far fa-calendar text-lg pointer-events-none"></i>
                <input type="date" id="datePicker" class="absolute inset-0 opacity-0 w-full h-full z-10" style="cursor: pointer;">
            </div>
            
            <!-- Search Toggle -->
            <button id="searchToggleBtn" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-white/5 text-text-sub">
                <i class="fas fa-search text-lg"></i>
            </button>
            
            <!-- Answer Modal Trigger -->
            <button id="openAnswerModalBtn" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-white/5 text-text-sub">
                <i class="far fa-question-circle text-lg"></i>
            </button>
        </div>
    </header>
    
    <!-- Popover Search Bar (Hidden by default) -->
    <div id="searchPopover" class="absolute top-16 left-4 right-4 z-40 hidden animate-fade-in origin-top">
        <div class="bg-surface border border-white/10 rounded-full shadow-2xl flex items-center px-4 py-2">
            <i class="fas fa-search text-text-sub text-sm mr-3"></i>
            <input type="text" id="timelineSearchInput" placeholder="Search logs..." class="bg-transparent border-none focus:ring-0 text-sm text-text-main w-full placeholder-text-sub/50">
            <button onclick="document.getElementById('searchPopover').classList.add('hidden')" class="text-text-sub ml-2"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <!-- 2. Timeline Area -->
    <div id="timelineContainer" class="flex-1 overflow-y-auto bg-black scroll-smooth p-4 pb-32 space-y-2">
        <!-- Javascript will populate this -->
        <div id="loadingIndicator" class="text-center py-10 opacity-50">
             <i class="fas fa-spinner fa-spin"></i> Loading...
        </div>
    </div>

    <!-- 3. Chat Input Bar -->
    <div class="fixed bottom-0 left-0 right-0 bg-surface border-t border-white/10 z-40 pb-safe">
        <div class="p-2 flex items-center gap-2 bg-surface">
            <!-- Tools Left -->
             <div class="flex items-center gap-1">
                 <!-- Tag -->
                <button id="toggleTagMenuBtn" class="w-10 h-10 flex items-center justify-center text-text-sub hover:text-primary transition rounded-full active:bg-white/5">
                    <i class="fas fa-hashtag text-lg"></i>
                </button>
                <!-- Image -->
                <button id="uploadImageBtn" class="w-10 h-10 flex items-center justify-center text-text-sub hover:text-primary transition rounded-full active:bg-white/5">
                    <i class="far fa-image text-lg"></i>
                </button>
                 <!-- Contact -->
                <button id="contactFlagBtn" class="w-10 h-10 flex items-center justify-center text-text-sub transition rounded-full active:bg-white/5 border border-transparent">
                    <i class="fas fa-handshake text-lg"></i>
                </button>
             </div>
    
            <!-- Input -->
            <div class="flex-1 relative">
                <textarea id="chatInput" rows="1" class="w-full bg-surface-2 text-text-main placeholder-text-sub/50 border border-white/10 focus:border-primary/50 focus:ring-0 rounded-xl py-2 px-3 resize-none transition-all duration-200 leading-normal" style="min-height: 40px; max-height: 120px; vertical-align: middle;" placeholder="Message..."></textarea>
            </div>
            
            <!-- Submit / Detail Toggle -->
            <div>
                 <button id="saveLogBtn" class="w-10 h-10 flex items-center justify-center rounded-full bg-surface-2 text-primary transition-all shadow-lg active:scale-95">
                    <!-- Default: Detail Icon (Ellipsis) -->
                    <i id="actionIconDetail" class="fas fa-ellipsis-h text-lg"></i>
                    <!-- Active: Send Icon (Paper Plane) -->
                    <i id="actionIconSend" class="fas fa-paper-plane text-lg hidden translate-x-[-1px] translate-y-[1px]"></i>
                </button>
            </div>
            
            <!-- Hidden inputs -->
            <input type="checkbox" id="contactFlag" class="hidden">
            <input type="file" id="imageInput" class="hidden" accept="image/*">
        </div>
    </div>

</div>

<!-- Answer Modal -->
{% include "intelligence_log_answer_modal.html" %} 
<!-- Tag Modal -->
{% include "intelligence_log_tag_modal.html" %}

<script>
    const targetId = "{{ target.id }}";
    const timelineContainer = document.getElementById('timelineContainer');
    const chatInput = document.getElementById('chatInput');
    const saveLogBtn = document.getElementById('saveLogBtn');
    const contactFlagBtn = document.getElementById('contactFlagBtn');
    const contactFlag = document.getElementById('contactFlag');
    const searchToggleBtn = document.getElementById('searchToggleBtn');
    const searchPopover = document.getElementById('searchPopover');
    const searchInput = document.getElementById('timelineSearchInput');
    const datePicker = document.getElementById('datePicker');
    
    // State
    let currentDateFilter = new Date().toISOString().split('T')[0]; // Default today? Or no filter? User mentioned "Selected Occurrence Date"
    // Ideally we load ALL and scroll to selected.
    
    // --- LOAD DATA ---
    document.addEventListener('DOMContentLoaded', () => {
        loadTimeline();
        
        // Adjust input height initially
        chatInput.style.height = '40px'; 
        
        // Set datepicker to today by default
        datePicker.value = currentDateFilter;
    });
    
    // --- UI INTERACTIONS ---
    
    // Date Picker Change
    datePicker.addEventListener('change', (e) => {
        currentDateFilter = e.target.value;
        loadTimeline(); // Reload to highlight/scroll
    });

    function updateInputState() {
        chatInput.style.height = 'auto';
        const newHeight = Math.min(chatInput.scrollHeight, 120);
        chatInput.style.height = (newHeight > 40 ? newHeight : 40) + 'px';
        
        const hasText = chatInput.value.trim().length > 0;
        
        const iconDetail = document.getElementById('actionIconDetail');
        const iconSend = document.getElementById('actionIconSend');
        
        if (hasText) {
             // Show Send
             saveLogBtn.classList.remove('bg-surface-2', 'text-primary'); 
             saveLogBtn.classList.add('bg-primary', 'text-black'); 
             
             iconDetail.style.display = 'none';
             iconSend.classList.remove('hidden');
             iconSend.style.display = 'inline-block';
        } else {
             // Show Detail
             saveLogBtn.classList.remove('bg-primary', 'text-black');
             saveLogBtn.classList.add('bg-surface-2', 'text-primary'); 
             
             iconDetail.style.display = 'inline-block';
             iconSend.classList.add('hidden');
             iconSend.style.display = 'none';
        }
    }

    // Input Auto-Resize & Button Toggle
    chatInput.addEventListener('input', updateInputState);
    
    // Initial State Check
    updateInputState();

    // Action Button Click
    saveLogBtn.addEventListener('click', () => {
        const text = chatInput.value.trim();
        if (text) {
            saveLog(text);
        } else {
            // Navigate to Detail
            window.location.href = "{% url 'target_detail' %}?target_id=" + targetId;
        }
    });
    
    // Contact Toggle
    contactFlagBtn.addEventListener('click', () => {
        contactFlag.checked = !contactFlag.checked;
        if(contactFlag.checked) {
            contactFlagBtn.classList.add('text-primary', 'bg-primary/10', 'border-primary/30');
            contactFlagBtn.classList.remove('text-text-sub', 'border-transparent');
        } else {
            contactFlagBtn.classList.remove('text-primary', 'bg-primary/10', 'border-primary/30');
            contactFlagBtn.classList.add('text-text-sub', 'border-transparent');
        }
    });
    
    // Search Toggle
    searchToggleBtn.addEventListener('click', () => {
        searchPopover.classList.toggle('hidden');
        if(!searchPopover.classList.contains('hidden')) {
            searchInput.focus();
        }
    });
    
    searchInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const items = timelineContainer.querySelectorAll('.timeline-content-wrapper'); // Search text content
        items.forEach(wrapper => {
            const text = wrapper.innerText.toLowerCase();
            const parentItem = wrapper.closest('.timeline-item');
            if(parentItem) parentItem.style.display = text.includes(term) ? 'flex' : 'none';
        });
    });

    // --- API CALLS ---
    function loadTimeline() {
        fetch(`/api/timeline/?target_id=${targetId}`)
        .then(res => res.json())
        .then(data => {
            renderTimeline(data.results);
        });
    }

    function renderTimeline(items) {
        timelineContainer.innerHTML = '';
        
        // 1. Group by Date
        const grouped = {};
        // API usually returns Newest first. We want to display Chronological (Oldest Top) within days?
        // User requested: "2025/12/01 ... 12:00, 13:00". Chronological within day.
        // And "2025/12/02".
        // So we need to sort items Chronologically (Oldest -> Newest) overall first?
        // Or sort keys.
        
        // Let's sort items by date ascending first
        items.sort((a, b) => new Date(a.date + 'T' + (a.time || '00:00')) - new Date(b.date + 'T' + (b.time || '00:00')));

        items.forEach(item => {
            if (!grouped[item.date]) {
                grouped[item.date] = { items: [], hasContact: false };
            }
            grouped[item.date].items.push(item);
            if(item.contact_made) grouped[item.date].hasContact = true;
        });
        
        // 2. Render Groups
        Object.keys(grouped).forEach(dateStr => {
            const group = grouped[dateStr];
            const isSelectedDate = dateStr === currentDateFilter; // String comparison YYYY-MM-DD
            
            // Container for this day
            const dayContainer = document.createElement('div');
            dayContainer.className = `rounded-xl p-2 transition-colors duration-500 ${isSelectedDate ? 'bg-primary/5 border border-primary/10' : 'border border-transparent'}`;
            if(isSelectedDate) dayContainer.id = "activeDateSection";
            
            // Separator
            const contactIconHtml = group.hasContact ? '<i class="fas fa-handshake text-primary text-xs mx-1"></i>' : '';
            const separatorHtml = `
                <div class="flex items-center justify-center my-4 opacity-50">
                    <div class="h-px bg-white/10 w-12"></div>
                    <div class="flex items-center mx-2 font-mono text-[10px] text-text-sub">
                        ${contactIconHtml}
                        <span>${dateStr.replace(/-/g, '/')}</span>
                    </div>
                    <div class="h-px bg-white/10 w-12"></div>
                </div>
            `;
            dayContainer.innerHTML += separatorHtml;
            
            // Items
            group.items.forEach(item => {
                const isQuestion = item.type === 'Question';
                const timeDisplay = item.time ? item.time.substring(0, 5) : (new Date(item.created_at).getHours() + ':' + String(new Date(item.created_at).getMinutes()).padStart(2, '0')); 
                // Using Item.time if available (Occurrence Time), else Input Time (created_at)
                // User said: "Right side is Input Time. Small." "Edit case, show edit time."
                
                // Let's assume item.created_at is input time.
                const inputTime = new Date(item.created_at);
                const inputTimeStr = `${inputTime.getFullYear()}/${String(inputTime.getMonth()+1).padStart(2,'0')}/${String(inputTime.getDate()).padStart(2,'0')} ${String(inputTime.getHours()).padStart(2,'0')}:${String(inputTime.getMinutes()).padStart(2,'0')}`;

                const itemHtml = `
                    <div class="timeline-item flex gap-3 text-text-main mb-3 group">
                         <!-- Content Bubble -->
                        <div class="flex-1 timeline-content-wrapper">
                            <div class="bg-surface-2 rounded-2xl rounded-tl-none p-3 relative transform transition-all active:scale-[0.99]">
                                ${isQuestion ? `<div class="font-bold text-xs text-primary mb-1 border-b border-primary/20 pb-1">${item.question_text || 'Question'}</div>` : ''}
                                
                                <div class="text-sm whitespace-pre-wrap leading-relaxed">${item.content}</div>
                                
                                <!-- Meta Info (Input Time & Edit) -->
                                <div class="flex justify-end items-center gap-2 mt-1 opacity-50">
                                     <span class="text-[9px] font-mono">${inputTimeStr}</span>
                                     <button class="text-text-sub hover:text-primary transition p-1" onclick="editLog('${item.id}', '${item.content|escapejs}')">
                                         <i class="fas fa-pen text-[9px]"></i>
                                     </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                dayContainer.innerHTML += itemHtml;
            });
            
            timelineContainer.appendChild(dayContainer);
        });
        
        // 3. Scroll Logic
        // "Scroll Selected Date's last LOG to bottom of view"
        // Meaning: The bottom of the Active Section should be aligned with the bottom of the viewport (above chat bar).
        if(currentDateFilter) {
            const activeSection = document.getElementById('activeDateSection');
            if(activeSection) {
                // We want the BOTTOM of activeSection to be visible.
                // activeSection.scrollIntoView({ block: 'end', behavior: 'smooth' });
                // But we have the chat bar covering the bottom. 'scrollIntoView' might put it behind the fixed header/footer.
                // Let's try explicit scroll calculation or 'block: center' if it's small?
                // User said "Last LOG ... comes to the bottom".
                
                setTimeout(() => {
                    activeSection.scrollIntoView({ block: 'end', behavior: 'smooth' });
                }, 100);
            }
        } else {
             // Scroll to very bottom if no date selected (or default)
             timelineContainer.scrollTop = timelineContainer.scrollHeight;
        }
        
        if (document.getElementById('loadingIndicator')) document.getElementById('loadingIndicator').remove();
    }

    function saveLog(content) {
        // Use selected Date as occurrence date?
        // User didn't specify, but "Selected Date" implies we are viewing/editing that day.
        // Usually chat adds to "Right Now".
        // But if I am viewing 2024/01/01, and I type, does it add to 2024/01/01?
        // User request: "Timeline displayed ... separator ... highlight selected date".
        // Let's assume input is for Current Date always unless specified? 
        // For now, use Today (Backend default) but maybe force reloading the view to show it.
        // If I add a log for Today, but I'm viewing Yesterday, I should probably switch view to Today?
        // Or "Input Time" is distinct from "Occurrence Time".
        
        const payload = {
            target_id: targetId,
            content: content,
            description: content,
            contact_made: contactFlag.checked,
            date: currentDateFilter || new Date().toISOString().split('T')[0] 
            // Only IF text box implies "Add to this day". 
            // Given "Chat", users expect "Now". 
            // BUT given "The Dossier" (Intelligence), often logging past events.
            // If I have a date selected in header, I probably want to log for THAT date.
            // I will use `currentDateFilter` if set.
        };
        
        fetch('', { 
             method: 'POST',
             headers: {
                 'Content-Type': 'application/json',
                 'X-CSRFToken': '{{ csrf_token }}'
             },
             body: JSON.stringify(payload)
        }).then(res => res.json()).then(data => {
            if(data.success) {
                chatInput.value = '';
                chatInput.dispatchEvent(new Event('input')); 
                contactFlag.checked = false;
                contactFlagBtn.classList.remove('text-primary', 'bg-primary/10', 'border-primary/30');
                contactFlagBtn.classList.add('text-text-sub', 'border-transparent');
                
                // Refresh
                loadTimeline(); 
            }
        });
    }
</script>

<style>
    @keyframes fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .animate-fade-in { animation: fade-in 0.1s ease-out; }
    /* Hide scrollbar for cleaner look */
    #timelineContainer::-webkit-scrollbar { width: 4px; }
    #timelineContainer::-webkit-scrollbar-thumb { bg-white/10; border-radius: 4px; }
</style>
{% endblock %}
