{% extends "mobile/base_mobile.html" %}

{% block title %}Calendar{% endblock %}

{% block content %}
<div class="flex flex-col h-screen bg-background relative overflow-hidden">
    
    <!-- 1. App Bar -->
    <header class="h-14 px-4 flex items-center justify-between border-b border-border bg-surface backdrop-blur shrink-0 z-40 relative">
        <!-- Left: Title -->
        <span class="text-xs font-bold text-text-sub uppercase tracking-wider">CALENDAR</span>
        
        <!-- Right: Actions -->
        <div class="flex items-center gap-2">
            <!-- Today Button -->
             <button onclick="scrollToToday()" class="w-9 h-9 bg-border rounded-lg border border-border hover:bg-surface-highlight transition-colors flex items-center justify-center text-text-sub hover:text-text-main">
                <i class="fas fa-calendar-day"></i>
            </button>
            
            <!-- Date Modal Trigger -->
            <button onclick="openDateModal()" class="bg-border rounded-lg h-9 border border-border hover:bg-surface-highlight transition-colors flex items-center px-3 gap-2">
                <span class="text-sm font-bold font-mono text-text-main">{{ selected_year }} / {{ selected_month|stringformat:"02d" }}</span>
                <i class="fas fa-caret-down text-text-sub text-[10px]"></i>
            </button>
        </div>
    </header>

    <!-- 2. Calendar List -->
    <div class="flex-1 overflow-y-auto relative scroll-smooth pb-24" id="calendarList">

        {% for day in days %}
        
        <!-- Sticky Month Header (Insert if 1st of month) -->
        {% if day.date.day == 1 %}
        <div id="month-header-{{ day.date|date:'Y-m' }}" class="sticky top-0 z-20 bg-background/95 backdrop-blur-sm border-b border-border px-4 py-2 flex items-center justify-between shadow-sm">
            <span class="text-sm font-bold text-text-main font-mono tracking-widest">
                {{ day.date|date:"Y" }} <span class="text-primary text-base ml-1">{{ day.date|date:"m" }}</span>
            </span>
        </div>
        {% endif %}
        
        <div id="day-{{ day.date|date:'Y-m-d' }}" class="scroll-mt-14 border-b border-border last:border-0 relative {% if day.is_past %}bg-surface{% else %}bg-background{% endif %}">
            <div class="flex min-h-[4rem]"> <!-- Min height ensures tap target size -->
                 
                 <!-- Date Column (Left) -->
                 <div class="w-14 shrink-0 flex flex-col items-center justify-start pt-3 border-r border-border bg-surface relative"
                      onclick="handleDayClick('{{ day.date|date:'Y-m-d' }}', {% if day.is_past %}true{% else %}false{% endif %})">
                     <!-- Day Name (Mon, Tue...) -->
                     <span class="text-[10px] font-bold uppercase tracking-wider mb-0.5
                         {% if day.date.weekday == 6 %}text-red-400{% elif day.date.weekday == 5 %}text-blue-400{% else %}text-text-sub{% endif %}">
                         {{ day.date|date:"D" }}
                     </span>
                     
                     <!-- Day Number -->
                     <span class="text-xl font-mono font-bold leading-none
                         {% if day.is_today %}text-primary scale-110{% else %}text-text-main{% endif %}">
                         {{ day.date.day }}
                     </span>
                     
                     <!-- Small Icon for Today -->
                     {% if day.is_today %}
                     <div class="mt-1 w-1.5 h-1.5 rounded-full bg-primary shadow-sm shadow-primary/50"></div>
                     {% endif %}
                 </div>
                 
                 <!-- Content Column (Right) -->
                 <div class="flex-1 p-2 pl-3 cursor-pointer active:bg-border transition-colors relative flex flex-col justify-center gap-1"
                      onclick="handleDayClick('{{ day.date|date:'Y-m-d' }}', {% if day.is_past %}true{% else %}false{% endif %})">
                     
                     <!-- A. Anniversaries (Full Width, Light Yellow, No Icon) -->
                     {% if day.anniversaries %}
                     <div class="space-y-1 mb-1 w-full">
                         {% for anniv in day.anniversaries %}
                         <div class="w-full px-2 py-1 text-[11px] font-medium truncate" style="background-color: #FFF9C4; color: black;">
                             {{ anniv.target.nickname }}: {{ anniv.label }}
                         </div>
                         {% endfor %}
                     </div>
                     {% endif %}
                     
                     <!-- B. Plans (Manual Events) -->
                     {% if day.plans %}
                     <div class="space-y-1 w-full relative">
                         {% for plan in day.plans %}
                         <div class="flex items-center justify-between w-full h-6">
                             <!-- Left: Target Name -->
                             <span class="text-sm font-bold text-text-main truncate pr-16 block">
                                 {{ plan.target.nickname }} 
                                 <span class="text-[10px] text-text-sub font-normal ml-1 opacity-90">
                                     (Log: {{ plan.target.day_log_count|default:0 }})
                                 </span>
                             </span>
                             
                             <!-- Right: Group Count -->
                             {% if forloop.first and day.group_count > 0 %}
                             <span class="text-xs text-text-sub opacity-70 whitespace-nowrap ml-auto absolute right-0 top-1.5">
                                 他 {{ day.group_count }} 名
                             </span>
                             {% endif %}
                         </div>
                         {% endfor %}
                     </div>
                     {% elif day.group_count > 0 %}
                         <div class="w-full text-right h-6 flex items-center justify-end">
                             <span class="text-xs text-text-sub opacity-70">他 {{ day.group_count }} 名</span>
                         </div>
                     {% endif %}
                     
                     <!-- C. Logs (Activity) - REMOVED -->
                     
                 </div>
             </div>
        </div>
        {% endfor %}
    </div>

</div>

<!-- Month Selection Modal -->
<div id="dateModal" class="fixed inset-0 z-50 hidden bg-background/80 backdrop-blur-sm flex items-center justify-center animate-fade-in px-4" onclick="closeDateModal()">
    <div class="bg-surface border border-border rounded-xl w-full max-w-xs overflow-hidden shadow-2xl flex flex-col max-h-[85vh]" onclick="event.stopPropagation()">
        
        <!-- Year Slider (Horizontal Scroll) -->
        <div class="relative w-full border-b border-border py-6 bg-surface shrink-0">
            <!-- Scroll Container -->
            <div id="yearSlider" class="flex overflow-x-auto snap-x snap-mandatory gap-0 px-[calc(50%-2.5rem)] scrollbar-hide items-center h-10 w-full touch-pan-x">
                <!-- JS Populated -->
            </div>
            
            <!-- Center Highlight Box (Absolute center) -->
            <!-- Rounded Background for Selected Year -->
            <div class="absolute left-0 right-0 mx-auto top-1/2 -translate-y-1/2 w-20 h-10 rounded-lg bg-border border-2 border-primary pointer-events-none shadow-[0_0_15px_rgba(var(--primary-rgb),0.3)] z-10"></div>
        </div>
        
        <!-- Month Grid (4 cols x 3 rows = 12) -->
        <div class="px-6 py-8 overflow-y-auto flex-1">
             <div class="grid grid-cols-4 gap-4 w-full">
                 {% for m in "123456789012"|make_list %}
                 <button onclick="selectMonth({{ forloop.counter }})" 
                         class="aspect-square flex items-center justify-center rounded-lg text-lg font-mono font-bold transition-all border border-border w-full
                         {% if forloop.counter == selected_month %}bg-primary text-black shadow-lg scale-110 border-primary{% else %}bg-surface hover:bg-border text-text-sub hover:text-text-main{% endif %}">
                     {{ forloop.counter }}
                 </button>
                 {% endfor %}
             </div>
        </div>
        
        <!-- Close (Sticky Footer) -->
        <div class="p-3 border-t border-border bg-surface shrink-0 pb-safe">
            <button onclick="closeDateModal()" class="w-full py-3 bg-border rounded-lg text-xs font-bold text-text-main hover:bg-surface-highlight tracking-widest active:scale-95 transition">CLOSE</button>
        </div>
    </div>
</div>

<!-- Sticky Header Script Injector -->
<!-- We need to ensure headers stick. The structure above puts headers INSIDE the loop. 
     If the container `calendarList` has `overflow-y-auto`, `sticky` works relative to it.
     Each header will stick until pushed. 
     However, standard sticky behavior stacks if not separated.
     But user wants "Corresponding month list interval". 
     The current `if day.day == 1` logic inserts a header. 
     If we want strictly "Current Month" at the top, `position: sticky` does that naturally. 
     As you scroll past Jan 1, Jan Header sticks. 
     When Feb 1 comes, Feb Header pushes Jan Header up (if they are siblings). 
     Yes, this is standard sticky behavior. 
     My previous code had `top-0`. 
     If `header` is inside `calendarList` (which is `relative`), it should work.
-->

<script>
    // Just to ensure sticky works, verify parent overflow. 
    // #calendarList is overflow-y-auto. 
    // Headers are direct children or children of wrapper?
    // In template: 
    // <div id="calendarList">
    //    {% for day in days %}
    //       {% if day.day == 1 %} <div class="sticky ...">Header</div> {% endif %}
    //       <div class="day-row">...</div>
    //    {% endfor %}
    // </div>
    // This structure works for sticky headers (they stack/push).
    
    // ... (Existing Scripts) ...
</script>

<!-- Add Plan Modal -->
<div id="addCandidateModal" class="fixed inset-0 z-[60] hidden bg-background flex flex-col animate-slide-up">
    <!-- Header -->
    <div class="p-4 border-b border-border shrink-0 bg-surface z-10">
         <div class="flex items-center gap-3 mb-3">
            <button onclick="closeAddModal()" class="w-8 h-8 flex items-center justify-center text-text-sub hover:text-text-main rounded-full bg-border">
                <i class="fas fa-chevron-left"></i>
            </button>
            <h3 class="text-sm font-bold tracking-wider text-text-main uppercase">Select Target</h3>
        </div>
        <div class="relative">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-text-sub opacity-50 text-xs"></i>
            <input type="text" id="candidateSearch" placeholder="Search targets..." 
                   class="w-full bg-surface border border-border rounded-lg pl-9 pr-3 py-2 text-sm text-text-main focus:border-primary/50 focus:ring-0 outline-none placeholder-text-sub/40"
                   oninput="filterCandidates(this.value)" autocomplete="off">
        </div>
    </div>
    
    <div id="candidateList" class="flex-1 overflow-y-auto p-4 space-y-1">
        <!-- JS Populated -->
    </div>
</div>


<script>
    // State
    let currentSelectedDate = null;
    let selectedYear = {{ selected_year }};
    let currentScrollYear = selectedYear;
    
    // Pre-loaded Targets
    const allTargets = [
        {% for t in all_targets %}
        {
            id: "{{ t.id }}",
            nickname: "{{ t.nickname|escapejs }}",
            name_text: "{% if t.last_name %}{{ t.last_name }}{% endif %}{% if t.first_name %}{{ t.first_name }}{% endif %}",
            avatar_url: "{% if t.avatar %}{{ t.avatar.url }}{% endif %}"
        },
        {% endfor %}
    ];
    let loadedCandidates = allTargets; 
    
    const addModal = document.getElementById('addCandidateModal');
    const candidateList = document.getElementById('candidateList');
    const yearSlider = document.getElementById('yearSlider');
    
    // Header Logic
    function openDateModal() {
        document.getElementById('dateModal').classList.remove('hidden');
        // Small timeout to allow display:block to happen before scrolling
        setTimeout(initYearSlider, 10);
    }
    
    function closeDateModal() {
        document.getElementById('dateModal').classList.add('hidden');
    }
    
    // Init Year Slider
    function initYearSlider() {
        // Populate if empty
        if(yearSlider.children.length === 0) {
            yearSlider.innerHTML = '';
            const range = 10; // +/- 10 years
            const startY = selectedYear - range;
            const endY = selectedYear + range;
            
            for(let y = startY; y <= endY; y++) {
                const el = document.createElement('div');
                el.className = `snap-center shrink-0 w-20 flex items-center justify-center text-xl font-mono font-bold transition-all cursor-pointer opacity-50`;
                el.innerText = y;
                el.dataset.year = y;
                
                el.onclick = () => {
                   // Center this year and update state
                   scrollToYear(y);
                };
                yearSlider.appendChild(el);
            }
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if(entry.isIntersecting) {
                        entry.target.classList.replace('opacity-50', 'opacity-100');
                        entry.target.classList.add('scale-110');
                        // Update global state only if triggered by scroll? 
                        // We want the CENTER item to be the selected year.
                        // But IntersectionObserver triggers for ANY visible item.
                        // We need to know which one is CENTER.
                        // Actually, 'snap-center' does the physics.
                        // The observer is just for visual "active" style.
                        // Let's rely on click or explicit scroll for logic.
                        // But if user scrolls manually, we need to update selectedYear.
                        // For now, let's trust the click/scroll-to.
                        currentScrollYear = parseInt(entry.target.dataset.year);
                    } else {
                        entry.target.classList.replace('opacity-100', 'opacity-50');
                        entry.target.classList.remove('scale-110');
                    }
                });
            }, { root: yearSlider, threshold: 0.5 });
    
            Array.from(yearSlider.children).forEach(c => observer.observe(c));
        }

        // Always scroll to selected
        setTimeout(() => scrollToYear(selectedYear), 50);
    }
    
    function scrollToYear(y) {
         selectedYear = y;
         const el = Array.from(yearSlider.children).find(c => c.dataset.year == y);
         if(el) {
             el.scrollIntoView({ behavior: 'smooth', inline: 'center' });
             // Manually trigger visual update if needed, but Observer handles it
         }
    }
    
    function selectMonth(m) {
        window.location.href = `?year=${selectedYear}&month=${m}`;
    }
    
    // Day Click Handler
    function handleDayClick(dateStr, isPast) {
        if (isPast) {
             // Past/Today -> Go to Intelligence Log
             window.location.href = "{% url 'intelligence_log' %}?date=" + dateStr;
        } else {
             // Future -> Open Plan Modal
             openAddPlanModal(dateStr);
        }
    }
    
    // Add Plan Logic
    function openAddPlanModal(dateStr) {
        currentSelectedDate = dateStr;
        addModal.classList.remove('hidden');
        document.getElementById('candidateSearch').value = '';
        renderCandidates(allTargets); 
    }
    
    function closeAddModal() {
        addModal.classList.add('hidden');
    }

    function scrollToToday() {
        // Go to today (Current Date)
        // We use the template variable specific to TODAY, not selected date.
        // Wait, did we pass 'today' correctly? Yes, context['today'] is date object.
        const todayId = "day-{{ today|date:'Y-m-d' }}";
        const el = document.getElementById(todayId);
        if(el) {
            el.scrollIntoView({ block: 'start', behavior: 'smooth' });
        } else {
            alert("Today is not in the current range.");
        }
    }

    function renderCandidates(list) {
         if(list.length === 0) {
            candidateList.innerHTML = '<div class="text-center py-10 opacity-50"><p>No targets found.</p></div>';
            return;
        }
        
        candidateList.innerHTML = list.map(c => `
            <div onclick="selectCandidate('${c.id}')" class="p-3 bg-background rounded-lg flex items-center gap-3 active:bg-primary/20 transition border border-border cursor-pointer">
                <div class="w-10 h-10 rounded-full bg-border flex items-center justify-center shrink-0 overflow-hidden">
                    ${c.avatar_url ? `<img src="${c.avatar_url}" class="w-full h-full object-cover">` : `<span class="opacity-50">${c.nickname.charAt(0)}</span>`}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-bold text-text-main truncate">${c.nickname}</div>
                    ${c.name_text ? `<div class="text-[10px] text-text-sub truncate">${c.name_text}</div>` : ''}
                </div>
                <div class="w-6 flex items-center justify-center text-primary opacity-0 hover:opacity-100">
                    <i class="fas fa-plus"></i>
                </div>
            </div>
        `).join('');
    }
        
    function filterCandidates(query) {
        if(!query) {
             renderCandidates(allTargets);
             return;
        }
        const q = query.toLowerCase();
        const filtered = allTargets.filter(c => 
            c.nickname.toLowerCase().includes(q) || 
            (c.name_text && c.name_text.includes(q))
        );
        renderCandidates(filtered);
    }
    
    function selectCandidate(id) {
        const fd = new FormData();
        fd.append('target_id', id);
        fd.append('date', currentSelectedDate);
        fd.append('title', '予定');
        
        // Use fetch to create plan and reload
        fetch('', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: fd
        }).then(res => res.json()).then(data => {
            if(data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }


    // Scroll Logic
    document.addEventListener('DOMContentLoaded', () => {
        // Condition: If Default View -> Scroll to Today
        // Else -> Scroll to Selected Month Header
        
        const isDefaultView = {{ is_default_view|yesno:"true,false" }};
        
        if (isDefaultView) {
            const todayId = "day-{{ today|date:'Y-m-d' }}";
            const el = document.getElementById(todayId);
            if(el) {
                // Scroll Today to TOP (block: start), utilizing scroll-mt-14 to avoid hiding
                setTimeout(() => el.scrollIntoView({ block: 'start', behavior: 'smooth' }), 100);
            }
        } else {
             // Scroll to Month Header
             const selectedId = "month-header-{{ selected_year }}-{{ selected_month|stringformat:'02d' }}";
             const el = document.getElementById(selectedId);
             if(el) {
                 setTimeout(() => el.scrollIntoView({ block: 'start', behavior: 'smooth' }), 100);
             }
        }
    });

    // Remove Long Press Logic (replaced by click logic)
</script>

<style>
    @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .animate-slide-up { animation: slide-up 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
    .animate-fade-in { animation: fade-in 0.1s ease-out; }
    
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
</style>
{% endblock %}
