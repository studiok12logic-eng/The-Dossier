{% extends "mobile/base_mobile.html" %}

{% block title %}Calendar{% endblock %}

{% block content %}
<div class="flex flex-col h-full bg-background pb-20">
    
    <!-- 1. Header -->
    <header class="h-14 px-4 flex items-center justify-between border-b border-white/10 bg-surface/95 backdrop-blur sticky top-0 z-30">
        <!-- Left: Title -->
        <span class="text-xs font-bold text-text-sub uppercase tracking-wider">CALENDAR</span>
        
        <!-- Right: Month Selector Button -->
        <button onclick="openDateModal()" class="bg-white/5 rounded-lg h-9 border border-white/10 hover:bg-white/10 transition-colors flex items-center px-3 gap-2">
            <span class="text-sm font-bold font-mono">{{ selected_year }} / {{ selected_month|stringformat:"02d" }}</span>
            <i class="fas fa-caret-down text-text-sub text-[10px]"></i>
        </button>
    </header>

    <!-- 2. Calendar List -->
    <div class="flex-1 overflow-y-auto relative" id="calendarList">
        {% for day in days %}
        
        <!-- Sticky Month Header (Insert if 1st of month OR first item in list) -->
        {% if day.date.day == 1 or forloop.first %}
        <div class="sticky top-0 z-20 bg-background/95 backdrop-blur border-y border-white/10 py-2 px-4 shadow-sm flex items-center gap-2">
            <span class="text-primary font-mono font-bold">{{ day.date.year }}</span>
            <span class="text-white font-bold text-lg">/ {{ day.date.month|stringformat:"02d" }}</span>
        </div>
        {% endif %}

        <div class="border-b border-white/5 bg-surface relative min-h-[80px]" id="day-{{ day.date|date:'Y-m-d' }}">
             <!-- Day Row Container -->
             <div class="flex items-stretch min-h-[80px]">
                 
                 <!-- Date Column (Left) -->
                 <div class="w-16 flex flex-col items-center justify-start pt-3 border-r border-white/5 shrink-0 {% if day.is_today %}bg-primary/5{% endif %}"
                      onclick="openAddPlanModal('{{ day.date|date:'Y-m-d' }}')">
                     
                     <!-- Day Number -->
                     <span class="text-2xl font-bold font-mono leading-none {% if day.is_today %}text-primary{% elif day.date.weekday == 6 %}text-red-400{% elif day.date.weekday == 5 %}text-blue-400{% else %}text-text-main{% endif %}">
                         {{ day.date.day }}
                     </span>
                     
                     <!-- Day Name -->
                     <span class="text-[10px] uppercase font-bold mt-1 opacity-50">
                         {{ day.date|date:"D" }}
                     </span>
                     
                     {% if day.is_today %}
                     <span class="mt-1 text-[8px] bg-primary text-black px-1.5 rounded-full font-bold">TODAY</span>
                     {% endif %}
                 </div>
                 
                 <!-- Content Column (Right) -->
                 <div class="flex-1 p-3 cursor-pointer active:bg-white/5 transition-colors relative flex flex-col justify-center"
                      onclick="openAddPlanModal('{{ day.date|date:'Y-m-d' }}')">
                     
                     <!-- Anniversaries (Rounded Tags) -->
                     {% if day.anniversaries %}
                     <div class="flex flex-wrap gap-1.5 mb-1">
                         {% for anniv in day.anniversaries %}
                         <div class="flex items-center gap-1.5 pl-1.5 pr-2 py-0.5 rounded-full bg-surface-2 border border-white/10 text-[10px] font-medium grow-0">
                             <!-- Simple colored dot instead of icon? User said "Icon unnecessary". Let's just use text color or simple dot. -->
                             <div class="w-1.5 h-1.5 rounded-full {% if anniv.type == 'birthday' %}bg-pink-400{% else %}bg-yellow-400{% endif %}"></div>
                             <span class="text-text-main">{{ anniv.target.nickname }}: {{ anniv.label }}</span>
                         </div>
                         {% endfor %}
                     </div>
                     {% endif %}
                     
                     <!-- Plans (Events) - Only Text, No Icons -->
                     {% if day.logs %}
                     <div class="space-y-1">
                         {% for log in day.logs %}
                         <!-- Only show if it's strictly Event, already filtered in view but double check? -->
                         <!-- View sends only 'Event' type based on new logic. -->
                         <div class="flex items-center gap-2">
                             <!-- Small dot for visual anchor -->
                             <div class="w-1 h-1 rounded-full bg-blue-400"></div>
                             
                             <span class="text-sm font-bold text-text-main">
                                 {{ log.target.nickname }}
                             </span>
                             <!-- Show Title if exists, small -->
                             <span class="text-xs text-text-sub opacity-70">
                                 {{ log.title|default:"" }}
                             </span>
                         </div>
                         {% endfor %}
                     </div>
                     {% endif %}
                     
                     <!-- Group Count (Right Side, Absolute) -->
                     {% if day.group_count > 0 %}
                     <div class="absolute right-3 bottom-3 text-xs text-text-sub font-medium bg-surface/50 px-2 py-1 rounded backdrop-blur-sm">
                         他 {{ day.group_count }} 名
                     </div>
                     {% endif %}
                 </div>
             </div>
        </div>
        {% endfor %}
    </div>

</div>

<!-- Month Selection Modal (Redesigned) -->
<div id="dateModal" class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center animate-fade-in" onclick="closeDateModal()">
    <div class="bg-surface border border-white/10 rounded-xl w-72 overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
        
        <!-- Year Slider Header -->
        <div class="p-4 bg-surface-2 border-b border-white/10 flex items-center justify-between">
            <button onclick="changeYear(-1)" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-white/5 active:scale-95 transition">
                <i class="fas fa-chevron-left"></i>
            </button>
            <span id="modalYear" class="font-mono text-2xl font-bold tracking-widest">{{ selected_year }}</span>
            <button onclick="changeYear(1)" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-white/5 active:scale-95 transition">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        
        <!-- Month Grid (4 cols x 3 rows) -->
        <div class="p-4 grid grid-cols-4 gap-3">
             {% for m in "123456789012"|make_list %}
             <button onclick="selectMonth({{ forloop.counter }})" 
                     class="aspect-square flex items-center justify-center rounded-lg text-lg font-mono font-bold transition-all
                     {% if forloop.counter == selected_month %}bg-primary text-black shadow-lg scale-105{% else %}bg-white/5 hover:bg-white/10 text-text-sub hover:text-white{% endif %}">
                 {{ forloop.counter }}
             </button>
             {% endfor %}
        </div>
        
        <!-- Close (Optional footer for clarity) -->
        <div class="p-2 border-t border-white/5">
            <button onclick="closeDateModal()" class="w-full py-2 text-xs text-text-sub hover:text-white">CLOSE</button>
        </div>
    </div>
</div>

<!-- Add Plan Modal (Target Select style) -->
<div id="addCandidateModal" class="fixed inset-0 z-[60] hidden bg-background flex flex-col animate-slide-up">
    <!-- Header -->
    <div class="p-4 border-b border-white/10 shrink-0 bg-surface z-10">
         <div class="flex items-center gap-3 mb-3">
            <button onclick="closeAddModal()" class="w-8 h-8 flex items-center justify-center text-text-sub hover:text-white rounded-full bg-white/5">
                <i class="fas fa-chevron-left"></i>
            </button>
            <h3 class="text-sm font-bold tracking-wider text-text-main uppercase">Select Target</h3>
        </div>
        <!-- Search -->
        <div class="relative">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-text-sub opacity-50 text-xs"></i>
            <input type="text" id="candidateSearch" placeholder="Search targets..." 
                   class="w-full bg-surface-2 border border-white/10 rounded-lg pl-9 pr-3 py-2 text-sm text-text-main focus:border-primary/50 focus:ring-0 outline-none placeholder-text-sub/40"
                   oninput="filterCandidates(this.value)" autocomplete="off">
        </div>
    </div>
    
    <!-- List -->
    <div id="candidateList" class="flex-1 overflow-y-auto p-4 space-y-1">
        <!-- JS Populated -->
    </div>
</div>

<script>
    // State
    let currentSelectedDate = null;
    let modalYear = {{ selected_year }};
    
    // Pre-loaded Targets
    const allTargets = [
        {% for t in all_targets %}
        {
            id: "{{ t.id }}",
            nickname: "{{ t.nickname|escapejs }}",
            name_text: "{% if t.last_name %}{{ t.last_name }}{% endif %}{% if t.first_name %}{{ t.first_name }}{% endif %}",
            avatar_url: "{% if t.avatar %}{{ t.avatar.url }}{% endif %}"
        },
        {% endfor %}
    ];
    let loadedCandidates = allTargets; 
    
    const addModal = document.getElementById('addCandidateModal');
    const candidateList = document.getElementById('candidateList');
    
    // Header Logic
    function openDateModal() {
        document.getElementById('dateModal').classList.remove('hidden');
    }
    
    function closeDateModal() {
        document.getElementById('dateModal').classList.add('hidden');
    }
    
    function changeYear(delta) {
        modalYear += delta;
        document.getElementById('modalYear').innerText = modalYear;
    }
    
    function selectMonth(m) {
        window.location.href = `?year=${modalYear}&month=${m}`;
    }
    
    // Add Plan Logic
    function openAddPlanModal(dateStr) {
        currentSelectedDate = dateStr;
        addModal.classList.remove('hidden');
        document.getElementById('candidateSearch').value = '';
        renderCandidates(allTargets); 
    }
    
    function closeAddModal() {
        addModal.classList.add('hidden');
    }

    function renderCandidates(list) {
         if(list.length === 0) {
            candidateList.innerHTML = '<div class="text-center py-10 opacity-50"><p>No targets found.</p></div>';
            return;
        }
        
        candidateList.innerHTML = list.map(c => `
            <div onclick="selectCandidate('${c.id}')" class="p-3 bg-white/5 rounded-lg flex items-center gap-3 active:bg-primary/20 transition border border-white/5 cursor-pointer">
                <div class="w-10 h-10 rounded-full bg-surface-2 flex items-center justify-center shrink-0 overflow-hidden">
                    ${c.avatar_url ? `<img src="${c.avatar_url}" class="w-full h-full object-cover">` : `<span class="opacity-50">${c.nickname.charAt(0)}</span>`}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-bold text-text-main truncate">${c.nickname}</div>
                    ${c.name_text ? `<div class="text-[10px] text-text-sub truncate">${c.name_text}</div>` : ''}
                </div>
                <div class="w-6 flex items-center justify-center text-primary opacity-0 hover:opacity-100">
                    <i class="fas fa-plus"></i>
                </div>
            </div>
        `).join('');
    }
    
    function filterCandidates(query) {
        if(!query) {
             renderCandidates(allTargets);
             return;
        }
        const q = query.toLowerCase();
        const filtered = allTargets.filter(c => 
            c.nickname.toLowerCase().includes(q) || 
            (c.name_text && c.name_text.includes(q))
        );
        renderCandidates(filtered);
    }
    
    function selectCandidate(id) {
        // Create Event
        const fd = new FormData();
        fd.append('target_id', id);
        fd.append('date', currentSelectedDate);
        fd.append('title', '予定'); // Default title
        // User "Log is unnecessary" implies maybe they don't see it, but we MUST create it to have a record.
        
        fetch('', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: fd
        }).then(res => res.json()).then(data => {
            if(data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }

    // Scroll to Today
    document.addEventListener('DOMContentLoaded', () => {
        const todayId = "day-{{ today|date:'Y-m-d' }}";
        const el = document.getElementById(todayId);
        if(el) {
            setTimeout(() => el.scrollIntoView({ block: 'center', behavior: 'smooth' }), 100);
        }
    });
    
    // Long Press Logic (Navigate to Log)
    document.querySelectorAll('[id^="day-"]').forEach(el => {
        const contentCol = el.querySelector('.flex-1');
        if(!contentCol) return;
        
        let timer;
        const dateStr = el.id.replace('day-', '');
        
        contentCol.addEventListener('touchstart', (e) => {
            timer = setTimeout(() => {
                window.location.href = "{% url 'intelligence_log' %}?date=" + dateStr;
            }, 600);
        });
        
        contentCol.addEventListener('touchend', () => clearTimeout(timer));
        contentCol.addEventListener('touchmove', () => clearTimeout(timer));
    });

</script>

<style>
    @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .animate-slide-up { animation: slide-up 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
    .animate-fade-in { animation: fade-in 0.1s ease-out; }
</style>
{% endblock %}
