{% extends "mobile/base_mobile.html" %}

{% block title %}{{ target.nickname }}{% endblock %}

{% block content %}
<style>
    .bar-animate { transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
</style>
<div class="flex flex-col h-full bg-background">
    <!-- Header (Fixed/Sticky) -->
    <div class="sticky top-0 z-50 p-4 bg-background/95 backdrop-blur-md border-b border-white/10 shrink-0 flex items-center gap-3">
        <button onclick="window.location.href=this.dataset.url;" data-url="{% url 'target_list' %}" class="w-8 h-8 flex items-center justify-center text-text-sub hover:text-white rounded-full bg-white/5">
            <i class="fas fa-chevron-left"></i>
        </button>
        <h3 class="text-sm font-bold text-text-main truncate flex-1">{{ target.nickname }}</h3>
        <a href="{% url 'target_edit' target.id %}" class="w-8 h-8 flex items-center justify-center bg-primary text-black rounded-full shadow-lg">
            <i class="fas fa-pen text-xs"></i>
        </a>
    </div>

    <!-- Hero Section (Avatar & Basic Info) -->
    <div class="relative shrink-0 pt-10 pb-6 px-6 flex flex-col items-center bg-surface-2 border-b border-white/5">
        
        <!-- RANK & LAST CONTACT -->
        <div class="flex items-center gap-4 mb-4 text-[10px] font-mono">
            {% with pts=total_points|default:0 %}
            <span class="font-bold flex items-center gap-1">
                {% if pts >= 100 %}
                <i class="fas fa-crown text-purple-400"></i> <span class="text-purple-400">PLATINUM</span>
                {% elif pts >= 61 %}
                <i class="fas fa-crown text-yellow-500"></i> <span class="text-yellow-500">GOLD</span>
                {% elif pts >= 31 %}
                <i class="fas fa-medal text-gray-300"></i> <span class="text-gray-300">SILVER</span>
                {% elif pts >= 1 %}
                <i class="fas fa-medal text-amber-700"></i> <span class="text-amber-700">BRONZE</span>
                {% else %}
                <span class="text-text-sub opacity-50">NO RANK</span>
                {% endif %}
            </span>
            {% endwith %}

            <span class="text-text-sub flex items-center gap-1">
                <i class="fas fa-history text-emerald-500/50"></i> 
                <span class="text-text-main">{% if target.last_contact %}{{ target.last_contact|date:"Y/m/d" }}{% else %}-{% endif %}</span>
            </span>
        </div>

        <!-- Avatar -->
        <div class="w-24 h-24 rounded-full border-2 border-white/10 mb-4 overflow-hidden relative shadow-xl">
             {% if target.avatar %}
                <img src="{{ target.avatar.url }}" class="w-full h-full object-cover">
             {% else %}
                <div class="w-full h-full flex items-center justify-center bg-surface text-4xl text-text-sub font-bold">
                    {{ target.nickname|slice:":1" }}
                </div>
             {% endif %}
        </div>
        
        <!-- Nickname -->
        <h1 class="text-2xl font-bold text-text-main mb-1">{{ target.nickname }}</h1>
        
        <!-- Names & Kana -->
        <div class="flex flex-col items-center mb-4">
            <p class="text-sm text-text-main">{{ target.last_name }} {{ target.first_name }}</p>
            <p class="text-[10px] text-text-sub">({{ target.last_name_kana }} {{ target.first_name_kana }})</p>
        </div>

        <!-- New Header Info Row -->
        <div class="flex flex-col items-center mb-6 text-xs text-text-sub">
            <div class="flex items-center gap-2 mb-1">
                <i class="fas fa-birthday-cake text-primary"></i>
                <span class="text-text-main font-bold">
                    {% if target.birth_year %}
                        {{ target.birth_year }}/{{ target.birth_month }}/{{ target.birth_day }} ({{ age }}歳) {{ target.eto }}
                    {% else %}
                        -
                    {% endif %}
                </span>
            </div>
            <div class="flex items-center gap-3 opacity-80 text-[11px]">
                <span>{{ target.zodiac_sign|default:"-" }}</span>
                <span class="text-white/10">|</span>
                <span>{{ target.get_gender_display|default:"-" }}</span>
                <span class="text-white/10">|</span>
                <span>{{ target.blood_type|default:"-" }}型</span>
            </div>
        </div>
        
        <!-- Quick Stats Row -->
        <div class="flex items-center justify-center gap-5 text-xs text-text-sub w-full">
            <div class="flex flex-col items-center">
                <span class="font-bold text-lg text-text-main flex items-center gap-1">
                    <i class="fas fa-comment text-blue-400/30 text-xs"></i> {{ log_count }}
                </span>
                <span>ログ数</span>
            </div>
            <div class="flex flex-col items-center border-l border-white/10 pl-5">
                <span class="font-bold text-lg text-text-main flex items-center gap-1">
                    <i class="fas fa-handshake text-emerald-500/30 text-xs"></i> {{ contact_count }}
                </span>
                <span>接触日数</span>
            </div>
            <div class="flex flex-col items-center border-l border-white/10 pl-5">
                <span class="font-bold text-lg text-text-main flex items-center gap-1">
                    <i class="fas fa-question-circle text-purple-400/30 text-xs"></i> {{ total_answers }}
                </span>
                <span>回答数</span>
            </div>
            <div class="flex flex-col items-center border-l border-white/10 pl-5">
                <span class="font-bold text-lg text-text-main flex items-center gap-1">
                    <i class="fas fa-star text-yellow-500/30 text-xs"></i> {{ total_points }}
                </span>
                <span>獲得P</span>
            </div>
        </div>
    </div>

    <!-- Base Profile & Progress Section -->
    <div class="px-6 py-6 bg-surface border-b border-white/5">
        <h2 class="text-xs font-bold text-text-sub uppercase tracking-wider mb-4 opacity-70">BASE PROFILE</h2>
        
        <!-- Base Profile Progress Bar (Moved here) -->
        <div class="space-y-3">
            <!-- Anniversary -->
            <div class="flex justify-between text-xs border-b border-white/5 pb-2">
                <span class="text-text-sub">記念日</span>
                <div class="text-right text-text-main font-medium">
                    {% for anniv in custom_anniversaries %}
                        <div>{{ anniv.label }} ({{ anniv.date|date:"m/d" }})</div>
                    {% empty %}
                        -
                    {% endfor %}
                </div>
            </div>
            <!-- Birthplace -->
            <div class="flex justify-between text-xs border-b border-white/5 pb-2">
                <span class="text-text-sub">出身地</span>
                <span class="text-text-main font-medium">{{ target.birthplace|default:"-" }}</span>
            </div>
            <!-- Occupation -->
            <div class="flex justify-between text-xs border-b border-white/5 pb-2">
                <span class="text-text-sub">職業</span>
                <span class="text-text-main font-medium">{{ base_answers.occupation|default:"-" }}</span>
            </div>
            <!-- Address -->
            <div class="flex justify-between text-xs border-b border-white/5 pb-2">
                <span class="text-text-sub">現在住所</span>
                <span class="text-text-main font-medium">{{ base_answers.address|default:"-" }}</span>
            </div>
            <!-- Family -->
            <div class="flex justify-between text-xs border-b border-white/5 pb-2">
                <span class="text-text-sub">家族構成</span>
                <span class="text-text-main font-medium">{{ base_answers.family_structure|default:"-" }}</span>
            </div>
            <!-- Hobbies -->
            <div class="flex justify-between text-xs border-b border-white/5 pb-2">
                <span class="text-text-sub">趣味</span>
                <span class="text-text-main font-medium">{{ base_answers.hobbies|default:"-" }}</span>
            </div>
            <!-- Weakness -->
            <div class="flex justify-between text-xs border-b border-white/5 pb-2">
                <span class="text-text-sub">弱点</span>
                <span class="text-text-main font-medium">{{ base_answers.weakness|default:"-" }}</span>
            </div>
            <!-- Skills -->
            <div class="flex justify-between text-xs border-b border-white/5 pb-2">
                <span class="text-text-sub">得意分野</span>
                <span class="text-text-main font-medium">{{ base_answers.skills|default:"-" }}</span>
            </div>
            <!-- Notes -->
            <div class="flex flex-col text-xs pt-1">
                <span class="text-text-sub mb-1">備考</span>
                <span class="text-text-main font-medium whitespace-pre-wrap leading-relaxed opacity-80">{{ target.description|default:"-" }}</span>
            </div>
        </div>

        <!-- Category Wise Progress -->
        <div class="space-y-4 mt-8">
            <h2 class="text-xs font-bold text-text-sub uppercase tracking-wider mb-3 opacity-70">カテゴリー進捗</h2>
            
            <div class="grid grid-cols-2 gap-4">
                <!-- Category Bars -->
                {% for cat in qa_data_progress %}
                <div class="flex flex-col gap-1.5">
                    <div class="flex justify-between items-end text-[10px] font-bold text-text-sub">
                        <span class="truncate pr-1">{{ cat.category.name }} <span class="opacity-70 font-normal">({{ cat.answered_count }}/{{ cat.total_count }})</span></span>
                        <span class="text-text-main">{{ cat.progress }}%</span>
                    </div>
                    <div class="h-1.5 w-full bg-white/5 rounded-full overflow-hidden">
                        <div class="h-full block bar-animate js-progress-bar" 
                             style="width: 0%; height: 100%; display: block; background: linear-gradient(90deg, #ef4444, #22c55e);"
                             data-width="{{ cat.progress }}%"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>


    <!-- Tabs content container -->
    <div class="flex-1" x-data="{ 
        tab: 'timeline',
        searchQuery: '',
        selectedTagId: null,
        showAllTags: false,
        items: [
            {% for item in events %}
            {
                id: {{ item.id }},
                type: '{{ item.type }}',
                content: '{{ item.content|escapejs|default:"" }}',
                date: '{{ item.date|date:"Y/m/d (D)" }}',
                dateRaw: '{{ item.date|date:"Y/m/d" }}',
                hasContact: {{ item.contact_made|yesno:"true,false" }},
                tags: [{% for tag in item.tags.all %}{id: {{ tag.id }}, name: '{{ tag.name|escapejs }}'}{% if not forloop.last %},{% endif %}{% endfor %}],
                isQuestion: {% if item.type == 'Question' %}true{% else %}false{% endif %}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        get filteredLogs() {
            return this.items.filter(item => {
                const searchMatch = !this.searchQuery || 
                    item.content.toLowerCase().includes(this.searchQuery.toLowerCase().replace(/^#/, ''));
                
                // If search starts with #, treat as tag search
                if (this.searchQuery.startsWith('#')) {
                    const tagName = this.searchQuery.substring(1).toLowerCase();
                    const hasTag = item.tags.some(t => t.name.toLowerCase().includes(tagName));
                    if (!hasTag) return false;
                }

                const tagMatch = !this.selectedTagId || 
                    item.tags.some(t => t.id === this.selectedTagId);
                
                return searchMatch && tagMatch;
            });
        },
        toggleTag(tagId) {
            if (this.selectedTagId === tagId) {
                this.selectedTagId = null;
            } else {
                this.selectedTagId = tagId;
                this.searchQuery = ''; // Clear search when picking tag via chip
            }
        },
        searchByTag(tagLabel) {
            this.searchQuery = '#' + tagLabel;
            this.selectedTagId = null;
            this.tab = 'timeline';
        }
    }">
        
        <!-- Sticky Tab Header -->
        <div class="sticky top-[65px] z-40 bg-background/95 backdrop-blur border-b border-white/10 flex text-sm font-bold">
            <button @click="tab = 'timeline'" :class="{'text-primary border-b-2 border-primary': tab==='timeline', 'text-text-sub border-b-2 border-transparent': tab!=='timeline'}" class="flex-1 py-3 text-center transition">
                Event Log
            </button>
            <button @click="tab = 'questions'" :class="{'text-primary border-b-2 border-primary': tab==='questions', 'text-text-sub border-b-2 border-transparent': tab!=='questions'}" class="flex-1 py-3 text-center transition">
                Q&A Summary
            </button>
        </div>

        <!-- 1. Event Log Tab -->
        <div x-show="tab === 'timeline'" class="p-4 pb-24">
             <!-- Revamped Search & Tags -->
             <div class="space-y-3 mb-6">
                 <div class="flex items-center gap-2">
                     <div class="relative flex-1">
                         <input type="text" x-model="searchQuery" placeholder="search Logs..." class="w-full bg-surface border border-white/10 rounded-full py-2 pl-9 pr-4 text-sm text-text-main focus:border-primary focus:outline-none placeholder-text-sub/50" autocomplete="off">
                         <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-text-sub text-xs"></i>
                     </div>
                     <a href="{% url 'intelligence_log' %}?target_id={{ target.id }}" class="h-9 px-3 rounded-full bg-primary text-black text-xs font-bold flex items-center justify-center shrink-0 shadow-lg active:scale-95 transition">
                        <i class="fas fa-plus mr-1"></i> Log
                     </a>
                 </div>

                 <!-- Tags List (Top 10 + More) -->
                 <div class="flex flex-wrap gap-1.5 px-1">
                     {% for tag in all_tags %}
                        {% if forloop.counter <= 10 %}
                        <button @click="toggleTag({{ tag.id }})" 
                                :class="selectedTagId === {{ tag.id }} ? 'bg-primary text-black border-primary' : 'bg-white/5 text-text-sub border-white/10'"
                                class="text-[10px] px-2.5 py-1 rounded-full border transition-all active:scale-95">
                            #{{ tag.name }}
                        </button>
                        {% else %}
                        <button x-show="showAllTags" 
                                @click="toggleTag({{ tag.id }})" 
                                :class="selectedTagId === {{ tag.id }} ? 'bg-primary text-black border-primary' : 'bg-white/5 text-text-sub border-white/10'"
                                class="text-[10px] px-2.5 py-1 rounded-full border transition-all active:scale-95"
                                style="display: none;">
                            #{{ tag.name }}
                        </button>
                        {% endif %}
                     {% endfor %}
                     
                     {% if all_tags|length > 10 %}
                     <button @click="showAllTags = !showAllTags" class="text-[10px] px-2.5 py-1 rounded-full bg-white/5 text-text-sub border border-white/10 italic">
                        <span x-text="showAllTags ? 'collapse' : '...'"></span>
                     </button>
                     {% endif %}
                 </div>
             </div>

             <!-- Log Items -->
             <div class="space-y-0 relative">
                 <template x-for="(item, index) in filteredLogs" :key="item.id">
                     <div>
                         <!-- Date Divider -->
                         <template x-if="index === 0 || item.dateRaw !== filteredLogs[index-1].dateRaw">
                             <div class="flex items-center gap-4 py-6 opacity-30 select-none">
                                 <div class="h-px flex-1 bg-white/20"></div>
                                 <span class="text-[10px] font-bold tracking-widest uppercase" x-text="item.dateRaw"></span>
                                 <div class="h-px flex-1 bg-white/20"></div>
                             </div>
                         </template>

                         <div class="flex gap-2 group items-start">
                             <!-- Content -->
                             <div class="flex-1 pb-2">
                                 <div class="flex justify-between items-start">
                                     <p class="text-[13px] text-text-main whitespace-pre-wrap leading-snug" x-text="item.content"></p>
                                     
                                     <!-- Right Contact Icon -->
                                     <template x-if="item.hasContact">
                                         <i class="fas fa-handshake text-emerald-500/80 text-xs ml-2 mt-0.5 shrink-0"></i>
                                     </template>
                                 </div>
                                 
                                 <!-- Item Tags -->
                                 <div class="flex flex-wrap gap-1 mt-2" x-show="item.tags.length > 0">
                                     <template x-for="tag in item.tags" :key="tag.id">
                                         <span @click.stop="searchByTag(tag.name)" class="text-[9px] px-2 py-0.5 rounded-full bg-surface border border-white/10 text-text-sub hover:text-primary hover:border-primary/30 transition cursor-pointer selection:bg-primary selection:text-black">
                                             #<span x-text="tag.name"></span>
                                         </span>
                                     </template>
                                 </div>
                             </div>
                         </div>
                     </div>
                 </template>

                 <!-- Empty State -->
                 <div x-show="filteredLogs.length === 0" class="text-center py-12 text-text-sub text-sm italic opacity-50">
                    No matching logs found.
                 </div>
             </div>
             
             <!-- Add Button (Sticky or Bottom) -->
             <div class="text-center py-8">
                 <a href="{% url 'intelligence_log' %}?target_id={{ target.id }}" class="inline-flex items-center gap-2 rounded-full bg-primary text-black text-sm font-bold shadow-xl active:scale-95 transition" style="padding: 1em;">
                     <i class="fas fa-plus text-lg"></i> <span class="tracking-wide">Add Event Log</span>
                 </a>
             </div>
        </div>

        <!-- 2. Q&A Tab -->
        <div x-show="tab === 'questions'" class="p-4 space-y-2 pb-24" style="display: none;">
            {% for cat_data in qa_data %}
            <div class="mb-4">
                <h3 class="text-xs font-bold text-text-sub uppercase tracking-wider mb-2 px-1">{{ cat_data.category.name }}</h3>
                <div class="space-y-2">
                    {% for q_info in cat_data.questions %}
                    <!-- Clickable Question Card -->
                    <div data-url="{% url 'intelligence_log' %}?target_id={{ target.id }}&action=question&question_id={{ q_info.question.id }}&next={% url 'target_detail' %}%3Ftarget_id%3D{{ target.id }}"
                         onclick="window.location.href=this.dataset.url" 
                         class="bg-surface rounded-lg p-3 border border-white/5 active:scale-[0.98] transition-transform cursor-pointer hover:border-primary/30">
                        <div class="flex justify-between items-start">
                            <div class="text-xs text-primary font-bold mb-1">{{ q_info.question.title }}</div>
                            <i class="fas fa-chevron-right text-[10px] text-text-sub opacity-50 mt-1"></i>
                        </div>
                        {% if q_info.is_answered %}
                        <p class="text-sm text-text-main line-clamp-2">{{ q_info.answer }}</p>
                        <div class="text-[10px] text-text-sub text-right mt-1 opacity-50">{{ q_info.answer_date|timesince }} ago</div>
                        {% else %}
                        <p class="text-sm text-text-sub italic opacity-50">Not answered yet</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        
    </div>

</div>

<!-- Alpine.js for Tabs -->
<script src="//unpkg.com/alpinejs" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Small delay to ensure transition triggers
    setTimeout(() => {
        document.querySelectorAll('.js-progress-bar').forEach(el => {
            if (el.dataset.width) el.style.width = el.dataset.width;
            if (el.dataset.color) el.style.backgroundColor = el.dataset.color;
            if (el.dataset.shadow) el.style.boxShadow = el.dataset.shadow;
        });
    }, 50);
});
</script>
{% endblock %}
