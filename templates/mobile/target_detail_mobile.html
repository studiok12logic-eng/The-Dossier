{% extends "mobile/base_mobile.html" %}

{% block title %}{{ target.nickname }}{% endblock %}

{% block content %}
<style>
    .bar-animate { transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
</style>
<div class="flex flex-col h-full bg-background">
    <!-- Header (Fixed/Sticky) -->
    <div class="sticky top-0 z-50 p-4 bg-background/95 backdrop-blur-md border-b border-white/10 shrink-0 flex items-center gap-3">
        <button onclick="window.location.href=this.dataset.url;" data-url="{% url 'target_list' %}" class="w-8 h-8 flex items-center justify-center text-text-sub hover:text-white rounded-full bg-white/5">
            <i class="fas fa-chevron-left"></i>
        </button>
        <h3 class="text-sm font-bold text-text-main truncate flex-1">{{ target.nickname }}</h3>
        <a href="{% url 'target_edit' target.id %}" class="w-8 h-8 flex items-center justify-center bg-primary text-black rounded-full shadow-lg">
            <i class="fas fa-pen text-xs"></i>
        </a>
    </div>

    <!-- Hero Section (Avatar & Basic Info) -->
    <div class="relative shrink-0 pt-10 pb-6 px-6 flex flex-col items-center bg-surface-2 border-b border-white/5">
        
        <!-- RANK & LAST CONTACT -->
        <div class="flex items-center gap-4 mb-4 text-[10px] font-mono">
            {% with pts=total_points|default:0 %}
            <span class="font-bold flex items-center gap-1">
                {% if pts >= 100 %}
                <i class="fas fa-crown text-purple-400"></i> <span class="text-purple-400">PLATINUM</span>
                {% elif pts >= 61 %}
                <i class="fas fa-crown text-yellow-500"></i> <span class="text-yellow-500">GOLD</span>
                {% elif pts >= 31 %}
                <i class="fas fa-medal text-gray-300"></i> <span class="text-gray-300">SILVER</span>
                {% elif pts >= 1 %}
                <i class="fas fa-medal text-amber-700"></i> <span class="text-amber-700">BRONZE</span>
                {% else %}
                <span class="text-text-sub opacity-50">NO RANK</span>
                {% endif %}
            </span>
            {% endwith %}

            <span class="text-text-sub flex items-center gap-1">
                <i class="fas fa-history text-emerald-500/50"></i> 
                <span class="text-text-main">{% if target.last_contact %}{{ target.last_contact|date:"Y/m/d" }}{% else %}-{% endif %}</span>
            </span>
        </div>

        <!-- Avatar -->
        <div class="w-24 h-24 rounded-full border-2 border-white/10 mb-4 overflow-hidden relative shadow-xl">
             {% if target.avatar %}
                <img src="{{ target.avatar.url }}" class="w-full h-full object-cover">
             {% else %}
                <div class="w-full h-full flex items-center justify-center bg-surface text-4xl text-text-sub font-bold">
                    {{ target.nickname|slice:":1" }}
                </div>
             {% endif %}
        </div>
        
        <!-- Nickname -->
        <h1 class="text-2xl font-bold text-text-main mb-1">{{ target.nickname }}</h1>
        
        <!-- Names & Kana -->
        <div class="flex flex-col items-center mb-4">
            <p class="text-sm text-text-main">{{ target.last_name }} {{ target.first_name }}</p>
            <p class="text-[10px] text-text-sub">({{ target.last_name_kana }} {{ target.first_name_kana }})</p>
        </div>
        
        <!-- Quick Stats Row -->
        <div class="flex items-center justify-center gap-5 text-xs text-text-sub w-full">
            <div class="flex flex-col items-center">
                <span class="font-bold text-lg text-text-main flex items-center gap-1">
                    <i class="fas fa-comment text-blue-400/30 text-xs"></i> {{ log_count }}
                </span>
                <span>Logs</span>
            </div>
            <div class="flex flex-col items-center border-l border-white/10 pl-5">
                <span class="font-bold text-lg text-text-main flex items-center gap-1">
                    <i class="fas fa-handshake text-emerald-500/30 text-xs"></i> {{ contact_count }}
                </span>
                <span>Contacts</span>
            </div>
            <div class="flex flex-col items-center border-l border-white/10 pl-5">
                <span class="font-bold text-lg text-text-main flex items-center gap-1">
                    <i class="fas fa-question-circle text-purple-400/30 text-xs"></i> {{ total_answers }}
                </span>
                <span>Answers</span>
            </div>
            <div class="flex flex-col items-center border-l border-white/10 pl-5">
                <span class="font-bold text-lg text-text-main flex items-center gap-1">
                    <i class="fas fa-star text-yellow-500/30 text-xs"></i> {{ total_points }}
                </span>
                <span>Points</span>
            </div>
        </div>
    </div>

    <!-- Base Profile & Progress Section -->
    <div class="px-6 py-6 bg-surface border-b border-white/5">
        <h2 class="text-xs font-bold text-text-sub uppercase tracking-wider mb-4 opacity-70">BASE PROFILE</h2>
        
        <!-- Base Profile Progress Bar (Moved here) -->
        <div class="mb-6">
            <div class="flex justify-between items-center text-[10px] font-bold text-text-sub uppercase tracking-wider mb-1.5 opacity-80">
                <span>PROGRESS</span>
                <span>{{ base_progress }}%</span>
            </div>
            <div class="h-2 w-full bg-white/5 rounded-full overflow-hidden">
                <div class="h-full block bar-animate js-progress-bar" 
                     style="width: 0%; height: 100%; display: block;"
                     data-width="{{ base_progress }}%" 
                     data-color="{{ base_color }}" 
                     data-shadow="{{ base_shadow }}"></div>
            </div>
        </div>

        <div class="space-y-3 mb-8">
            <div class="flex justify-between items-center text-xs">
                <span class="text-text-sub">誕生日</span>
                <span class="text-text-main font-bold">
                    {% if target.birth_year %}
                        {{ target.birth_year }}/{{ target.birth_month }}/{{ target.birth_day }} ({{ age }}歳) {{ target.eto }} {{ target.zodiac_sign }}
                    {% else %}-{% endif %}
                </span>
            </div>
            
            <!-- 3-Column Row: Gender, Blood, Personality -->
            <div class="flex items-center gap-4 py-2 border-y border-white/5 my-2">
                <div class="flex-1">
                    <div class="text-[9px] text-text-sub uppercase mb-0.5">性別</div>
                    <div class="text-xs text-text-main font-bold">{{ base_answers.性別|default:"-" }}</div>
                </div>
                <div class="w-px h-6 bg-white/10"></div>
                <div class="flex-1">
                    <div class="text-[9px] text-text-sub uppercase mb-0.5">血液型</div>
                    <div class="text-xs text-text-main font-bold">{{ base_answers.血液型|default:"-" }}</div>
                </div>
                <div class="w-px h-6 bg-white/10"></div>
                <div class="flex-1">
                    <div class="text-[9px] text-text-sub uppercase mb-0.5">性格タイプ</div>
                    <div class="text-xs text-text-main font-bold">{{ base_answers.性格タイプ|default:"-" }}</div>
                </div>
            </div>

            <div class="flex justify-between items-center text-xs pt-1">
                <span class="text-text-sub">記念日</span>
                <div class="text-right">
                    {% for anniv in custom_anniversaries %}
                        <div class="text-text-main font-bold">{{ anniv.label }} ({{ anniv.date|date:"m/d" }})</div>
                    {% empty %}
                        <span class="text-text-sub">-</span>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Other Shared Questions (Excl. the 3 above) -->
            <div class="pt-4 space-y-3 mt-2">
                {% for title, ans in base_answers.items %}
                    {% if title != "性別" and title != "血液型" and title != "性格タイプ" %}
                    <div class="flex justify-between text-xs">
                        <span class="text-text-sub">{{ title }}</span>
                        <span class="text-text-main font-medium">{{ ans|default:"-" }}</span>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Category Wise Progress -->
        <div class="space-y-4">
            <h2 class="text-xs font-bold text-text-sub uppercase tracking-wider mb-2 opacity-70">CATEGORY PROGRESS</h2>
            
            <!-- Row 1: Base and Category Progress (2 Columns) -->
            <div class="grid grid-cols-2 gap-x-4 gap-y-5">
                <!-- Base Profile Bar in Grid -->
                <div class="flex flex-col gap-1.5">
                    <div class="flex justify-between items-center text-[10px] font-bold text-text-sub uppercase tracking-tighter">
                        <span>Base Profile</span>
                        <span>{{ base_progress }}%</span>
                    </div>
                    <div class="h-1.5 w-full bg-white/5 rounded-full overflow-hidden">
                        <div class="h-full block bg-emerald-500 bar-animate js-progress-bar" 
                             style="width: 0%; height: 100%; display: block;"
                             data-width="{{ base_progress }}%"></div>
                    </div>
                </div>

                <!-- Category Bars (Excluding Base Info which is hidden from qa_data_progress in view) -->
                {% for cat in qa_data_progress %}
                <div class="flex flex-col gap-1.5">
                    <div class="flex justify-between items-center text-[10px] font-bold text-text-sub uppercase tracking-tighter">
                        <span class="truncate pr-2">{{ cat.category.name }}</span>
                        <span>{{ cat.progress }}%</span>
                    </div>
                    <div class="h-1.5 w-full bg-white/5 rounded-full overflow-hidden">
                        <div class="h-full block bg-blue-500 opacity-80 bar-animate js-progress-bar" 
                             style="width: 0%; height: 100%; display: block;"
                             data-width="{{ cat.progress }}%"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    </div>

    <!-- Tabs content container -->
    <div class="flex-1" x-data="{ 
        tab: 'timeline',
        searchQuery: '',
        selectedTagId: null,
        showAllTags: false,
        items: [
            {% for item in events %}
            {
                id: {{ item.id }},
                type: '{{ item.type }}',
                content: '{{ item.content|escapejs|default:"" }}',
                date: '{{ item.date|date:"Y/m/d (D)" }}',
                dateRaw: '{{ item.date|date:"Y/m/d" }}',
                hasContact: {{ item.contact_made|yesno:"true,false" }},
                tags: [{% for tag in item.tags.all %}{id: {{ tag.id }}, name: '{{ tag.name|escapejs }}'}{% if not forloop.last %},{% endif %}{% endfor %}],
                isQuestion: {% if item.type == 'Question' %}true{% else %}false{% endif %}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        get filteredLogs() {
            return this.items.filter(item => {
                const searchMatch = !this.searchQuery || 
                    item.content.toLowerCase().includes(this.searchQuery.toLowerCase().replace(/^#/, ''));
                
                // If search starts with #, treat as tag search
                if (this.searchQuery.startsWith('#')) {
                    const tagName = this.searchQuery.substring(1).toLowerCase();
                    const hasTag = item.tags.some(t => t.name.toLowerCase().includes(tagName));
                    if (!hasTag) return false;
                }

                const tagMatch = !this.selectedTagId || 
                    item.tags.some(t => t.id === this.selectedTagId);
                
                return searchMatch && tagMatch;
            });
        },
        toggleTag(tagId) {
            if (this.selectedTagId === tagId) {
                this.selectedTagId = null;
            } else {
                this.selectedTagId = tagId;
                this.searchQuery = ''; // Clear search when picking tag via chip
            }
        },
        searchByTag(tagLabel) {
            this.searchQuery = '#' + tagLabel;
            this.selectedTagId = null;
            this.tab = 'timeline';
        }
    }">
        
        <!-- Sticky Tab Header -->
        <div class="sticky top-[65px] z-40 bg-background/95 backdrop-blur border-b border-white/10 flex text-sm font-bold">
            <button @click="tab = 'timeline'" :class="{'text-primary border-b-2 border-primary': tab==='timeline', 'text-text-sub border-b-2 border-transparent': tab!=='timeline'}" class="flex-1 py-3 text-center transition">
                Event Log
            </button>
            <button @click="tab = 'questions'" :class="{'text-primary border-b-2 border-primary': tab==='questions', 'text-text-sub border-b-2 border-transparent': tab!=='questions'}" class="flex-1 py-3 text-center transition">
                Q&A Summary
            </button>
        </div>

        <!-- 1. Event Log Tab -->
        <div x-show="tab === 'timeline'" class="p-4">
             <!-- Revamped Search & Tags -->
             <div class="space-y-3 mb-6">
                 <div class="relative">
                     <input type="text" x-model="searchQuery" placeholder="search Logs..." class="w-full bg-surface border border-white/10 rounded-full py-2 pl-9 pr-4 text-sm text-text-main focus:border-primary focus:outline-none placeholder-text-sub/50" autocomplete="off">
                     <i class="fas fa-search absolute left-3 top-2.5 text-text-sub text-xs"></i>
                 </div>

                 <!-- Tags List (Top 10 + More) -->
                 <div class="flex flex-wrap gap-1.5 px-1">
                     {% for tag in all_tags %}
                        {% if forloop.counter <= 10 %}
                        <button @click="toggleTag({{ tag.id }})" 
                                :class="selectedTagId === {{ tag.id }} ? 'bg-primary text-black border-primary' : 'bg-white/5 text-text-sub border-white/10'"
                                class="text-[10px] px-2.5 py-1 rounded-full border transition-all active:scale-95">
                            #{{ tag.name }}
                        </button>
                        {% else %}
                        <button x-show="showAllTags" 
                                @click="toggleTag({{ tag.id }})" 
                                :class="selectedTagId === {{ tag.id }} ? 'bg-primary text-black border-primary' : 'bg-white/5 text-text-sub border-white/10'"
                                class="text-[10px] px-2.5 py-1 rounded-full border transition-all active:scale-95"
                                style="display: none;">
                            #{{ tag.name }}
                        </button>
                        {% endif %}
                     {% endfor %}
                     
                     {% if all_tags|length > 10 %}
                     <button @click="showAllTags = !showAllTags" class="text-[10px] px-2.5 py-1 rounded-full bg-white/5 text-text-sub border border-white/10 italic">
                        <span x-text="showAllTags ? 'collapse' : '...'"></span>
                     </button>
                     {% endif %}
                 </div>
             </div>

             <!-- Log Items -->
             <div class="space-y-0 relative">
                 <template x-for="(item, index) in filteredLogs" :key="item.id">
                     <div>
                         <!-- Date Divider -->
                         <template x-if="index === 0 || item.dateRaw !== filteredLogs[index-1].dateRaw">
                             <div class="flex items-center gap-4 py-6 opacity-30 select-none">
                                 <div class="h-px flex-1 bg-white/20"></div>
                                 <span class="text-[10px] font-bold tracking-widest uppercase" x-text="item.dateRaw"></span>
                                 <div class="h-px flex-1 bg-white/20"></div>
                             </div>
                         </template>

                         <div class="flex gap-4 group">
                             <!-- Leading Icon Column -->
                             <div class="flex flex-col items-center shrink-0 w-6">
                                 <div class="w-6 h-6 flex items-center justify-center rounded-full" 
                                      :class="item.isQuestion ? 'bg-purple-500/20 text-purple-400' : (item.hasContact ? 'bg-emerald-500/20 text-emerald-400' : 'bg-white/5 text-text-sub')">
                                     <i class="fas text-[10px]" :class="item.isQuestion ? 'fa-question-circle' : (item.hasContact ? 'fa-handshake' : 'fa-sticky-note')"></i>
                                 </div>
                                 <div class="w-px flex-1 bg-white/5 group-last:hidden mt-2"></div>
                             </div>
                             
                             <!-- Content -->
                             <div class="flex-1 pb-6">
                                 <div class="flex justify-between items-start mb-1">
                                     <span class="text-[10px] text-text-sub uppercase font-bold tracking-tight opacity-40" x-text="item.isQuestion ? 'ANSWER' : 'EVENT'"></span>
                                 </div>
                                 <p class="text-[13px] text-text-main whitespace-pre-wrap leading-snug" x-text="item.content"></p>
                                 
                                 <!-- Item Tags -->
                                 <div class="flex flex-wrap gap-1 mt-2" x-show="item.tags.length > 0">
                                     <template x-for="tag in item.tags" :key="tag.id">
                                         <span @click.stop="searchByTag(tag.name)" class="text-[9px] px-2 py-0.5 rounded-full bg-surface border border-white/10 text-text-sub hover:text-primary hover:border-primary/30 transition cursor-pointer selection:bg-primary selection:text-black">
                                             #<span x-text="tag.name"></span>
                                         </span>
                                     </template>
                                 </div>
                             </div>
                         </div>
                     </div>
                 </template>

                 <!-- Empty State -->
                 <div x-show="filteredLogs.length === 0" class="text-center py-12 text-text-sub text-sm italic opacity-50">
                    No matching logs found.
                 </div>
             </div>
             
             <!-- Add Button (Sticky or Bottom) -->
             <div class="text-center py-8">
                 <a href="{% url 'intelligence_log' %}?target_id={{ target.id }}" class="inline-flex items-center gap-2 px-6 py-2.5 rounded-full bg-primary text-black text-xs font-bold shadow-xl active:scale-95 transition">
                     <i class="fas fa-plus"></i> Add Event Log
                 </a>
             </div>
        </div>

        <!-- 2. Q&A Tab -->
        <div x-show="tab === 'questions'" class="p-4 space-y-2" style="display: none;">
            {% for cat_data in qa_data %}
            <div class="mb-4">
                <h3 class="text-xs font-bold text-text-sub uppercase tracking-wider mb-2 px-1">{{ cat_data.category.name }}</h3>
                <div class="space-y-2">
                    {% for q_info in cat_data.questions %}
                    <div class="bg-surface rounded-lg p-3 border border-white/5">
                        <div class="text-xs text-primary font-bold mb-1">{{ q_info.question.title }}</div>
                        {% if q_info.is_answered %}
                        <p class="text-sm text-text-main">{{ q_info.answer }}</p>
                        <div class="text-[10px] text-text-sub text-right mt-1 opacity-50">{{ q_info.answer_date|timesince }} ago</div>
                        {% else %}
                        <p class="text-sm text-text-sub italic opacity-50">Not answered yet</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        
    </div>

</div>

<!-- Alpine.js for Tabs -->
<script src="//unpkg.com/alpinejs" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Small delay to ensure transition triggers
    setTimeout(() => {
        document.querySelectorAll('.js-progress-bar').forEach(el => {
            if (el.dataset.width) el.style.width = el.dataset.width;
            if (el.dataset.color) el.style.backgroundColor = el.dataset.color;
            if (el.dataset.shadow) el.style.boxShadow = el.dataset.shadow;
        });
    }, 50);
});
</script>
{% endblock %}
