{% extends "mobile/base_mobile.html" %}

{% block title %}Question Detail{% endblock %}

{% block content %}
<div class="flex flex-col h-full bg-background pb-20 relative">

    <!-- Header -->
    <header class="h-14 px-4 flex items-center justify-between border-b border-white/10 bg-surface/95 backdrop-blur sticky top-0 z-30 shrink-0">
        <div class="flex items-center gap-3">
            <button data-url="{% url 'question_list' %}" 
                    onclick="window.location.href=this.dataset.url" 
                    class="w-10 h-10 flex items-center justify-center text-text-sub hover:text-white rounded-full hover:bg-white/5 active:bg-white/10">
                <i class="fas fa-chevron-left text-lg"></i>
            </button>
            <span class="text-xs font-bold text-text-sub uppercase tracking-wider">QUESTION DETAIL</span>
        </div>
        <button onclick="document.getElementById('targetSelectModal').classList.remove('hidden')" class="w-8 h-8 flex items-center justify-center rounded-full bg-primary/10 text-primary border border-primary/20 hover:bg-primary/20 transition-colors">
            <i class="fas fa-plus"></i>
        </button>
    </header>

    <!-- Scrollable Content -->
    <div class="flex-1 overflow-y-auto scroll-smooth">
        <!-- Question Info -->
        <div class="p-6 pb-2">
            <!-- Badges Row -->
            <div class="flex flex-wrap items-center gap-2 mb-3">
                {% if question.category %}
                <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-white/5 text-text-sub border border-white/10">{{ question.category.name }}</span>
                {% endif %}
                {% if question.rank %}
                <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-white/5 text-text-sub border border-white/10">{{ question.rank.name }}</span>
                {% endif %}
                <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-white/5 text-text-sub border border-white/10">{{ question.get_answer_type_display }}</span>
            </div>

            <!-- Answer Stats -->
            <div class="text-[10px] text-primary mb-3 font-mono opacity-80">
                <i class="fas fa-users mr-1"></i> {{ total_targets }} People / {{ total_answers }} Answers
            </div>

            <!-- Title -->
            <h1 class="text-xl font-bold text-text-main mb-3 leading-snug">{{ question.title }}</h1>
            
            <!-- Description -->
            {% if question.description %}
            <p class="text-sm text-text-sub mb-2 leading-relaxed opacity-90">{{ question.description }}</p>
            {% endif %}

            <!-- Example -->
            {% if question.example %}
            <p class="text-xs text-text-sub opacity-50">{{ question.example }}</p>
            {% endif %}
        </div>
        
        <div class="h-px bg-white/5 mx-6 mb-4"></div>

        <!-- Filter Area -->
        <div class="px-4 mb-3">
             <select onchange="updateGroupFilter(this.value)" class="w-full bg-surface border border-white/10 rounded-lg text-sm text-text-sub px-3 py-2 outline-none focus:border-primary">
                 <option value="">All Groups</option>
                 {% for g in groups %}
                 <option value="{{ g.id }}" {% if request.GET.group|add:"0" == g.id %}selected{% endif %}>{{ g.name }}</option>
                 {% endfor %}
             </select>
        </div>

        <!-- Answers List -->
        <div class="px-4 pb-20 space-y-4"> 
            {% for item in answer_data %}
            <div class="bg-surface rounded-xl p-3 border border-white/5">
                <div class="flex items-start gap-3 mb-2">
                    <!-- Avatar -->
                    <div class="w-8 h-8 rounded-full bg-surface-2 border border-white/10 flex items-center justify-center text-xs font-bold overflow-hidden shrink-0">
                        {% if item.target.avatar %}
                        <img src="{{ item.target.avatar.url }}" class="w-full h-full object-cover">
                        {% else %}
                        {{ item.target.nickname|slice:":1" }}
                        {% endif %}
                    </div>
                    
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <span class="font-bold text-sm text-text-main">{{ item.target.nickname }}</span>
                            <!-- Use latest_answer.date for sorting display -->
                            <span class="text-[10px] text-text-sub">{{ item.latest_answer.date|date:"Y/m/d" }}</span>
                        </div>
                        <div class="mt-1 text-sm text-primary leading-relaxed whitespace-pre-wrap">{{ item.latest_answer.content }}</div>
                    </div>
                </div>
                
                {% if item.answer_count > 1 %}
                <details class="text-[10px] text-text-sub">
                    <summary class="cursor-pointer hover:text-primary transition py-1">View older answers ({{ item.answer_count|add:"-1" }})</summary>
                    <div class="pl-11 border-l-2 border-white/5 mt-2 space-y-2">
                        {% for old_ans in item.all_answers|slice:"1:" %}
                        <div>
                            <div class="flex justify-between opacity-50 mb-0.5">
                                <span>{{ old_ans.date|date:"Y/m/d" }}</span>
                            </div>
                            <p class="text-text-main opacity-80">{{ old_ans.content }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </details>
                {% endif %}
            </div>
            {% empty %}
            <div class="text-center py-10 opacity-50">
                <p>No answers recorded yet.</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Target Selection Modal -->
<div id="targetSelectModal" class="fixed inset-0 z-[60] hidden bg-background flex flex-col animate-slide-up">
    <!-- Header -->
    <div class="p-4 border-b border-white/10 shrink-0 bg-surface z-10">
         <div class="flex items-center gap-3 mb-3">
            <button onclick="document.getElementById('targetSelectModal').classList.add('hidden')" class="w-8 h-8 flex items-center justify-center text-text-sub hover:text-white rounded-full bg-white/5">
                <i class="fas fa-chevron-left"></i>
            </button>
            <h3 class="text-sm font-bold tracking-wider text-text-main uppercase">Select Target</h3>
        </div>
        <!-- Search -->
        <div class="relative">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-text-sub opacity-50 text-xs"></i>
            <input type="text" id="targetSearchInput" placeholder="Search targets..." oninput="filterTargets(this.value)" 
                   class="w-full bg-surface-2 border border-white/10 rounded-lg pl-9 pr-3 py-2 text-sm text-text-main focus:border-primary/50 focus:ring-0 outline-none placeholder-text-sub/40" autocomplete="off">
        </div>
    </div>

    <!-- List -->
    <div id="targetListContainer" class="flex-1 overflow-y-auto p-4 space-y-2">
        {% for t in all_targets %}
        <button onclick="logForTarget('{{ t.id }}')" data-name="{{ t.nickname|lower }}" class="target-item-btn w-full bg-surface p-3 rounded-xl border border-white/10 flex items-center gap-3 active:bg-primary/20 hover:border-white/20 transition-colors">
             <div class="w-10 h-10 rounded-full bg-surface-2 overflow-hidden shrink-0">
                 {% if t.avatar %}<img src="{{ t.avatar.url }}" class="w-full h-full object-cover">
                 {% else %}<span class="flex items-center justify-center w-full h-full font-bold text-xs">{{ t.nickname|slice:":1" }}</span>{% endif %}
             </div>
             <span class="font-bold text-text-main">{{ t.nickname }}</span>
        </button>
        {% endfor %}
        <div id="noTargetsMsg" class="hidden text-center text-text-sub text-xs mt-4">No targets found.</div>
    </div>
</div>

<script>
    function updateGroupFilter(groupId) {
        const url = new URL(window.location.href);
        if(groupId) {
            url.searchParams.set('group', groupId);
        } else {
            url.searchParams.delete('group');
        }
        window.location.href = url.toString();
    }

    function logForTarget(targetId) {
        // Redirect to Log with target, question, and action to trigger modal
        window.location.href = `{% url 'intelligence_log' %}?target_id=${targetId}&action=question&question_id={{ question.id }}&next=/questions/detail/?question_id={{ question.id }}`;
    }

    function filterTargets(query) {
        const term = query.toLowerCase();
        const items = document.querySelectorAll('.target-item-btn');
        let visibleCount = 0;
        
        items.forEach(btn => {
            const name = btn.dataset.name;
            if(name.includes(term)) {
                btn.classList.remove('hidden');
                visibleCount++;
            } else {
                btn.classList.add('hidden');
            }
        });
        
        const msg = document.getElementById('noTargetsMsg');
        if(visibleCount === 0) msg.classList.remove('hidden');
        else msg.classList.add('hidden');
    }
</script>
{% endblock %}
