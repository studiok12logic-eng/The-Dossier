{% extends 'base.html' %}
{% load static %}
{% block content_wrapper_class %}flex-1 flex flex-col min-h-0 overflow-hidden p-4 md:p-8 pb-32 md:pb-12{% endblock %}

{% block content %}
<div class="flex-1 min-h-0 flex flex-col gap-4 overflow-hidden">
    
    <!-- Anniversary Notifications -->
    {% if upcoming_anniversaries %}
    <div class="bg-surface/50 border border-accent/30 rounded-lg p-3 shrink-0 flex items-center gap-3 overflow-x-auto">
        <i class="fas fa-gift text-accent text-sm shrink-0"></i>
        <div class="flex items-center gap-4 flex-1 min-w-0">
            {% for item in upcoming_anniversaries %}
            <div class="flex items-center gap-2 shrink-0">
                <div class="w-8 h-8 rounded-full bg-background border border-border overflow-hidden">
                    {% if item.target.avatar %}
                    <img src="{{ item.target.avatar.url }}" class="w-full h-full object-cover">
                    {% else %}
                    <div class="w-full h-full flex items-center justify-center text-xs text-text-sub">{{ item.target.nickname|slice:":1" }}</div>
                    {% endif %}
                </div>
                <div class="text-xs">
                    <span class="text-accent font-bold">{{ item.name }}</span>
                    <span class="text-text-sub mx-1">·</span>
                    <span class="text-text-sub">{{ item.date|date:"m/d" }}</span>
                    <span class="ml-1 text-[10px] font-bold {% if item.is_today %}text-accent-red{% else %}text-primary{% endif %}">
                        {% if item.is_today %}TODAY{% else %}{{ item.days_left }}d{% endif %}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Main Content: Recent Logs List -->
    <div class="flex-1 min-h-0 grid grid-cols-1 gap-6 overflow-hidden">
        <div class="flex flex-col min-h-0 bg-surface border border-border rounded-xl overflow-hidden shadow-xl">
            <!-- Header -->
            <div class="p-4 border-b border-border bg-surface shrink-0">
                <h2 class="text-lg font-mono text-text-main flex items-center gap-2">
                    <span class="w-1 h-5 bg-primary block"></span> RECENT ACTIVITY
                </h2>
                <div class="text-xs text-text-sub mt-1">最近ログを追加した人</div>
            </div>

            <!-- Recent Logs List -->
            <div id="recentLogsContainer" class="flex-1 overflow-y-auto p-4 space-y-4 bg-background/50">
                <div id="recentLogsContent" class="space-y-3"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Recent Logs Logic ---
    const recentLogsContent = document.getElementById('recentLogsContent');
    
    function fetchRecentLogs() {
        // Fetch recent activity - last 10 people who added logs
        fetch('{% url "timeline_list" %}?limit=10&group_by_target=true')
            .then(res => res.json())
            .then(data => {
                if(data.success && data.data.length > 0) {
                    renderRecentLogs(data.data);
                } else {
                    recentLogsContent.innerHTML = '<div class="text-center text-text-sub text-xs py-10">まだログがありません</div>';
                }
            })
            .catch(err => {
                console.error(err);
                recentLogsContent.innerHTML = '<div class="text-center text-text-sub text-xs py-10">エラーが発生しました</div>';
            });
    }
    
    function renderRecentLogs(items) {
        const frag = document.createDocumentFragment();
        
        items.forEach(item => {
            const el = document.createElement('div');
            const target = item.target || {nickname: 'Unknown'};
            const isQ = item.type === 'Question';
            const typeBadge = isQ ? 'bg-green-500/20 text-green-400' : 'bg-blue-500/20 text-blue-400';
            
            el.className = "bg-surface border border-border rounded-lg p-4 hover:border-primary/30 transition-all group";
            el.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="w-12 h-12 rounded-full bg-background border border-border overflow-hidden shrink-0">
                         ${ target.avatar ? `<img src="${target.avatar}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-sm text-text-sub">${target.nickname[0]}</div>` }
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start mb-2">
                            <div class="text-base font-bold text-text-main font-mono">${escapeHtml(target.nickname)}</div>
                            <div class="text-[10px] text-text-sub font-mono text-right leading-tight">
                                <div>${item.date}</div>
                                <div class="opacity-50">${item.created_at.split(' ')[1] || ''}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="px-2 py-0.5 rounded text-[10px] ${typeBadge} border border-white/5">${item.type.toUpperCase()}</span>
                            ${item.contact_made ? '<span class="px-2 py-0.5 rounded text-[10px] bg-primary/20 text-primary border border-primary/30"><i class="fas fa-handshake mr-1"></i>Encanto</span>' : ''}
                        </div>
                        <div class="text-sm text-text-sub line-clamp-2 leading-relaxed">
                            ${ isQ ? `<span class="font-bold text-text-main">Q. ${escapeHtml(item.question_title || '')}</span> ` : '' }
                            ${escapeHtml(item.description || '').substring(0, 100)}${(item.description || '').length > 100 ? '...' : ''}
                        </div>
                        <div class="mt-3 flex justify-end opacity-0 group-hover:opacity-100 transition-opacity">
                             <a href="{% url 'intelligence_log' %}?target_id=${target.id}&date=${item.date}" class="text-[10px] px-3 py-1.5 rounded border border-border text-text-sub hover:text-text-main hover:bg-text-main/5 transition flex items-center gap-1">
                                 <i class="fas fa-pen"></i> VIEW LOG
                             </a>
                        </div>
                    </div>
                </div>
            `;
            frag.appendChild(el);
        });
        recentLogsContent.appendChild(frag);
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    // Init
    fetchRecentLogs();

</script>
{% endblock %}