{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="h-full flex flex-col gap-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-mono font-bold text-white flex items-center gap-2">
            <span class="w-2 h-8 bg-primary block"></span>
            Dashboard
        </h1>
        <div class="flex items-center gap-4">
            <span class="text-xs font-mono text-gray-500">SYSTEM STATUS: ONLINE</span>
            <div class="w-2 h-2 rounded-full bg-primary animate-pulse"></div>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 flex-1 min-h-0">
        <!-- Left Column: Target & Intel -->
        <div class="lg:col-span-7 flex flex-col gap-6 min-h-0">
            <!-- Active Target Card -->
            <div class="bg-surface/50 border border-primary/20 rounded-xl p-6 relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-50">
                    <svg class="w-64 h-64 text-primary/5 -mr-16 -mt-16" fill="currentColor" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="50" />
                    </svg>
                </div>

                <h2 class="text-sm font-mono text-primary mb-4 tracking-widest uppercase">Target: Priority Alpha</h2>

                <div class="flex flex-col md:flex-row gap-8 items-center md:items-start">
                    <!-- Avatar -->
                    <div class="relative w-40 h-40 shrink-0">
                        <div
                            class="w-full h-full rounded-lg overflow-hidden border-2 border-primary/30 relative avatar-noise">
                            {% if active_target and active_target.avatar %}
                            <img src="{{ active_target.avatar.url }}" alt="Target" class="w-full h-full object-cover">
                            {% else %}
                            <div
                                class="w-full h-full bg-gray-700 flex items-center justify-center text-gray-400 text-xs">
                                No Image</div>
                            {% endif %}
                            <div class="absolute inset-0 bg-primary/10 mix-blend-overlay"></div>
                        </div>
                        <div
                            class="absolute -bottom-2 -right-2 bg-black/80 border border-primary px-2 py-1 rounded text-xs font-mono text-primary">
                            98% MATCH
                        </div>
                    </div>

                    <!-- Info -->
                    <div class="flex-1 space-y-4 w-full">
                        <div>
                            <h3 class="text-3xl font-bold text-white mb-1">
                                {% if active_target %}
                                {{ active_target.nickname }}
                                {% else %}
                                未選択
                                {% endif %}
                            </h3>
                            <div class="flex items-center gap-3">
                                <span
                                    class="px-2 py-0.5 rounded bg-primary/20 text-primary text-xs font-mono border border-primary/20">
                                    RANK: {% if active_target %}{{ active_target.get_rank_display }}{% else %}N/A{%
                                    endif %}
                                </span>
                                <span
                                    class="px-2 py-0.5 rounded bg-orange-500/20 text-orange-400 text-xs font-mono border border-orange-500/20">
                                    SSR Rarity
                                </span>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-black/40 p-3 rounded border border-white/5">
                                <p class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">諜報収集率</p>
                                <div class="flex items-end gap-2">
                                    <span class="text-2xl font-mono font-bold text-primary">
                                        {% if active_target %}{{ active_target.intel_depth|default:"0" }}{% else %}0{%
                                        endif %}%
                                    </span>
                                    <div class="h-1.5 flex-1 bg-gray-800 rounded-full mb-2">
                                        <div class="h-full bg-primary rounded-full"
                                            style="width: {% if active_target %}{{ active_target.intel_depth|default:'0' }}{% else %}0{% endif %}%">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-black/40 p-3 rounded border border-white/5">
                                <p class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">最終接触</p>
                                <p class="text-lg font-mono text-white">2h 14m</p>
                            </div>
                        </div>

                        <button
                            class="w-full py-3 bg-gradient-to-r from-primary to-emerald-600 text-black font-bold font-mono rounded-lg hover:from-primary/90 hover:to-emerald-500/90 transition-all uppercase tracking-wide flex items-center justify-center gap-2 group-hover:shadow-[0_0_20px_rgba(16,185,129,0.3)]">
                            <span>接触開始</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Latest Intel -->
            <div class="bg-surface/50 border border-white/10 rounded-xl p-6 flex-1 min-h-[300px]">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-sm font-mono text-gray-400 tracking-widest uppercase">最新諜報ログ</h2>
                    <button class="text-xs text-primary hover:text-primary/80">全て見る</button>
                </div>

                <div class="space-y-4 font-mono text-sm">
                    {% for item in timeline %}
                    <div
                        class="flex gap-4 p-3 rounded hover:bg-white/5 border-l-2 {% if item.sentiment == 'Alert' or item.sentiment == 'Negative' %}border-red-500/50{% else %}border-primary{% endif %} bg-primary/5 transition-colors">
                        <span class="text-gray-500 w-24 text-right flex-shrink-0">{{ item.date|date:"H:i" }}</span>
                        <div>
                            <span
                                class="{% if item.sentiment == 'Alert' or item.sentiment == 'Negative' %}text-red-400{% else %}text-primary{% endif %} font-bold">{{
                                item.get_type_display }}</span>
                            <span class="text-gray-400">@{{ item.target.origin }}</span>
                            <p class="text-xs text-gray-500 mt-1">{{ item.content }}</p>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-gray-500 py-4">データがありません</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Right Column: Tactical Map -->
        <div class="lg:col-span-5 flex flex-col gap-6 min-h-0">
            <div
                class="bg-surface/50 border border-white/10 rounded-xl p-0 relative overflow-hidden flex-1 h-full min-h-[400px]">
                <div class="absolute inset-0 p-6 flex flex-col z-10 pointer-events-none">
                    <div class="flex items-center justify-between">
                        <h2 class="text-sm font-mono text-gray-400 tracking-widest uppercase">戦術マップ</h2>
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-width="2"
                                d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z">
                            </path>
                        </svg>
                    </div>
                </div>

                <!-- Map Visualization Placeholder (Grid & Lines) -->
                <div class="absolute inset-0 bg-[#080a09] opacity-80">
                    <!-- Grid -->
                    <div class="absolute inset-0"
                        style="background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 40px 40px;">
                    </div>

                    <!-- Nodes (CSS absolute positioning) -->
                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full h-full">
                        <!-- Center Node -->
                        <div class="absolute top-[30%] left-[20%]">
                            <div class="relative">
                                <div class="w-3 h-3 bg-primary rounded-full shadow-[0_0_10px_#10b981]"></div>
                                <div
                                    class="absolute top-4 left-0 bg-primary/20 text-primary text-[10px] px-2 py-0.5 rounded border border-primary/30 whitespace-nowrap">
                                    {% if active_target %}{{ active_target.nickname }}{% else %}未選択{% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="absolute top-[40%] right-[20%]">
                            <div class="relative">
                                <div class="w-2 h-2 bg-gray-500 rounded-full"></div>
                                <div class="absolute top-3 left-0 text-gray-500 text-[10px] whitespace-nowrap">CONTACT A
                                </div>
                            </div>
                        </div>

                        <div class="absolute bottom-[20%] left-[40%]">
                            <div class="relative">
                                <div class="w-2 h-2 bg-gray-500 rounded-full"></div>
                                <div
                                    class="absolute top-3 left-0 bg-gray-800/80 text-gray-400 text-[10px] px-2 py-0.5 rounded border border-white/10 whitespace-nowrap">
                                    UNKNOWN LOCATION</div>
                            </div>
                        </div>

                        <!-- Connecting Lines -->
                        <svg class="absolute inset-0 w-full h-full pointer-events-none">
                            <line x1="20%" y1="30%" x2="80%" y2="40%" stroke="#10b981" stroke-width="1"
                                stroke-opacity="0.3" />
                            <line x1="20%" y1="30%" x2="40%" y2="80%" stroke="#10b981" stroke-width="1"
                                stroke-opacity="0.3" />
                            <line x1="80%" y1="40%" x2="40%" y2="80%" stroke="#10b981" stroke-width="1"
                                stroke-opacity="0.3" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}