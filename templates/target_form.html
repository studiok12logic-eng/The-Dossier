{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
<div class="h-full flex flex-col gap-6 overflow-y-auto pr-2 pb-10">
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-mono font-bold text-white flex items-center gap-2">
            <span class="w-2 h-8 bg-primary block"></span>
            {% if is_edit %}TARGET EDIT{% else %}NEW TARGET{% endif %}
        </h1>
        <a href="{% url 'target_list' %}" class="text-gray-500 hover:text-white font-mono text-sm">
            [ BACK TO LIST ]
        </a>
    </div>

    <!-- Main Form -->
    <form method="post" enctype="multipart/form-data" class="space-y-8" id="targetForm">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <!-- 1. Basic Info Section -->
        <section class="bg-surface/30 border border-white/10 rounded-xl p-6 relative overflow-hidden">
            <!-- Corner decorations -->
            <div class="absolute top-0 left-0 w-2 h-2 border-t border-l border-primary/50"></div>
            <div class="absolute top-0 right-0 w-2 h-2 border-t border-r border-primary/50"></div>
            <div class="absolute bottom-0 left-0 w-2 h-2 border-b border-l border-primary/50"></div>
            <div class="absolute bottom-0 right-0 w-2 h-2 border-b border-r border-primary/50"></div>

            <h2 class="text-primary font-mono text-lg mb-6 flex items-center gap-2 border-b border-white/5 pb-2">
                <span class="text-primary/50">01.</span> BASIC IDENTITY
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <!-- Avatar Column -->
                <div class="md:col-span-1 flex flex-col gap-4">
                    <div class="aspect-square bg-black border-2 border-dashed border-white/20 rounded-lg flex items-center justify-center relative group overflow-hidden"
                        id="avatarPreviewContainer">
                        {% if form.instance.avatar %}
                        <img src="{{ form.instance.avatar.url }}" class="w-full h-full object-cover">
                        {% else %}
                        <div class="text-center text-gray-500 p-4">
                            <span class="block text-4xl mb-2">+</span>
                            <span class="text-xs font-mono">UPLOAD PHOTO</span>
                        </div>
                        {% endif %}
                        <!-- File Input Overlay -->
                        <input type="file" name="avatar" id="id_avatar" accept="image/*"
                            class="absolute inset-0 opacity-0 cursor-pointer z-10 w-full h-full">
                    </div>
                    <div class="text-[10px] text-gray-500 font-mono text-center">
                        CLICK TO UPLOAD / DRAG & DROP<br>
                        (Auto-crop to Square)
                    </div>
                </div>

                <!-- Fields Column -->
                <div class="md:col-span-3 space-y-4">
                    <!-- Nickname (Required) -->
                    <div class="form-group">
                        <label class="block text-xs font-mono text-gray-400 mb-1">CODENAME (NICKNAME) *</label>
                        {{ form.nickname }}
                    </div>

                    <!-- Name Split -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-mono text-gray-400 mb-1">SURNAME</label>
                            {{ form.last_name }}
                        </div>
                        <div>
                            <label class="block text-xs font-mono text-gray-400 mb-1">GIVEN NAME</label>
                            {{ form.first_name }}
                        </div>
                    </div>
                    <!-- Kana Split -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-mono text-gray-400 mb-1">SURNAME (KANA)</label>
                            {{ form.last_name_kana }}
                        </div>
                        <div>
                            <label class="block text-xs font-mono text-gray-400 mb-1">GIVEN NAME (KANA)</label>
                            {{ form.first_name_kana }}
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. Physical & Bio Data -->
        <section class="bg-surface/30 border border-white/10 rounded-xl p-6">
            <h2 class="text-primary font-mono text-lg mb-6 flex items-center gap-2 border-b border-white/5 pb-2">
                <span class="text-primary/50">02.</span> BIO-METRICS
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Birthdate -->
                <div class="bg-black/20 p-4 rounded border border-white/5">
                    <label class="block text-xs font-mono text-gray-400 mb-2">DATE OF BIRTH</label>
                    <div class="grid grid-cols-3 gap-2 mb-2">
                        {{ form.birth_year }}
                        {{ form.birth_month }}
                        {{ form.birth_day }}
                    </div>
                    <div class="flex items-center gap-4 text-xs font-mono text-gray-500 mt-2">
                        <span id="ageDisplay">AGE: --</span>
                        <span id="etoDisplay">ETO: --</span>
                    </div>
                </div>

                <!-- Zodiac -->
                <div class="bg-black/20 p-4 rounded border border-white/5 relative">
                    <label class="block text-xs font-mono text-gray-400 mb-2">ZODIAC SIGN</label>
                    <div class="flex gap-2">
                        <div class="flex-1">
                            {{ form.zodiac_sign }}
                        </div>
                        <!-- Manual Override Select -->
                        <select id="zodiacParams"
                            class="bg-surface border border-white/10 rounded px-2 text-white text-xs w-24">
                            <option value="">AUTO</option>
                            <option value="Aries">♈ Aries</option>
                            <option value="Taurus">♉ Taurus</option>
                            <option value="Gemini">♊ Gemini</option>
                            <option value="Cancer">♋ Cancer</option>
                            <option value="Leo">♌ Leo</option>
                            <option value="Virgo">♍ Virgo</option>
                            <option value="Libra">♎ Libra</option>
                            <option value="Scorpio">♏ Scorpio</option>
                            <option value="Sagittarius">♐ Sagittarius</option>
                            <option value="Capricorn">♑ Capricorn</option>
                            <option value="Aquarius">♒ Aquarius</option>
                            <option value="Pisces">♓ Pisces</option>
                        </select>
                    </div>
                </div>

                <!-- Gender & Blood -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-mono text-gray-400 mb-1">GENDER</label>
                        {{ form.gender }}
                    </div>
                    <div>
                        <label class="block text-xs font-mono text-gray-400 mb-1">BLOOD TYPE</label>
                        {{ form.blood_type }}
                    </div>
                </div>
                <!-- Origin -->
                <div>
                    <label class="block text-xs font-mono text-gray-400 mb-1">ORIGIN (BIRTHPLACE)</label>
                    {{ form.birthplace }}
                </div>
            </div>
        </section>

        <!-- 3. Affiliation & Groups -->
        <section class="bg-surface/30 border border-white/10 rounded-xl p-6">
            <h2 class="text-primary font-mono text-lg mb-6 flex items-center gap-2 border-b border-white/5 pb-2">
                <span class="text-primary/50">03.</span> AFFILIATION
            </h2>

            <div class="form-group">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-xs font-mono text-gray-400">ASSIGNED GROUPS</label>
                    <button type="button" id="openGroupModal"
                        class="text-xs bg-primary/20 text-primary border border-primary/50 px-2 py-1 rounded hover:bg-primary/30 transition">
                        + NEW GROUP
                    </button>
                </div>
                {% if is_edit %}更新 (UPDATE){% else %}登録 (EXECUTE){% endif %}
                </button>
            </div>
    </form>
</div>
</div>

<!-- Group Modal -->
<div id="group_modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center">
    <div class="bg-surface border border-primary/50 rounded-xl p-6 w-96 shadow-2xl">
        <h3 class="text-lg font-mono text-white mb-4">新規グループ作成</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-xs text-gray-400 mb-1">グループ名</label>
                {{ group_form.name }}
            </div>
            <div>
                <label class="block text-xs text-gray-400 mb-1">説明</label>
                {{ group_form.description }}
            </div>
            <div class="flex justify-end gap-2 pt-4">
                <button type="button" onclick="document.getElementById('group_modal').classList.add('hidden')"
                    class="px-4 py-2 text-xs text-gray-400 hover:text-white">キャンセル</button>
                <button type="button" id="create_group_btn"
                    class="px-4 py-2 bg-primary text-black text-xs font-bold rounded hover:bg-primary/90">作成</button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Template for Anniversary Row -->
<div id="empty_form" class="hidden">
    <div class="anniversary-row flex gap-2 items-center mt-2">
        <div class="flex-1">{{ anniversaries.empty_form.label }}</div>
        <div class="w-40">{{ anniversaries.empty_form.date }}</div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Loader removed
        // --- Birthdate Logic (Same as before but refined) ---
        const yearSelect = document.getElementById('birth_year_select');
        const monthSelect = document.getElementById('birth_month_select');
        const daySelect = document.getElementById('birth_day_select');
        const zodiacInput = document.querySelector('input[name="zodiac_sign"]');

        // Eto Array
        const eto = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];

        // Populate Years
        const currentYear = new Date().getFullYear();
        // Pre-select logic if editing (can parse from hidden input or context if avail, 
        // but simpler to just populate and let user re-select for now if values missing)
        // Actually Django form handles initial binding for standard fields, but we split them.
        // Ideally we should pass initial values for year/month/day if editing.
        // For now, populate options first.

        for (let y = currentYear; y >= 1900; y--) {
            const option = document.createElement('option');
            const age = currentYear - y;
            const etoIndex = (y - 4) % 12;
            const etoName = eto[etoIndex];
            option.value = y;
            option.text = `${y}年 (${age}歳・${etoName})`;
            yearSelect.appendChild(option);
        }

        // Populate Days & Zodiac
        function updateDays() {
            const y = parseInt(yearSelect.value);
            const m = parseInt(monthSelect.value);
            const currentDay = parseInt(daySelect.value);

            // Save current selection
            const prevVal = daySelect.value;

            daySelect.innerHTML = '<option value="">日</option>';
            if (!m) return;
            const daysInMonth = new Date(y || 2000, m, 0).getDate();
            for (let d = 1; d <= daysInMonth; d++) {
                const option = document.createElement('option');
                option.value = d;
                option.text = d + '日';
                if (d == prevVal) option.selected = true;
                daySelect.appendChild(option);
            }
            updateZodiac();
        }

        function updateZodiac() {
            const m = parseInt(monthSelect.value);
            const d = parseInt(daySelect.value);
            if (!m || !d) { zodiacInput.value = ''; return; }

            let sign = '';
            if ((m == 3 && d >= 21) || (m == 4 && d <= 19)) sign = '牡羊座';
            else if ((m == 4 && d >= 20) || (m == 5 && d <= 20)) sign = '牡牛座';
            else if ((m == 5 && d >= 21) || (m == 6 && d <= 21)) sign = '双子座';
            else if ((m == 6 && d >= 22) || (m == 7 && d <= 22)) sign = '蟹座';
            else if ((m == 7 && d >= 23) || (m == 8 && d <= 22)) sign = '獅子座';
            else if ((m == 8 && d >= 23) || (m == 9 && d <= 22)) sign = '乙女座';
            else if ((m == 9 && d >= 23) || (m == 10 && d <= 23)) sign = '天秤座';
            else if ((m == 10 && d >= 24) || (m == 11 && d <= 22)) sign = '蠍座';
            else if ((m == 11 && d >= 23) || (m == 12 && d <= 21)) sign = '射手座';
            else if ((m == 12 && d >= 22) || (m == 1 && d <= 19)) sign = '山羊座';
            else if ((m == 1 && d >= 20) || (m == 2 && d <= 18)) sign = '水瓶座';
            else sign = '魚座';

            zodiacInput.value = sign;
        }

        yearSelect.addEventListener('change', updateDays);
        monthSelect.addEventListener('change', updateDays);
        daySelect.addEventListener('change', updateZodiac);

        // --- Pre-fill Date Logic for Edit Mode ---
        // If instance exists, we might need to parse birthdate if it's not None.
        // However, since we use `birth_year` etc. as fields in form, Django might fill them if we set initial in GET.
        // The current Form implementation extracts from cleaned_data on save, but doesn't decompose on init.
        // We should probably rely on the user re-entering detailed date if editing, OR improved Form __init__.
        // For this prototype, I'll rely on Django filling the `birth_year` input value if it matches the field name. 
        // And I need to sync the Select with that value.

        // Attempt to sync Selects with the Inputs (which might have values from backend)
        // But wait, I rendered them AS Select widgets in the HTML manually...
        // Actually in the Template I used `select` tags with IDs, but the `form.birth_year` renders an INPUT or SELECT?
        // In forms.py I used `NumberInput`. So `{{ form.birth_year }}` renders `<input type="number">`.
        // In my HTML I manually wrote `<select id="birth_year_select" name="birth_year">`.
        // This naming collision `name="birth_year"` is good, it submits correctly.
        // But to show existing value, I need to know the value.
        // I will read the `value` attribute if Django rendered it, but I replaced Django's rendering with manual HTML.
        // So I need to inject the value.
        // A quick hack: Get the value from the form object in template.

        const initialYear = "{{ form.birth_year.value|default:'' }}";
        const initialMonth = "{{ form.birth_month.value|default:'' }}";
        const initialDay = "{{ form.birth_day.value|default:'' }}";

        if (initialYear) yearSelect.value = initialYear;
        if (initialMonth) monthSelect.value = initialMonth;
        // Trigger update days to populate day select
        updateDays();
        if (initialDay) daySelect.value = initialDay;
        updateZodiac();


        // --- Anniversary FormSet ---
        const addAnniversaryBtn = document.getElementById('add_anniversary');
        const anniversariesContainer = document.getElementById('anniversaries_container');
        const totalForms = document.getElementById('id_customanniversary_set-TOTAL_FORMS');

        addAnniversaryBtn.addEventListener('click', function () {
            const formIdx = totalForms.value;
            const emptyFormHtml = document.getElementById('empty_form').innerHTML;
            const newFormHtml = emptyFormHtml.replace(/__prefix__/g, formIdx);

            const div = document.createElement('div');
            div.innerHTML = newFormHtml;
            anniversariesContainer.appendChild(div.firstElementChild);

            totalForms.value = parseInt(formIdx) + 1;
        });

        // --- Group Creation (AJAX) ---
        const createGroupBtn = document.getElementById('create_group_btn');
        createGroupBtn.addEventListener('click', function () {
            const nameInput = document.getElementById('id_name'); // From group_form
            const descInput = document.getElementById('id_description');
            const name = nameInput.value;
            const desc = descInput.value;

            if (!name) return alert('グループ名を入力してください');

            fetch('{% url "api_group_create" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ name: name, description: desc })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Add to select list
                        const select = document.getElementById('id_groups');
                        const option = document.createElement('option');
                        option.value = data.id;
                        option.text = data.name;
                        option.selected = true; // Auto-select new group
                        select.appendChild(option);

                        // Clear and close modal
                        nameInput.value = '';
                        descInput.value = '';
                        document.getElementById('group_modal').classList.add('hidden');
                    } else {
                        alert('エラー: ' + data.error);
                    }
                });
        });
    });
</script>
{% endblock %}