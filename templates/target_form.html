{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />

<div class="h-full flex flex-col gap-6 overflow-y-auto pr-2 pb-10">
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-mono font-bold text-white flex items-center gap-2">
            <span class="w-2 h-8 bg-primary block"></span>
            {% if is_edit %}ターゲット情報編集{% else %}新規ターゲット登録{% endif %}
        </h1>
        <a href="{% url 'target_list' %}" class="text-gray-500 hover:text-white font-mono text-sm">
            [ キャンセル / 一覧へ戻る ]
        </a>
    </div>

    <form method="post" enctype="multipart/form-data" class="space-y-8" id="targetForm">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <!-- 1. 基本情報 (Basic Identity) -->
        <section class="bg-surface/30 border border-white/10 rounded-xl p-6 relative">
            <h2 class="text-primary font-mono text-lg mb-6 flex items-center gap-2 border-b border-white/5 pb-2">
                <span class="text-primary/50">01.</span> 基本情報 (IDENTITY)
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Text Fields (Left) -->
                <div class="md:col-span-1 space-y-4 order-2 md:order-1">
                    <!-- Nickname -->
                    <div class="form-group">
                        <label class="block text-xs font-mono text-gray-400 mb-1">ニックネーム / コードネーム <span
                                class="text-red-500">*</span></label>
                        {{ form.nickname }}
                    </div>

                    <!-- Name -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-mono text-gray-400 mb-1">姓 (Surname)</label>
                            {{ form.last_name }}
                        </div>
                        <div>
                            <label class="block text-xs font-mono text-gray-400 mb-1">名 (Given Name)</label>
                            {{ form.first_name }}
                        </div>
                    </div>
                    <!-- Kana -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-mono text-gray-400 mb-1">せい (Kana)</label>
                            {{ form.last_name_kana }}
                        </div>
                        <div>
                            <label class="block text-xs font-mono text-gray-400 mb-1">めい (Kana)</label>
                            {{ form.first_name_kana }}
                        </div>
                    </div>
                </div>

                <!-- Avatar (Right) -->
                <div class="md:col-span-1 flex flex-col gap-4 order-1 md:order-2">
                    <label class="block text-xs font-mono text-gray-400 mb-1 md:text-right">プロフィール画像 (300x300)</label>
                    <div class="w-[300px] h-[300px] bg-black border-2 border-dashed border-white/20 rounded-lg flex items-center justify-center relative group overflow-hidden mx-auto md:ml-auto"
                        id="avatarPreviewContainer">
                        {% if form.instance.avatar %}
                        <img src="{{ form.instance.avatar.url }}" id="avatarPreview" class="w-full h-full object-cover">
                        {% else %}
                        <div id="avatarPlaceholder"
                            class="text-center text-gray-500 p-4 flex flex-col items-center justify-center h-full">
                            <span class="block text-[80px] leading-none mb-4 mix-blend-difference opacity-50">+</span>
                            <span class="text-xs font-mono">UPLOAD PHOTO</span>
                        </div>
                        {% endif %}
                        <input type="file" name="avatar" id="id_avatar" accept="image/*"
                            class="absolute inset-0 opacity-0 cursor-pointer z-10 w-full h-full">
                    </div>

                    <!-- Avatar Delete Button -->
                    <div class="flex justify-center md:justify-end gap-2 {% if not form.instance.avatar %}hidden{% endif %}" id="deleteAvatarBtnContainer" style="position: relative; z-index: 30;">
                        <button type="button" id="deleteAvatarBtn"
                            class="text-xs text-red-500 hover:text-red-400 border border-red-500/30 px-2 py-1 rounded bg-red-500/10 cursor-pointer">
                            画像削除
                        </button>
                    </div>

                    <div class="text-[10px] text-gray-500 text-center md:text-right">
                        クリックで選択 (自動で正方形にトリミング可能)
                    </div>

                    {% if form.instance.avatar %}
                    <div class="hidden">
                        <input type="checkbox" name="avatar-clear" id="avatar-clear_id">
                    </div>
                    {% endif %}
                </div>
            </div>
        </section>

        <!-- 2. 生体情報 (Bio-Metrics) -->
        <section class="bg-surface/30 border border-white/10 rounded-xl p-6">
            <h2 class="text-primary font-mono text-lg mb-6 flex items-center gap-2 border-b border-white/5 pb-2">
                <span class="text-primary/50">02.</span> 生体情報 (BIO-METRICS)
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Birthdate (Selects) -->
                <div class="bg-black/20 p-4 rounded border border-white/5">
                    <label class="block text-xs font-mono text-gray-400 mb-2">生年月日</label>
                    <div class="flex flex-col md:flex-row gap-2 mb-2">
                        <!-- Year -->
                        <div class="relative flex-1">
                            {{ form.birth_year.as_hidden }}
                            <select id="birth_year_select"
                                class="w-full bg-surface border border-white/10 rounded px-2 py-2 text-white text-sm appearance-none focus:border-primary">
                                <option value="">年</option>
                                <!-- JS Populated -->
                            </select>
                        </div>
                        <!-- Month -->
                        <div class="relative flex-1">
                            {{ form.birth_month.as_hidden }}
                            <select id="birth_month_select"
                                class="w-full bg-surface border border-white/10 rounded px-2 py-2 text-white text-sm appearance-none focus:border-primary">
                                <option value="">月</option>
                                {% for i in "x"|ljust:"12" %}
                                <option value="{{ forloop.counter }}">{{ forloop.counter }}月</option>
                                {% endfor %}
                            </select>
                        </div>
                        <!-- Day -->
                        <div class="relative flex-1">
                            {{ form.birth_day.as_hidden }}
                            <select id="birth_day_select"
                                class="w-full bg-surface border border-white/10 rounded px-2 py-2 text-white text-sm appearance-none focus:border-primary">
                                <option value="">日</option>
                                {% for i in "x"|ljust:"31" %}
                                <option value="{{ forloop.counter }}">{{ forloop.counter }}日</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 text-xs font-mono text-gray-500 mt-2">
                        <span id="ageDisplay">年齢: --歳</span>
                        <span id="etoDisplay">干支: --</span>
                    </div>
                </div>

                <!-- Zodiac -->
                <div class="bg-black/20 p-4 rounded border border-white/5 relative">
                    <label class="block text-xs font-mono text-gray-400 mb-2">星座 (自動判定 / 手動変更可)</label>
                    <div class="flex gap-2 mb-1">
                        <div class="flex-1">
                            {{ form.zodiac_sign }}
                        </div>
                        <select id="zodiacParams"
                            class="bg-surface border border-white/10 rounded px-2 text-white text-xs w-32">
                            <option value="">自動 (Auto)</option>
                            <option value="牡羊座">♈ 牡羊座</option>
                            <option value="牡牛座">♉ 牡牛座</option>
                            <option value="双子座">♊ 双子座</option>
                            <option value="蟹座">♋ 蟹座</option>
                            <option value="獅子座">♌ 獅子座</option>
                            <option value="乙女座">♍ 乙女座</option>
                            <option value="天秤座">♎ 天秤座</option>
                            <option value="蠍座">♏ 蠍座</option>
                            <option value="射手座">♐ 射手座</option>
                            <option value="山羊座">♑ 山羊座</option>
                            <option value="水瓶座">♒ 水瓶座</option>
                            <option value="魚座">♓ 魚座</option>
                        </select>
                    </div>
                    <!-- Zodiac Date Range Display -->
                    <div id="zodiacRangeDisplay" class="text-[10px] text-gray-500 text-right h-4"></div>
                </div>

                <!-- Gender & Blood -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-mono text-gray-400 mb-1">性別</label>
                        {{ form.gender }}
                    </div>
                    <div>
                        <label class="block text-xs font-mono text-gray-400 mb-1">血液型</label>
                        {{ form.blood_type }}
                    </div>
                </div>
                <!-- Origin -->
                <div>
                    <label class="block text-xs font-mono text-gray-400 mb-1">出身地</label>
                    {{ form.birthplace }}
                </div>
            </div>
        </section>

        <!-- 3. 所属 (Affiliation) -->
        <section class="bg-surface/30 border border-white/10 rounded-xl p-6">
            <h2 class="text-primary font-mono text-lg mb-6 flex items-center gap-2 border-b border-white/5 pb-2">
                <span class="text-primary/50">03.</span> 所属・グループ (AFFILIATION)
            </h2>

            <div class="form-group">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-xs font-mono text-gray-400">所属グループ選択</label>
                    <button type="button" id="openGroupModal"
                        class="text-xs bg-primary/20 text-primary border border-primary/50 px-2 py-1 rounded hover:bg-primary/30 transition">
                        + 新規グループ作成
                    </button>
                </div>
                <!-- Checkbox Grid -->
                <div class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-40 overflow-y-auto p-2 bg-black/20 rounded border border-white/5"
                    id="groupsContainer">
                    {% for group in form.groups.field.queryset %}
                    <div class="flex items-center justify-between p-2 rounded hover:bg-white/5 transition border border-transparent hover:border-white/10 group-item group/item">
                        <label class="flex items-center gap-2 cursor-pointer flex-1">
                            <input type="checkbox" name="groups" value="{{ group.id }}" class="rounded border-gray-600 text-primary focus:ring-primary bg-gray-900 w-4 h-4" {% if group in form.instance.groups.all %}checked{% endif %}>
                            <span class="text-sm text-gray-300 group-name-span">{{ group.name }}</span>
                        </label>
                        <div class="flex gap-2">
                            <button type="button" class="text-gray-400 hover:text-white edit-group-btn" 
                                data-id="{{ group.id }}" 
                                data-name="{{ group.name }}" 
                                data-desc="{{ group.description }}"
                                data-mon="{{ group.is_mon|yesno:'true,false' }}"
                                data-tue="{{ group.is_tue|yesno:'true,false' }}"
                                data-wed="{{ group.is_wed|yesno:'true,false' }}"
                                data-thu="{{ group.is_thu|yesno:'true,false' }}"
                                data-fri="{{ group.is_fri|yesno:'true,false' }}"
                                data-sat="{{ group.is_sat|yesno:'true,false' }}"
                                data-sun="{{ group.is_sun|yesno:'true,false' }}">
                                <i class="fas fa-pencil-alt text-xs"></i> 編集
                            </button>
                            <button type="button" class="text-gray-400 hover:text-red-500 delete-group-btn" data-id="{{ group.id }}">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-span-full text-center text-gray-500 text-xs py-4">グループがまだありません</div>
                    {% endfor %}
                </div>
            </div>
        </section>

        <!-- 4. 記念日 (Anniversaries) -->
        <section class="bg-surface/30 border border-white/10 rounded-xl p-6">
            <h2 class="text-primary font-mono text-lg mb-6 flex items-center gap-2 border-b border-white/5 pb-2">
                <span class="text-primary/50">04.</span> 重要な日付・記念日 (DATES)
            </h2>

            {{ anniversaries.management_form }}
            <div id="anniversary-forms" class="space-y-4">
                {% for form in anniversaries %}
                <div class="anniversary-row flex gap-4 items-end bg-black/20 p-3 rounded border border-white/5">
                    {{ form.id }}
                    {{ form.target }}

                    <div class="hidden">
                        {{ form.DELETE }}
                    </div>

                    <div class="flex-1">
                        <label class="block text-[10px] font-mono text-gray-500 mb-1">名称 (例: 結婚記念日)</label>
                        {{ form.label }}
                    </div>
                    <div class="w-40">
                        <label class="block text-[10px] font-mono text-gray-500 mb-1">日付</label>
                        {{ form.date }}
                    </div>
                    <div class="pb-1">
                        <button type="button"
                            class="delete-anniversary-btn w-6 h-6 rounded-full bg-red-500 text-white flex items-center justify-center hover:bg-red-600 transition {% if not form.instance.pk %}hidden{% endif %}" title="削除">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            <button type="button" id="add-anniversary"
                class="mt-4 w-full py-2 bg-primary/20 text-primary border border-primary/50 rounded font-mono text-xs hover:bg-primary/30 transition">
                + 記念日を追加
            </button>
        </section>

        <!-- 5. メモ (Notes) -->
        <section class="bg-surface/30 border border-white/10 rounded-xl p-6">
            <h2 class="text-primary font-mono text-lg mb-6 flex items-center gap-2 border-b border-white/5 pb-2">
                <span class="text-primary/50">05.</span> その他メモ (NOTES)
            </h2>
            {{ form.description }}
        </section>

        <!-- Submit -->
        <!-- Submit Actions -->
        <div class="sticky bottom-4 z-40 flex gap-4">
            {% if is_edit %}
            <a href="{% url 'target_delete' form.instance.pk %}"
               class="flex-1 bg-red-500/10 text-red-500 font-bold py-4 rounded border border-red-500/30 hover:bg-red-500/20 transition font-mono flex items-center justify-center whitespace-nowrap">
               削除 (DELETE)
            </a>
            {% endif %}
            <button type="submit"
                class="flex-[2] bg-primary text-black font-bold py-4 rounded shadow-[0_0_20px_rgba(34,197,94,0.3)] hover:shadow-[0_0_30px_rgba(34,197,94,0.5)] transition font-mono border border-green-400">
                {% if is_edit %}更新を保存 (SAVE){% else %}登録する (REGISTER){% endif %}
            </button>
        </div>
    </form>
</div>

<!-- Crop Modal -->
<div id="cropModal" class="hidden fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4">
    <div class="bg-surface border border-white/20 rounded-xl p-6 max-w-2xl w-full flex flex-col gap-4">
        <h3 class="text-xl font-mono text-white">画像トリミング</h3>
        <div class="h-[500px] w-full bg-black flex items-center justify-center">
            <img id="imageToCrop" src="" class="max-w-full max-h-full">
        </div>
        <div class="flex justify-end gap-4">
            <button type="button" id="cancelCrop"
                class="px-4 py-2 text-gray-400 hover:text-white border border-white/10 rounded">キャンセル</button>
            <button type="button" id="confirmCrop" class="px-6 py-2 bg-primary text-black font-bold rounded">適用する
                (300px)</button>
        </div>
    </div>
</div>

<!-- Group Modal -->
<div id="groupModal"
    class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-surface border border-white/20 rounded-xl p-6 w-full max-w-md shadow-2xl">
        <h3 class="text-xl font-mono text-white mb-4 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span class="w-1 h-6 bg-primary block"></span>
                <span id="groupModalTitle">新規グループ作成</span>
            </div>
            <button type="button" id="deleteGroupFromModal" class="hidden text-red-500 hover:text-red-400 border border-red-500/30 bg-red-500/10 px-2 py-1 rounded text-xs">
                <i class="fas fa-trash"></i> 削除
            </button>
        </h3>
        <form id="groupCreateForm" class="space-y-4">
            <div>
                <label class="block text-xs font-mono text-gray-400 mb-1">グループ名</label>
                {{ group_form.name }}
            </div>
            <div>
                <label class="block text-xs font-mono text-gray-400 mb-1">説明</label>
                {{ group_form.description }}
            </div>
            <div class="mt-4">
                <label class="block text-xs font-mono text-gray-400 mb-2">接触頻度 (Contact Frequency)</label>
                <div class="flex flex-wrap gap-3">
                    <label class="flex items-center gap-1 cursor-pointer">
                        {{ group_form.is_mon }} <span class="text-xs text-gray-300">月</span>
                    </label>
                    <label class="flex items-center gap-1 cursor-pointer">
                        {{ group_form.is_tue }} <span class="text-xs text-gray-300">火</span>
                    </label>
                    <label class="flex items-center gap-1 cursor-pointer">
                        {{ group_form.is_wed }} <span class="text-xs text-gray-300">水</span>
                    </label>
                    <label class="flex items-center gap-1 cursor-pointer">
                        {{ group_form.is_thu }} <span class="text-xs text-gray-300">木</span>
                    </label>
                    <label class="flex items-center gap-1 cursor-pointer">
                        {{ group_form.is_fri }} <span class="text-xs text-gray-300">金</span>
                    </label>
                    <label class="flex items-center gap-1 cursor-pointer">
                        {{ group_form.is_sat }} <span class="text-xs text-gray-300">土</span>
                    </label>
                    <label class="flex items-center gap-1 cursor-pointer">
                        {{ group_form.is_sun }} <span class="text-xs text-gray-300">日</span>
                    </label>
                </div>
            </div>
            <div class="flex justify-end gap-3 pt-4 border-t border-white/10">
                <button type="button" id="closeGroupModal"
                    class="px-4 py-2 text-gray-400 hover:text-white text-sm">キャンセル</button>
                <button type="submit"
                    class="px-6 py-2 bg-primary/20 hover:bg-primary/30 text-primary border border-primary/50 rounded text-sm">作成</button>
            </div>
        </form>
    </div>
</div>

<!-- Hidden Template for Anniversary Row -->
<div id="empty_anniversary_form_template" class="hidden">
    <div class="anniversary-row flex gap-4 items-end bg-black/20 p-3 rounded border border-white/5">
        {{ anniversaries.empty_form.id }}
        {{ anniversaries.empty_form.target }}
        <div class="hidden">{{ anniversaries.empty_form.DELETE }}</div>

        <div class="flex-1">
            <label class="block text-[10px] font-mono text-gray-500 mb-1">名称 (例: 結婚記念日)</label>
            {{ anniversaries.empty_form.label }}
        </div>
        <div class="w-40">
            <label class="block text-[10px] font-mono text-gray-500 mb-1">日付</label>
            {{ anniversaries.empty_form.date }}
        </div>
        <div class="pb-1">
            <button type="button"
                class="delete-anniversary-btn w-6 h-6 rounded-full bg-red-500 text-white flex items-center justify-center hover:bg-red-600 transition" title="削除">
                <i class="fas fa-times text-xs"></i>
            </button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
    // --- Helper Functions ---
    function getEto(year) {
        if (!year) return '--';
        const etos = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
        const etoIndex = (year - 4) % 12;
        return etos[etoIndex < 0 ? etoIndex + 12 : etoIndex];
    }

    function calculateAge(year, month, day) {
        if (!year) return '--';
        const today = new Date();
        const y = parseInt(year);
        // Default to Jan 1st if no month provided for month-level precision check?
        const m = month ? parseInt(month) : 1;
        const d = day ? parseInt(day) : 1;

        let age = today.getFullYear() - y;
        const mDiff = today.getMonth() + 1 - m;

        if (mDiff < 0 || (mDiff === 0 && today.getDate() < d)) {
            age--;
        }
        return age;
    }

    // --- Populate Year Select ---
    const yearSelect = document.getElementById('birth_year_select');
    const monthSelect = document.getElementById('birth_month_select');
    const daySelect = document.getElementById('birth_day_select');
    const yearInput = document.getElementById('id_birth_year');
    const monthInput = document.getElementById('id_birth_month');
    const dayInput = document.getElementById('id_birth_day');

    const currentYear = new Date().getFullYear();
    const startYear = 1900;

    for (let y = currentYear; y >= startYear; y--) {
        let opt = document.createElement('option');
        opt.value = y;
        const simpleAge = currentYear - y;
        const eto = getEto(y);
        opt.textContent = `${y}年（${eto}）${simpleAge}歳`;
        yearSelect.appendChild(opt);
    }

    if (yearInput.value) yearSelect.value = yearInput.value;
    if (monthInput.value) monthSelect.value = monthInput.value;
    if (dayInput.value) daySelect.value = dayInput.value;

    function syncDate() {
        yearInput.value = yearSelect.value;
        monthInput.value = monthSelect.value;
        dayInput.value = daySelect.value;
        updateBio();
    }

    yearSelect.addEventListener('change', syncDate);
    monthSelect.addEventListener('change', syncDate);
    daySelect.addEventListener('change', syncDate);


    // --- Bio Logic (Age, Eto, Zodiac) ---
    const ageDisplay = document.getElementById('ageDisplay');
    const etoDisplay = document.getElementById('etoDisplay');
    const zodiacInput = document.getElementById('id_zodiac_sign');
    const zodiacSelect = document.getElementById('zodiacParams');
    const zodiacRangeDisplay = document.getElementById('zodiacRangeDisplay');

    const zodiacInfo = {
        "牡羊座": { start: "3/21", end: "4/19" },
        "牡牛座": { start: "4/20", end: "5/20" },
        "双子座": { start: "5/21", end: "6/21" },
        "蟹座": { start: "6/22", end: "7/22" },
        "獅子座": { start: "7/23", end: "8/22" },
        "乙女座": { start: "8/23", end: "9/22" },
        "天秤座": { start: "9/23", end: "10/23" },
        "蠍座": { start: "10/24", end: "11/22" },
        "射手座": { start: "11/23", end: "12/21" },
        "山羊座": { start: "12/22", end: "1/19" },
        "水瓶座": { start: "1/20", end: "2/18" },
        "魚座": { start: "2/19", end: "3/20" }
    };

    function getZodiac(month, day) {
        if (!month || !day) return '';
        const m = parseInt(month);
        const d = parseInt(day);
        if ((m == 1 && d <= 19) || (m == 12 && d >= 22)) return "山羊座";
        if ((m == 1 && d >= 20) || (m == 2 && d <= 18)) return "水瓶座";
        if ((m == 2 && d >= 19) || (m == 3 && d <= 20)) return "魚座";
        if ((m == 3 && d >= 21) || (m == 4 && d <= 19)) return "牡羊座";
        if ((m == 4 && d >= 20) || (m == 5 && d <= 20)) return "牡牛座";
        if ((m == 5 && d >= 21) || (m == 6 && d <= 21)) return "双子座";
        if ((m == 6 && d >= 21) || (m == 7 && d <= 22)) return "蟹座";
        if ((m == 7 && d >= 23) || (m == 8 && d <= 22)) return "獅子座";
        if ((m == 8 && d >= 23) || (m == 9 && d <= 22)) return "乙女座";
        if ((m == 9 && d >= 23) || (m == 10 && d <= 23)) return "天秤座";
        if ((m == 10 && d >= 23) || (m == 11 && d <= 21)) return "蠍座";
        if ((m == 11 && d >= 22) || (m == 12 && d <= 21)) return "射手座";
        return "";
    }

    function updateBio() {
        const y = parseInt(yearSelect.value);
        const m = parseInt(monthSelect.value);
        const d = parseInt(daySelect.value);

        if (y) {
            let age = calculateAge(y, m, d);
            ageDisplay.textContent = `年齢: ${age}歳`;
            etoDisplay.textContent = `干支: ${getEto(y)}`;
        } else {
            ageDisplay.textContent = `年齢: --歳`;
            etoDisplay.textContent = `干支: --`;
        }

        if (m && d) {
            const z = getZodiac(m, d);
            zodiacSelect.value = "";
            zodiacInput.value = z;
        } else if (zodiacSelect.value === "") {
            zodiacInput.value = "";
        }
    }

    updateBio();

    zodiacSelect.addEventListener('change', function () {
        if (this.value) {
            zodiacInput.value = this.value;
            const info = zodiacInfo[this.value];
            if (info) zodiacRangeDisplay.textContent = `${info.start} 〜 ${info.end}`;
        } else {
            zodiacRangeDisplay.textContent = "";
            updateBio();
        }
    });

    const originalUpdateBio = updateBio;
    updateBio = function () {
        originalUpdateBio();
        const startEnd = zodiacInfo[zodiacInput.value];
        if (startEnd) {
            zodiacRangeDisplay.textContent = `${startEnd.start} 〜 ${startEnd.end}`;
        } else {
            zodiacRangeDisplay.textContent = "";
        }
    };


    // --- Avatar Logic ---
    let cropper;
    const avatarInput = document.getElementById('id_avatar');
    const imageToCrop = document.getElementById('imageToCrop');
    const cropModal = document.getElementById('cropModal');
    const confirmCropBtn = document.getElementById('confirmCrop');
    const cancelCropBtn = document.getElementById('cancelCrop');
    const avatarPreviewContainer = document.getElementById('avatarPreviewContainer');
    let avatarPreview = document.getElementById('avatarPreview'); // Existing or new
    const avatarPlaceholder = document.getElementById('avatarPlaceholder');
    const deleteAvatarBtn = document.getElementById('deleteAvatarBtn');
    const avatarClearInput = document.getElementById('avatar-clear_id');

    avatarInput.addEventListener('change', function (e) {
        const files = e.target.files;
        if (files && files.length > 0) {
            const file = files[0];
            const url = URL.createObjectURL(file);
            imageToCrop.src = url;
            cropModal.classList.remove('hidden');

            if (cropper) cropper.destroy();
            cropper = new Cropper(imageToCrop, {
                aspectRatio: 1,
                viewMode: 1,
                dragMode: 'move',
            });
            if (avatarClearInput) avatarClearInput.checked = false;
        }
    });

    cancelCropBtn.addEventListener('click', function () {
        cropModal.classList.add('hidden');
        if (cropper) cropper.destroy();
        avatarInput.value = '';
    });

    confirmCropBtn.addEventListener('click', function () {
        if (cropper) {
            cropper.getCroppedCanvas({ width: 300, height: 300 }).toBlob((blob) => {
                const file = new File([blob], "avatar.jpg", { type: "image/jpeg" });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                avatarInput.files = dataTransfer.files;

                const previewUrl = URL.createObjectURL(blob);
                if (!avatarPreview) {
                    avatarPreview = document.createElement('img');
                    avatarPreview.id = 'avatarPreview';
                    avatarPreview.className = "w-full h-full object-cover";
                    avatarPreviewContainer.appendChild(avatarPreview);
                }
                avatarPreview.src = previewUrl;
                if (avatarPlaceholder) avatarPlaceholder.classList.add('hidden');
                avatarPreview.classList.remove('hidden');
            }, 'image/jpeg');
            cropModal.classList.add('hidden');
            document.getElementById('deleteAvatarBtnContainer').classList.remove('hidden');
        }
    });

    deleteAvatarBtn.addEventListener('click', function () {
        avatarInput.value = '';
        if (avatarPreview) {
            avatarPreview.src = '';
            avatarPreview.classList.add('hidden');
        }
        if (avatarPlaceholder) avatarPlaceholder.classList.remove('hidden');
        if (avatarClearInput) avatarClearInput.checked = true;
        document.getElementById('deleteAvatarBtnContainer').classList.add('hidden');
    });

    // --- Group AJAX ---
    const groupModal = document.getElementById('groupModal');
    const openGroupBtn = document.getElementById('openGroupModal');
    const closeGroupBtn = document.getElementById('closeGroupModal');
    const groupForm = document.getElementById('groupCreateForm');
    let currentEditingGroupId = null;

    openGroupBtn.addEventListener('click', () => {
        currentEditingGroupId = null;
        groupForm.reset();
        document.getElementById('groupModalTitle').textContent = '新規グループ作成';
        document.getElementById('deleteGroupFromModal').classList.add('hidden');
        groupModal.querySelector('button[type="submit"]').textContent = '作成';
        groupModal.classList.remove('hidden');
    });
    closeGroupBtn.addEventListener('click', () => groupModal.classList.add('hidden'));

    // Edit/Delete Group Delegates
    document.getElementById('groupsContainer').addEventListener('click', function(e) {
        if (e.target.closest('.delete-group-btn')) {
            const btn = e.target.closest('.delete-group-btn');
            const id = btn.dataset.id;
            if (confirm('このグループを削除しますか？\n(ターゲットとの関連も解除されます)')) {
                fetch(`/api/groups/${id}/delete/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
                }).then(resp => resp.json()).then(data => {
                    if(data.success) {
                        btn.closest('.group-item').remove();
                    } else {
                        alert('Error: ' + data.error);
                    }
                });
            }
        } else if (e.target.closest('.edit-group-btn')) {
            const btn = e.target.closest('.edit-group-btn');
            currentEditingGroupId = btn.dataset.id;
            groupForm.querySelector('[name="name"]').value = btn.dataset.name;
            groupForm.querySelector('[name="description"]').value = btn.dataset.desc;
            
            // Set frequency checks
            groupForm.querySelector('[name="is_mon"]').checked = btn.dataset.mon === 'true';
            groupForm.querySelector('[name="is_tue"]').checked = btn.dataset.tue === 'true';
            groupForm.querySelector('[name="is_wed"]').checked = btn.dataset.wed === 'true';
            groupForm.querySelector('[name="is_thu"]').checked = btn.dataset.thu === 'true';
            groupForm.querySelector('[name="is_fri"]').checked = btn.dataset.fri === 'true';
            groupForm.querySelector('[name="is_sat"]').checked = btn.dataset.sat === 'true';
            groupForm.querySelector('[name="is_sun"]').checked = btn.dataset.sun === 'true';

            document.getElementById('groupModalTitle').textContent = 'グループ編集';
            document.getElementById('deleteGroupFromModal').classList.remove('hidden');
            groupModal.querySelector('button[type="submit"]').textContent = '更新';
            groupModal.classList.remove('hidden');
        }
    });

    groupForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = {
            name: this.querySelector('[name="name"]').value,
            description: this.querySelector('[name="description"]').value,
            is_mon: this.querySelector('[name="is_mon"]').checked,
            is_tue: this.querySelector('[name="is_tue"]').checked,
            is_wed: this.querySelector('[name="is_wed"]').checked,
            is_thu: this.querySelector('[name="is_thu"]').checked,
            is_fri: this.querySelector('[name="is_fri"]').checked,
            is_sat: this.querySelector('[name="is_sat"]').checked,
            is_sun: this.querySelector('[name="is_sun"]').checked
        };

        const url = currentEditingGroupId ? `/api/groups/${currentEditingGroupId}/edit/` : '{% url "group_add" %}';
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (currentEditingGroupId) {
                        // Update existing UI
                        const btn = document.querySelector(`.edit-group-btn[data-id="${currentEditingGroupId}"]`);
                        btn.dataset.name = formData.name;
                        btn.dataset.desc = formData.description;
                        btn.dataset.mon = formData.is_mon;
                        // ... update other datasets ...
                        const row = btn.closest('.group-item');
                        row.querySelector('.group-name-span').textContent = formData.name;
                    } else {
                        // Add new UI
                        const container = document.getElementById('groupsContainer');
                        const emptyMsg = container.querySelector('.text-center');
                        if (emptyMsg) emptyMsg.remove();

                        const div = document.createElement('div');
                        div.className = "flex items-center justify-between p-2 rounded hover:bg-white/5 transition border border-transparent hover:border-white/10 group-item group/item";
                        div.innerHTML = `
                        <label class="flex items-center gap-2 cursor-pointer flex-1">
                            <input type="checkbox" name="groups" value="${data.id}" checked class="rounded border-gray-600 text-primary focus:ring-primary bg-gray-900 w-4 h-4">
                            <span class="text-sm text-gray-300 group-name-span">${data.name}</span>
                        </label>
                        <div class="flex gap-2 opacity-0 group-hover/item:opacity-100 transition-opacity">
                             <button type="button" class="text-gray-400 hover:text-white edit-group-btn" 
                                data-id="${data.id}" data-name="${data.name}" data-desc="${formData.description}"
                                data-mon="${formData.is_mon}" data-tue="${formData.is_tue}" data-wed="${formData.is_wed}"
                                data-thu="${formData.is_thu}" data-fri="${formData.is_fri}" data-sat="${formData.is_sat}" data-sun="${formData.is_sun}">
                                <i class="fas fa-pencil-alt text-xs"></i> 編集
                            </button>
                            <button type="button" class="text-gray-400 hover:text-red-500 delete-group-btn" data-id="${data.id}">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                        `;
                        container.prepend(div);
                    }
                    groupModal.classList.add('hidden');
                    groupForm.reset();
                } else {
                }
            });
    });

    // Modal Delete Button
    document.getElementById('deleteGroupFromModal').addEventListener('click', function() {
        if (currentEditingGroupId && confirm('本当にこのグループを削除しますか？\n(ターゲットとの関連も解除されます)')) {
            fetch(`/api/groups/${currentEditingGroupId}/delete/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
            }).then(resp => resp.json()).then(data => {
                if(data.success) {
                    const btn = document.querySelector(`.edit-group-btn[data-id="${currentEditingGroupId}"]`);
                    if(btn) btn.closest('.group-item').remove();
                    groupModal.classList.add('hidden');
                } else {
                    alert('Error: ' + data.error);
                }
            });
        }
    });

    // --- Anniversary FormSet ---
    const addAnniversaryBtn = document.getElementById('add-anniversary');
    const anniversaryFormsContainer = document.getElementById('anniversary-forms');
    const totalFormsInput = document.getElementById('id_customanniversary_set-TOTAL_FORMS');
    const emptyFormTemplate = document.getElementById('empty_anniversary_form_template');

    anniversaryFormsContainer.addEventListener('click', function (e) {
        if (e.target.closest('.delete-anniversary-btn')) {
            const row = e.target.closest('.anniversary-row');
            const idInput = row.querySelector('input[name$="-id"]');
            const deleteInput = row.querySelector('input[name$="-DELETE"]');

            if (idInput && idInput.value) {
                if (deleteInput) deleteInput.checked = true;
                row.classList.add('hidden');
            } else {
                row.remove();
            }
        }
    });

    addAnniversaryBtn.addEventListener('click', function () {
        const formIdx = parseInt(totalFormsInput.value);
        const newFormHtml = emptyFormTemplate.innerHTML.replace(/__prefix__/g, formIdx);
        const div = document.createElement('div');
        div.innerHTML = newFormHtml;
        const newFormRow = div.firstElementChild;

        newFormRow.querySelectorAll('input').forEach(input => {
            if (input.type !== 'hidden' && input.type !== 'checkbox' && !input.className.includes('delete-anniversary-btn')) {
                input.value = '';
            }
            if (input.type === 'checkbox') input.checked = false;
        });

        anniversaryFormsContainer.appendChild(newFormRow);
        totalFormsInput.value = formIdx + 1;
    });

</script>
{% endblock %}