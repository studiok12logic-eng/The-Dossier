{% extends 'base.html' %}
{% load static %}

{% block content_wrapper_class %}flex-1 overflow-y-auto p-0 pb-24 md:pb-8{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />

<div class="h-full flex flex-col gap-6 overflow-y-auto p-0 pb-10">
    <div class="p-4 border-b border-white/10 shrink-0 flex items-center gap-3">
                 <button onclick="window.location.href='{% url 'target_list' %}'" class="w-8 h-8 flex items-center justify-center text-text-sub hover:text-white rounded-full bg-white/5">
                     <i class="fas fa-chevron-left"></i>
                 </button>
                 <h3 class="text-sm font-bold text-text-main truncate flex-1" id="answerPageTitle">{% if is_edit %}EDIT TARGET{% else %}ADD TARGET{% endif %}</h3>
             </div>

    <form method="post" enctype="multipart/form-data" class="space-y-8" id="targetForm">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <!-- 1. 基本情報 (Basic Identity) -->
        <section class="bg-surface/30 p-6 relative">
            <h2 class="text-primary font-mono text-sm mb-6 flex items-center gap-2 border-b border-white/5 pb-2">
                <span class="text-primary/50">01.</span> 基本情報
            </h2>

            <!-- Fields First -->
            <div class="space-y-4 mb-6">
                <!-- Nickname -->
                <div class="form-group">
                    <label class="block text-xs font-mono text-gray-400 mb-1">ニックネーム / コードネーム <span
                            class="text-red-500">*</span></label>
                    {{ form.nickname }}
                </div>

                <!-- Name -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-mono text-gray-400 mb-1">姓 (Surname)</label>
                        {{ form.last_name }}
                    </div>
                    <div>
                        <label class="block text-xs font-mono text-gray-400 mb-1">名 (Given Name)</label>
                        {{ form.first_name }}
                    </div>
                </div>
                <!-- Kana -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-mono text-gray-400 mb-1">せい (Kana)</label>
                        {{ form.last_name_kana }}
                    </div>
                    <div>
                        <label class="block text-xs font-mono text-gray-400 mb-1">めい (Kana)</label>
                        {{ form.first_name_kana }}
                    </div>
                </div>
            </div>

            <!-- Avatar Last -->
            <div class="flex flex-col gap-4">
                <!-- Label + Button Row -->
                <div class="flex items-center gap-3">
                    <label class="text-xs font-mono text-gray-400">ターゲット画像</label>
                    <label for="id_avatar" class="px-3 py-1 bg-white/10 text-[10px] border border-white/20 rounded cursor-pointer hover:bg-white/20 text-white font-mono">
                         + IMAGE UPLOAD
                    </label>
                    <input type="file" name="avatar" id="id_avatar" accept="image/*" class="hidden">
                </div>

                <!-- Centered Preview & Delete -->
                <div class="flex flex-col items-center gap-2">
                    <div id="avatarPreviewContainer" class="relative">
                        {% if form.instance.avatar %}
                        <img src="{{ form.instance.avatar.url }}" id="avatarPreview" class="object-cover" style="width: 30vw; height: 30vw;">
                        {% else %}
                        <img id="avatarPreview" class="hidden object-cover" style="width: 30vw; height: 30vw;">
                        {% endif %}
                    </div>
    
                    <div class="{% if not form.instance.avatar %}hidden{% endif %}" id="deleteAvatarBtnContainer">
                        <button type="button" id="deleteAvatarBtn"
                            class="text-xs text-red-500 hover:text-red-400 border border-red-500/30 px-2 py-1 rounded bg-red-500/10 cursor-pointer">
                            画像削除
                        </button>
                    </div>
    
                    {% if form.instance.avatar %}
                    <div class="hidden">
                        <input type="checkbox" name="avatar-clear" id="avatar-clear_id">
                    </div>
                    {% endif %}
                </div>
            </div>
        </section>

        <!-- 2. 生体情報 (Bio-Metrics) -->
        <section class="bg-surface/30 p-6">
            <h2 class="text-primary font-mono text-sm mb-6 flex items-center gap-2 border-b border-white/5 pb-2">

                <span class="text-primary/50">02.</span> 生体情報
            </h2>

            <!-- Birthdate -->
            <div class="mb-6">
                <label class="block text-xs font-mono text-gray-400 mb-2">生年月日</label>
                <div class="flex gap-2 mb-2">
                    <!-- Year -->
                    <div class="relative flex-1">
                        {{ form.birth_year.as_hidden }}
                        <select id="birth_year_select"
                            class="w-full bg-surface border border-white/10 rounded px-2 py-2 text-white text-sm appearance-none focus:border-primary">
                            <option value="">年</option>
                            <!-- JS Populated -->
                        </select>
                    </div>
                    <!-- Month -->
                    <div class="relative flex-1">
                        {{ form.birth_month.as_hidden }}
                        <select id="birth_month_select"
                            class="w-full bg-surface border border-white/10 rounded px-2 py-2 text-white text-sm appearance-none focus:border-primary">
                            <option value="">月</option>
                            {% for i in "x"|ljust:"12" %}
                            <option value="{{ forloop.counter }}">{{ forloop.counter }}月</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Day -->
                    <div class="relative flex-1">
                        {{ form.birth_day.as_hidden }}
                        <select id="birth_day_select"
                            class="w-full bg-surface border border-white/10 rounded px-2 py-2 text-white text-sm appearance-none focus:border-primary">
                            <option value="">日</option>
                            {% for i in "x"|ljust:"31" %}
                            <option value="{{ forloop.counter }}">{{ forloop.counter }}日</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="flex items-center gap-4 text-xs font-mono text-gray-500 mt-2">
                    <span id="ageDisplay">年齢: --歳</span>
                    <span id="etoDisplay">干支: --</span>
                    <span id="zodiacDisplay">星座: --</span>
                </div>
            </div>

            <!-- Zodiac Input (Hidden) -->
            <div class="hidden">{{ form.zodiac_sign }}</div>

            <!-- Zodiac Select, Gender, Blood -->
            <div class="flex gap-2 mb-6">
                <!-- Zodiac Select -->
                <div class="flex-1 min-w-0">
                     <label class="block text-xs font-mono text-gray-400 mb-1">星座</label>
                     <select id="zodiacParams"
                         class="w-full bg-surface border border-white/10 rounded px-2 py-2 text-white text-sm appearance-none focus:border-primary">
                         <option value="">自動</option>
                         <option value="牡羊座">♈ 牡羊座</option>
                         <option value="牡牛座">♉ 牡牛座</option>
                         <option value="双子座">♊ 双子座</option>
                         <option value="蟹座">♋ 蟹座</option>
                         <option value="獅子座">♌ 獅子座</option>
                         <option value="乙女座">♍ 乙女座</option>
                         <option value="天秤座">♎ 天秤座</option>
                         <option value="蠍座">♏ 蠍座</option>
                         <option value="射手座">♐ 射手座</option>
                         <option value="山羊座">♑ 山羊座</option>
                         <option value="水瓶座">♒ 水瓶座</option>
                         <option value="魚座">♓ 魚座</option>
                     </select>
                </div>
                <!-- Gender -->
                <div class="flex-1 min-w-0">
                    <label class="block text-xs font-mono text-gray-400 mb-1">性別</label>
                    {{ form.gender }}
                </div>
                <!-- Blood -->
                <div class="flex-1 min-w-0">
                    <label class="block text-xs font-mono text-gray-400 mb-1">血液型</label>
                    {{ form.blood_type }}
                </div>
            </div>

            <!-- Origin -->
            <div>
                <label class="block text-xs font-mono text-gray-400 mb-1">出身地</label>
                {{ form.birthplace }}
            </div>
        </section>

        <!-- 3. 所属 (Affiliation) -->
        <section class="bg-surface/30 p-6 relative">
            <h2 class="text-primary font-mono text-sm mb-6 flex items-center gap-2 border-b border-white/5 pb-2">
                <span class="text-primary/50">03.</span> 所属・グループ
            </h2>

            <div class="form-group">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-xs font-mono text-gray-400">所属グループ選択</label>
                    <button type="button" id="openGroupModal"
                        class="text-xs bg-primary/20 text-primary border border-primary/50 px-2 py-1 rounded hover:bg-primary/30 transition">
                        + 新規グループ作成
                    </button>
                </div>
                <!-- Checkbox Grid (Tag Style) -->
                <div class="flex flex-wrap gap-2 max-h-40 overflow-y-auto p-2 bg-black/20 rounded border border-white/5" id="groupsContainer">
                    {% for group in user_groups %}
                    <label class="group-item relative flex items-center justify-between px-3 py-2 rounded-full border border-white/10 bg-surface/50 transition cursor-pointer select-none group-select-label"
                        data-id="{{ group.id }}"
                        data-name="{{ group.name }}"
                        data-desc="{{ group.description }}"
                        data-mon="{{ group.is_mon|yesno:'true,false' }}"
                        data-tue="{{ group.is_tue|yesno:'true,false' }}"
                        data-wed="{{ group.is_wed|yesno:'true,false' }}"
                        data-thu="{{ group.is_thu|yesno:'true,false' }}"
                        data-fri="{{ group.is_fri|yesno:'true,false' }}"
                        data-sat="{{ group.is_sat|yesno:'true,false' }}"
                        data-sun="{{ group.is_sun|yesno:'true,false' }}">
                        
                        <input type="checkbox" name="groups" value="{{ group.id }}" class="hidden peer" {% if group in form.instance.groups.all %}checked{% endif %}>
                        
                        <div class="absolute inset-0 rounded-full border border-primary/50 bg-primary/20 opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                        
                        <span class="relative z-10 text-xs text-gray-300 peer-checked:text-primary transition-colors flex items-center gap-2">
                            <span class="group-name-span">{{ group.name }}</span>
                            <span class="text-[10px] bg-black/40 px-1.5 rounded-full text-gray-400 peer-checked:text-primary/80">{{ group.target_count }}</span>
                        </span>
                    </label>
                    {% empty %}
                    <div class="w-full text-center text-gray-500 text-xs py-4">グループがまだありません</div>
                    {% endfor %}
                </div>
            </div>
        </section>

        <!-- 4. 記念日 (Anniversaries) -->
        <section class="bg-surface/30 p-6 relative">
            <h2 class="text-primary font-mono text-sm mb-6 flex items-center gap-2 border-b border-white/5 pb-2">
                <span class="text-primary/50">04.</span> 重要な日付・記念日
            </h2>

            {{ anniversaries.management_form }}
            <div id="anniversary-forms" class="space-y-4">
                {% for form in anniversaries %}
                <div class="anniversary-row flex gap-4 items-end bg-black/20 p-3 rounded border border-white/5">
                    {{ form.id }}
                    {{ form.target }}

                    <div class="hidden">
                        {{ form.DELETE }}
                    </div>

                    <div class="flex-1">
                        <label class="block text-[10px] font-mono text-gray-500 mb-1">名称 (例: 結婚記念日)</label>
                        {{ form.label }}
                    </div>
                    <div class="w-40">
                        <label class="block text-[10px] font-mono text-gray-500 mb-1">日付</label>
                        {{ form.date }}
                    </div>
                    <div class="pb-1">
                        <button type="button"
                            class="delete-anniversary-btn w-6 h-6 rounded-full bg-red-500 text-white flex items-center justify-center hover:bg-red-600 transition {% if not form.instance.pk %}hidden{% endif %}" title="削除">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            <button type="button" id="add-anniversary"
                class="mt-4 w-full py-2 bg-primary/20 text-primary border border-primary/50 rounded font-mono text-xs hover:bg-primary/30 transition">
                + 記念日を追加
            </button>
        </section>

        <!-- 5. メモ (Notes) -->
        <section class="bg-surface/30 p-6 relative">
            <h2 class="text-primary font-mono text-sm mb-6 flex items-center gap-2 border-b border-white/5 pb-2">
                <span class="text-primary/50">05.</span> その他メモ
            </h2>
            {{ form.description }}
        </section>

        <!-- Submit -->
        <!-- Submit Actions -->
        <div class="mt-8 flex gap-4">
            {% if is_edit %}
            <a href="{% url 'target_delete' form.instance.pk %}"
               class="flex-1 bg-red-500/10 text-red-500 font-bold py-4 rounded border border-red-500/30 hover:bg-red-500/20 transition font-mono flex items-center justify-center whitespace-nowrap">
               削除 (DELETE)
            </a>
            {% endif %}
            <button type="submit"
                class="flex-[2] bg-primary text-black font-bold py-4 rounded shadow-[0_0_20px_rgba(34,197,94,0.3)] hover:shadow-[0_0_30px_rgba(34,197,94,0.5)] transition font-mono border border-green-400">
                {% if is_edit %}更新を保存 (SAVE){% else %}登録する (REGISTER){% endif %}
            </button>
        </div>
    </form>
</div>

<!-- Crop Modal -->
<div id="cropModal" class="hidden fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4">
    <div class="bg-surface border border-white/20 rounded-xl p-6 max-w-2xl w-full flex flex-col gap-4">
        <h3 class="text-xl font-mono text-white">画像トリミング</h3>
        <div class="h-[500px] w-full bg-black flex items-center justify-center">
            <img id="imageToCrop" src="" class="max-w-full max-h-full">
        </div>
        <div class="flex justify-end gap-4">
            <button type="button" id="cancelCrop"
                class="px-4 py-2 text-gray-400 hover:text-white border border-white/10 rounded">キャンセル</button>
            <button type="button" id="confirmCrop" class="px-6 py-2 bg-primary text-black font-bold rounded">適用する
                (300px)</button>
        </div>
    </div>
</div>

<!-- Group Modal -->
<div id="groupModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-surface border border-white/20 rounded-xl w-full max-w-md shadow-2xl overflow-hidden">
        <!-- Header -->
        <div class="p-4 border-b border-white/10 shrink-0 flex items-center gap-3 bg-surface">
            <button type="button" id="closeGroupModal" class="text-gray-400 hover:text-white">
                <i class="fas fa-chevron-left"></i>
            </button>
            <h3 class="text-base font-mono text-white flex-1" id="groupModalTitle">新規グループ作成</h3>
        </div>

        <div class="p-6">
            <form id="groupCreateForm" class="space-y-6">
                <div>
                    <label class="block text-xs font-mono text-gray-400 mb-1">グループ名</label>
                    {{ group_form.name }}
                </div>
                <div>
                    <label class="block text-xs font-mono text-gray-400 mb-1">説明</label>
                    {{ group_form.description }}
                </div>
                <div>
                    <label class="block text-xs font-mono text-gray-400 mb-2">接触頻度 (曜日選択)</label>
                    <div class="flex flex-wrap gap-2">
                        {% for field, label in group_form.days_fields %}
                        <!-- This requires custom iteration or manual rendering. I'll manually render for now -->
                        {% endfor %}
                        
                        <!-- Manual Day Toggles -->
                        <label class="cursor-pointer">
                            <input type="checkbox" name="is_mon" class="hidden peer">
                            <span class="block w-8 h-8 flex items-center justify-center rounded bg-surface border border-white/10 text-xs text-gray-400 peer-checked:bg-green-500 peer-checked:text-black peer-checked:border-green-500 transition">月</span>
                        </label>
                        <label class="cursor-pointer">
                            <input type="checkbox" name="is_tue" class="hidden peer">
                            <span class="block w-8 h-8 flex items-center justify-center rounded bg-surface border border-white/10 text-xs text-gray-400 peer-checked:bg-green-500 peer-checked:text-black peer-checked:border-green-500 transition">火</span>
                        </label>
                        <label class="cursor-pointer">
                            <input type="checkbox" name="is_wed" class="hidden peer">
                            <span class="block w-8 h-8 flex items-center justify-center rounded bg-surface border border-white/10 text-xs text-gray-400 peer-checked:bg-green-500 peer-checked:text-black peer-checked:border-green-500 transition">水</span>
                        </label>
                        <label class="cursor-pointer">
                            <input type="checkbox" name="is_thu" class="hidden peer">
                            <span class="block w-8 h-8 flex items-center justify-center rounded bg-surface border border-white/10 text-xs text-gray-400 peer-checked:bg-green-500 peer-checked:text-black peer-checked:border-green-500 transition">木</span>
                        </label>
                        <label class="cursor-pointer">
                            <input type="checkbox" name="is_fri" class="hidden peer">
                            <span class="block w-8 h-8 flex items-center justify-center rounded bg-surface border border-white/10 text-xs text-gray-400 peer-checked:bg-green-500 peer-checked:text-black peer-checked:border-green-500 transition">金</span>
                        </label>
                        <label class="cursor-pointer">
                            <input type="checkbox" name="is_sat" class="hidden peer">
                            <span class="block w-8 h-8 flex items-center justify-center rounded bg-surface border border-white/10 text-xs text-gray-400 peer-checked:bg-green-500 peer-checked:text-black peer-checked:border-green-500 transition">土</span>
                        </label>
                        <label class="cursor-pointer">
                            <input type="checkbox" name="is_sun" class="hidden peer">
                            <span class="block w-8 h-8 flex items-center justify-center rounded bg-surface border border-white/10 text-xs text-gray-400 peer-checked:bg-green-500 peer-checked:text-black peer-checked:border-green-500 transition">日</span>
                        </label>
                    </div>
                </div>
                <div class="pt-4 flex justify-center">
                    <button type="submit"
                        class="px-8 py-3 bg-primary/20 hover:bg-primary/30 text-primary border border-primary/50 rounded font-bold text-sm min-w-[120px]">
                        作成
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Long Press Action Menu -->
<div id="groupActionMenu" class="hidden fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-surface border border-white/20 rounded-xl w-full max-w-xs overflow-hidden flex flex-col">
        <div class="p-4 text-center border-b border-white/10 text-white font-bold" id="actionMenuTitle">グループ操作</div>
        <button type="button" id="actionEdit" class="p-4 text-white hover:bg-white/5 border-b border-white/10 transition text-left">
            <i class="fas fa-pencil-alt mr-2 text-gray-400"></i> 編集する
        </button>
        <button type="button" id="actionDelete" class="p-4 text-red-500 hover:bg-red-500/10 transition text-left">
            <i class="fas fa-trash mr-2"></i> 削除する
        </button>
        <button type="button" id="actionCancel" class="p-4 text-gray-400 bg-black/40 hover:bg-black/60 transition text-center border-t border-white/10">
            キャンセル
        </button>
    </div>
</div>

<!-- Hidden Template for Anniversary Row -->
<div id="empty_anniversary_form_template" class="hidden">
    <div class="anniversary-row flex gap-4 items-end bg-black/20 p-3 rounded border border-white/5">
        {{ anniversaries.empty_form.id }}
        {{ anniversaries.empty_form.target }}
        <div class="hidden">{{ anniversaries.empty_form.DELETE }}</div>

        <div class="flex-1">
            <label class="block text-[10px] font-mono text-gray-500 mb-1">名称 (例: 結婚記念日)</label>
            {{ anniversaries.empty_form.label }}
        </div>
        <div class="w-40">
            <label class="block text-[10px] font-mono text-gray-500 mb-1">日付</label>
            {{ anniversaries.empty_form.date }}
        </div>
        <div class="pb-1">
            <button type="button"
                class="delete-anniversary-btn w-6 h-6 rounded-full bg-red-500 text-white flex items-center justify-center hover:bg-red-600 transition" title="削除">
                <i class="fas fa-times text-xs"></i>
            </button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
    // --- Helper Functions ---
    function getEto(year) {
        if (!year) return '--';
        const etos = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
        const etoIndex = (year - 4) % 12;
        return etos[etoIndex < 0 ? etoIndex + 12 : etoIndex];
    }

    function calculateAge(year, month, day) {
        if (!year) return '--';
        const today = new Date();
        const y = parseInt(year);
        // Default to Jan 1st if no month provided for month-level precision check?
        const m = month ? parseInt(month) : 1;
        const d = day ? parseInt(day) : 1;

        let age = today.getFullYear() - y;
        const mDiff = today.getMonth() + 1 - m;

        if (mDiff < 0 || (mDiff === 0 && today.getDate() < d)) {
            age--;
        }
        return age;
    }

    // --- Populate Year Select ---
    const yearSelect = document.getElementById('birth_year_select');
    const monthSelect = document.getElementById('birth_month_select');
    const daySelect = document.getElementById('birth_day_select');
    const yearInput = document.getElementById('id_birth_year');
    const monthInput = document.getElementById('id_birth_month');
    const dayInput = document.getElementById('id_birth_day');

    const currentYear = new Date().getFullYear();
    const startYear = 1900;

    for (let y = currentYear; y >= startYear; y--) {
        let opt = document.createElement('option');
        opt.value = y;
        const simpleAge = currentYear - y;
        const eto = getEto(y);
        opt.textContent = `${y}年（${eto}）${simpleAge}歳`;
        yearSelect.appendChild(opt);
    }

    if (yearInput.value) yearSelect.value = yearInput.value;
    if (monthInput.value) monthSelect.value = monthInput.value;
    if (dayInput.value) daySelect.value = dayInput.value;

    function syncDate() {
        yearInput.value = yearSelect.value;
        monthInput.value = monthSelect.value;
        dayInput.value = daySelect.value;
        updateBio();
    }

    yearSelect.addEventListener('change', syncDate);
    monthSelect.addEventListener('change', syncDate);
    daySelect.addEventListener('change', syncDate);


    // --- Bio Logic (Age, Eto, Zodiac) ---
    const ageDisplay = document.getElementById('ageDisplay');
    const etoDisplay = document.getElementById('etoDisplay');
    const zodiacDisplay = document.getElementById('zodiacDisplay');
    const zodiacInput = document.getElementById('id_zodiac_sign');
    const zodiacSelect = document.getElementById('zodiacParams');

    const zodiacInfo = {
        "牡羊座": { start: "3/21", end: "4/19" },
        "牡牛座": { start: "4/20", end: "5/20" },
        "双子座": { start: "5/21", end: "6/21" },
        "蟹座": { start: "6/22", end: "7/22" },
        "獅子座": { start: "7/23", end: "8/22" },
        "乙女座": { start: "8/23", end: "9/22" },
        "天秤座": { start: "9/23", end: "10/23" },
        "蠍座": { start: "10/24", end: "11/22" },
        "射手座": { start: "11/23", end: "12/21" },
        "山羊座": { start: "12/22", end: "1/19" },
        "水瓶座": { start: "1/20", end: "2/18" },
        "魚座": { start: "2/19", end: "3/20" }
    };

    function getZodiac(month, day) {
        if (!month || !day) return '';
        const m = parseInt(month);
        const d = parseInt(day);
        if ((m == 1 && d <= 19) || (m == 12 && d >= 22)) return "山羊座";
        if ((m == 1 && d >= 20) || (m == 2 && d <= 18)) return "水瓶座";
        if ((m == 2 && d >= 19) || (m == 3 && d <= 20)) return "魚座";
        if ((m == 3 && d >= 21) || (m == 4 && d <= 19)) return "牡羊座";
        if ((m == 4 && d >= 20) || (m == 5 && d <= 20)) return "牡牛座";
        if ((m == 5 && d >= 21) || (m == 6 && d <= 21)) return "双子座";
        if ((m == 6 && d >= 21) || (m == 7 && d <= 22)) return "蟹座";
        if ((m == 7 && d >= 23) || (m == 8 && d <= 22)) return "獅子座";
        if ((m == 8 && d >= 23) || (m == 9 && d <= 22)) return "乙女座";
        if ((m == 9 && d >= 23) || (m == 10 && d <= 23)) return "天秤座";
        if ((m == 10 && d >= 23) || (m == 11 && d <= 21)) return "蠍座";
        if ((m == 11 && d >= 22) || (m == 12 && d <= 21)) return "射手座";
        return "";
    }

    function updateDisplay() {
         const z = zodiacInput.value;
         if (z && zodiacInfo[z]) {
             zodiacDisplay.textContent = `星座: ${z}(${zodiacInfo[z].start} 〜 ${zodiacInfo[z].end})`;
         } else {
             zodiacDisplay.textContent = `星座: --`;
         }
    }

    function updateBio() {
        const y = parseInt(yearSelect.value);
        const m = parseInt(monthSelect.value);
        const d = parseInt(daySelect.value);

        if (y) {
            let age = calculateAge(y, m, d);
            ageDisplay.textContent = `年齢: ${age}歳`;
            etoDisplay.textContent = `干支: ${getEto(y)}`;
        } else {
            ageDisplay.textContent = `年齢: --歳`;
            etoDisplay.textContent = `干支: --`;
        }

        if (m && d) {
            const z = getZodiac(m, d);
            zodiacSelect.value = "";
            zodiacInput.value = z;
        } else if (zodiacSelect.value === "") {
             if(!zodiacSelect.value) zodiacInput.value = "";
        }
        updateDisplay();
    }

    updateBio();

    zodiacSelect.addEventListener('change', function () {
        if (this.value) {
            zodiacInput.value = this.value;
            updateDisplay();
        } else {
            updateBio();
        }
    });


    // --- Avatar Logic ---
    let cropper;
    const avatarInput = document.getElementById('id_avatar');
    const imageToCrop = document.getElementById('imageToCrop');
    const cropModal = document.getElementById('cropModal');
    const confirmCropBtn = document.getElementById('confirmCrop');
    const cancelCropBtn = document.getElementById('cancelCrop');
    const avatarPreviewContainer = document.getElementById('avatarPreviewContainer');
    let avatarPreview = document.getElementById('avatarPreview'); // Existing or new
    const avatarPlaceholder = document.getElementById('avatarPlaceholder');
    const deleteAvatarBtn = document.getElementById('deleteAvatarBtn');
    const avatarClearInput = document.getElementById('avatar-clear_id');

    avatarInput.addEventListener('change', function (e) {
        const files = e.target.files;
        if (files && files.length > 0) {
            const file = files[0];
            const url = URL.createObjectURL(file);
            imageToCrop.src = url;
            cropModal.classList.remove('hidden');

            if (cropper) cropper.destroy();
            cropper = new Cropper(imageToCrop, {
                aspectRatio: 1,
                viewMode: 1,
                dragMode: 'move',
            });
            if (avatarClearInput) avatarClearInput.checked = false;
        }
    });

    cancelCropBtn.addEventListener('click', function () {
        cropModal.classList.add('hidden');
        if (cropper) cropper.destroy();
        avatarInput.value = '';
    });

    confirmCropBtn.addEventListener('click', function () {
        if (cropper) {
            cropper.getCroppedCanvas({ width: 300, height: 300 }).toBlob((blob) => {
                const file = new File([blob], "avatar.jpg", { type: "image/jpeg" });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                avatarInput.files = dataTransfer.files;

                const previewUrl = URL.createObjectURL(blob);
                if (!avatarPreview) {
                    avatarPreview = document.createElement('img');
                    avatarPreview.id = 'avatarPreview';
                    avatarPreview.className = "w-full h-full object-cover";
                    avatarPreviewContainer.appendChild(avatarPreview);
                }
                avatarPreview.src = previewUrl;
                if (avatarPlaceholder) avatarPlaceholder.classList.add('hidden');
                avatarPreview.classList.remove('hidden');
            }, 'image/jpeg');
            cropModal.classList.add('hidden');
            document.getElementById('deleteAvatarBtnContainer').classList.remove('hidden');
        }
    });

    deleteAvatarBtn.addEventListener('click', function () {
        avatarInput.value = '';
        if (avatarPreview) {
            avatarPreview.src = '';
            avatarPreview.classList.add('hidden');
        }
        if (avatarPlaceholder) avatarPlaceholder.classList.remove('hidden');
        if (avatarClearInput) avatarClearInput.checked = true;
        document.getElementById('deleteAvatarBtnContainer').classList.add('hidden');
    });

    // --- Group AJAX & Long Press ---
    const groupModal = document.getElementById('groupModal');
    const openGroupBtn = document.getElementById('openGroupModal');
    const closeGroupBtn = document.getElementById('closeGroupModal');
    const groupForm = document.getElementById('groupCreateForm');
    const actionMenu = document.getElementById('groupActionMenu');
    let currentEditingGroupId = null;
    let longPressTimer;
    let isLongPress = false;
    let touchedElement = null;

    // Open Create Modal
    openGroupBtn.addEventListener('click', () => {
        currentEditingGroupId = null;
        groupForm.reset();
        document.getElementById('groupModalTitle').textContent = '新規グループ作成';
        groupModal.querySelector('button[type="submit"]').textContent = '作成';
        groupModal.classList.remove('hidden');
    });

    closeGroupBtn.addEventListener('click', () => groupModal.classList.add('hidden'));

    // Helpers for Day Toggles (Manual binding since Django Widget default doesn't match well)
    // Actually the inputs are cleaner in HTML now.
    
    // Group List Interactions
    const groupsContainer = document.getElementById('groupsContainer');

    groupsContainer.addEventListener('mousedown', handleStart);
    groupsContainer.addEventListener('touchstart', handleStart);
    groupsContainer.addEventListener('mouseup', handleEnd);
    groupsContainer.addEventListener('touchend', handleEnd);
    groupsContainer.addEventListener('mousemove', handleMove);
    groupsContainer.addEventListener('touchmove', handleMove);
    groupsContainer.addEventListener('click', handleClick);

    function handleStart(e) {
        if (e.target.closest('.group-select-label')) {
            touchedElement = e.target.closest('.group-select-label');
            isLongPress = false;
            longPressTimer = setTimeout(() => {
                isLongPress = true;
                showActionMenu(touchedElement);
            }, 600);
        }
    }

    function handleMove(e) {
        // If moved significantly, cancel long press
        // Simplify: just cancel on any move if strict, or use distance check.
        // For now, cancel on move.
        // clearTimeout(longPressTimer); 
    }

    function handleEnd(e) {
        clearTimeout(longPressTimer);
    }
    
    function handleClick(e) {
        if (isLongPress) {
            e.preventDefault();
            e.stopPropagation(); // prevent toggle
            isLongPress = false;
        }
    }

    function showActionMenu(el) {
        currentEditingGroupId = el.dataset.id;
        document.getElementById('actionMenuTitle').textContent = el.dataset.name;
        
        // Populate form data invisibly for Edit action
        groupForm.querySelector('[name="name"]').value = el.dataset.name;
        groupForm.querySelector('[name="description"]').value = el.dataset.desc;
        groupForm.querySelector('[name="is_mon"]').checked = el.dataset.mon === 'true';
        groupForm.querySelector('[name="is_tue"]').checked = el.dataset.tue === 'true';
        groupForm.querySelector('[name="is_wed"]').checked = el.dataset.wed === 'true';
        groupForm.querySelector('[name="is_thu"]').checked = el.dataset.thu === 'true';
        groupForm.querySelector('[name="is_fri"]').checked = el.dataset.fri === 'true';
        groupForm.querySelector('[name="is_sat"]').checked = el.dataset.sat === 'true';
        groupForm.querySelector('[name="is_sun"]').checked = el.dataset.sun === 'true';

        actionMenu.classList.remove('hidden');
    }

    // Action Menu Listeners
    document.getElementById('actionCancel').addEventListener('click', () => actionMenu.classList.add('hidden'));
    
    document.getElementById('actionEdit').addEventListener('click', () => {
        actionMenu.classList.add('hidden');
        document.getElementById('groupModalTitle').textContent = 'グループ編集';
        groupModal.querySelector('button[type="submit"]').textContent = '更新';
        groupModal.classList.remove('hidden');
    });

    document.getElementById('actionDelete').addEventListener('click', () => {
        actionMenu.classList.add('hidden');
        if (confirm('このグループを削除しますか？\n(ターゲットとの関連も解除されます)')) {
            fetch(`/api/groups/${currentEditingGroupId}/delete/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
            }).then(resp => resp.json()).then(data => {
                if(data.success) {
                    const el = document.querySelector(`.group-select-label[data-id="${currentEditingGroupId}"]`);
                    if(el) el.remove();
                } else {
                    alert('Error: ' + data.error);
                }
            });
        }
    });

    // Form Submit
    groupForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = {
            name: this.querySelector('[name="name"]').value,
            description: this.querySelector('[name="description"]').value,
            is_mon: this.querySelector('[name="is_mon"]').checked,
            is_tue: this.querySelector('[name="is_tue"]').checked,
            is_wed: this.querySelector('[name="is_wed"]').checked,
            is_thu: this.querySelector('[name="is_thu"]').checked,
            is_fri: this.querySelector('[name="is_fri"]').checked,
            is_sat: this.querySelector('[name="is_sat"]').checked,
            is_sun: this.querySelector('[name="is_sun"]').checked
        };

        const url = currentEditingGroupId ? `/api/groups/${currentEditingGroupId}/edit/` : '{% url "group_add" %}';
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                     if (currentEditingGroupId) {
                        // Update existing UI
                        const el = document.querySelector(`.group-select-label[data-id="${currentEditingGroupId}"]`);
                        el.dataset.name = formData.name;
                        el.dataset.desc = formData.description;
                        el.dataset.mon = formData.is_mon;
                        el.dataset.tue = formData.is_tue;
                        el.dataset.wed = formData.is_wed;
                        el.dataset.thu = formData.is_thu;
                        el.dataset.fri = formData.is_fri;
                        el.dataset.sat = formData.is_sat;
                        el.dataset.sun = formData.is_sun;
                        
                        el.querySelector('.group-name-span').textContent = formData.name;
                    } else {
                        // Add new UI
                        const container = document.getElementById('groupsContainer');
                        const emptyMsg = container.querySelector('.text-center');
                        if (emptyMsg) emptyMsg.remove();
                        
                        // Creating clean DOM element string
                        const div = document.createElement('div'); // Temp wrapper
                        div.innerHTML = `
                        <label class="group-item relative flex items-center justify-between px-3 py-2 rounded-full border border-white/10 bg-surface/50 transition cursor-pointer select-none group-select-label"
                            data-id="${data.id}"
                            data-name="${data.name}"
                            data-desc="${formData.description}"
                            data-mon="${formData.is_mon}"
                            data-tue="${formData.is_tue}"
                            data-wed="${formData.is_wed}"
                            data-thu="${formData.is_thu}"
                            data-fri="${formData.is_fri}"
                            data-sat="${formData.is_sat}"
                            data-sun="${formData.is_sun}">
                            
                            <input type="checkbox" name="groups" value="${data.id}" checked class="hidden peer">
                            <div class="absolute inset-0 rounded-full border border-primary/50 bg-primary/20 opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                            
                            <span class="relative z-10 text-xs text-gray-300 peer-checked:text-primary transition-colors flex items-center gap-2">
                                <span class="group-name-span">${data.name}</span>
                                <span class="text-[10px] bg-black/40 px-1.5 rounded-full text-gray-400 peer-checked:text-primary/80">0</span>
                            </span>
                        </label>`;
                        container.prepend(div.firstElementChild);
                    }
                    groupModal.classList.add('hidden');
                    groupForm.reset();
                }
            });
    });

    // --- Anniversary FormSet ---
    const addAnniversaryBtn = document.getElementById('add-anniversary');
    const anniversaryFormsContainer = document.getElementById('anniversary-forms');
    const totalFormsInput = document.getElementById('id_customanniversary_set-TOTAL_FORMS');
    const emptyFormTemplate = document.getElementById('empty_anniversary_form_template');

    anniversaryFormsContainer.addEventListener('click', function (e) {
        if (e.target.closest('.delete-anniversary-btn')) {
            const row = e.target.closest('.anniversary-row');
            const idInput = row.querySelector('input[name$="-id"]');
            const deleteInput = row.querySelector('input[name$="-DELETE"]');

            if (idInput && idInput.value) {
                if (deleteInput) deleteInput.checked = true;
                row.classList.add('hidden');
            } else {
                row.remove();
            }
        }
    });

    addAnniversaryBtn.addEventListener('click', function () {
        const formIdx = parseInt(totalFormsInput.value);
        const newFormHtml = emptyFormTemplate.innerHTML.replace(/__prefix__/g, formIdx);
        const div = document.createElement('div');
        div.innerHTML = newFormHtml;
        const newFormRow = div.firstElementChild;

        newFormRow.querySelectorAll('input').forEach(input => {
            if (input.type !== 'hidden' && input.type !== 'checkbox' && !input.className.includes('delete-anniversary-btn')) {
                input.value = '';
            }
            if (input.type === 'checkbox') input.checked = false;
        });

        anniversaryFormsContainer.appendChild(newFormRow);
        totalFormsInput.value = formIdx + 1;
    });

</script>
{% endblock %}