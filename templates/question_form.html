{% extends 'base.html' %}
{% block content_wrapper_class %}flex-1 overflow-y-auto pb-24 md:p-8 md:pb-8{% endblock %}
{% block content %}
    
    <div class="h-full flex flex-col p-0 pb-20 overflow-y-auto"> <!-- Restored pb-20 -->
        
        <!-- Header -->
        <div class="p-4 border-b border-white/10 shrink-0 flex items-center gap-3">
            <button type="button" onclick="history.back()" class="w-8 h-8 flex items-center justify-center text-text-sub hover:text-white rounded-full bg-white/5">
                <i class="fas fa-chevron-left"></i>
            </button>
            <h3 class="text-sm font-bold text-text-main truncate flex-1">
                {% if form.instance.pk %}EDIT QUESTION{% else %}NEW QUESTION{% endif %}
            </h3>
        </div>

        <!-- Form -->
        <form method="post" class="">
            {% csrf_token %}
            
            <!-- Type & Scope (Master Only for Shared/Order) -->
            {% if user.role == 'MASTER' %}
            <section class="bg-surface/30 p-6 relative">
                 <h2 class="text-primary font-mono text-sm mb-6 flex items-center gap-2 border-b border-white/5 pb-2">
                    <span class="text-primary/50">00.</span> ADMIN SETTINGS
                </h2>
                <div class="space-y-4">
                    <div class="flex items-center gap-2 p-3 bg-white/5 rounded border border-white/10">
                        {{ form.is_shared }}
                        <span class="text-sm text-gray-300 font-bold">共通質問 (Shared)</span>
                    </div>
                     <div>
                        <label class="block text-xs font-mono text-gray-400 mb-2">表示順 (Order)</label>
                        {{ form.order }}
                    </div>
                </div>
            </section>
            {% endif %}

            <!-- Classification (Category & Rank) -->
            <section class="bg-surface/30 p-6 relative">
                 <h2 class="text-primary font-mono text-sm mb-6 flex items-center gap-2 border-b border-white/5 pb-2">
                    <span class="text-primary/50">01.</span> CLASSIFICATION
                </h2>
                <div class="space-y-6">
                    <!-- Rank (Master Only) -->
                     {% if user.role == 'MASTER' %}
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-xs font-mono text-gray-400">ランク (RANK)</label>
                             <button type="button" id="addRankBtn" class="text-[10px] text-primary hover:underline border border-primary/30 px-2 py-0.5 rounded">+ ADD NEW</button>
                        </div>
                        {{ form.rank }}
                    </div>
                    {% endif %}

                    <!-- Category -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-xs font-mono text-gray-400">カテゴリー (CATEGORY)</label>
                            {% if user.role == 'MASTER' %}
                            <button type="button" id="addCategoryBtn" class="text-[10px] text-primary hover:underline border border-primary/30 px-2 py-0.5 rounded">+ ADD NEW</button>
                            {% endif %}
                        </div>
                        <div class="relative">
                            {{ form.category }}
                        </div>
                         {% if user.role != 'MASTER' %}
                         <p class="text-[10px] text-gray-500 mt-1">* 共有カテゴリーから選択してください。</p>
                         {% endif %}
                    </div>
                </div>
            </section>

            <!-- Content -->
            <section class="bg-surface/30 p-6 relative">
                 <h2 class="text-primary font-mono text-sm mb-6 flex items-center gap-2 border-b border-white/5 pb-2">
                    <span class="text-primary/50">02.</span> CONTENT
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-mono text-gray-400 mb-1">質問名 (Title)</label>
                        {{ form.title }}
                    </div>
                    <div>
                        <label class="block text-xs font-mono text-gray-400 mb-1">説明・意図 (Intent)</label>
                        {{ form.description }}
                    </div>
                    <div>
                        <label class="block text-xs font-mono text-gray-400 mb-1">質問例 (Example)</label>
                        {{ form.example }}
                    </div>
                </div>
            </section>

            <!-- Answer Settings -->
            <section class="bg-surface/30 p-6 relative">
                 <h2 class="text-primary font-mono text-sm mb-6 flex items-center gap-2 border-b border-white/5 pb-2">
                    <span class="text-primary/50">03.</span> ANSWER SETTINGS
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-mono text-gray-400 mb-1">回答形式 (Type)</label>
                        {{ form.answer_type }}
                    </div>
                    <div id="choicesContainer" class="transition-opacity duration-300">
                        <label class="block text-xs font-mono text-gray-400 mb-1">選択肢 (Choices)</label>
                        {{ form.choices }}
                        <p class="text-[10px] text-gray-500 mt-1">カンマ区切り (例: A, B, C)</p>
                    </div>
                </div>
            </section>

            <!-- Submit -->
            <div class="mt-8 flex gap-4 px-6 pb-8">
                 {% if form.instance.pk and user.role == "MASTER" or form.instance.pk and not form.instance.is_shared %}
                <a href="{% url 'question_delete' form.instance.pk %}" 
                   class="flex-1 bg-red-500/10 text-red-500 font-bold py-4 rounded border border-red-500/30 hover:bg-red-500/20 transition font-mono flex items-center justify-center whitespace-nowrap"
                   onclick="return confirm('この質問を削除してもよろしいですか？')">
                    削除 (DELETE)
                </a>
                {% endif %}
                <button type="submit" 
                    class="flex-[2] bg-primary text-black font-bold py-4 rounded shadow-[0_0_20px_rgba(34,197,94,0.3)] hover:shadow-[0_0_30px_rgba(34,197,94,0.5)] transition font-mono border border-green-400">
                    {% if form.instance.pk %}更新を保存 (SAVE){% else %}登録する (REGISTER){% endif %}
                </button>
            </div>
        </form>
    </div>

<!-- Modals for Category/Rank (Simple Prompts or Custom Modal) -->
{% if user.role == 'MASTER' %}
<div id="catModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-surface border border-white/20 p-6 rounded-xl w-96">
        <h3 class="text-white font-mono mb-4">NEW CATEGORY</h3>
        <input id="newCatName" type="text" placeholder="Name" class="w-full bg-white/5 border border-white/20 rounded px-3 py-2 text-white mb-4 shadow-inner">
        <div class="flex justify-end gap-2">
            <button type="button" onclick="document.getElementById('catModal').classList.add('hidden')" class="px-3 py-1 text-gray-400 text-sm">Cancel</button>
            <button type="button" id="saveCatBtn" class="px-3 py-1 bg-primary text-black text-sm rounded">Save</button>
        </div>
    </div>
</div>

<div id="rankModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-surface border border-white/20 p-6 rounded-xl w-96">
        <h3 class="text-white font-mono mb-4">NEW RANK</h3>
        <input id="newRankName" type="text" placeholder="Rank Name" class="w-full bg-white/5 border border-white/20 rounded px-3 py-2 text-white mb-2 shadow-inner">
        <input id="newRankPoints" type="number" placeholder="Points" class="w-full bg-white/5 border border-white/20 rounded px-3 py-2 text-white mb-4 shadow-inner">
        <div class="flex justify-end gap-2">
            <button type="button" onclick="document.getElementById('rankModal').classList.add('hidden')" class="px-3 py-1 text-gray-400 text-sm">Cancel</button>
            <button type="button" id="saveRankBtn" class="px-3 py-1 bg-primary text-black text-sm rounded">Save</button>
        </div>
    </div>
</div>
{% endif %}

<script>
    // Toggle Choices Visual State
    const typeSelect = document.querySelector('[name="answer_type"]');
    const choicesInput = document.querySelector('[name="choices"]');
    const choicesContainer = document.getElementById('choicesContainer');
    
    function updateChoicesState() {
        if(typeSelect.value === 'SELECTION') {
            choicesInput.disabled = false;
            choicesInput.classList.remove('opacity-50', 'cursor-not-allowed');
            choicesContainer.classList.remove('opacity-50');
        } else {
            // Disabled style
            choicesInput.disabled = true; // Or just visual? "グレーアウト" usually implies disabled.
            // But if user wants to keep data... well, TEXT type doesn't use choices.
            choicesInput.classList.add('opacity-50', 'cursor-not-allowed');
            choicesContainer.classList.add('opacity-50');
        }
    }
    typeSelect.addEventListener('change', updateChoicesState);
    updateChoicesState(); // Init

    // Styling Django Form Widgets via JS if needed (or assume classes added in ID)
    // Styling is handled in forms.py, but just in case of raw inputs not in ModelForm:
    document.querySelectorAll('input:not([class*="bg-"]), select:not([class*="bg-"]), textarea:not([class*="bg-"])').forEach(el => {
        if(el.type !== 'checkbox' && el.type !== 'hidden') {
            el.classList.add('w-full', 'bg-white/5', 'border', 'border-white/20', 'rounded', 'px-4', 'py-2', 'text-white', 'focus:outline-none', 'focus:border-primary');
        }
        if(el.tagName === 'SELECT') el.classList.add('appearance-none', 'cursor-pointer');
    });

    {% if user.role == 'MASTER' %}
    // API Handling for Category/Rank
    const addCatBtn = document.getElementById('addCategoryBtn');
    if(addCatBtn) addCatBtn.addEventListener('click', () => document.getElementById('catModal').classList.remove('hidden'));
    
    const addRankBtn = document.getElementById('addRankBtn');
    if(addRankBtn) addRankBtn.addEventListener('click', () => document.getElementById('rankModal').classList.remove('hidden'));

    document.getElementById('saveCatBtn').addEventListener('click', () => {
        const name = document.getElementById('newCatName').value;
        if(!name) return;

        fetch('{% url "category_add" %}', {
            method: 'POST',
            body: JSON.stringify({name}),
            headers: {'X-CSRFToken': '{{ csrf_token }}'}
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                const opt = new Option(data.name, data.id, true, true);
                document.querySelector('[name="category"]').appendChild(opt);
                document.getElementById('catModal').classList.add('hidden');
            }
        });
    });

    document.getElementById('saveRankBtn').addEventListener('click', () => {
        const name = document.getElementById('newRankName').value;
        const pts = document.getElementById('newRankPoints').value;
        if(!name) return;

        fetch('{% url "rank_add" %}', {
            method: 'POST',
            body: JSON.stringify({name, points: pts}),
            headers: {'X-CSRFToken': '{{ csrf_token }}'}
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                const opt = new Option(data.name, data.id, true, true);
                document.querySelector('[name="rank"]').appendChild(opt);
                document.getElementById('rankModal').classList.add('hidden');
            }
        });
    });
    {% endif %}
</script>
{% endblock %}
